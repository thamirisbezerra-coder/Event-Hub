<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Hub - Painel de Marketing</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Import Map para React (ESM) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react-dom": "https://esm.sh/react-dom@18.2.0"
      }
    }
    </script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; padding-bottom: 80px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-header { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.5); }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        blue: { 900: '#1e3a8a', 950: '#172554' }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <!-- Container Principal -->
    <div id="root"></div>

    <!-- Container de Erro Global (Fallback) -->
    <div id="global-error" style="display:none; padding: 20px; color: #ef4444; background: #fee2e2; margin: 20px; border-radius: 8px; font-family: sans-serif;">
        <h2 style="font-weight: bold; margin-bottom: 10px;">Ocorreu um erro ao carregar a aplicação:</h2>
        <pre id="error-message" style="white-space: pre-wrap; font-size: 14px;"></pre>
        <button onclick="localStorage.clear(); window.location.reload()" style="margin-top:15px; padding:8px 16px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer;">Limpar Dados e Recarregar</button>
    </div>

    <script>
        // Captura erros globais antes do React carregar
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('global-error').style.display = 'block';
            document.getElementById('error-message').textContent = message + '\n\nSource: ' + source + ':' + lineno;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { createPortal } from 'react-dom';

        import { 
            Calendar as CalendarIcon, Users, CheckSquare, Flag, Plus, X, Clock, 
            Edit2, Trash2, ChevronLeft, ChevronRight, Truck, ArrowLeft, 
            Search, Bell, MessageSquare, Send, AlertCircle, ChevronDown, 
            ChevronUp, Settings, UserPlus, Box, TrendingUp, Filter, Check, 
            Image as ImageIcon, AlertTriangle, Crown, Plane, Target, Camera,
            DollarSign, ClipboardList, Mic, Music, Coffee, Gift, Sparkles, Bot,
            BarChart3, Layout, GripVertical, Flame, Info, Wifi, WifiOff,
            ExternalLink, Lightbulb, BrainCircuit, MoreVertical, Paperclip, FileText,
            Wand2, Copy, Share2, ZoomIn, Layers, Zap, Megaphone, Palette, Maximize2, MapPin, Briefcase, Rocket, Star,
            PieChart, Timer, UserCheck, RefreshCw, Key, Archive, Download, Cloud,
            Home, List, Grid, Smile, LogOut, Repeat, Columns, Database, HardDrive, Lock, ZapOff
        } from 'https://esm.sh/lucide-react@0.294.0';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- Configuração Firebase ---
        const userFirebaseConfig = {
            apiKey: "AIzaSyD976h76Lt8FZVq3K6wlmtKJgy6QAOsaVA",
            authDomain: "eventhub-c03e4.firebaseapp.com",
            projectId: "eventhub-c03e4",
            storageBucket: "eventhub-c03e4.firebasestorage.app",
            messagingSenderId: "288236914912",
            appId: "1:288236914912:web:940ee18e9d84c651ab2885",
            measurementId: "G-ZE8C5JKQ44"
        };

        let app = null;
        let db = null;
        let auth = null;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        try {
            let configToUse = userFirebaseConfig;
            if (typeof __firebase_config !== 'undefined') {
                configToUse = JSON.parse(__firebase_config);
            } else if (!userFirebaseConfig.apiKey && localStorage.getItem('event_hub_firebase_config')) {
                configToUse = JSON.parse(localStorage.getItem('event_hub_firebase_config'));
            }

            if (configToUse && configToUse.apiKey) {
                app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);
            }
        } catch (e) {
            console.warn("Firebase Init Error:", e);
        }

        const getColPath = (colName) => {
            if (!db) return null;
            return collection(db, 'artifacts', appId, 'public', 'data', colName);
        };
        const getDocPath = (colName, docId) => {
            if (!db) return null;
            return doc(db, 'artifacts', appId, 'public', 'data', colName, String(docId));
        };

        // --- Funções Auxiliares ---
        const compressImage = (file, maxWidth = 800) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL(file.type === 'image/png' ? 'image/png' : 'image/jpeg', 0.7)); 
                        } else resolve(img.src);
                    };
                };
            });
        };

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
        
        const getDaysLeft = (evt) => {
            if (!evt || !evt.startDate) return 0;
            const [year, month, day] = evt.startDate.split('-').map(Number);
            const target = new Date(year, month - 1, day); // Meia-noite local
            const today = new Date();
            today.setHours(0,0,0,0); // Meia-noite local hoje
            const diff = target - today;
            return Math.ceil(diff / (86400000));
        };

        const isEventFinished = (evt) => {
            if (!evt.endDate && !evt.startDate) return false;
            const dateStr = evt.endDate || evt.startDate;
            const [year, month, day] = dateStr.split('-').map(Number);
            const eventEnd = new Date(year, month - 1, day, 23, 59, 59, 999);
            return eventEnd < new Date();
        };

        // --- Dados Iniciais ---
        const INITIAL_MEMBERS = [
            { id: '1', name: 'Paulo Mokarzel', role: 'Head de Eventos', photoUrl: null },
            { id: '2', name: 'Matheus Silva', role: 'Marketing', photoUrl: null },
            { id: '3', name: 'Larissa Tomé', role: 'Marketing', photoUrl: null },
            { id: '4', name: 'Suzana Santos', role: 'Marketing', photoUrl: null },
            { id: '5', name: 'Thalita Carmo', role: 'Marketing', photoUrl: null },
            { id: '6', name: 'Felipe Paiva', role: 'Marketing', photoUrl: null },
            { id: '7', name: 'Dominik', role: 'Marketing', photoUrl: null },
            { id: '8', name: 'Claudiano', role: 'Marketing', photoUrl: null },
            { id: '9', name: 'Vitória Araujo', role: 'Marketing', photoUrl: null }
        ];

        const STATUS_OPTIONS = [
            { id: 'planning', label: 'Planejamento', color: 'bg-blue-100 text-blue-700 border-blue-200' },
            { id: 'in_progress', label: 'Andamento', color: 'bg-amber-100 text-amber-700 border-amber-200' },
            { id: 'review', label: 'Finalização', color: 'bg-purple-100 text-purple-700 border-purple-200' },
            { id: 'done', label: 'Concluído', color: 'bg-emerald-100 text-emerald-700 border-emerald-200' }
        ];

        // --- Constantes & Configs ---
        const PASTEL_COLORS = [
            { id: 'blue', bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-200', hex: '#DBEAFE' },
            { id: 'green', bg: 'bg-emerald-100', text: 'text-emerald-700', border: 'border-emerald-200', hex: '#D1FAE5' },
            { id: 'yellow', bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-200', hex: '#FEF3C7' },
            { id: 'red', bg: 'bg-rose-100', text: 'text-rose-700', border: 'border-rose-200', hex: '#FFE4E6' },
            { id: 'purple', bg: 'bg-purple-100', text: 'text-purple-700', border: 'border-purple-200', hex: '#F3E8FF' },
            { id: 'orange', bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200', hex: '#FFEDD5' },
            { id: 'teal', bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-200', hex: '#CCFBF1' },
            { id: 'indigo', bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-200', hex: '#E0E7FF' },
        ];

        const STATUS_COLUMNS = [
            { id: 'planning', title: 'Planejamento', color: 'blue', icon: Box },
            { id: 'in_progress', title: 'Andamento', color: 'amber', icon: Truck },
            { id: 'review', title: 'Finalização', color: 'purple', icon: Search },
            { id: 'done', title: 'Concluído', color: 'emerald', icon: CheckSquare }
        ];

        const ICON_MAP = { box: Box, truck: Truck, users: Users, trending: TrendingUp, check: CheckSquare, layers: Layers, zap: Zap, megaphone: Megaphone, palette: Palette, gift: Gift, coffee: Coffee, music: Music, layout: Layout, search: Search, smile: Smile, star: Star, cloud: Cloud, key: Key, lock: Archive, map: MapPin, camera: Camera };
        const ICON_KEYS = Object.keys(ICON_MAP);

        const DEFAULT_CATEGORIES = [
            { id: 'planning', title: 'Planejamento & Produto', icon: 'box', color: 'blue', phases: ['pre', 'during', 'post'], responsibleId: null, supportIds: [] },
            { id: 'logistics', title: 'Logística & Estande', icon: 'truck', color: 'amber', phases: ['pre', 'during', 'post'], responsibleId: null, supportIds: [] },
            { id: 'staff', title: 'Staff & Viagem', icon: 'users', color: 'purple', phases: ['pre', 'during', 'post'], responsibleId: null, supportIds: [] },
            { id: 'post', title: 'Pós-Evento & Leads', icon: 'trending', color: 'emerald', phases: ['post'], responsibleId: null, supportIds: [] }
        ];

        const AGENDA_COLORS = [
            { id: 'blue', bg: 'bg-blue-100', text: 'text-blue-700', ring: 'ring-blue-500' },
            { id: 'green', bg: 'bg-emerald-100', text: 'text-emerald-700', ring: 'ring-emerald-500' },
            { id: 'red', bg: 'bg-rose-100', text: 'text-rose-700', ring: 'ring-rose-500' },
            { id: 'orange', bg: 'bg-orange-100', text: 'text-orange-700', ring: 'ring-orange-500' },
            { id: 'purple', bg: 'bg-purple-100', text: 'text-purple-700', ring: 'ring-purple-500' },
        ];

        const OPTIONAL_STARTUP_TASKS = [
            { id: 'p1', text: 'Definir tema e conceito do evento', category: 'planning', phase: 'pre' },
            { id: 'p2', text: 'Aprovar orçamento preliminar', category: 'planning', phase: 'pre' },
            { id: 'l1', text: 'Reservar local/espaço', category: 'logistics', phase: 'pre' },
            { id: 'l2', text: 'Contratar serviço de Buffet', category: 'logistics', phase: 'pre' },
            { id: 's1', text: 'Contratar recepcionistas', category: 'staff', phase: 'pre' },
            { id: 'po1', text: 'Consolidar relatório de leads', category: 'post', phase: 'post' }
        ];

        // --- Componentes ---

        const Avatar = ({ member, size = "w-10 h-10", className = "" }) => {
            if (!member) return <div className={`${size} rounded-full bg-gray-200 border border-gray-300 ${className}`}></div>;
            const content = member.photoUrl ? (
                <img src={member.photoUrl} className="w-full h-full object-cover" />
            ) : (
                <div className="w-full h-full flex items-center justify-center text-blue-900 font-bold text-[10px]">
                    {member.name?.substring(0,2).toUpperCase()}
                </div>
            );
            return (
                <div className={`${size} rounded-full bg-white border border-gray-200 relative flex-shrink-0 overflow-hidden ${className}`} title={member.name}>
                    {content}
                </div>
            );
        };

        const FlagPriority = ({ level, onClick }) => {
            const colors = { 
                high: "text-red-500 hover:text-red-600", 
                medium: "text-amber-500 hover:text-amber-600", 
                low: "text-emerald-500 hover:text-emerald-600" 
            };
            return (
                <button 
                    onClick={(e) => { e.stopPropagation(); onClick && onClick(); }} 
                    className={`transition-transform hover:scale-110 ${colors[level] || colors.low}`}
                    title="Alterar Prioridade"
                >
                    <Flag size={16} fill="currentColor"/>
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-lg", hideHeader = false, fullScreen = false }) => {
            if (!isOpen) return null;
            const content = (
                <div className={`bg-white ${fullScreen ? 'fixed inset-0 z-[100] flex flex-col' : `rounded-2xl shadow-2xl w-full ${maxWidth} max-h-[90vh] overflow-hidden flex flex-col bg-white relative z-[100]`}`}>
                    {!hideHeader && (
                        <div className="p-4 border-b bg-[#1e1b4b] text-white flex justify-between items-center shrink-0">
                            <h3 className="font-bold">{title}</h3>
                            <button onClick={onClose}><X size={20}/></button>
                        </div>
                    )}
                    {hideHeader && <button onClick={onClose} className="absolute top-4 right-4 z-50 p-2 bg-black/10 hover:bg-black/20 rounded-full text-white"><X size={20}/></button>}
                    <div className="p-0 overflow-y-auto flex-1 bg-white relative">{children}</div>
                </div>
            );
            return createPortal(
                <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-in">{content}</div>,
                document.body
            );
        };

        // --- Notification Center ---
        const NotificationCenter = ({ isOpen, onClose, notifications, markRead }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed top-16 right-6 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 z-[200] animate-in overflow-hidden">
                    <div className="bg-[#1e1b4b] text-white p-3 font-bold text-sm flex justify-between items-center">
                        <div className="flex items-center gap-2"><Bell size={16}/> Notificações</div>
                        <button onClick={onClose}><X size={16}/></button>
                    </div>
                    <div className="max-h-80 overflow-y-auto bg-gray-50 p-2 space-y-2">
                        {notifications.length === 0 ? (
                            <div className="text-center text-gray-400 py-6 text-xs">Nenhuma notificação não lida.</div>
                        ) : (
                            notifications.map((notif, idx) => (
                                <div key={idx} className="bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex gap-3 relative group">
                                    <div className={`mt-1 w-2 h-2 rounded-full flex-shrink-0 ${notif.type === 'deadline' ? 'bg-red-500' : 'bg-blue-500'}`}></div>
                                    <div className="flex-1">
                                        <p className="text-xs font-bold text-gray-800">{notif.title}</p>
                                        <p className="text-[10px] text-gray-500 mt-1">{notif.message}</p>
                                        <p className="text-[9px] text-gray-400 mt-1">{notif.context}</p>
                                    </div>
                                    <button onClick={(e) => { e.stopPropagation(); markRead(notif.id); }} className="absolute top-2 right-2 text-gray-300 hover:text-blue-600" title="Marcar como lida"><Check size={14}/></button>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // --- AI Assistant ---
        // (Mantido igual ao anterior, código omitido para brevidade, mas incluído no final)
        const AIAssistant = ({ isOpen, onClose, context, apiKey }) => {
            // ... (implementação padrão do assistente)
             const [messages, setMessages] = useState([{ sender: 'ai', text: "Olá! Eu sou o assistente de IA do Event Hub. Como posso ajudar com a sua gestão de eventos hoje?" }]);
            const [input, setInput] = useState("");
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, isTyping]);

            const callGeminiAPI = async (prompt) => {
                if (!apiKey) return null;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Você é um assistente de gestão de eventos. Responda de forma concisa e útil em português.` }] }] })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) { console.error("Gemini API Error", error); return null; }
            };

            const processQuery = async (text) => {
                const userMsg = { sender: 'user', text };
                setMessages(prev => [...prev, userMsg]);
                setIsTyping(true);
                let responseText = "Desculpe, não consegui entender o contexto.";
                const aiResponse = await callGeminiAPI(text);
                if (aiResponse) responseText = aiResponse; else responseText = "Sem resposta da IA.";
                setMessages(prev => [...prev, { sender: 'ai', text: responseText }]);
                setIsTyping(false);
            };

            const handleSend = async () => { if(!input.trim()) return; const txt = input; setInput(""); await processQuery(txt); };

            if(!isOpen) return null;

            return (
                <div className="fixed bottom-24 right-6 w-80 md:w-96 h-[500px] bg-white rounded-2xl shadow-2xl z-[200] flex flex-col border border-gray-200 animate-in overflow-hidden">
                    <div className="p-4 bg-gradient-to-r from-blue-600 to-indigo-700 text-white flex justify-between items-center"><div className="flex items-center gap-2"><Sparkles size={18}/> <span className="font-bold">Assistente IA</span></div><button onClick={onClose}><X size={18}/></button></div>
                    <div className="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50">{messages.map((m, i) => (<div key={i} className={`flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[85%] p-3 rounded-xl text-sm ${m.sender === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-gray-200 text-gray-700 rounded-tl-none shadow-sm'}`} style={{whiteSpace: 'pre-wrap'}}>{m.text}</div></div>))}{isTyping && <div className="flex justify-start"><div className="bg-white border border-gray-100 p-3 rounded-xl rounded-tl-none shadow-sm flex gap-1"><div className="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div></div></div>}<div ref={messagesEndRef}></div></div>
                    <div className="p-3 bg-white border-t flex gap-2"><input className="flex-1 bg-gray-100 border-none outline-none rounded-lg px-3 py-2 text-sm" placeholder="Digite sua pergunta..." value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSend()}/><button onClick={handleSend} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"><Send size={18}/></button></div>
                </div>
            );
        };

        // --- Agenda Component ---
        // (Mantido igual)
        const AgendaComponent = ({ agendaItems, onAdd, onDelete, onUpdate, readOnly = false, contextTitle = "Agenda", selectedDateFilter, events, scrollable = true }) => {
             const [newItem, setNewItem] = useState({ title: '', date: '', color: 'blue', eventId: '' });
            const [isAdding, setIsAdding] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const filteredItems = selectedDateFilter ? agendaItems.filter(item => item.date === selectedDateFilter) : agendaItems;
            const sortedItems = [...filteredItems].sort((a,b) => new Date(a.date) - new Date(b.date));
            const handleSave = () => { if(!newItem.title) return; const dateToAdd = newItem.date || selectedDateFilter || new Date().toISOString().split('T')[0]; if (editItem) { onUpdate(editItem.id, { ...newItem, date: dateToAdd }); setEditItem(null); } else { onAdd({ ...newItem, id: Date.now(), date: dateToAdd }); } setNewItem({ title: '', date: '', color: 'blue', eventId: '' }); setIsAdding(false); };
            const startEdit = (item) => { setNewItem({ title: item.title, date: item.date, color: item.color, eventId: item.eventId || '' }); setEditItem(item); setIsAdding(true); };
            return (
                <div className="flex flex-col h-full bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                    <div className="p-4 border-b bg-gray-50/50 flex justify-between items-center"><h3 className="font-bold text-gray-800 flex items-center gap-2"><CalendarIcon size={16} className="text-blue-600"/> {selectedDateFilter ? new Date(selectedDateFilter).toLocaleDateString('pt-BR') : contextTitle}</h3>{!readOnly && <button onClick={() => { setNewItem(prev => ({...prev, date: selectedDateFilter || prev.date})); setIsAdding(!isAdding); setEditItem(null); }} className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition-colors">{isAdding ? 'Cancelar' : '+ Adicionar'}</button>}</div>
                    {isAdding && (<div className="p-3 bg-blue-50/50 border-b border-blue-100 animate-in space-y-2"><input className="w-full p-2 text-xs border rounded bg-white" placeholder="Título..." value={newItem.title} onChange={e=>setNewItem({...newItem, title: e.target.value})} autoFocus/><div className="flex gap-2"><input type="date" className="flex-1 p-2 text-xs border rounded bg-white" value={newItem.date} onChange={e=>setNewItem({...newItem, date: e.target.value})}/>{events && <select className="flex-1 p-2 text-xs border rounded bg-white" value={newItem.eventId} onChange={e=>setNewItem({...newItem, eventId: e.target.value})}><option value="">Opcional: Evento</option>{events.map(ev => <option key={ev.id} value={ev.id}>{ev.title}</option>)}</select>}</div><div className="flex gap-1 items-center">{AGENDA_COLORS.map(c => (<button key={c.id} onClick={()=>setNewItem({...newItem, color: c.id})} className={`w-5 h-5 rounded-full ${c.bg} border ${newItem.color === c.id ? 'border-gray-500 scale-110' : 'border-transparent'}`}></button>))}</div><button onClick={handleSave} className="w-full bg-blue-600 text-white px-3 rounded text-xs font-bold py-1">Salvar</button></div>)}
                    <div className={`flex-1 p-2 space-y-2 ${scrollable ? 'overflow-y-auto max-h-[300px]' : ''}`}>{sortedItems.length === 0 && <p className="text-center text-gray-400 text-xs py-4">Nenhum item.</p>}{sortedItems.map(item => { const color = AGENDA_COLORS.find(c => c.id === item.color) || AGENDA_COLORS[0]; const [y, m, d] = item.date.split('-'); return (<div key={item.id} className="group flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 border border-transparent hover:border-gray-100 transition-all"><div className={`flex-shrink-0 w-12 h-12 rounded-lg ${color.bg} flex flex-col items-center justify-center text-[10px] font-bold ${color.text}`}><span>{d}</span></div><div className="flex-1 min-w-0"><p className="text-xs font-bold text-gray-800 truncate">{item.title}</p>{item.eventName && <p className="text-[9px] text-gray-400 truncate">{item.eventName}</p>}</div>{!readOnly && <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => startEdit(item)} className="text-gray-300 hover:text-blue-500"><Edit2 size={14}/></button><button onClick={() => onDelete(item.id)} className="text-gray-300 hover:text-red-500"><Trash2 size={14}/></button></div>}</div>)})}</div>
                </div>
            );
        };

        // --- Modals ---
        const WorkloadDetailModal = ({ isOpen, onClose, member, memberTasks, allMembers, onUpdateTask, onTransferTask }) => {
            const [targetMember, setTargetMember] = useState('');
            const [transferReason, setTransferReason] = useState('');
            const [isTransferring, setIsTransferring] = useState(false);

            if (!isOpen || !member) return null;

            const handleTransfer = () => {
                if(!targetMember || !transferReason) { alert("Selecione o destino e informe o motivo."); return; }
                const target = allMembers.find(m => m.id === targetMember);
                if (onTransferTask) {
                    onTransferTask(memberTasks, target, transferReason);
                }
                setIsTransferring(false);
                setTargetMember('');
                setTransferReason('');
                onClose();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Carga de Trabalho: ${member.name}`}>
                    <div className="p-6">
                        <div className="flex items-center gap-4 mb-6 p-4 bg-gray-50 rounded-xl border border-gray-100">
                            <div className="w-16 h-16 rounded-full overflow-hidden border-2 border-white shadow-md"><Avatar member={member} size="w-full h-full"/></div>
                            <div><h3 className="font-bold text-lg text-gray-900">{member.name}</h3><p className="text-sm text-gray-500">{member.role}</p><span className="inline-block mt-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-bold">{memberTasks.length} Tarefas Ativas</span></div>
                        </div>
                        
                        <div className="mb-4">
                            <button onClick={() => setIsTransferring(!isTransferring)} className="text-xs font-bold text-blue-600 underline">Transferir Responsabilidade</button>
                            {isTransferring && (
                                <div className="mt-2 bg-blue-50 p-3 rounded-lg border border-blue-100 space-y-2 animate-in">
                                    <label className="text-[10px] font-bold uppercase text-gray-500">Transferir todas tarefas para:</label>
                                    <select className="w-full p-2 text-sm border rounded" value={targetMember} onChange={e=>setTargetMember(e.target.value)}>
                                        <option value="">Selecione...</option>
                                        {allMembers.filter(m => m.id !== member.id).map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                    </select>
                                    <input className="w-full p-2 text-sm border rounded" placeholder="Motivo da transferência..." value={transferReason} onChange={e=>setTransferReason(e.target.value)}/>
                                    <button onClick={handleTransfer} className="w-full bg-blue-600 text-white p-2 rounded text-xs font-bold">Confirmar Transferência</button>
                                </div>
                            )}
                        </div>

                        <div className="space-y-2 max-h-60 overflow-y-auto pr-2">{memberTasks.map(t => (<div key={t.id} className="p-3 border border-gray-100 rounded-xl flex justify-between items-center bg-white hover:shadow-sm transition-all group"><span className="text-sm font-medium text-gray-700 truncate flex-1 pr-4">{t.text}</span></div>))}</div>
                    </div>
                </Modal>
            );
        };

        const ManageCategoriesModal = ({ isOpen, onClose, categories, onUpdateCategories, members }) => {
            // (Mantido igual, apenas garantindo que members seja passado para selecionar responsavel)
            const [cats, setCats] = useState(categories);
            const [newCat, setNewCat] = useState({ title: '', color: 'blue', icon: 'box', phases: ['pre', 'during', 'post'], responsibleId: '', supportIds: [] });
            const [editingId, setEditingId] = useState(null);
            useEffect(() => { setCats(categories); }, [categories]);
            const handleUpdate = (id, field, val) => { setCats(prev => prev.map(c => c.id === id ? { ...c, [field]: val } : c)); };
            const handleDelete = (id) => { if (confirm("Tem a certeza?")) setCats(prev => prev.filter(c => c.id !== id)); };
            const handleAdd = () => { if (!newCat.title.trim()) return; setCats(prev => [...prev, { id: Date.now().toString(), ...newCat }]); setNewCat({ title: '', color: 'blue', icon: 'box', phases: ['pre', 'during', 'post'], responsibleId: '', supportIds: [] }); };
            const save = () => { onUpdateCategories(cats); onClose(); };
            const togglePhase = (phase) => { if(newCat.phases.includes(phase)) setNewCat({...newCat, phases: newCat.phases.filter(p => p !== phase)}); else setNewCat({...newCat, phases: [...newCat.phases, phase]}); };
            const toggleEditPhase = (id, phase) => { const cat = cats.find(c => c.id === id); if(!cat) return; const currentPhases = cat.phases || ['pre', 'during', 'post']; let newPhases; if(currentPhases.includes(phase)) newPhases = currentPhases.filter(p => p !== phase); else newPhases = [...currentPhases, phase]; handleUpdate(id, 'phases', newPhases); };
            const toggleSupport = (id, memberId) => { const cat = cats.find(c => c.id === id); if(!cat) return; const currentSupport = cat.supportIds || []; let newSupport; if(currentSupport.includes(memberId)) newSupport = currentSupport.filter(mid => mid !== memberId); else newSupport = [...currentSupport, memberId]; handleUpdate(id, 'supportIds', newSupport); }

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Ajustes de Categorias">
                    <div className="p-6">
                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6"><h4 className="text-xs font-bold text-blue-800 uppercase mb-3">Nova Categoria</h4><div className="flex flex-col gap-3"><input className="w-full p-2 border rounded-lg text-sm bg-white" placeholder="Nome da Categoria..." value={newCat.title} onChange={e=>setNewCat({...newCat, title: e.target.value})}/><div><span className="text-[10px] font-bold text-gray-500 uppercase block mb-1">Aparece em:</span><div className="flex gap-2">{['pre', 'during', 'post'].map(phase => (<label key={phase} className={`flex items-center gap-1.5 px-2 py-1 rounded text-xs border cursor-pointer select-none ${newCat.phases.includes(phase) ? 'bg-blue-100 border-blue-300 text-blue-800' : 'bg-white border-gray-200 text-gray-500'}`}><input type="checkbox" className="hidden" checked={newCat.phases.includes(phase)} onChange={() => togglePhase(phase)}/>{phase === 'pre' ? 'Pré-Evento' : phase === 'during' ? 'Durante' : 'Pós-Evento'}</label>))}</div></div><div className="flex gap-2 items-center"><span className="text-[10px] font-bold text-gray-500 uppercase">Cor:</span>{PASTEL_COLORS.map(c => (<button key={c.id} onClick={() => setNewCat({...newCat, color: c.id})} className={`w-6 h-6 rounded-full ${c.bg} border-2 ${newCat.color === c.id ? 'border-gray-600 scale-110' : 'border-transparent'}`}></button>))}</div><button onClick={handleAdd} className="w-full bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-bold mt-2">Adicionar</button></div></div>
                        <div className="space-y-3 max-h-[40vh] overflow-y-auto pr-2">{cats.map(cat => (<div key={cat.id} className="bg-white p-3 rounded-xl border border-gray-200"><div className="flex items-center justify-between"><div className="flex items-center gap-3"><div className={`p-2 rounded-lg bg-${cat.color}-100 text-${cat.color}-700`}>{React.createElement(ICON_MAP[cat.icon] || Box, { size: 18 })}</div>{editingId === cat.id ? (<input className="font-bold text-sm bg-gray-50 border rounded px-1" value={cat.title} onChange={e=>handleUpdate(cat.id, 'title', e.target.value)} />) : (<span className="font-bold text-sm text-gray-800">{cat.title}</span>)}</div><div className="flex gap-1"><button onClick={() => setEditingId(editingId === cat.id ? null : cat.id)} className={`p-1.5 rounded ${editingId === cat.id ? 'text-green-600 bg-green-50' : 'text-gray-400 hover:text-blue-500'}`}>{editingId === cat.id ? <Check size={16}/> : <Edit2 size={16}/>}</button><button onClick={() => handleDelete(cat.id)} className="p-1.5 text-gray-400 hover:text-red-500"><Trash2 size={16}/></button></div></div>{editingId === cat.id && (<div className="mt-3 pt-3 border-t border-gray-100 space-y-3 animate-in"><div><span className="text-[10px] font-bold text-gray-400 uppercase block mb-1">Aparece em:</span><div className="flex gap-2">{['pre', 'during', 'post'].map(phase => (<label key={phase} className={`flex items-center gap-1.5 px-2 py-1 rounded text-xs border cursor-pointer select-none ${(cat.phases || ['pre', 'during', 'post']).includes(phase) ? 'bg-blue-100 border-blue-300 text-blue-800' : 'bg-gray-50 border-gray-200 text-gray-400'}`}><input type="checkbox" className="hidden" checked={(cat.phases || ['pre', 'during', 'post']).includes(phase)} onChange={() => toggleEditPhase(cat.id, phase)}/>{phase === 'pre' ? 'Pré' : phase === 'during' ? 'Durante' : 'Pós'}</label>))}</div></div><div className="grid grid-cols-2 gap-3"><div><span className="text-[10px] font-bold text-gray-400 uppercase block mb-1">Responsável:</span><select className="w-full p-1 text-xs border rounded" value={cat.responsibleId || ''} onChange={e => handleUpdate(cat.id, 'responsibleId', e.target.value)}><option value="">Nenhum</option>{members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}</select></div><div><span className="text-[10px] font-bold text-gray-400 uppercase block mb-1">Apoio:</span><div className="flex flex-wrap gap-1">{members.map(m => (<button key={m.id} onClick={() => toggleSupport(cat.id, m.id)} className={`p-1 rounded-full border ${cat.supportIds?.includes(m.id) ? 'border-blue-500 opacity-100' : 'border-gray-200 opacity-40'}`}><Avatar member={m} size="w-5 h-5"/></button>))}</div></div></div><div className="flex gap-2 items-center"><span className="text-[10px] font-bold text-gray-400 uppercase">Cor:</span>{PASTEL_COLORS.map(c => (<button key={c.id} onClick={() => handleUpdate(cat.id, 'color', c.id)} className={`w-5 h-5 rounded-full ${c.bg} border-2 ${cat.color === c.id ? 'border-gray-600 scale-110' : 'border-transparent'}`}></button>))}</div></div>)}</div>))}</div>
                        <div className="mt-6 flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 text-gray-500 text-sm font-bold">Cancelar</button><button onClick={save} className="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">Concluir</button></div>
                    </div>
                </Modal>
            );
        };

        const SettingsModal = ({ isOpen, onClose, members, onUpdateMember, onAddMember, onUpdateLogo, currentLogo, managerId, onUpdateManager, onUpdateGeminiKey, onDeleteMember }) => {
            const [isLocked, setIsLocked] = useState(true);
            const [password, setPassword] = useState('');
            const [apiKey, setApiKey] = useState('');
            const logoInputRef = useRef(null);
            const memberPhotoInputRef = useRef(null);
            const [newMemberName, setNewMemberName] = useState('');
            const [newMemberRole, setNewMemberRole] = useState('Marketing');
            const [newMemberPhoto, setNewMemberPhoto] = useState(null);
            const [editingMemberId, setEditingMemberId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editRole, setEditRole] = useState('');

            const handleLogoUpload = async (e) => { if(e.target.files[0]) { const url = await compressImage(e.target.files[0], 200); onUpdateLogo(url); } };
            const handleNewMemberPhoto = async (e) => { if(e.target.files[0]) { const url = await compressImage(e.target.files[0], 150); setNewMemberPhoto(url); } };
            const handleAddMemberAction = () => { if(!newMemberName) return; onAddMember({ id: Date.now().toString(), name: newMemberName, role: newMemberRole, photoUrl: newMemberPhoto }); setNewMemberName(''); setNewMemberPhoto(null); };
            const handleMemberPhotoUpdate = async (e, memberId) => { if(e.target.files[0]) { const url = await compressImage(e.target.files[0], 150); onUpdateMember(memberId, { photoUrl: url }); } };
            
            const startEditingMember = (member) => { setEditingMemberId(member.id); setEditName(member.name); setEditRole(member.role); };
            const saveMember = () => { onUpdateMember(editingMemberId, { name: editName, role: editRole }); setEditingMemberId(null); };
            const manager = members.find(m => m.id === managerId) || members[0];
            const handleSaveKey = () => { onUpdateGeminiKey(apiKey); alert("Chave API salva!"); };

            const handleUnlock = () => {
                if (password === '1234') { 
                    setIsLocked(false);
                } else {
                    alert("Senha incorreta");
                }
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Ajustes" maxWidth="max-w-2xl">
                    {isLocked ? (
                        <div className="flex flex-col items-center justify-center p-12 space-y-6">
                            <div className="relative">
                                <div className="animate-pulse absolute inset-0 bg-red-100 rounded-full opacity-50 blur-xl"></div>
                                <Lock size={64} className="text-red-500 relative z-10 animate-pulse" />
                            </div>
                            <h3 className="text-xl font-bold text-gray-800">Acesso Restrito ao Gestor</h3>
                            <div className="flex gap-2 w-full max-w-xs">
                                <input type="password" className="flex-1 p-2 border rounded-lg" placeholder="Senha" value={password} onChange={e=>setPassword(e.target.value)} onKeyDown={e=>e.key==='Enter' && handleUnlock()}/>
                                <button onClick={handleUnlock} className="bg-red-500 text-white px-4 py-2 rounded-lg font-bold">Desbloquear</button>
                            </div>
                        </div>
                    ) : (
                        <div className="p-6 space-y-8 animate-in">
                            <section><h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Sparkles size={16} className="text-blue-600"/> Chave API Gemini (IA)</h4><div className="bg-gray-50 p-4 rounded-xl border border-gray-200"><p className="text-xs text-gray-500 mb-3">Para ativar a IA, insira sua chave da Google AI Studio aqui.</p><div className="flex gap-2"><input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} className="flex-1 p-2 text-sm border rounded-lg outline-none focus:border-blue-500" placeholder="AIza..."/><button onClick={handleSaveKey} className="bg-blue-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-800">Salvar</button></div></div></section>
                            <section><h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><ImageIcon size={16} className="text-blue-600"/> Identidade Visual</h4><div className="flex items-center gap-4"><div className="w-20 h-20 rounded-xl border border-dashed border-gray-300 flex items-center justify-center overflow-hidden bg-transparent relative">{currentLogo ? <img src={currentLogo} className="w-full h-full object-contain"/> : <span className="text-xs text-gray-400">Logo</span>}</div><div><p className="text-sm font-bold text-gray-800 mb-1">Carregar logo</p><button onClick={() => logoInputRef.current.click()} className="text-xs bg-white border border-gray-300 px-3 py-1.5 rounded-lg font-medium hover:bg-gray-50">Escolher arquivo</button><input type="file" ref={logoInputRef} className="hidden" accept="image/*" onChange={handleLogoUpload}/></div></div></section>
                            <section>
                                <h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Crown size={16} className="text-amber-500"/> Gestor da Equipe</h4>
                                <div className="bg-white p-3 border rounded-xl flex items-center justify-between gap-3">
                                    <div className="flex items-center gap-3">
                                        <Avatar member={manager}/> 
                                        <div><p className="text-sm font-bold">{manager?.name}</p><p className="text-xs text-gray-500">Líder / Admin</p></div>
                                    </div>
                                    <select className="text-xs p-1 border rounded" value={managerId} onChange={(e) => onUpdateManager(e.target.value)}>
                                        {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                    </select>
                                </div>
                            </section>
                            <section><h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Users size={16} className="text-blue-600"/> Equipe Global</h4><div className="space-y-3 mb-4">{members.map(m => (<div key={m.id} className="flex justify-between items-center bg-white p-3 border rounded-xl"><div className="flex items-center gap-3"><div className="relative group cursor-pointer"><Avatar member={m}/><div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white"><Camera size={12}/></div><input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={(e) => handleMemberPhotoUpdate(e, m.id)}/></div><div>{editingMemberId === m.id ? <div className="flex flex-col gap-1"><input className="border p-1 text-sm rounded" value={editName} onChange={e=>setEditName(e.target.value)}/><input className="border p-1 text-xs rounded" value={editRole} onChange={e=>setEditRole(e.target.value)}/></div> : <div><p className="text-sm font-bold text-gray-800">{m.name}</p><p className="text-xs text-gray-500">{m.role}</p></div>}</div></div><div className="flex gap-2">{editingMemberId === m.id ? <button onClick={saveMember} className="text-green-600"><Check size={16}/></button> : <button onClick={() => startEditingMember(m)} className="text-gray-400 hover:text-blue-500"><Edit2 size={16}/></button>}<button onClick={() => onDeleteMember && onDeleteMember(m.id)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button></div></div>))}</div><div className="bg-gray-50 p-4 rounded-xl border border-gray-200"><h5 className="text-xs font-bold uppercase text-gray-500 mb-3">Novo Membro</h5><div className="flex gap-3 items-end"><div className="flex flex-col items-center gap-2"><div className="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center cursor-pointer hover:bg-gray-300 overflow-hidden" onClick={() => memberPhotoInputRef.current.click()}>{newMemberPhoto ? <img src={newMemberPhoto} className="w-full h-full object-cover"/> : <Camera size={16} className="text-gray-500"/>}</div><span className="text-[9px] text-gray-500">Carregar Foto</span><input type="file" ref={memberPhotoInputRef} className="hidden" accept="image/*" onChange={handleNewMemberPhoto}/></div><div className="flex-1 space-y-2"><input className="w-full p-2 text-sm border rounded-lg" placeholder="Nome" value={newMemberName} onChange={e=>setNewMemberName(e.target.value)}/><input className="w-full p-2 text-sm border rounded-lg" placeholder="Cargo (Ex: Marketing)" value={newMemberRole} onChange={e=>setNewMemberRole(e.target.value)}/></div></div><button onClick={handleAddMemberAction} className="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg text-sm font-bold">Adicionar Membro</button></div></section>
                        </div>
                    )}
                </Modal>
            );
        };

        const NewEventModal = ({ isOpen, onClose, onCreate, members }) => {
            // (Mesmo código anterior)
            const [title, setTitle] = useState('');
            const [location, setLocation] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [isSingleDay, setIsSingleDay] = useState(false);
            const [responsible, setResponsible] = useState('');
            const [team, setTeam] = useState([]);
            const [selectedOptionalTasks, setSelectedOptionalTasks] = useState([]);
            useEffect(() => { if (isSingleDay) setEndDate(startDate); }, [isSingleDay, startDate]);
            if (!isOpen) return null;
            const toggleTask = (taskId) => { if (selectedOptionalTasks.includes(taskId)) setSelectedOptionalTasks(prev => prev.filter(id => id !== taskId)); else setSelectedOptionalTasks(prev => [...prev, taskId]); };
            const toggleTeamMember = (memberId) => { if (team.includes(memberId)) setTeam(prev => prev.filter(id => id !== memberId)); else setTeam(prev => [...prev, memberId]); };
            const handleSubmit = () => {
                if (!title || !startDate || !responsible) { alert("Preencha Nome, Data e Responsável."); return; }
                const initialTasksToCreate = OPTIONAL_STARTUP_TASKS.filter(t => selectedOptionalTasks.includes(t.id)).map(t => ({ 
                    id: Date.now() + Math.random(), // Unique IDs
                    text: t.text, category: t.category, phase: t.phase, priority: 'medium', status: 'planning', cost: 0, responsible: members.find(m => m.id === responsible) || null, messages: [], support: [], subtasks: [], createdAt: new Date().toISOString()
                }));
                const formatDate = (d) => { if (!d) return ''; const [y, m, day] = d.split('-'); return `${day}/${m}/${y}`; }
                const dateRange = isSingleDay || !endDate ? formatDate(startDate) : `${formatDate(startDate)} - ${formatDate(endDate)}`;
                onCreate({ id: Date.now().toString(), title, location: location || 'Local a definir', startDate, endDate: isSingleDay ? startDate : endDate, dateRange, responsibleId: responsible, teamIds: team, categories: DEFAULT_CATEGORIES, agenda: [], driveLink: '' }, initialTasksToCreate);
                onClose(); 
            };
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Novo Evento" hideHeader={true} maxWidth="max-w-3xl">
                    <div className="bg-gradient-to-r from-blue-900 via-indigo-800 to-purple-900 p-8 text-white relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10 transform translate-x-4 -translate-y-4"><Rocket size={120} /></div><h2 className="text-3xl font-extrabold mb-2 flex items-center gap-3 relative z-10"><Sparkles className="text-amber-400 animate-pulse" /> Criar Novo Evento</h2><p className="text-blue-100 text-sm max-w-md relative z-10 opacity-90">Prepare o terreno para um evento inesquecível. Comece definindo os detalhes principais abaixo.</p></div>
                    <div className="p-8 space-y-6">
                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome do Evento *</label><input className="w-full p-4 border border-gray-200 rounded-xl bg-gray-50 text-sm outline-none focus:border-blue-500" placeholder="Ex: Lançamento 2026" value={title} onChange={e=>setTitle(e.target.value)} autoFocus/></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Local</label><input className="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-sm outline-none" placeholder="Cidade/Estado" value={location} onChange={e=>setLocation(e.target.value)}/></div>
                            <div className="space-y-3"><div className="flex items-center justify-between"><label className="block text-xs font-bold text-gray-500 uppercase">Início *</label><label className="flex items-center gap-2 text-xs font-bold text-blue-600 cursor-pointer"><input type="checkbox" checked={isSingleDay} onChange={e => setIsSingleDay(e.target.checked)}/> Dia único?</label></div><div className="flex gap-2"><input type="date" className="w-full p-3 border rounded-xl bg-gray-50 text-sm" value={startDate} onChange={e=>setStartDate(e.target.value)}/>{!isSingleDay && <input type="date" className="w-full p-3 border rounded-xl bg-gray-50 text-sm" value={endDate} onChange={e=>setEndDate(e.target.value)}/>}</div></div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2 border-t border-gray-100">
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Responsável *</label><div className="space-y-2 max-h-40 overflow-y-auto">{members.map(m => (<div key={m.id} onClick={() => setResponsible(m.id)} className={`flex items-center gap-3 p-2 rounded-lg cursor-pointer border transition-all ${responsible === m.id ? 'bg-blue-50 border-blue-500' : 'bg-white border-gray-100 hover:bg-gray-50'}`}><Avatar member={m} size="w-8 h-8"/><span className="text-xs font-bold flex-1">{m.name}</span>{responsible === m.id && <Check size={14} className="text-blue-600"/>}</div>))}</div></div>
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Equipe</label><div className="flex flex-wrap gap-2">{members.filter(m => m.id !== responsible).map(m => (<button key={m.id} onClick={() => toggleTeamMember(m.id)} className={`flex items-center gap-2 p-1.5 rounded-lg border text-xs ${team.includes(m.id) ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-gray-200'}`}><Avatar member={m} size="w-5 h-5"/> {m.name}</button>))}</div></div>
                        </div>
                        <div className="pt-2 border-t border-gray-100"><label className="block text-xs font-bold text-gray-500 uppercase mb-3">Tarefas Iniciais (Opcional)</label><div className="bg-gray-50 border border-gray-200 rounded-xl p-4 max-h-40 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-3">{OPTIONAL_STARTUP_TASKS.map(task => (<label key={task.id} className={`flex items-center gap-2 p-2 rounded-lg border cursor-pointer transition-all ${selectedOptionalTasks.includes(task.id) ? 'bg-white border-blue-300 shadow-sm' : 'border-transparent'}`}><input type="checkbox" className="rounded text-blue-600" checked={selectedOptionalTasks.includes(task.id)} onChange={() => toggleTask(task.id)}/><span className="text-xs text-gray-700">{task.text}</span></label>))}</div></div>
                        <button onClick={handleSubmit} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl font-bold hover:shadow-lg animate-shine bg-[length:200%_auto]">Criar Evento</button>
                    </div>
                </Modal>
            );
        };

        const EditEventModal = ({ isOpen, onClose, event, onUpdate, onDelete, members }) => {
            const [title, setTitle] = useState(event?.title || '');
            const [startDate, setStartDate] = useState(event?.startDate || '');
            const [endDate, setEndDate] = useState(event?.endDate || ''); 
            const [location, setLocation] = useState(event?.location || ''); 
            const [cover, setCover] = useState(event?.coverUrl || '');
            const [responsible, setResponsible] = useState(event?.responsibleId || '');
            const [driveLink, setDriveLink] = useState(event?.driveLink || '');
            const fileInputRef = useRef(null);

            useEffect(() => {
                if(event) { 
                    setTitle(event.title || ''); 
                    setStartDate(event.startDate || ''); 
                    setEndDate(event.endDate || ''); 
                    setLocation(event.location || ''); 
                    setCover(event.coverUrl || ''); 
                    setResponsible(event.responsibleId || '');
                    setDriveLink(event.driveLink || '');
                }
            }, [event]);

            if(!isOpen || !event) return null;

            const handleSave = () => { 
                onUpdate(event.id, { title, startDate, endDate, location, coverUrl: cover, responsibleId: responsible, driveLink }); 
                onClose(); 
            };
            const handleCoverUpload = async (e) => { if(e.target.files[0]) { const url = await compressImage(e.target.files[0], 800); setCover(url); } };

            const getLocalDaysLeft = () => {
                if (!startDate) return 0;
                const [year, month, day] = startDate.split('-').map(Number);
                const target = new Date(year, month - 1, day);
                const today = new Date();
                today.setHours(0,0,0,0);
                const diff = target - today;
                return Math.ceil(diff / (86400000));
            };
            const daysLeft = getLocalDaysLeft();
            const daysLeftText = daysLeft < 0 ? `Terminou há ${Math.abs(daysLeft)} dias` : daysLeft === 0 ? "É hoje!" : `Faltam ${daysLeft} dias`;
            const formatDate = (d) => { if (!d) return ''; const [y, m, day] = d.split('-'); return `${day}/${m}/${y}`; };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Editar Evento">
                    <div className={`mb-4 p-3 rounded-xl text-center flex flex-col gap-1 ${daysLeft < 0 ? 'bg-gray-100 text-gray-600' : 'bg-blue-50 text-blue-700'}`}>
                        <span className="text-lg font-bold">{daysLeftText}</span>
                        <span className="text-xs font-normal opacity-80">
                            {formatDate(startDate)} {endDate && endDate !== startDate ? ` - ${formatDate(endDate)}` : ''}
                            {location ? ` • ${location}` : ''}
                        </span>
                    </div>
                    <div className="space-y-4">
                        <div onClick={()=>fileInputRef.current.click()} className="h-32 bg-gray-100 rounded-xl flex items-center justify-center cursor-pointer overflow-hidden relative group border border-gray-200">
                            {cover ? <img src={cover} className="w-full h-full object-cover"/> : <span className="text-gray-400 font-bold">Alterar Capa</span>}
                            <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white font-bold"><Camera size={24}/></div>
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleCoverUpload}/>
                        </div>
                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome do Evento</label><input className="w-full p-3 border rounded-xl font-bold text-gray-800" placeholder="Nome" value={title} onChange={e=>setTitle(e.target.value)}/></div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Início</label><input type="date" className="w-full p-3 border rounded-xl text-sm" value={startDate} onChange={e=>setStartDate(e.target.value)}/></div>
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Fim</label><input type="date" className="w-full p-3 border rounded-xl text-sm" value={endDate} onChange={e=>setEndDate(e.target.value)}/></div>
                        </div>
                         <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Localização</label><input className="w-full p-3 border rounded-xl text-sm" placeholder="Ex: São Paulo, SP" value={location} onChange={e=>setLocation(e.target.value)}/></div>
                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Link Pasta Google Drive</label><input className="w-full p-3 border rounded-xl text-sm" placeholder="https://drive.google.com..." value={driveLink} onChange={e=>setDriveLink(e.target.value)}/></div>
                         <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Responsável</label><select className="w-full p-3 border rounded-xl bg-white text-sm" value={responsible} onChange={(e) => setResponsible(e.target.value)}><option value="">Selecione...</option>{members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}</select></div>
                        <div className="flex gap-2 pt-2"><button onClick={handleSave} className="flex-1 bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition-colors">Salvar</button>{onDelete && (<button onClick={() => onDelete(event.id)} className="bg-red-50 text-red-600 p-3 rounded-xl font-bold hover:bg-red-100 transition-colors" title="Excluir Evento"><Trash2 size={20}/></button>)}</div>
                    </div>
                </Modal>
            );
        };

        const NewTaskModal = ({ isOpen, onClose, eventCategories, onCreate, members, eventId }) => {
            const [text, setText] = useState('');
            const [category, setCategory] = useState(eventCategories[0]?.id || '');
            const [phase, setPhase] = useState('pre');
            const [responsible, setResponsible] = useState('');
            const [support, setSupport] = useState([]);
            const [cost, setCost] = useState(0);

            if (!isOpen) return null;

            const handleCreate = () => {
                if (!text) return;
                onCreate({
                    id: Date.now(),
                    eventId,
                    text,
                    category,
                    phase,
                    responsible: members.find(m => m.id === responsible) || null,
                    support: support.map(id => members.find(m => m.id === id)).filter(Boolean),
                    status: 'planning',
                    priority: 'medium',
                    subtasks: [],
                    messages: [],
                    cost: Number(cost),
                    createdAt: new Date().toISOString()
                });
                setText(''); setResponsible(''); setSupport([]); setCost(0);
                onClose();
            };

            const toggleSupport = (id) => {
                if(support.includes(id)) setSupport(prev => prev.filter(s => s !== id));
                else setSupport(prev => [...prev, id]);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Nova Tarefa">
                    <div className="p-6 space-y-4">
                        <input className="w-full p-3 border rounded-xl" placeholder="Descrição da Tarefa" value={text} onChange={e=>setText(e.target.value)} autoFocus/>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-xs font-bold text-gray-500 uppercase">Categoria</label><select className="w-full p-2 border rounded-lg mt-1" value={category} onChange={e=>setCategory(e.target.value)}>{eventCategories.map(c=><option key={c.id} value={c.id}>{c.title}</option>)}</select></div>
                            <div><label className="text-xs font-bold text-gray-500 uppercase">Fase</label><select className="w-full p-2 border rounded-lg mt-1" value={phase} onChange={e=>setPhase(e.target.value)}><option value="pre">Pré-Evento</option><option value="during">Durante</option><option value="post">Pós-Evento</option></select></div>
                        </div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase">Custo Estimado (R$)</label><input type="number" className="w-full p-2 border rounded-lg mt-1" value={cost} onChange={e=>setCost(e.target.value)}/></div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase">Responsável (Opcional)</label><select className="w-full p-2 border rounded-lg mt-1" value={responsible} onChange={e=>setResponsible(e.target.value)}><option value="">Selecione...</option>{members.map(m=><option key={m.id} value={m.id}>{m.name}</option>)}</select></div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Apoio (Opcional)</label><div className="flex flex-wrap gap-2">{members.filter(m=>m.id!==responsible).map(m=><button key={m.id} onClick={()=>toggleSupport(m.id)} className={`p-1.5 rounded-full border-2 ${support.includes(m.id)?'border-blue-500':'border-transparent opacity-50'}`}><Avatar member={m} size="w-8 h-8"/></button>)}</div></div>
                        <button onClick={handleCreate} className="w-full bg-blue-600 text-white p-3 rounded-xl font-bold">Adicionar Tarefa</button>
                    </div>
                </Modal>
            );
        };

        const BottomNav = ({ activeTab, onChangeTab, onAdd }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-2 flex justify-between items-center z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <button onClick={() => onChangeTab('dashboard')} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'dashboard' ? 'text-blue-900' : 'text-gray-400'}`}><Home size={20} /><span className="text-[10px]">Início</span></button>
                <button onClick={() => onChangeTab('agenda')} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'agenda' ? 'text-blue-900' : 'text-gray-400'}`}><CalendarIcon size={20} /><span className="text-[10px]">Agenda</span></button>
                <div className="relative -top-6"><button onClick={onAdd} className="w-14 h-14 bg-gradient-to-r from-blue-900 to-blue-800 rounded-full shadow-lg flex items-center justify-center text-white"><Plus size={28} /></button></div>
                <button onClick={() => onChangeTab('team')} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'team' ? 'text-blue-900' : 'text-gray-400'}`}><Users size={20} /><span className="text-[10px]">Equipe</span></button>
                <button onClick={() => onChangeTab('settings')} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'settings' ? 'text-blue-900' : 'text-gray-400'}`}><Settings size={20} /><span className="text-[10px]">Ajustes</span></button>
            </div>
        );

        // --- Task Detail Modal Redesigned ---
        const TaskDetailModal = ({ isOpen, onClose, task, members, dbOperations, deleteTask }) => {
            const [messageText, setMessageText] = useState("");
            const [selectedSender, setSelectedSender] = useState(members[0]);
            const [chatAttachment, setChatAttachment] = useState(null);
            const [newSubtask, setNewSubtask] = useState("");
            const [showEmojis, setShowEmojis] = useState(false);
            const chatEndRef = useRef(null);
            const fileInputRef = useRef(null);

            const currentTask = task; 

            if (!isOpen || !currentTask) return null;

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [currentTask.messages]);

            const handleSendMessage = () => {
                if (!messageText.trim() && !chatAttachment) return;
                const newMessage = { id: Date.now(), senderId: selectedSender?.id || 'system', senderName: selectedSender?.name || 'Sistema', text: messageText, image: chatAttachment, timestamp: new Date().toISOString() };
                const updatedMessages = [...(currentTask.messages || []), newMessage];
                dbOperations.updateTask(currentTask.id, { messages: updatedMessages });
                setMessageText(""); setChatAttachment(null);
            };

            const handleDeleteMessage = (msgId) => { const updatedMessages = currentTask.messages.filter(m => m.id !== msgId); dbOperations.updateTask(currentTask.id, { messages: updatedMessages }); };
            const handleAddSubtask = () => { if (!newSubtask.trim()) return; const newSub = { id: Date.now(), text: newSubtask, completed: false }; const updatedSubtasks = [...(currentTask.subtasks || []), newSub]; dbOperations.updateTask(currentTask.id, { subtasks: updatedSubtasks }); setNewSubtask(""); };
            const toggleSubtask = (subId) => { const updatedSubtasks = currentTask.subtasks.map(s => s.id === subId ? { ...s, completed: !s.completed } : s); dbOperations.updateTask(currentTask.id, { subtasks: updatedSubtasks }); };
            const handleFileSelect = async (e) => { const file = e.target.files[0]; if (file) { const url = await compressImage(file, 400); setChatAttachment(url); } };
            const addEmoji = (emoji) => { setMessageText(prev => prev + emoji); setShowEmojis(false); };
            const toggleSupport = (memberId) => { const currentSupport = currentTask.support || []; const newSupport = currentSupport.some(m => m.id === memberId) ? currentSupport.filter(m => m.id !== memberId) : [...currentSupport, members.find(m => m.id === memberId)]; dbOperations.updateTask(currentTask.id, { support: newSupport }); };
            const handleDeleteTask = () => { if(confirm("Tem a certeza?")) { deleteTask(currentTask.id); onClose(); } };

            // Helper for operational details update
            const updateOpDetail = (field, val) => {
                dbOperations.updateTask(currentTask.id, { [`operationalDetails.${field}`]: val });
            };
             // Helper for tech specs
            const updateTechSpec = (field, val) => {
                dbOperations.updateTask(currentTask.id, { [`techSpecs.${field}`]: val });
            };

            const opDetails = currentTask.operationalDetails || {};
            const techSpecs = currentTask.techSpecs || {};

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Tarefa: ${currentTask.text}`} fullScreen={true}>
                    <div className="flex flex-col lg:flex-row h-full bg-[#F8FAFC]">
                        {/* LEFT COLUMN: Details */}
                        <div className="flex-1 p-6 overflow-y-auto space-y-6">
                            <div className="flex justify-between items-start">
                                <h2 className="text-2xl font-bold text-blue-950">{currentTask.text}</h2>
                                <button onClick={handleDeleteTask} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={20}/></button>
                            </div>

                            {/* Status Selector */}
                            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                <h3 className="text-xs font-bold text-gray-500 uppercase mb-3">Status</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    {STATUS_OPTIONS.map(s => (
                                        <button 
                                            key={s.id}
                                            onClick={() => dbOperations.updateTask(currentTask.id, { status: s.id })}
                                            className={`py-2 px-3 rounded-lg text-xs font-bold border transition-all ${currentTask.status === s.id ? s.color + ' ring-2 ring-offset-1 ring-blue-100' : 'bg-gray-50 text-gray-500 border-transparent hover:bg-gray-100'}`}
                                        >
                                            {s.label}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Operational Details */}
                            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-4">
                                <h3 className="text-sm font-bold text-blue-900 flex items-center gap-2"><ClipboardList size={16}/> Detalhes Operacionais</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label className="text-[10px] font-bold text-gray-500 uppercase">Quantidade</label><input className="w-full p-2 border rounded-lg mt-1 text-sm" value={opDetails.quantity || ''} onChange={e=>updateOpDetail('quantity', e.target.value)}/></div>
                                    <div><label className="text-[10px] font-bold text-gray-500 uppercase">Custo (R$)</label><input type="number" className="w-full p-2 border rounded-lg mt-1 text-sm font-bold text-emerald-600" value={currentTask.cost || ''} onChange={e=>dbOperations.updateTask(currentTask.id, { cost: parseFloat(e.target.value) || 0 })}/></div>
                                    <div><label className="text-[10px] font-bold text-gray-500 uppercase">Fornecedor</label><input className="w-full p-2 border rounded-lg mt-1 text-sm" value={opDetails.supplier || ''} onChange={e=>updateOpDetail('supplier', e.target.value)}/></div>
                                    <div><label className="text-[10px] font-bold text-gray-500 uppercase">ID Nimbi</label><input className="w-full p-2 border rounded-lg mt-1 text-sm" value={opDetails.nimbiId || ''} onChange={e=>updateOpDetail('nimbiId', e.target.value)}/></div>
                                    <div><label className="text-[10px] font-bold text-gray-500 uppercase">Entrega</label><input type="date" className="w-full p-2 border rounded-lg mt-1 text-sm" value={opDetails.deliveryDate || ''} onChange={e=>updateOpDetail('deliveryDate', e.target.value)}/></div>
                                </div>
                            </div>

                            {/* Tech Specs */}
                            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                <h3 className="text-sm font-bold text-blue-900 flex items-center gap-2 mb-3"><Zap size={16}/> Especificações Técnicas</h3>
                                <div className="flex gap-6">
                                    <label className="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer"><input type="checkbox" className="w-4 h-4 text-blue-600 rounded" checked={techSpecs.electric || false} onChange={e=>updateTechSpec('electric', e.target.checked)}/> Requer Elétrica</label>
                                    <label className="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer"><input type="checkbox" className="w-4 h-4 text-blue-600 rounded" checked={techSpecs.hydraulic || false} onChange={e=>updateTechSpec('hydraulic', e.target.checked)}/> Hidráulica</label>
                                </div>
                            </div>

                            {/* People */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Responsável</label>
                                    <select className="w-full p-2 border rounded-lg text-sm bg-gray-50" value={currentTask.responsible?.id || ''} onChange={(e) => dbOperations.updateTask(currentTask.id, { responsible: members.find(m => m.id === e.target.value) || null })}>
                                        <option value="">Selecione...</option>
                                        {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                    </select>
                                </div>
                                <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Apoio</label>
                                    <div className="flex flex-wrap gap-2">
                                        {members.map(m => (
                                            <button key={m.id} onClick={() => toggleSupport(m.id)} className={`p-1 rounded-full border transition-all relative ${currentTask.support?.some(s => s.id === m.id) ? 'ring-2 ring-blue-500 border-transparent' : 'border-gray-200 opacity-60 hover:opacity-100'}`}>
                                                <Avatar member={m} size="w-8 h-8"/>
                                                {currentTask.support?.some(s => s.id === m.id) && <div className="absolute -top-1 -right-1 bg-blue-500 rounded-full w-3 h-3 border border-white"></div>}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Subtasks */}
                            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2"><CheckSquare size={18}/> Subtarefas</h3>
                                <div className="space-y-2 mb-3">{currentTask.subtasks?.map(sub => (<div key={sub.id} className="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg group"><input type="checkbox" checked={sub.completed} onChange={() => toggleSubtask(sub.id)} className="w-4 h-4 text-blue-600 rounded cursor-pointer"/><span className={`text-sm flex-1 ${sub.completed ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{sub.text}</span><button onClick={() => { const newSubs = currentTask.subtasks.filter(s => s.id !== sub.id); dbOperations.updateTask(currentTask.id, { subtasks: newSubs }); }} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><X size={14}/></button></div>))}</div>
                                <div className="flex gap-2"><input className="flex-1 p-2 border rounded-lg text-sm" placeholder="Adicionar item..." value={newSubtask} onChange={e => setNewSubtask(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAddSubtask()}/><button onClick={handleAddSubtask} className="bg-blue-100 text-blue-700 p-2 rounded-lg"><Plus size={18}/></button></div>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: Chat */}
                        <div className="w-full lg:w-[400px] bg-white border-l border-gray-200 flex flex-col h-[50vh] lg:h-auto">
                            <div className="p-4 border-b bg-gray-50 font-bold text-gray-700 flex items-center gap-2"><MessageSquare size={18}/> Chat da Tarefa</div>
                            <div className="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50">
                                {(currentTask.messages || []).length === 0 && <p className="text-center text-gray-400 text-xs mt-10">Inicie a conversa.</p>}
                                {(currentTask.messages || []).map(msg => (
                                    <div key={msg.id} className={`flex gap-2 group/msg ${msg.senderId === selectedSender?.id ? 'flex-row-reverse' : ''}`}>
                                        <div className="flex-shrink-0 mt-1"><Avatar member={members.find(m => m.id === msg.senderId) || {name: msg.senderName}} size="w-8 h-8"/></div>
                                        <div className={`p-3 rounded-xl text-sm max-w-[80%] relative ${msg.senderId === selectedSender?.id ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-gray-200 rounded-tl-none shadow-sm'}`}>
                                            <p className="text-[10px] font-bold opacity-70 mb-1">{msg.senderName}</p>
                                            {msg.image && <img src={msg.image} className="w-full rounded-lg mb-2"/>}
                                            <p>{msg.text}</p>
                                            <button onClick={() => handleDeleteMessage(msg.id)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover/msg:opacity-100 transition-opacity"><X size={10}/></button>
                                        </div>
                                    </div>
                                ))}
                                <div ref={chatEndRef}></div>
                            </div>
                            <div className="p-3 bg-white border-t">{chatAttachment && (<div className="flex items-center gap-2 bg-blue-50 p-2 rounded-lg mb-2 text-xs text-blue-700"><ImageIcon size={14}/> Imagem selecionada <button onClick={() => setChatAttachment(null)}><X size={14}/></button></div>)}<div className="flex items-center gap-2 mb-2"><span className="text-xs text-gray-500">Falando como:</span><select className="text-xs font-bold border-none bg-transparent outline-none text-blue-700 cursor-pointer" value={selectedSender?.id} onChange={e => setSelectedSender(members.find(m => m.id === e.target.value))}>{members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}</select></div><div className="flex items-end gap-2"><div className="flex-1 bg-gray-100 rounded-xl flex items-center p-1 relative"><button onClick={() => fileInputRef.current.click()} className="p-2 text-gray-400 hover:text-blue-600"><Paperclip size={18}/></button><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileSelect}/><button onClick={() => setShowEmojis(!showEmojis)} className="p-2 text-gray-400 hover:text-yellow-500"><Smile size={18}/></button>{showEmojis && (<div className="absolute bottom-12 left-0 bg-white shadow-xl border rounded-xl p-2 grid grid-cols-6 gap-2 z-10 w-64">{['👍','👎','🔥','🎉','✅','❌','📅','😊','🤔','👀','🚀','💡'].map(e => (<button key={e} onClick={() => addEmoji(e)} className="text-xl hover:bg-gray-100 rounded p-1">{e}</button>))}</div>)}<textarea className="flex-1 bg-transparent border-none outline-none text-sm p-2 max-h-24 resize-none" rows={1} placeholder="Escreva..." value={messageText} onChange={e => setMessageText(e.target.value)} onKeyDown={e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } }}/></div><button onClick={handleSendMessage} className="p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 shadow-md"><Send size={18}/></button></div></div>
                        </div>
                    </div>
                </Modal>
            );
        };

        const Dashboard = ({ events, tasks, members, onSelectEvent, onNewEvent, onMemberClick, onAddAgendaItem, onDeleteAgendaItem, onUpdateAgendaItem, globalLogo, managerId, notifications, onToggleNotifications, isNotifOpen, markRead }) => {
            const [eventViewMode, setEventViewMode] = useState('active'); 
            
            const activeEvents = events.filter(e => !isEventFinished(e)).sort((a, b) => new Date(a.startDate) - new Date(b.startDate)); 
            const finishedEvents = events.filter(e => isEventFinished(e)).sort((a, b) => new Date(b.endDate || b.startDate) - new Date(a.endDate || a.startDate));
            const activeEventIds = activeEvents.map(e => e.id);
            const workload = members.map(m => {
                const memberTasks = tasks.filter(t => activeEventIds.includes(t.eventId) && t.responsible?.id === m.id);
                const pending = memberTasks.filter(t => t.status !== 'done').length;
                const done = memberTasks.filter(t => t.status === 'done').length;
                return { ...m, pending, done, total: pending + done };
            });
            const manager = members.find(m => m.id === managerId) || members[0];
            const activeTasks = tasks.filter(t => activeEventIds.includes(t.eventId));
            const completedActiveTasks = activeTasks.filter(t => t.status === 'done').length;
            const totalActiveTasks = activeTasks.length;
            const progress = totalActiveTasks > 0 ? Math.round((completedActiveTasks / totalActiveTasks) * 100) : 0;
            const eventsToDisplay = eventViewMode === 'active' ? activeEvents : finishedEvents;

            // Only count unread notifs for the red dot
            const unreadCount = notifications.length;

            return (
                <div className="max-w-[1600px] mx-auto p-6 md:p-8 animate-in pb-24">
                    <div className="flex justify-between items-center mb-8">
                        <div className="flex items-center gap-4"><div className="w-20 h-20 flex items-center justify-center font-bold text-xs bg-transparent rounded-2xl overflow-hidden">{globalLogo ? <img src={globalLogo} className="w-full h-full object-contain"/> : 'LOGO'}</div><div><h1 className="text-2xl font-extrabold text-blue-950">Event Hub</h1><p className="text-sm text-gray-500">Painel de Marketing</p></div></div>
                        <div className="flex items-center gap-4">
                            <button onClick={onToggleNotifications} className="relative p-2 bg-white rounded-full shadow-sm hover:shadow-md border border-gray-100 text-gray-600"><Bell size={20}/>{unreadCount > 0 && <div className="absolute top-0 right-0 w-4 h-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">{unreadCount}</div>}</button>
                            <NotificationCenter isOpen={isNotifOpen} onClose={onToggleNotifications} notifications={notifications} markRead={markRead} />
                            <div className="flex items-center gap-3 bg-white p-2 rounded-full shadow-sm border border-gray-100 pr-4 hover:shadow-md transition-all cursor-pointer group"><div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-2 border-white relative"><Avatar member={manager} size="w-full h-full"/></div><div className="text-left hidden sm:block"><p className="text-xs font-bold text-gray-800">{manager?.name}</p><p className="text-[10px] text-blue-600 font-bold uppercase flex items-center gap-1"><Crown size={10} fill="currentColor" /> Gestor da Equipe</p></div></div>
                        </div>
                    </div>
                    {/* Stats & Event List (Mantido igual) */}
                    <div className="grid grid-cols-1 gap-8">
                        <div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 relative overflow-hidden flex items-center justify-between h-auto min-h-[14rem]"><div className="relative w-32 h-32 flex-shrink-0"><svg className="w-full h-full -rotate-90"><circle cx="64" cy="64" r="54" stroke="#F3F4F6" strokeWidth="12" fill="none"/><circle cx="64" cy="64" r="54" stroke="#1e3a8a" strokeWidth="12" fill="none" strokeDasharray="339" strokeDashoffset={339 - (339*progress)/100} strokeLinecap="round"/></svg><div className="absolute inset-0 flex items-center justify-center font-bold text-2xl text-blue-900">{progress}%</div></div><div className="ml-8 flex-1"><h3 className="font-bold text-gray-900 mb-3 text-lg">Status Global (Ativos)</h3><div className="space-y-3"><div className="flex items-center justify-between bg-emerald-50 p-2 rounded-lg border border-emerald-100"><span className="text-xs font-bold text-emerald-700 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-emerald-500"></div> Concluídas</span><span className="text-sm font-extrabold text-emerald-800">{completedActiveTasks}</span></div><div className="flex items-center justify-between bg-amber-50 p-2 rounded-lg border border-amber-100"><span className="text-xs font-bold text-amber-700 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-amber-500"></div> Pendentes</span><span className="text-sm font-extrabold text-amber-800">{totalActiveTasks - completedActiveTasks}</span></div></div></div></div>
                                <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 flex flex-col justify-center h-auto min-h-[14rem]"><h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2"><Users size={18} className="text-blue-600"/> Carga de Trabalho (Eventos Ativos)</h3><div className="grid grid-cols-2 sm:grid-cols-3 gap-3">{workload.map(m => (<div key={m.id} onClick={() => onMemberClick(m)} className="flex items-center gap-3 p-2 rounded-xl border border-gray-50 hover:bg-gray-50 hover:border-gray-200 transition-all cursor-pointer group bg-white shadow-sm"><div className="relative shrink-0"><Avatar member={m} size="w-10 h-10"/>{m.total > 0 && (<div className={`absolute -top-1 -right-1 w-4 h-4 rounded-full flex items-center justify-center text-[9px] text-white font-bold border border-white ${m.total > 5 ? 'bg-blue-600' : 'bg-blue-400'}`}>{m.total}</div>)}</div><div className="flex-1 min-w-0"><p className="text-[11px] font-bold text-gray-800 truncate">{m.name.split(' ')[0]}</p><div className="flex gap-2 mt-0.5"><span className="text-[9px] font-bold text-amber-600 flex items-center gap-0.5" title="Pendentes"><div className="w-1.5 h-1.5 rounded-full bg-amber-500"></div> {m.pending}</span><span className="text-[9px] font-bold text-emerald-600 flex items-center gap-0.5" title="Concluídas"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500"></div> {m.done}</span></div></div></div>))}</div></div>
                            </div>
                            <div className="flex items-center justify-between mb-6"><h2 className="text-xl font-bold text-blue-950 flex items-center gap-2">{eventViewMode === 'active' ? <Clock size={24}/> : <CheckSquare size={24}/>} {eventViewMode === 'active' ? 'Eventos em Andamento' : 'Eventos Concluídos'}</h2><div className="bg-white p-1 rounded-xl border border-gray-200 flex shadow-sm"><button onClick={() => setEventViewMode('active')} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${eventViewMode === 'active' ? 'bg-blue-100 text-blue-800 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}><Clock size={14}/> Em Andamento</button><button onClick={() => setEventViewMode('completed')} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${eventViewMode === 'completed' ? 'bg-emerald-100 text-emerald-800 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}><CheckSquare size={14}/> Concluídos</button></div></div>
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-10 min-h-[200px]">{eventsToDisplay.length === 0 ? (<div className="col-span-full flex flex-col items-center justify-center py-12 opacity-50 bg-white rounded-2xl border border-dashed border-gray-200"><div className="bg-gray-50 p-4 rounded-full mb-3 text-gray-400">{eventViewMode === 'active' ? <Rocket size={32}/> : <Archive size={32}/>}</div><p className="text-sm font-bold text-gray-500">{eventViewMode === 'active' ? 'Nenhum evento ativo no momento.' : 'Nenhum evento concluído ainda.'}</p></div>) : (eventsToDisplay.map(evt => (<div key={evt.id} onClick={() => onSelectEvent(evt)} className={`bg-white rounded-xl border shadow-sm hover:shadow-md transition-all cursor-pointer group overflow-hidden aspect-square flex flex-col relative transform hover:-translate-y-1 ${eventViewMode === 'completed' ? 'grayscale border-gray-200' : 'border-gray-100'}`}><div className="flex-1 bg-gray-100 relative overflow-hidden">{evt.coverUrl && <img src={evt.coverUrl} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"/>}{eventViewMode === 'active' && (<div className="absolute top-2 right-2 bg-white/90 px-1.5 py-0.5 rounded text-[10px] font-bold shadow-sm text-blue-900">{getDaysLeft(evt)} dias</div>)}{eventViewMode === 'completed' && (<div className="absolute inset-0 bg-white/10 flex items-center justify-center"><div className="bg-emerald-500 text-white p-2 rounded-full shadow-lg"><Check size={20}/></div></div>)}</div><div className="p-3 shrink-0 bg-white border-t border-gray-50"><h3 className="font-bold text-gray-900 mb-0.5 truncate text-sm">{evt.title}</h3><p className="text-[10px] text-gray-500 flex items-center gap-1"><MapPin size={10}/> {evt.location || 'Local a definir'}</p></div></div>)))}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const EventDetail = ({ event, onBack, tasks, members, onUpdateTask, onUpdateEvent, categories, onOpenCategorySettings, onAddTask, onDeleteTask, onAddTeamMember, onRemoveTeamMember, onDeleteEvent }) => {
            const [selectedDate, setSelectedDate] = useState(null);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [selectedTaskId, setSelectedTaskId] = useState(null); 
            const [filterPhase, setFilterPhase] = useState('all');
            const [viewGrouping, setViewGrouping] = useState('category'); 
            const [isEditEventOpen, setIsEditEventOpen] = useState(false);
            const [isAddTeamOpen, setIsAddTeamOpen] = useState(false);
            const [showCharts, setShowCharts] = useState(true);
            const [newTempMemberName, setNewTempMemberName] = useState('');

            const selectedTask = tasks.find(t => t.id === selectedTaskId);
            const handleDragStart = (e, task) => { e.dataTransfer.setData("taskId", task.id); };
            const handleDragOver = (e) => e.preventDefault();
            const handleDrop = (e, targetId) => { const taskId = e.dataTransfer.getData("taskId"); if (viewGrouping === 'status') onUpdateTask(parseInt(taskId), { status: targetId }); else onUpdateTask(parseInt(taskId), { category: targetId }); };
            const filteredTasks = tasks.filter(t => t.eventId === event.id && (filterPhase === 'all' || t.phase === filterPhase));
            const handleAddAgenda = (item) => onUpdateEvent(event.id, { agenda: [...(event.agenda||[]), item] });
            const handleDeleteAgenda = (id) => onUpdateEvent(event.id, { agenda: (event.agenda||[]).filter(a=>a.id!==id) });
            const handleUpdateAgenda = (id, newItem) => { const newAgenda = (event.agenda || []).map(a => a.id === id ? { ...a, ...newItem } : a); onUpdateEvent(event.id, { agenda: newAgenda }); };
            const cyclePriority = (task) => { const map = { low: 'medium', medium: 'high', high: 'low' }; onUpdateTask(task.id, { priority: map[task.priority || 'low'] }); };
            
            const eventTeam = [
                members.find(m => m.id === event.responsibleId),
                ...members.filter(m => event.teamIds?.includes(m.id) && m.id !== event.responsibleId)
            ].filter(Boolean);

            let columns = [];
            if (viewGrouping === 'status') { columns = STATUS_COLUMNS; } else {
                const relevantCategories = event.categories || DEFAULT_CATEGORIES;
                columns = relevantCategories.filter(cat => { const catPhases = cat.phases || ['pre', 'during', 'post']; return filterPhase === 'all' || catPhases.includes(filterPhase); });
            }

            const totalEventCost = filteredTasks.reduce((acc, t) => acc + (t.cost || 0), 0);
            const daysLeft = getDaysLeft(event);
            const daysLeftText = daysLeft < 0 ? `Terminou há ${Math.abs(daysLeft)} dias` : daysLeft === 0 ? "É hoje!" : `Faltam ${daysLeft} dias`;
            const formatDate = (d) => { if (!d) return ''; const [y, m, day] = d.split('-'); return `${day}/${m}/${y}`; };

            const statsByPhase = ['pre', 'during', 'post'].map(ph => {
                const phaseTasks = tasks.filter(t => t.eventId === event.id && t.phase === ph);
                const done = phaseTasks.filter(t => t.status === 'done').length;
                const total = phaseTasks.length;
                const percent = total > 0 ? (done/total)*100 : 0;
                return { phase: ph, percent, label: ph === 'pre' ? 'Pré-Evento' : ph === 'during' ? 'Durante' : 'Pós-Evento' };
            });

            const handleAddTempMember = () => {
                if(!newTempMemberName.trim()) return;
                onAddTeamMember(event.id, null, newTempMemberName); // Special call
                setNewTempMemberName('');
                setIsAddTeamOpen(false);
            }

            return (
                <div className="min-h-screen bg-[#F8FAFC] pb-24 animate-in">
                    <div className="h-48 bg-blue-900 relative">
                        {event.coverUrl && <img src={event.coverUrl} className="w-full h-full object-cover opacity-30"/>}
                        <div className="absolute inset-0 bg-gradient-to-t from-[#F8FAFC] to-transparent"></div>
                        <div className="absolute bottom-4 left-6">
                            <h1 className="text-2xl font-extrabold text-blue-950">{event.title}</h1>
                            <div className="flex flex-col mt-1">
                                 <div className="flex items-center gap-2">
                                     <span className="text-xs font-bold text-blue-900 bg-white/50 px-2 py-1 rounded inline-flex items-center gap-1 w-fit">
                                        <Clock size={12}/> {daysLeftText} • {formatDate(event.startDate)} {event.endDate ? `- ${formatDate(event.endDate)}` : ''}
                                     </span>
                                     {event.driveLink && <a href={event.driveLink} target="_blank" rel="noopener noreferrer" className="text-xs font-bold text-gray-700 bg-white hover:bg-gray-50 border px-2 py-1 rounded inline-flex items-center gap-1 hover:text-blue-600 transition-colors shadow-sm"><HardDrive size={12}/> Drive</a>}
                                 </div>
                                 <span className="text-xs text-blue-950/70 font-medium flex items-center gap-1 mt-1"><MapPin size={12}/> {event.location || 'Local não definido'}</span>
                            </div>
                            <p className="text-xs font-bold text-emerald-600 mt-1 flex items-center gap-1"><DollarSign size={12}/> Custo Total: {formatCurrency(totalEventCost)}</p>
                        </div>
                        <button onClick={onBack} className="absolute top-4 left-4 p-2 bg-white/20 rounded-full hover:bg-white/40 text-white"><ArrowLeft/></button>
                        <button onClick={() => setIsEditEventOpen(true)} className="absolute top-4 right-4 p-2 bg-white/20 rounded-full hover:bg-white/40 text-white"><Edit2/></button>
                    </div>

                    <div className="max-w-[1800px] mx-auto px-6 mt-4 grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <div className="lg:col-span-1 space-y-6">
                            <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-800 flex items-center gap-2"><Users size={16}/> Equipe do Evento</h3><button onClick={()=>setIsAddTeamOpen(!isAddTeamOpen)} className="text-blue-600 hover:bg-blue-50 p-1 rounded"><Plus size={16}/></button></div>
                                {isAddTeamOpen && (
                                    <div className="mb-3 p-2 bg-gray-50 rounded-lg animate-in border border-blue-100">
                                        <div className="mb-2 max-h-32 overflow-y-auto space-y-1">
                                            {members.filter(m => !eventTeam.some(et => et.id === m.id)).map(m => (<div key={m.id} className="flex justify-between items-center p-1 hover:bg-gray-100 rounded cursor-pointer" onClick={() => { onAddTeamMember(event.id, m.id); setIsAddTeamOpen(false); }}><span className="text-xs">{m.name}</span><Plus size={12}/></div>))}
                                        </div>
                                        <div className="pt-2 border-t border-gray-200">
                                            <input className="w-full p-1 text-xs border rounded mb-1" placeholder="Nome Temporário..." value={newTempMemberName} onChange={e=>setNewTempMemberName(e.target.value)}/>
                                            <button onClick={handleAddTempMember} className="w-full bg-blue-100 text-blue-700 text-[10px] font-bold py-1 rounded">Adicionar Temp</button>
                                        </div>
                                    </div>
                                )}
                                <div className="space-y-3">{eventTeam.map(m => (<div key={m.id} className="flex items-center gap-3 group"><Avatar member={m}/><div className="flex-1 min-w-0"><p className="text-xs font-bold truncate">{m.name}</p><p className="text-[10px] text-gray-500 truncate">{m.role}</p></div>{m.id === event.responsibleId ? <Crown size={14} className="text-amber-500"/> : <button onClick={() => onRemoveTeamMember(event.id, m.id)} className="text-red-400 opacity-0 group-hover:opacity-100"><X size={14}/></button>}</div>))}</div>
                            </div>
                            <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden flex flex-col h-[500px]">
                                <div className="p-4 border-b bg-gray-50/50 font-bold text-gray-700 flex items-center gap-2"><CalendarIcon size={16}/> Agenda do Evento</div>
                                <div className="flex-1 overflow-visible"><AgendaComponent agendaItems={event.agenda || []} selectedDateFilter={null} onAdd={handleAddAgenda} onDelete={handleDeleteAgenda} onUpdate={handleUpdateAgenda} contextTitle="" scrollable={true} /></div>
                            </div>
                        </div>
                        <div className="lg:col-span-3 space-y-6">
                            <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-4">
                                <div className="flex flex-col md:flex-row justify-between gap-4">
                                    <div className="flex bg-gray-100 p-1 rounded-lg w-fit">{['all', 'pre', 'during', 'post'].map(ph => (<button key={ph} onClick={()=>setFilterPhase(ph)} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${filterPhase===ph ? 'bg-white shadow text-blue-900' : 'text-gray-500'}`}>{ph === 'all' ? 'Todos' : ph === 'pre' ? 'Pré' : ph === 'during' ? 'Durante' : 'Pós'}</button>))}</div>
                                    <div className="flex items-center gap-2"><button onClick={() => setShowCharts(!showCharts)} className={`p-2 border rounded-lg hover:bg-gray-50 ${showCharts ? 'bg-blue-50 text-blue-600 border-blue-200' : 'text-gray-500'}`} title="Ver Gráficos"><BarChart3 size={16}/></button><div className="flex bg-gray-100 p-1 rounded-lg mr-2"><button onClick={() => setViewGrouping('category')} className={`p-2 rounded-md ${viewGrouping === 'category' ? 'bg-white shadow text-blue-600' : 'text-gray-400'}`} title="Ver por Categoria"><Grid size={16}/></button><button onClick={() => setViewGrouping('status')} className={`p-2 rounded-md ${viewGrouping === 'status' ? 'bg-white shadow text-blue-600' : 'text-gray-400'}`} title="Ver por Status"><Columns size={16}/></button></div><button onClick={onOpenCategorySettings} className="p-2 border rounded-lg text-gray-500 hover:bg-gray-50" title="Ajustes de Categoria"><Settings size={16}/></button><button onClick={onAddTask} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 flex items-center gap-2"><Plus size={14}/> Nova Tarefa</button></div>
                                </div>
                                {showCharts && (<div className="grid grid-cols-3 gap-4 py-4 animate-in">{statsByPhase.map(stat => (<div key={stat.phase} className="bg-gray-50 rounded-lg p-3 border border-gray-100"><div className="flex justify-between text-xs mb-1 font-bold text-gray-600"><span>{stat.label}</span><span>{Math.round(stat.percent)}%</span></div><div className="h-2 bg-gray-200 rounded-full overflow-hidden"><div className="h-full bg-blue-600 rounded-full transition-all duration-500" style={{width: `${stat.percent}%`}}></div></div></div>))}</div>)}
                            </div>
                            <div className="flex flex-wrap gap-4 items-start">
                                {columns.map(col => {
                                    const colTasks = filteredTasks.filter(t => viewGrouping === 'status' ? t.status === col.id : t.category === col.id);
                                    const catResp = viewGrouping === 'category' && col.responsibleId ? members.find(m => m.id === col.responsibleId) : null;
                                    const catSupport = viewGrouping === 'category' && col.supportIds ? col.supportIds.map(id => members.find(m => m.id === id)).filter(Boolean) : [];
                                    return (
                                        <div key={col.id} className="min-w-[280px] flex-1 bg-gray-100/50 rounded-xl p-2 border border-gray-200 flex flex-col" onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, col.id)}>
                                            <div className="flex flex-col p-3 mb-2"><div className="flex items-center justify-between mb-1"><span className={`text-xs font-bold uppercase flex items-center gap-2 ${col.color ? `text-${col.color}-700` : 'text-gray-700'}`}>{col.icon && React.createElement(ICON_MAP[col.icon] || Box, { size: 14 })} {col.title}</span><span className="bg-white text-gray-400 text-[10px] font-bold px-2 py-0.5 rounded border">{colTasks.length}</span></div>{viewGrouping === 'category' && (catResp || catSupport.length > 0) && (<div className="flex items-center gap-1 mt-1 pl-6">{catResp && <Avatar member={catResp} size="w-5 h-5" className="border border-white"/>}{catSupport.map(s => <Avatar key={s.id} member={s} size="w-4 h-4" className="border border-white opacity-70"/>)}</div>)}</div>
                                            <div className="space-y-3 flex-1">{colTasks.map(task => (<div key={task.id} draggable onDragStart={(e) => handleDragStart(e, task)} onClick={() => { setSelectedTaskId(task.id); setIsTaskModalOpen(true); }} className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm hover:shadow-md cursor-pointer group relative"><div className="flex justify-between items-start mb-2"><FlagPriority level={task.priority} onClick={()=>cyclePriority(task)}/><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button className="text-gray-400 hover:text-blue-600"><Edit2 size={12}/></button></div></div><p className="text-sm font-medium text-gray-800 mb-3">{task.text}</p><div className="flex items-center justify-between pt-2 border-t border-gray-50"><div className="flex items-center gap-2"><Avatar member={task.responsible} size="w-5 h-5"/><span className="text-[10px] text-gray-500">{task.responsible?.name.split(' ')[0]}</span></div>{task.cost > 0 && <span className="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-1 rounded">{formatCurrency(task.cost)}</span>}</div></div>))}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                    {selectedTask && <TaskDetailModal isOpen={isTaskModalOpen} onClose={() => { setIsTaskModalOpen(false); setSelectedTaskId(null); }} task={selectedTask} members={members} dbOperations={{ updateTask: (id, updates) => onUpdateTask(id, updates) }} deleteTask={onDeleteTask} />}
                    <EditEventModal isOpen={isEditEventOpen} onClose={() => setIsEditEventOpen(false)} event={event} onUpdate={onUpdateEvent} members={members} onDelete={onDeleteEvent} />
                </div>
            );
        };

        const GlobalAgendaView = ({ events, tasks, onAddAgendaItem, onDeleteAgendaItem, onUpdateAgendaItem }) => {
            const items = [
                ...events.flatMap(e => (e.agenda||[]).map(a => ({...a, eventName: e.title}))),
                ...tasks.filter(t => t.date).map(t => ({ id: `t-${t.id}`, title: t.text, date: t.date, color: 'green', eventName: 'Tarefa' }))
            ];
            return (
                <div className="p-6 pb-24 bg-[#F8FAFC] min-h-screen">
                    <h1 className="text-2xl font-bold text-blue-950 mb-6 flex items-center gap-2"><CalendarIcon/> Agenda Geral</h1>
                    <div className="h-[600px]"><AgendaComponent agendaItems={items} selectedDateFilter={null} onAdd={(item) => onAddAgendaItem('global', item)} onDelete={onDeleteAgendaItem} onUpdate={onUpdateAgendaItem} contextTitle="Todos os Compromissos" events={events} scrollable={true} /></div>
                </div>
            );
        };

        const GlobalTeamView = ({ members, onEdit }) => (
            <div className="p-6 pb-24 bg-[#F8FAFC] min-h-screen">
                <div className="flex justify-between items-center mb-6"><h1 className="text-2xl font-bold text-blue-950">Equipe</h1><button onClick={onEdit} className="text-blue-600 font-bold text-sm bg-blue-50 px-3 py-2 rounded-lg hover:bg-blue-100">Gerenciar</button></div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{members.map(m => (<div key={m.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4"><div className="w-16 h-16 rounded-full overflow-hidden"><Avatar member={m} size="w-full h-full"/></div><div><p className="font-bold text-gray-900 text-lg">{m.name}</p><p className="text-sm text-gray-500">{m.role}</p></div></div>))}</div>
            </div>
        );

        function App() {
            const [view, setView] = useState('dashboard');
            const [selectedEvent, setSelectedEvent] = useState(null);
            
            // --- FIREBASE STATE ---
            const [events, setEvents] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [members, setMembers] = useState([]);
            const [readNotifs, setReadNotifs] = useState([]); // Store IDs of read notifications locally
            const [transferNotifs, setTransferNotifs] = useState([]); // Notifications from DB
            const [user, setUser] = useState(null);
            const [needsConfig, setNeedsConfig] = useState(false);
            
            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            const [isNewEventOpen, setIsNewEventOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isCatSettingsOpen, setIsCatSettingsOpen] = useState(false);
            const [isNewTaskOpen, setIsNewTaskOpen] = useState(false);
            const [isAIOpen, setIsAIOpen] = useState(false);
            const [selectedWorkloadMember, setSelectedWorkloadMember] = useState(null);
            const [logo, setLogo] = useState(null);
            const [managerId, setManagerId] = useState('1'); 
            const [geminiKey, setGeminiKey] = useState('');
            const [isNotifOpen, setIsNotifOpen] = useState(false);

            useEffect(() => {
                if (!app) { setNeedsConfig(true); return; }
                const initAuth = async () => { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } } catch (e) { console.error("Authentication Failed", e); } };
                initAuth();
                const storedReads = localStorage.getItem('read_notifs');
                if(storedReads) setReadNotifs(JSON.parse(storedReads));
                return onAuthStateChanged(auth, (u) => { setUser(u); });
            }, []);

            useEffect(() => {
                if(!user || !db) return;
                const unsubEvents = onSnapshot(getColPath('events'), (snap) => { if (snap.empty && !localStorage.getItem('db_initialized')) { INITIAL_MEMBERS.forEach(m => setDoc(getDocPath('members', m.id), m)); setDoc(getDocPath('config', 'main'), { managerId: '1' }); localStorage.setItem('db_initialized', 'true'); } else { setEvents(snap.docs.map(d => d.data())); } });
                const unsubTasks = onSnapshot(getColPath('tasks'), (snap) => { setTasks(snap.docs.map(d => d.data())); });
                const unsubMembers = onSnapshot(getColPath('members'), (snap) => { setMembers(snap.docs.map(d => d.data())); });
                const unsubSettings = onSnapshot(getDocPath('config', 'main'), (snap) => { if(snap.exists()) { const data = snap.data(); if(data.logo) setLogo(data.logo); if(data.managerId) setManagerId(data.managerId); if(data.geminiKey) setGeminiKey(data.geminiKey); } });
                const unsubTransfers = onSnapshot(getColPath('notifications'), (snap) => { setTransferNotifs(snap.docs.map(d => ({id: d.id, ...d.data()}))); }); // Listen for transfers
                return () => { unsubEvents(); unsubTasks(); unsubMembers(); unsubSettings(); unsubTransfers(); };
            }, [user]);

            const handleUpdateTask = (id, updates) => updateDoc(getDocPath('tasks', id), updates);
            const handleDeleteTask = (id) => deleteDoc(getDocPath('tasks', id));
            const handleCreateTask = (newTask) => setDoc(getDocPath('tasks', newTask.id), newTask);
            const handleUpdateEvent = (id, updates) => updateDoc(getDocPath('events', id), updates);
            const handleCreateEvent = (newEvent, newTasks) => { setDoc(getDocPath('events', newEvent.id), newEvent); newTasks.forEach(t => setDoc(getDocPath('tasks', t.id), t)); };
            const handleDeleteEvent = (eventId) => { if(confirm("Tem certeza?")) { deleteDoc(getDocPath('events', eventId)); tasks.filter(t => t.eventId === eventId).forEach(t => deleteDoc(getDocPath('tasks', t.id))); setView('dashboard'); setSelectedEvent(null); } };
            const handleUpdateMember = (id, updates) => updateDoc(getDocPath('members', id), updates);
            const handleAddMember = (newMember) => setDoc(getDocPath('members', newMember.id), newMember);
            const handleDeleteMember = (id) => { if(confirm("Excluir membro?")) deleteDoc(getDocPath('members', id)); };
            const handleUpdateLogo = (url) => setDoc(getDocPath('config', 'main'), { logo: url }, { merge: true });
            const handleUpdateManager = (id) => setDoc(getDocPath('config', 'main'), { managerId: id }, { merge: true });
            const handleUpdateGeminiKey = (key) => setDoc(getDocPath('config', 'main'), { geminiKey: key }, { merge: true });
            
            const handleTransferTask = (tasksToTransfer, targetMember, reason) => {
                const notifId = Date.now().toString();
                // Persist notification
                addDoc(getColPath('notifications'), {
                    type: 'transfer',
                    title: 'Transferência de Responsabilidade',
                    message: `${tasksToTransfer.length} tarefas transferidas para ${targetMember.name}. Motivo: ${reason}`,
                    timestamp: new Date().toISOString()
                });
                
                tasksToTransfer.forEach(task => {
                    const newMsg = {
                        id: Date.now() + Math.random(),
                        senderId: 'system',
                        senderName: 'Sistema',
                        text: `Responsabilidade transferida para ${targetMember.name}. Motivo: ${reason}`,
                        timestamp: new Date().toISOString()
                    };
                    handleUpdateTask(task.id, { responsible: targetMember, messages: [...(task.messages || []), newMsg] });
                });
            };

            const handleAddTeamMember = (eventId, memberId, tempName = null) => {
                const event = events.find(e => e.id === eventId);
                if (!event) return;
                let idToAdd = memberId;
                
                if (tempName) {
                    const tempId = 'temp-' + Date.now();
                    const tempMember = { id: tempId, name: tempName, role: 'Temporário', isTemp: true, photoUrl: null };
                    handleAddMember(tempMember); // Add to global/temp list
                    idToAdd = tempId;
                }

                if (idToAdd && !event.teamIds?.includes(idToAdd)) {
                    handleUpdateEvent(eventId, { teamIds: [...(event.teamIds || []), idToAdd] });
                }
            };

            const handleGlobalAddAgenda = (type, item) => { if(item.eventId) { const evt = events.find(e => e.id === item.eventId); if(evt) handleUpdateEvent(evt.id, { agenda: [...(evt.agenda||[]), item] }); } else if (events.length > 0) { const evt = events[0]; handleUpdateEvent(evt.id, { agenda: [...(evt.agenda||[]), item] }); } };
            const handleGlobalDeleteAgenda = (id) => { const evt = events.find(e => (e.agenda || []).some(a => a.id === id)); if (evt) handleUpdateEvent(evt.id, { agenda: evt.agenda.filter(a => a.id !== id) }); };
            const handleGlobalUpdateAgenda = (id, newItem) => { const evt = events.find(e => (e.agenda || []).some(a => a.id === id)); if (evt) { const newAgenda = evt.agenda.map(a => a.id === id ? { ...a, ...newItem } : a); handleUpdateEvent(evt.id, { agenda: newAgenda }); } };
            const handleUpdateEventCategories = (newCats) => { if(selectedEvent) { handleUpdateEvent(selectedEvent.id, { categories: newCats }); setSelectedEvent(prev => ({ ...prev, categories: newCats })); } };
            const handleRemoveTeamMember = (eventId, memberId) => { const event = events.find(e => e.id === eventId); if(event) { handleUpdateEvent(eventId, { teamIds: (event.teamIds || []).filter(id => id !== memberId) }); } };

            const currentSelectedEvent = selectedEvent ? events.find(e => e.id === selectedEvent.id) : null;

            // Generate Notifications
            const notifications = useMemo(() => {
                const notifs = [];
                const activeEvents = events.filter(e => !isEventFinished(e));
                const activeEventIds = activeEvents.map(e => e.id);

                // 1. New Tasks (last 24h) from Active Events
                const now = new Date();
                const oneDayAgo = new Date(now - 86400000);
                tasks.filter(t => activeEventIds.includes(t.eventId)).forEach(t => {
                    if (t.createdAt && new Date(t.createdAt) > oneDayAgo) {
                        const evt = events.find(e => e.id === t.eventId);
                        const cat = (evt?.categories || DEFAULT_CATEGORIES).find(c => c.id === t.category);
                        notifs.push({ 
                            id: `task-${t.id}`,
                            type: 'new_task', 
                            title: 'Nova Tarefa', 
                            message: t.text.substring(0, 40) + (t.text.length > 40 ? '...' : ''),
                            context: `${evt?.title || 'Evento'} • ${cat?.title || 'Geral'}`
                        });
                    }
                });
                
                // 2. Deadlines from Active Events
                activeEvents.forEach(e => {
                    const days = getDaysLeft(e);
                    if (days >= 0 && days <= 2) {
                        notifs.push({ 
                            id: `deadline-${e.id}`,
                            type: 'deadline', 
                            title: 'Prazo Próximo', 
                            message: `Evento "${e.title}" começa em ${days} dias.`,
                            context: 'Cronograma'
                        });
                    }
                });

                // 3. Transfer Notifications (From DB)
                transferNotifs.forEach(t => {
                     notifs.push({
                         id: t.id,
                         type: 'transfer',
                         title: t.title,
                         message: t.message,
                         context: 'Gestão de Equipe'
                     });
                });

                // Filter out read notifications
                return notifs.filter(n => !readNotifs.includes(n.id));
            }, [tasks, events, readNotifs, transferNotifs]);

            const markNotificationRead = (id) => {
                const newRead = [...readNotifs, id];
                setReadNotifs(newRead);
                localStorage.setItem('read_notifs', JSON.stringify(newRead));
            };

            if (needsConfig) return <div className="p-10 text-center">Configurando...</div>;

            return (
                <>
                    {view === 'dashboard' && <Dashboard events={events} tasks={tasks} members={members} onSelectEvent={(e) => { setSelectedEvent(e); setView('detail'); }} onNewEvent={() => setIsNewEventOpen(true)} onMemberClick={setSelectedWorkloadMember} onAddAgendaItem={handleGlobalAddAgenda} onDeleteAgendaItem={handleGlobalDeleteAgenda} onUpdateAgendaItem={handleGlobalUpdateAgenda} globalLogo={logo} managerId={managerId} notifications={notifications} onToggleNotifications={() => setIsNotifOpen(!isNotifOpen)} isNotifOpen={isNotifOpen} markRead={markNotificationRead} />}
                    {view === 'detail' && currentSelectedEvent && (
                        <EventDetail 
                            event={currentSelectedEvent} onBack={() => setView('dashboard')} 
                            tasks={tasks} members={members} categories={currentSelectedEvent.categories || DEFAULT_CATEGORIES}
                            onUpdateTask={handleUpdateTask} onUpdateEvent={handleUpdateEvent} onDeleteTask={handleDeleteTask}
                            onOpenCategorySettings={() => setIsCatSettingsOpen(true)}
                            onAddTask={() => setIsNewTaskOpen(true)}
                            onAddTeamMember={handleAddTeamMember}
                            onRemoveTeamMember={handleRemoveTeamMember}
                            onDeleteEvent={handleDeleteEvent}
                        />
                    )}
                    {view === 'agenda' && <GlobalAgendaView events={events} tasks={tasks} onAddAgendaItem={handleGlobalAddAgenda} onDeleteAgendaItem={handleGlobalDeleteAgenda} onUpdateAgendaItem={handleGlobalUpdateAgenda}/>}
                    {view === 'team' && <GlobalTeamView members={members} onEdit={() => setIsSettingsOpen(true)} />}
                    {view === 'settings' && <SettingsModal isOpen={true} onClose={() => setView('dashboard')} members={members} onUpdateMember={handleUpdateMember} onAddMember={handleAddMember} onDeleteMember={handleDeleteMember} onUpdateLogo={handleUpdateLogo} currentLogo={logo} managerId={managerId} onUpdateManager={handleUpdateManager} onUpdateGeminiKey={handleUpdateGeminiKey}/>}
                    
                    <BottomNav activeTab={view} onChangeTab={(v) => { if(v === 'settings') setIsSettingsOpen(true); else setView(v); }} onAdd={() => setIsNewEventOpen(true)} />
                    
                    <button onClick={() => setIsAIOpen(!isAIOpen)} className="fixed bottom-24 right-6 w-14 h-14 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full shadow-xl shadow-blue-600/30 flex items-center justify-center text-white z-[150] hover:scale-110 transition-transform duration-300 animate-in">
                        {isAIOpen ? <X size={24}/> : <Sparkles size={24}/>}
                    </button>

                    <AIAssistant isOpen={isAIOpen} onClose={() => setIsAIOpen(false)} context={{totalCost: tasks.reduce((a,b)=>a+(b.cost||0),0), tasks, members, events}} apiKey={geminiKey} />

                    <NewEventModal isOpen={isNewEventOpen} onClose={() => setIsNewEventOpen(false)} onCreate={handleCreateEvent} members={members} />
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} members={members} onUpdateMember={handleUpdateMember} onAddMember={handleAddMember} onDeleteMember={handleDeleteMember} onUpdateLogo={handleUpdateLogo} currentLogo={logo} managerId={managerId} onUpdateManager={handleUpdateManager} onUpdateGeminiKey={handleUpdateGeminiKey}/>
                    <WorkloadDetailModal isOpen={!!selectedWorkloadMember} onClose={() => setSelectedWorkloadMember(null)} member={selectedWorkloadMember} memberTasks={tasks.filter(t => t.responsible?.id === selectedWorkloadMember?.id)} allMembers={members} onUpdateTask={handleUpdateTask} onTransferTask={handleTransferTask} />
                    <ManageCategoriesModal isOpen={isCatSettingsOpen} onClose={() => setIsCatSettingsOpen(false)} categories={currentSelectedEvent?.categories || DEFAULT_CATEGORIES} onUpdateCategories={handleUpdateEventCategories} members={members} />
                    {currentSelectedEvent && <NewTaskModal isOpen={isNewTaskOpen} onClose={() => setIsNewTaskOpen(false)} eventId={currentSelectedEvent.id} eventCategories={currentSelectedEvent.categories || DEFAULT_CATEGORIES} onCreate={handleCreateTask} members={members} />}
                </>
            );
        };

        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = createRoot(rootElement);
            root.render(<App />);
        } else {
            console.error("Root element not found");
        }
    </script>
</body>
</html>









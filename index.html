<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Hub - Painel de Marketing</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .drag-over { transform: scale(1.01); transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .dragging { opacity: 0.5; transform: scale(0.95); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-in-notification { animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* Efeito de brilho no bot√£o */
        @keyframes shine {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }
        .animate-shine {
            background-size: 200% auto;
            animation: shine 3s linear infinite;
        }

        /* Glassmorphism sutil */
        .glass-header {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Indicador de carregamento da IA */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        blue: { 900: '#1e3a8a', 950: '#172554' }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createPortal } from 'https://esm.sh/react-dom@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Calendar as CalendarIcon, Users, CheckSquare, Flag, Plus, X, Clock, 
            Edit2, Trash2, ChevronLeft, ChevronRight, Truck, ArrowLeft, 
            Search, Bell, MessageSquare, Send, AlertCircle, ChevronDown, 
            ChevronUp, Settings, UserPlus, Box, TrendingUp, Filter, Check, 
            Image as ImageIcon, AlertTriangle, Crown, Plane, Target, Camera,
            DollarSign, ClipboardList, Mic, Music, Coffee, Gift, Sparkles, Bot,
            BarChart3, Layout, GripVertical, Flame, Info, Wifi, WifiOff,
            ExternalLink, Lightbulb, BrainCircuit, MoreVertical, Paperclip, FileText,
            Wand2, Copy, Share2, ZoomIn, Layers, Zap, Megaphone, Palette, Maximize2, MapPin, Briefcase, Rocket, Star,
            PieChart, Timer, UserCheck, RefreshCw, Key
        } from 'https://esm.sh/lucide-react@0.294.0';

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- Configura√ß√£o Firebase ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCOFpqcXhf-TkL9BLhpKTcMK2MO7G7T2mU",
            authDomain: "bolsas-termicas.firebaseapp.com",
            projectId: "bolsas-termicas",
            storageBucket: "bolsas-termicas.firebasestorage.app",
            messagingSenderId: "372188665466",
            appId: "1:372188665466:web:3b1514a6c681fb06920dc3",
            measurementId: "G-1HTMMPYKHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'event-hub-production-v27-adjustments';

        // --- Utils & Constants ---
        const compressImage = (file, maxWidth = 800) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            const outputType = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
                            resolve(canvas.toDataURL(outputType, 0.7)); 
                        } else resolve(img.src);
                    };
                };
            });
        };

        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        // --- FUN√á√ïES DE DATA REUTILIZ√ÅVEIS ---
        const getDaysLeft = (evt) => {
            if (!evt) return null;
            let targetDate = null;
            if (evt.startDate) {
                targetDate = new Date(evt.startDate + 'T00:00:00');
            } else if (evt.dateRange) {
                const parts = evt.dateRange.split(' - ')[0].split('/');
                if (parts.length === 3) {
                    targetDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00`);
                }
            }
            if (!targetDate) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = targetDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        const getMonthAbbr = (dateStr) => {
            if (!dateStr) return 'DEZ';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleString('pt-BR', { month: 'short' }).toUpperCase().replace('.', '');
        };

        const getDayNumber = (dateStr) => {
            if (!dateStr) return '02';
            const date = new Date(dateStr + 'T00:00:00');
            return String(date.getDate()).padStart(2, '0');
        };
        
        // --- L√ìGICA DE FALLBACK (IA LOCAL) ---
        const localAIResponse = (prompt, contextData) => {
            const lower = prompt.toLowerCase();
            const { tasks, totalCost } = contextData;

            if (lower.includes('custo') || lower.includes('or√ßamento')) {
                return `üí∞ **(Modo Offline)** Investimento total atual: ${formatCurrency(totalCost)}. \n\n*Para an√°lises mais detalhadas, insira uma Chave de API Gemini nas configura√ß√µes.*`;
            }
            if (lower.includes('tarefa') || lower.includes('status')) {
                const done = tasks.filter(t => t.status === 'done').length;
                return `üìä **(Modo Offline)** Temos ${tasks.length} tarefas no total, sendo ${done} conclu√≠das. \n\n*Para insights inteligentes, insira uma Chave de API Gemini nas configura√ß√µes.*`;
            }
            return "Estou no modo offline temporariamente. Por favor, adicione uma **Chave API do Gemini** no menu de Configura√ß√µes (√≠cone de engrenagem) para ativar minha intelig√™ncia completa.";
        };

        // --- CONEX√ÉO COM GEMINI API ---
        const callGeminiFlash = async (prompt, context, apiKey) => {
            if (!apiKey) {
                return localAIResponse(prompt, context);
            }
            
            // --- ENRIQUECIMENTO DE DADOS PARA A IA ---
            const tasksByMember = {};
            context.members.forEach(m => tasksByMember[m.id] = []);
            context.tasks.forEach(t => {
                if(t.responsible?.id) {
                    if (!tasksByMember[t.responsible.id]) tasksByMember[t.responsible.id] = [];
                    tasksByMember[t.responsible.id].push(t);
                }
            });

            const resumoEquipe = context.members.map(m => {
                const tasks = tasksByMember[m.id] || [];
                const activeTasks = tasks.filter(t => t.status !== 'done');
                const completedTasks = tasks.filter(t => t.status === 'done');
                
                return {
                    nome: m.name,
                    cargo: m.role,
                    status: activeTasks.length === 0 ? "LIVRE / SEM TAREFAS" : "OCUPADO",
                    tarefasAtuais: activeTasks.map(t => t.text).join(", "),
                    totalPendentes: activeTasks.length,
                    totalConcluidas: completedTasks.length
                };
            });

            const custosPorEvento = context.events.map(e => {
                const eventTasks = context.tasks.filter(t => t.eventId === e.id);
                const custo = eventTasks.reduce((acc, t) => acc + (parseFloat(t.cost) || 0), 0);
                return { evento: e.title, custo: formatCurrency(custo), data: e.dateRange };
            });

            const aiContext = {
                resumoGeral: "Gest√£o de eventos de marketing",
                custoTotal: formatCurrency(context.totalCost),
                analiseEquipe: resumoEquipe, 
                analiseFinanceira: custosPorEvento,
                listaEventos: context.events.map(e => ({ titulo: e.title, diasRestantes: getDaysLeft(e) }))
            };

            const systemInstructionText = `
                Voc√™ √© a IA oficial do 'Event Hub', um painel de gest√£o de eventos.
                Voc√™ tem acesso total aos dados do projeto.
                
                DADOS PROCESSADOS: ${JSON.stringify(aiContext)}
                
                SUAS FUN√á√ïES PRINCIPAIS:
                1. Dizer o que cada pessoa est√° fazendo (consulte 'analiseEquipe').
                2. Identificar quem est√° livre/sem tarefas (consulte 'analiseEquipe' -> status 'LIVRE').
                3. Informar custos de eventos espec√≠ficos (consulte 'analiseFinanceira').
                4. Dar resumos de prazos.

                DIRETRIZES:
                - Use formata√ß√£o Markdown (negrito, listas).
                - Seja direto. Se perguntarem "Quem est√° livre?", liste apenas os nomes.
                - Se perguntarem "O que o Paulo est√° fazendo?", liste as tarefas atuais dele.
                - Responda sempre em Portugu√™s do Brasil.
            `;

            const maxRetries = 3;
            let attempt = 0;
            let delay = 2000;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Pergunta do usu√°rio: "${prompt}"` }] }],
                            systemInstruction: { parts: [{ text: systemInstructionText }] }
                        })
                    });

                    if (response.status === 503) {
                         attempt++;
                         await new Promise(resolve => setTimeout(resolve, delay));
                         delay *= 2;
                         continue;
                    }

                    const data = await response.json();
                    
                    if (data.error) {
                        console.error("Erro API Gemini:", JSON.stringify(data.error)); 
                        return `Erro na IA: ${data.error.message || 'Chave inv√°lida ou erro de quota.'}`;
                    }

                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Hmm, n√£o consegui processar sua resposta. Tente novamente.";
                    
                } catch (error) {
                    console.error("Erro Fetch:", error);
                    return localAIResponse(prompt, context);
                }
            }
            return localAIResponse(prompt, context);
        };

        const PASTEL_COLORS = [
            { id: 'blue', bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-200', hex: '#DBEAFE' },
            { id: 'green', bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-200', hex: '#D1FAE5' },
            { id: 'yellow', bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-200', hex: '#FEF3C7' },
            { id: 'red', bg: 'bg-rose-100', text: 'text-rose-800', border: 'border-rose-200', hex: '#FFE4E6' },
            { id: 'purple', bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-200', hex: '#F3E8FF' },
            { id: 'orange', bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200', hex: '#FFEDD5' },
            { id: 'teal', bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-200', hex: '#CCFBF1' },
            { id: 'indigo', bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-200', hex: '#E0E7FF' },
        ];

        const STATUS_COLUMNS = [
            { id: 'planning', title: 'Planejamento', color: 'blue', icon: Box, bgSoft: 'bg-blue-50/80', border: 'border-blue-100' },
            { id: 'in_progress', title: 'Andamento', color: 'amber', icon: Truck, bgSoft: 'bg-amber-50/80', border: 'border-amber-100' },
            { id: 'review', title: 'Finaliza√ß√£o', color: 'purple', icon: Search, bgSoft: 'bg-purple-50/80', border: 'border-purple-100' },
            { id: 'done', title: 'Conclu√≠do', color: 'emerald', icon: CheckSquare, bgSoft: 'bg-emerald-50/80', border: 'border-emerald-100' }
        ];

        const ICON_MAP = { box: Box, truck: Truck, users: Users, trending: TrendingUp, check: CheckSquare, layers: Layers, zap: Zap, megaphone: Megaphone, palette: Palette, gift: Gift, coffee: Coffee, music: Music };
        
        const COLOR_PRESETS = {
            blue: 'text-blue-700 bg-blue-100 border-blue-200',
            amber: 'text-amber-700 bg-amber-100 border-amber-200',
            purple: 'text-purple-700 bg-purple-100 border-purple-200',
            emerald: 'text-emerald-700 bg-emerald-100 border-emerald-200',
            gray: 'text-gray-700 bg-gray-100 border-gray-200'
        };
        
        const getCategoryStyles = (color) => COLOR_PRESETS[color] || COLOR_PRESETS.blue;
        const getCategoryIcon = (iconName) => { const Icon = ICON_MAP[iconName] || Box; return <Icon size={18} />; };
        const MONTH_NAMES = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        const DEFAULT_CATEGORIES = [
            { id: 'planning', title: 'Planejamento & Produto', icon: 'box', color: 'blue' },
            { id: 'logistics', title: 'Log√≠stica & Estande', icon: 'truck', color: 'amber' },
            { id: 'staff', title: 'Staff & Viagem', icon: 'users', color: 'purple' },
            { id: 'post', title: 'P√≥s-Evento & Leads', icon: 'trending', color: 'emerald' }
        ];

        const PREDEFINED_TASKS_DATA = [
            { text: "Definir tema e conceito do evento", category: "planning" },
            { text: "Aprovar or√ßamento preliminar", category: "planning" },
            { text: "Criar cronograma macro", category: "planning" },
            { text: "Desenvolver identidade visual (KV)", category: "planning" },
            { text: "Disparar 'Save the Date'", category: "planning" },
            { text: "Reservar local/espa√ßo", category: "logistics" },
            { text: "Contratar servi√ßo de Buffet", category: "logistics" },
            { text: "Definir projeto cenogr√°fico", category: "logistics" },
            { text: "Contratar Sonoriza√ß√£o e Luz", category: "logistics" },
            { text: "Alinhar equipe de seguran√ßa e limpeza", category: "logistics" },
            { text: "Contratar recepcionistas", category: "staff" },
            { text: "Reservar passagens a√©reas", category: "staff" },
            { text: "Reservar hospedagem da equipe", category: "staff" },
            { text: "Produzir uniformes/camisetas", category: "staff" },
            { text: "Realizar briefing com a equipe", category: "staff" },
            { text: "Consolidar relat√≥rio de leads", category: "post" },
            { text: "Enviar pesquisa de satisfa√ß√£o (NPS)", category: "post" },
            { text: "Realizar pagamentos finais", category: "post" },
            { text: "Organizar material de foto/v√≠deo", category: "post" },
            { text: "Reuni√£o de debriefing", category: "post" }
        ];

        // --- Componentes Gen√©ricos ---

        const ImagePreviewModal = ({ isOpen, onClose, imageUrl }) => {
            if (!isOpen || !imageUrl) return null;
            return createPortal(
                <div className="fixed inset-0 z-[9999] bg-black/90 flex items-center justify-center p-4 animate-in" onClick={onClose}>
                    <div className="relative max-w-4xl max-h-[90vh]">
                         <button onClick={onClose} className="absolute -top-10 right-0 text-white hover:text-gray-300"><X size={24}/></button>
                         <img src={imageUrl} className="max-w-full max-h-[85vh] rounded-lg shadow-2xl" onClick={(e) => e.stopPropagation()} />
                    </div>
                </div>,
                document.body
            );
        };

        const Avatar = ({ member, size = "w-10 h-10", showCrown = false }) => {
            if (!member) return <div className={`${size} rounded-full bg-gray-200 border border-gray-300`}></div>;
            const content = member.photoUrl ? (
                <img src={member.photoUrl} className="w-full h-full object-cover" />
            ) : (
                <div className="w-full h-full flex items-center justify-center text-blue-900 font-bold text-[10px]">
                    {member.name?.substring(0,2).toUpperCase()}
                </div>
            );
            return (
                <div className={`${size} rounded-full bg-white border border-gray-200 relative flex-shrink-0 overflow-hidden`}>
                    {content}
                </div>
            );
        };

        const PriorityBadge = ({ level, onClick }) => {
            const styles = { 
                high: "bg-red-100 text-red-700 hover:bg-red-200 border-red-200", 
                medium: "bg-amber-100 text-amber-700 hover:bg-amber-200 border-amber-200", 
                low: "bg-emerald-100 text-emerald-700 hover:bg-emerald-200 border-emerald-200" 
            };
            const labels = { high: "Alta", medium: "M√©dia", low: "Baixa" };
            const safeLevel = styles[level] ? level : 'low';
            
            return (
                <button 
                    onClick={(e) => { e.stopPropagation(); onClick && onClick(); }} 
                    className={`flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold border transition-all active:scale-95 ${styles[safeLevel]}`}
                    title="Clique para alterar prioridade"
                >
                    <Flag size={10} fill="currentColor" /> {labels[safeLevel]}
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children, fullScreen, maxWidth = "max-w-lg", hideHeader = false }) => {
            useEffect(() => {
                if (isOpen) { document.body.style.overflow = 'hidden'; } else { document.body.style.overflow = 'unset'; }
                return () => { document.body.style.overflow = 'unset'; };
            }, [isOpen]);

            if (!isOpen) return null;
            
            const content = (
                <div className={`bg-white ${fullScreen ? 'fixed inset-0 z-[100] flex flex-col' : `rounded-2xl shadow-2xl w-full ${maxWidth} max-h-[90vh] overflow-hidden flex flex-col bg-white relative z-[100]`}`}>
                    {!hideHeader && (
                        <div className="p-4 border-b bg-[#1e1b4b] text-white flex justify-between items-center shrink-0">
                            <div className="flex items-center gap-2">
                                {title === 'Configura√ß√µes' && <Settings size={18}/>}
                                <h3 className="font-bold">{title}</h3>
                            </div>
                            <button onClick={onClose}><X size={20}/></button>
                        </div>
                    )}
                    {hideHeader && <button onClick={onClose} className="absolute top-4 right-4 z-50 p-2 bg-black/10 hover:bg-black/20 rounded-full text-gray-800"><X size={20}/></button>}
                    <div className="p-0 overflow-y-auto flex-1 bg-white relative">{children}</div>
                </div>
            );

            const modalMarkup = fullScreen ? (
                <div className="fixed inset-0 z-[9999] bg-white animate-in" style={{animationDuration: '200ms'}}>{content}</div>
            ) : (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-in" style={{animationDuration: '200ms'}}>{content}</div>
            );

            return createPortal(modalMarkup, document.body);
        };

        const Toast = ({ message, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 5000); return () => clearTimeout(timer); }, [onClose]);
            return createPortal(
                <div className="fixed top-6 right-6 z-[10000] bg-white rounded-xl shadow-2xl border-l-4 border-blue-600 p-4 flex items-start gap-3 max-w-sm slide-in-notification">
                    <div className="bg-blue-100 p-2 rounded-full text-blue-600"><Bell size={20}/></div>
                    <div className="flex-1"><h4 className="font-bold text-gray-800 text-sm">Nova Atualiza√ß√£o</h4><p className="text-xs text-gray-600 mt-1">{message}</p></div>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={14}/></button>
                </div>,
                document.body
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={title} maxWidth="max-w-sm">
                    <div className="p-6">
                        <p className="text-sm text-gray-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-bold">Cancelar</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg text-sm font-bold">Sim, confirmar</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- Workload Detail Modal (NOVO) ---
        const WorkloadDetailModal = ({ isOpen, onClose, member, memberTasks, dbOperations, allMembers, events }) => {
            const [actionType, setActionType] = useState(null); // 'delete' or 'reassign'
            const [selectedTask, setSelectedTask] = useState(null);
            const [reassignTo, setReassignTo] = useState("");
            
            if (!isOpen || !member) return null;

            // Helper para achar nome do evento
            const getEventTitle = (eventId) => {
                const evt = events.find(e => e.id === eventId);
                return evt ? evt.title : "Evento Desconhecido";
            };

            const handleRequestDelete = (task) => {
                setSelectedTask(task);
                setActionType('delete');
            };

            const handleRequestReassign = (task) => {
                setSelectedTask(task);
                setReassignTo(""); // reset
                setActionType('reassign');
            };

            const handleConfirmAction = () => {
                if (actionType === 'delete' && selectedTask) {
                    dbOperations.deleteTask(selectedTask.id);
                } else if (actionType === 'reassign' && selectedTask && reassignTo) {
                    const newResponsible = allMembers.find(m => m.id === reassignTo);
                    if (newResponsible) {
                        dbOperations.updateTask(selectedTask.id, { responsible: newResponsible });
                    }
                }
                setActionType(null);
                setSelectedTask(null);
                setReassignTo("");
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Carga de Trabalho: ${member.name}`} maxWidth="max-w-2xl">
                    <div className="p-6">
                        <div className="flex items-center gap-4 mb-6 p-4 bg-gray-50 rounded-xl border border-gray-100">
                            <div className="w-16 h-16 rounded-full overflow-hidden border-2 border-white shadow-md">
                                <Avatar member={member} size="w-full h-full" />
                            </div>
                            <div>
                                <h3 className="text-lg font-bold text-gray-900">{member.name}</h3>
                                <p className="text-sm text-gray-500">{member.role}</p>
                                <div className="flex gap-2 mt-2">
                                    <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold">{memberTasks.filter(t=>t.status!=='done').length} Pendentes</span>
                                    <span className="text-xs bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded-full font-bold">{memberTasks.filter(t=>t.status==='done').length} Feitas</span>
                                </div>
                            </div>
                        </div>

                        <h4 className="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wider">Lista de Tarefas</h4>
                        
                        <div className="space-y-2 max-h-[50vh] overflow-y-auto pr-2">
                            {memberTasks.length === 0 ? (
                                <p className="text-center text-gray-400 py-8 italic">Nenhuma tarefa atribu√≠da no momento.</p>
                            ) : (
                                memberTasks.map(task => (
                                    <div key={task.id} className="flex items-center justify-between p-3 bg-white border border-gray-100 rounded-lg hover:shadow-sm transition-all group">
                                        <div className="flex-1 min-w-0 pr-4">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-[9px] text-gray-400 font-bold uppercase tracking-wider border border-gray-200 px-1 rounded">{getEventTitle(task.eventId)}</span>
                                                <PriorityBadge level={task.priority} />
                                                {task.status === 'done' && <span className="text-[10px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded font-bold">Conclu√≠da</span>}
                                            </div>
                                            <p className={`text-sm font-medium truncate ${task.status === 'done' ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{task.text}</p>
                                        </div>
                                        
                                        <div className="flex items-center gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                            <button 
                                                onClick={() => handleRequestReassign(task)}
                                                className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" 
                                                title="Reatribuir Tarefa"
                                            >
                                                <RefreshCw size={16}/>
                                            </button>
                                            <button 
                                                onClick={() => handleRequestDelete(task)}
                                                className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" 
                                                title="Excluir Tarefa"
                                            >
                                                <Trash2 size={16}/>
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {/* Modal de Confirma√ß√£o para A√ß√µes */}
                    <ConfirmModal 
                        isOpen={!!actionType} 
                        onClose={() => { setActionType(null); setSelectedTask(null); }} 
                        onConfirm={handleConfirmAction}
                        title={actionType === 'delete' ? 'Excluir Tarefa' : 'Reatribuir Tarefa'}
                        message={
                            actionType === 'delete' 
                            ? `Tem certeza que deseja excluir a tarefa "${selectedTask?.text}"?` 
                            : (
                                <div className="space-y-3">
                                    <p>Selecione o novo respons√°vel para a tarefa <strong>"{selectedTask?.text}"</strong>:</p>
                                    <select 
                                        className="w-full p-2 border rounded-lg text-sm bg-gray-50"
                                        value={reassignTo}
                                        onChange={e => setReassignTo(e.target.value)}
                                    >
                                        <option value="">Selecione...</option>
                                        {allMembers.filter(m => m.id !== member.id).map(m => (
                                            <option key={m.id} value={m.id}>{m.name}</option>
                                        ))}
                                    </select>
                                </div>
                            )
                        }
                    />
                </Modal>
            );
        };

        const NotificationsDropdown = ({ onClose, notifications }) => {
            return (
                <div className="absolute top-14 right-0 w-80 bg-white rounded-2xl shadow-2xl border border-gray-100 z-[100] animate-in fade-in zoom-in-95 duration-200 overflow-hidden">
                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center"><span className="font-bold text-gray-800 text-sm flex items-center gap-2"><Bell size={14} className="text-blue-600"/> Notifica√ß√µes</span><button onClick={onClose}><X size={16} className="text-gray-400 hover:text-gray-600"/></button></div>
                    <div className="max-h-80 overflow-y-auto">
                        {notifications.length === 0 ? <div className="p-8 text-center text-gray-400 text-xs">Tudo limpo por aqui! ‚ú®</div> : 
                        notifications.map((notif, idx) => (
                            <div key={idx} className="p-4 border-b border-gray-50 hover:bg-blue-50/50 transition-colors cursor-pointer group">
                                <div className="flex gap-3"><div className="mt-1 w-2 h-2 rounded-full flex-shrink-0 bg-blue-500 ring-4 ring-blue-100"></div><div><p className="text-sm font-semibold text-gray-800 group-hover:text-blue-700 transition-colors">{notif.text}</p><p className="text-xs text-gray-400 mt-1 flex items-center gap-1"><Clock size={10}/> {notif.date}</p></div></div>
                            </div>
                        ))}
                    </div>
                    <div className="p-2 bg-gray-50 text-center border-t border-gray-100"><button className="text-xs font-bold text-blue-600 hover:text-blue-800">Marcar todas como lidas</button></div>
                </div>
            );
        };

        const EditEventModal = ({ isOpen, onClose, event, members, onUpdate }) => {
            const [formData, setFormData] = useState({
                title: '', location: '', startDate: '', endDate: '', responsible: '', cover: null
            });
            const coverInputRef = useRef(null);

            useEffect(() => {
                if (isOpen && event) {
                    setFormData({
                        title: event.title || '',
                        location: event.location || '',
                        startDate: event.startDate || '',
                        endDate: event.endDate || '',
                        responsible: event.responsibleId || '',
                        cover: event.coverUrl || null
                    });
                }
            }, [isOpen, event]);

            const handleCoverUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    compressImage(file, 800).then(url => {
                        setFormData(prev => ({ ...prev, cover: url }));
                    });
                }
            };

            const handleSubmit = () => {
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const [y, m, d] = dateStr.split('-');
                    return `${d}/${m}/${y}`;
                };

                const dateRange = `${formatDate(formData.startDate)} - ${formData.endDate ? formatDate(formData.endDate) : formatDate(formData.startDate)}`;

                onUpdate(event.id, {
                    title: formData.title,
                    location: formData.location,
                    startDate: formData.startDate,
                    endDate: formData.endDate,
                    dateRange: dateRange,
                    responsibleId: formData.responsible,
                    coverUrl: formData.cover
                });
                onClose();
            };

            if (!isOpen) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Editar Informa√ß√µes do Evento">
                    <div className="p-6 space-y-4">
                        <div className="relative w-full h-40 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center overflow-hidden group hover:border-blue-400 transition-colors cursor-pointer" onClick={() => coverInputRef.current?.click()}>
                            {formData.cover ? (
                                <img src={formData.cover} className="w-full h-full object-cover" />
                            ) : (
                                <div className="text-center p-4">
                                    <ImageIcon size={32} className="mx-auto text-gray-400 mb-2"/><p className="text-sm font-bold text-gray-500">Adicionar Capa do Evento</p>
                                </div>
                            )}
                            <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <span className="text-white font-bold text-sm"><Camera size={20} className="inline mr-2"/>Alterar Capa</span>
                            </div>
                            <input type="file" ref={coverInputRef} onChange={handleCoverUpload} className="hidden" accept="image/*"/>
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome do Evento</label>
                            <input className="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-gray-50 focus:bg-white transition-colors" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})}/>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Local</label>
                            <div className="flex items-center gap-2 border rounded-xl p-3 bg-gray-50 focus-within:bg-white focus-within:border-blue-500 transition-colors">
                                <MapPin size={18} className="text-gray-400"/>
                                <input className="flex-1 outline-none text-sm bg-transparent" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})}/>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data In√≠cio</label>
                                <input type="date" className="w-full p-3 border rounded-xl text-sm bg-gray-50 focus:bg-white outline-none focus:border-blue-500" value={formData.startDate} onChange={e => setFormData({...formData, startDate: e.target.value})}/>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data Fim</label>
                                <input type="date" className="w-full p-3 border rounded-xl text-sm bg-gray-50 focus:bg-white outline-none focus:border-blue-500" value={formData.endDate} onChange={e => setFormData({...formData, endDate: e.target.value})}/>
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Respons√°vel Principal</label>
                            <select className="w-full p-3 border rounded-xl bg-gray-50 text-sm outline-none focus:border-blue-500" value={formData.responsible} onChange={e => setFormData({...formData, responsible: e.target.value})}>
                                <option value="">Selecione um gestor...</option>
                                {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                            </select>
                        </div>
                        <div className="pt-4 flex gap-2">
                             <button onClick={onClose} className="flex-1 py-3 rounded-xl font-bold text-gray-600 bg-gray-100 hover:bg-gray-200">Cancelar</button>
                             <button onClick={handleSubmit} className="flex-1 py-3 rounded-xl font-bold text-white bg-blue-900 hover:bg-blue-800">Salvar Altera√ß√µes</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const NewEventModal = ({ isOpen, onClose, members, onCreate, categories }) => {
            const [formData, setFormData] = useState({
                title: '', location: '', startDate: '', endDate: '', responsible: '', team: [], selectedTasks: [], cover: null
            });
            const [isSingleDay, setIsSingleDay] = useState(false); 
            const coverInputRef = useRef(null);

            useEffect(() => {
                if (isOpen) {
                    setFormData(prev => ({ ...prev, selectedTasks: PREDEFINED_TASKS_DATA }));
                    setIsSingleDay(false);
                }
            }, [isOpen]);

            // L√≥gica para sincronizar data fim se for dia √∫nico
            useEffect(() => {
                if (isSingleDay && formData.startDate) {
                    setFormData(prev => ({ ...prev, endDate: prev.startDate }));
                }
            }, [isSingleDay, formData.startDate]);

            if (!isOpen) return null;

            const handleToggleMember = (memberId) => {
                if (formData.team.includes(memberId)) { setFormData({ ...formData, team: formData.team.filter(id => id !== memberId) }); } 
                else { setFormData({ ...formData, team: [...formData.team, memberId] }); }
            };

            const handleToggleTask = (task) => {
                const exists = formData.selectedTasks.some(t => t.text === task.text);
                if (exists) { setFormData({ ...formData, selectedTasks: formData.selectedTasks.filter(t => t.text !== task.text) }); } 
                else { setFormData({ ...formData, selectedTasks: [...formData.selectedTasks, task] }); }
            };

            const handleCoverUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    compressImage(file, 800).then(url => {
                        setFormData({ ...formData, cover: url });
                    });
                }
            };

            const handleSubmit = () => {
                // CORRE√á√ÉO: Adicionada valida√ß√£o expl√≠cita com alerta
                if (!formData.title || !formData.startDate || !formData.responsible) {
                    alert("Por favor, preencha todos os campos obrigat√≥rios: Nome, Data de In√≠cio e Respons√°vel.");
                    return;
                }
                
                // Garantir data fim se for dia √∫nico
                const finalEndDate = isSingleDay ? formData.startDate : formData.endDate;

                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const [y, m, d] = dateStr.split('-');
                    return `${d}/${m}/${y}`;
                };

                const newEvent = {
                    title: formData.title,
                    location: formData.location || 'Local a definir',
                    dateRange: `${formatDate(formData.startDate)} - ${finalEndDate ? formatDate(finalEndDate) : formatDate(formData.startDate)}`,
                    startDate: formData.startDate, // Salva a data crua para facilitar contas
                    endDate: finalEndDate,
                    responsibleId: formData.responsible,
                    teamIds: formData.team,
                    initialTasks: formData.selectedTasks,
                    coverUrl: formData.cover
                };

                onCreate(newEvent);
                setFormData({ title: '', location: '', startDate: '', endDate: '', responsible: '', team: [], selectedTasks: [], cover: null });
            };

            // Agrupar tarefas predefinidas pelas categorias PERSISTIDAS
            const groupedTasks = PREDEFINED_TASKS_DATA.reduce((acc, task) => {
                if (!acc[task.category]) acc[task.category] = [];
                acc[task.category].push(task);
                return acc;
            }, {});

            // CORRE√á√ÉO: Verifica√ß√£o completa para desabilitar bot√£o
            const isFormValid = formData.title && formData.startDate && formData.responsible;

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Criar Novo Evento" maxWidth="max-w-4xl" hideHeader={true}>
                    <div>
                        <div className="bg-gradient-to-r from-blue-900 via-indigo-900 to-blue-900 p-8 text-white relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-10 opacity-10"><Rocket size={120} /></div>
                            <h2 className="text-3xl font-bold mb-2 flex items-center gap-3 relative z-10">
                                <Sparkles className="text-amber-400 animate-pulse"/> Vamos criar o pr√≥ximo sucesso?
                            </h2>
                            <p className="text-blue-200 text-sm max-w-lg relative z-10">Prepare o terreno para um evento inesquec√≠vel. Organize, planeje e execute com excel√™ncia.</p>
                        </div>
                        
                        <div className="p-6 space-y-6">
                            <div className="relative w-full h-40 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center overflow-hidden group hover:border-blue-400 transition-colors cursor-pointer" onClick={() => coverInputRef.current?.click()}>
                                {formData.cover ? (
                                    <img src={formData.cover} className="w-full h-full object-cover" />
                                ) : (
                                    <div className="text-center p-4">
                                        <ImageIcon size={32} className="mx-auto text-gray-400 mb-2"/><p className="text-sm font-bold text-gray-500">Adicionar Capa do Evento</p>
                                    </div>
                                )}
                                <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                    <span className="text-white font-bold text-sm"><Camera size={20} className="inline mr-2"/>Alterar Capa</span>
                                </div>
                                <input type="file" ref={coverInputRef} onChange={handleCoverUpload} className="hidden" accept="image/*"/>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="md:col-span-2">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome do Evento <span className="text-red-500">*</span></label>
                                    <input className="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-gray-50 focus:bg-white transition-colors" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="Ex: Conven√ß√£o 2026"/>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Local</label>
                                    <div className="flex items-center gap-2 border rounded-xl p-3 bg-gray-50 focus-within:bg-white focus-within:border-blue-500 transition-colors">
                                        <MapPin size={18} className="text-gray-400"/>
                                        <input className="flex-1 outline-none text-sm bg-transparent" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} placeholder="Ex: Audit√≥rio Principal"/>
                                    </div>
                                </div>
                                
                                <div className="md:col-span-2 flex items-center gap-2 py-2">
                                    <input 
                                        type="checkbox" 
                                        id="oneDayEvent"
                                        checked={isSingleDay} 
                                        onChange={(e) => setIsSingleDay(e.target.checked)} 
                                        className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 cursor-pointer"
                                    />
                                    <label htmlFor="oneDayEvent" className="text-sm font-bold text-gray-700 cursor-pointer">
                                        √â um evento de dia √∫nico?
                                    </label>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data In√≠cio {isSingleDay && "(Data do Evento)"} <span className="text-red-500">*</span></label>
                                    <input type="date" className="w-full p-3 border rounded-xl text-sm bg-gray-50 focus:bg-white outline-none focus:border-blue-500" value={formData.startDate} onChange={e => setFormData({...formData, startDate: e.target.value})}/>
                                </div>
                                
                                {!isSingleDay && (
                                    <div className="animate-in">
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data Fim</label>
                                        <input type="date" className="w-full p-3 border rounded-xl text-sm bg-gray-50 focus:bg-white outline-none focus:border-blue-500" value={formData.endDate} onChange={e => setFormData({...formData, endDate: e.target.value})}/>
                                    </div>
                                )}
                            </div>

                            <div className="space-y-4 border-t pt-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Respons√°vel Principal <span className="text-red-500">*</span></label>
                                    <select className="w-full p-3 border rounded-xl bg-gray-50 text-sm outline-none focus:border-blue-500" value={formData.responsible} onChange={e => setFormData({...formData, responsible: e.target.value})}>
                                        <option value="">Selecione um gestor...</option>
                                        {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                    </select>
                                    {members.length === 0 && <p className="text-xs text-red-500 mt-1">Adicione membros nas configura√ß√µes para selecionar.</p>}
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Equipe do Evento</label>
                                    <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 border rounded-xl bg-gray-50">
                                        {members.map(m => (
                                            <button 
                                                key={m.id} 
                                                onClick={() => handleToggleMember(m.id)}
                                                className={`flex items-center gap-2 p-1.5 rounded-lg border text-xs transition-colors ${formData.team.includes(m.id) ? 'bg-blue-100 border-blue-300 text-blue-800' : 'bg-white border-gray-200 text-gray-600 hover:border-blue-200'}`}
                                            >
                                                <div className="w-5 h-5 rounded-full overflow-hidden border border-gray-200">
                                                    <Avatar member={m} size="w-full h-full" showCrown={false} />
                                                </div>
                                                {m.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4 border-t pt-4">
                                <label className="block text-xs font-bold text-gray-500 uppercase">Tarefas Pr√©-definidas (Ser√£o criadas automaticamente)</label>
                                <div className="bg-blue-50 border border-blue-100 rounded-lg p-3 text-xs text-blue-800 mb-2 flex items-center gap-2">
                                    <Info size={14}/> Estas tarefas j√° v√™m marcadas para agilizar seu processo. Desmarque as que n√£o precisar.
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-40 overflow-y-auto p-1">
                                    {Object.keys(groupedTasks).map(catId => {
                                        // Busca a categoria nas props (persistidas) ou usa padr√£o se n√£o achar
                                        const cat = categories.find(c => c.id === catId) || DEFAULT_CATEGORIES.find(c => c.id === catId);
                                        // Se a categoria n√£o existir em lugar nenhum (ex: foi deletada), n√£o mostra o grupo
                                        if (!cat) return null;

                                        return (
                                            <div key={catId} className="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                                <h5 className={`text-xs font-bold mb-2 flex items-center gap-1 ${getCategoryStyles(cat?.color || 'gray').split(' ')[0]}`}>{getCategoryIcon(cat?.icon)} {cat?.title}</h5>
                                                <div className="space-y-1">
                                                    {groupedTasks[catId].map((task, idx) => (
                                                        <label key={idx} className="flex items-center gap-2 p-1.5 rounded cursor-pointer hover:bg-white hover:shadow-sm transition-all">
                                                            <input 
                                                                type="checkbox" 
                                                                checked={formData.selectedTasks.some(t => t.text === task.text)} 
                                                                onChange={() => handleToggleTask(task)} 
                                                                className="rounded text-blue-600 focus:ring-blue-500"
                                                            />
                                                            <span className="text-xs text-gray-700">{task.text}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="flex justify-end pt-6 border-t mt-4">
                                <button onClick={handleSubmit} disabled={!isFormValid} className="w-full md:w-auto bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-xl font-bold hover:shadow-lg hover:scale-105 transition-all disabled:opacity-50 disabled:hover:scale-100 animate-shine flex items-center justify-center gap-2 shadow-blue-500/30 disabled:cursor-not-allowed">
                                    <Rocket size={20} /> Lan√ßar Evento
                                </button>
                            </div>
                        </div>
                    </div>
                </Modal>
            );
        };

        const TaskDetailModal = ({ task, isOpen, onClose, members, dbOperations }) => {
            const [messageText, setMessageText] = useState("");
            const [isSelectingResponsible, setIsSelectingResponsible] = useState(false);
            const [isSelectingSupport, setIsSelectingSupport] = useState(false);
            const [previewImage, setPreviewImage] = useState(null);
            const [chatAttachment, setChatAttachment] = useState(null);
            const [newSubtask, setNewSubtask] = useState("");
            const [confirmDeleteMessageId, setConfirmDeleteMessageId] = useState(null);
            const chatContainerRef = useRef(null);
            const chatFileRef = useRef(null); 
            const [selectedSender, setSelectedSender] = useState(members[0] || {name: 'Eu', id: 'me'});

            const [taskPhase, setTaskPhase] = useState(task?.phase || 'pre');

            const messages = task?.messages || [];
            
            useEffect(() => { 
                if (isOpen && chatContainerRef.current) { chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight; }
                if (isOpen && task && members.length > 0) {
                    const me = members.find(m => m.name === 'Paulo Mokarzel') || members[0];
                    if (me) setSelectedSender(me);
                    setTaskPhase(task.phase || 'pre');
                }
            }, [messages, isOpen, task, members]);

            if (!task) return null;
            
            const responsible = task.responsible || { name: "N√£o definido", role: "-", avatar: "?" };
            const supportList = task.support || [];
            const attachments = task.attachments || [];
            const subtasks = task.subtasks || [];
            
            const statusConfig = STATUS_COLUMNS.find(c => c.id === task.status) || STATUS_COLUMNS[0];

            const handleSend = () => { 
                if (!messageText.trim() && !chatAttachment) return;
                const newMessage = { 
                    sender: selectedSender.name, 
                    senderId: selectedSender.id, 
                    text: messageText, 
                    attachment: chatAttachment, 
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now() // Adicionado timestamp para ordena√ß√£o global
                };
                dbOperations.updateTask(task.id, { messages: [...messages, newMessage] });
                setMessageText(""); 
                setChatAttachment(null);
            };

            const handleAddSubtask = () => {
                if(!newSubtask.trim()) return;
                dbOperations.updateTask(task.id, { subtasks: [...subtasks, { id: Date.now(), text: newSubtask, completed: false }] });
                setNewSubtask("");
            };

            const toggleSubtask = (subId) => {
                dbOperations.updateTask(task.id, { subtasks: subtasks.map(s => s.id === subId ? {...s, completed: !s.completed} : s) });
            };

            const deleteSubtask = (subId) => {
                if(window.confirm("Excluir este complemento?")) {
                    dbOperations.updateTask(task.id, { subtasks: subtasks.filter(s => s.id !== subId) });
                }
            };

            const handleChatImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) { compressImage(file, 400).then(url => { setChatAttachment(url); }); }
            };

            const addSupport = (member) => {
                if (!supportList.find(s => s.id === member.id)) {
                    dbOperations.updateTask(task.id, { support: [...supportList, member] });
                }
                setIsSelectingSupport(false);
            };

            const removeSupport = (memberId) => {
                dbOperations.updateTask(task.id, { support: supportList.filter(s => s.id !== memberId) });
            };

            const handlePhaseChange = (e) => {
                const newPhase = e.target.value;
                setTaskPhase(newPhase);
                dbOperations.updateTask(task.id, { phase: newPhase });
            };
            
            const cyclePriority = () => {
                const order = ['low', 'medium', 'high'];
                const nextIndex = (order.indexOf(task.priority || 'low') + 1) % 3;
                dbOperations.updateTask(task.id, { priority: order[nextIndex] });
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Tarefa #${task.id.toString().slice(-4)}`} fullScreen={true}>
                    <div className="flex flex-col md:flex-row h-full">
                        <div className="flex-1 flex flex-col border-r border-gray-100 bg-gray-50/50 overflow-y-auto">
                            <div className="p-6 border-b bg-white">
                                <div className="flex justify-between items-start mb-4">
                                    <div className="flex items-center gap-3">
                                        <PriorityBadge level={task.priority} onClick={cyclePriority} />
                                        <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold border ${getCategoryStyles(statusConfig.color)}`}>
                                            {statusConfig.title}
                                        </span>
                                    </div>
                                    <select value={taskPhase} onChange={handlePhaseChange} className="text-xs bg-gray-100 border border-gray-300 rounded px-2 py-1 outline-none focus:border-blue-500 font-medium text-gray-700">
                                        <option value="pre">Pr√©-Evento</option>
                                        <option value="during">Durante</option>
                                        <option value="post">P√≥s-Evento</option>
                                    </select>
                                </div>
                                
                                <h2 className="text-xl font-bold text-gray-900 leading-tight mb-6">{task.text}</h2>
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="relative">
                                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Respons√°vel</p>
                                        <button onClick={() => setIsSelectingResponsible(!isSelectingResponsible)} className="flex items-center gap-2 p-1.5 -ml-1.5 rounded-lg hover:bg-gray-100 transition-colors text-left group w-full">
                                            <Avatar member={responsible} size="w-8 h-8" />
                                            <div className="flex-1 min-w-0">
                                                <p className="text-xs font-bold text-gray-800 flex items-center gap-1 truncate">{responsible.name} <ChevronDown size={12}/></p>
                                                <p className="text-[10px] text-gray-500 truncate">{responsible.role}</p>
                                            </div>
                                        </button>
                                        {isSelectingResponsible && (<div className="absolute top-full left-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 z-50 p-2 max-h-48 overflow-y-auto"><div className="space-y-1">{members.map((member) => (<button key={member.id} onClick={() => { dbOperations.updateTask(task.id, { responsible: member }); setIsSelectingResponsible(false); }} className={`w-full flex items-center gap-3 p-2 rounded-lg hover:bg-blue-50 transition-colors text-left ${responsible.name === member.name ? 'bg-blue-50' : ''}`}><Avatar member={member} size="w-6 h-6" /><span className="text-xs font-bold">{member.name}</span></button>))}</div></div>)}
                                    </div>
                                    <div className="relative">
                                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Apoio</p>
                                        <div className="flex flex-wrap gap-2">
                                            {supportList.map(member => (
                                                <div key={member.id} className="relative group cursor-pointer" onClick={() => removeSupport(member.id)}>
                                                    <Avatar member={member} size="w-8 h-8" />
                                                    <div className="absolute inset-0 bg-black/20 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><X size={12} className="text-white"/></div>
                                                </div>
                                            ))}
                                            <button onClick={() => setIsSelectingSupport(!isSelectingSupport)} className="w-8 h-8 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 hover:border-blue-400 hover:text-blue-500 transition-colors"><Plus size={14}/></button>
                                        </div>
                                        {isSelectingSupport && (<div className="absolute top-full left-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 z-50 p-2 max-h-48 overflow-y-auto"><div className="space-y-1">{members.map((member) => (<button key={member.id} onClick={() => addSupport(member)} className={`w-full flex items-center gap-3 p-2 rounded-lg hover:bg-blue-50 transition-colors text-left`}><Avatar member={member} size="w-6 h-6" /><span className="text-xs font-bold">{member.name}</span></button>))}</div></div>)}
                                    </div>
                                    <div className="col-span-2">
                                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Custo Estimado</p>
                                        <div className="flex items-center gap-2 bg-white border border-gray-200 rounded-lg p-2 max-w-[200px]">
                                            <DollarSign size={14} className="text-gray-400"/>
                                            <input type="number" className="w-full text-sm font-bold text-gray-700 outline-none" placeholder="0,00" value={task.cost || ''} onChange={(e) => dbOperations.updateTask(task.id, { cost: e.target.value })} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="p-4 bg-white border-b border-gray-100">
                                <h4 className="font-bold text-xs text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-2"><Layers size={14}/> Complementos</h4>
                                <div className="space-y-2 mb-3">
                                    {subtasks.map(sub => (
                                        <div key={sub.id} className="flex items-center gap-2 group">
                                            <button onClick={() => toggleSubtask(sub.id)} className={`w-4 h-4 rounded border flex items-center justify-center transition-colors ${sub.completed ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300 hover:border-blue-400'}`}>{sub.completed && <Check size={10}/>}</button>
                                            <span className={`text-sm flex-1 ${sub.completed ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{sub.text}</span>
                                            <button onClick={() => deleteSubtask(sub.id)} className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500"><X size={14}/></button>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <input value={newSubtask} onChange={(e) => setNewSubtask(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddSubtask()} placeholder="Adicionar complemento..." className="flex-1 text-xs p-2 bg-gray-50 rounded border border-gray-200 outline-none focus:border-blue-300" />
                                    <button onClick={handleAddSubtask} disabled={!newSubtask} className="p-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 disabled:opacity-50"><Plus size={14}/></button>
                                </div>
                            </div>

                            <div className="flex-1 flex flex-col bg-slate-100 overflow-hidden">
                                <div className="p-3 border-b bg-white/50 backdrop-blur-sm flex items-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-wider sticky top-0 z-10"><MessageSquare size={14}/> Coment√°rios</div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-6" ref={chatContainerRef}>
                                    {messages.map((msg, i) => {
                                        const isMe = msg.senderId === selectedSender.id;
                                        const senderMember = members.find(m => m.id === msg.senderId) || { name: msg.sender, photoUrl: null };
                                        return (
                                            <div key={i} className={`flex gap-3 group/msg ${isMe ? 'flex-row-reverse' : ''}`}>
                                                <Avatar member={senderMember} size="w-8 h-8" />
                                                <div className={`max-w-[75%] flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="text-[10px] font-bold text-gray-600">{senderMember.name}</span>
                                                        <span className="text-[9px] text-gray-400">{msg.time}</span>
                                                        <button onClick={() => setConfirmDeleteMessageId(i)} className="opacity-0 group-hover/msg:opacity-100 text-gray-400 hover:text-red-500 transition-opacity"><Trash2 size={10}/></button>
                                                    </div>
                                                    <div className={`p-3 rounded-2xl text-sm shadow-sm relative group ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-700 border border-gray-200 rounded-tl-none'}`}>
                                                        {msg.attachment && (<div className="mb-2 rounded-lg overflow-hidden cursor-pointer bg-black/5 hover:opacity-90 transition-opacity" onClick={() => setPreviewImage(msg.attachment)}><img src={msg.attachment} className="max-w-full h-32 object-cover" alt="Anexo" /></div>)}
                                                        <p className="whitespace-pre-wrap">{msg.text}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="p-3 bg-white border-t border-gray-200">
                                    {chatAttachment && (<div className="flex items-center gap-2 mb-2 p-2 bg-blue-50 rounded-lg border border-blue-100 text-xs text-blue-700"><ImageIcon size={14}/> Imagem anexada <button onClick={() => setChatAttachment(null)} className="ml-auto hover:text-red-500"><X size={14}/></button></div>)}
                                    <div className="flex flex-col gap-2">
                                        <div className="flex items-center gap-2 text-xs text-gray-500 px-1"><span>Falando como:</span><select className="bg-transparent font-bold text-blue-900 outline-none cursor-pointer hover:bg-gray-50 rounded p-1" value={selectedSender.id} onChange={(e) => setSelectedSender(members.find(m => m.id === e.target.value))}>{members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}</select></div>
                                        <div className="flex items-end gap-2 bg-gray-50 p-2 rounded-xl border border-gray-200 focus-within:ring-2 ring-blue-100 transition-all">
                                            <button onClick={() => chatFileRef.current?.click()} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Anexar imagem"><Paperclip size={18} /></button><input type="file" ref={chatFileRef} onChange={handleChatImageUpload} className="hidden" accept="image/*" />
                                            <textarea rows={1} placeholder="Escreva uma mensagem..." className="flex-1 text-sm p-2 bg-transparent outline-none text-gray-700 resize-none max-h-24" value={messageText} onChange={(e) => setMessageText(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }}} />
                                            <button onClick={handleSend} disabled={!messageText.trim() && !chatAttachment} className="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"><Send size={16} /></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="w-full md:w-80 bg-white border-l border-gray-100 flex flex-col h-full overflow-y-auto">
                            <div className="p-4 border-b border-gray-100">
                                <h4 className="font-bold text-sm text-gray-800 flex items-center gap-2 mb-4"><Paperclip size={16}/> Arquivos</h4>
                                <div className="space-y-2 mb-4">
                                    {attachments.map(att => (<div key={att.id} className="flex items-center gap-3 p-2 rounded-lg border border-gray-100 bg-gray-50 hover:bg-blue-50 transition-colors group"><div className="w-8 h-8 rounded bg-white border border-gray-200 flex items-center justify-center text-blue-600"><FileText size={16}/></div><div className="flex-1 min-w-0"><p className="text-xs font-bold text-gray-700 truncate">{att.name}</p><p className="text-[10px] text-gray-400">{att.size}</p></div><button onClick={() => { if(window.confirm("Excluir?")) dbOperations.updateTask(task.id, { attachments: attachments.filter(a => a.id !== att.id) }); }} className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500"><X size={14}/></button></div>))}
                                </div>
                                <label className="flex items-center justify-center gap-2 w-full p-2 border border-dashed border-blue-300 rounded-lg text-xs font-bold text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors"><Plus size={14}/> Adicionar Arquivo<input type="file" className="hidden" onChange={(e) => { const file = e.target.files[0]; if(file) dbOperations.updateTask(task.id, { attachments: [...attachments, { id: Date.now(), name: file.name, size: (file.size/1024).toFixed(1)+'KB' }] }); }}/></label>
                            </div>
                        </div>
                    </div>
                    <ImagePreviewModal isOpen={!!previewImage} onClose={() => setPreviewImage(null)} imageUrl={previewImage} />
                    <ConfirmModal isOpen={confirmDeleteMessageId !== null} onClose={() => setConfirmDeleteMessageId(null)} onConfirm={() => onDeleteMessage(task.id, confirmDeleteMessageId)} title="Excluir Coment√°rio" message="Tem certeza que deseja excluir este coment√°rio?" />
                </Modal>
            );
        };

        const ManageCategoriesModal = ({ isOpen, onClose, categories, onAdd, onUpdate, onDelete }) => {
            const [editingId, setEditingId] = useState(null);
            const [formData, setFormData] = useState({ title: '', icon: 'box', color: 'blue' });
            const [confirmDeleteId, setConfirmDeleteId] = useState(null);

            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (!formData.title) return; 
                if (editingId) { onUpdate({ id: editingId, ...formData }); setEditingId(null); } 
                else { onAdd({ ...formData, id: Date.now().toString() }); } 
                setFormData({ title: '', icon: 'box', color: 'blue' }); 
            };
            const handleEdit = (cat) => { setEditingId(cat.id); setFormData({ title: cat.title, icon: cat.icon || 'box', color: cat.color || 'blue' }); };
            
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Gerenciar Categorias">
                    <div className="p-6 space-y-6">
                        <form onSubmit={handleSubmit} className="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4">
                            <div className="flex items-center justify-between"><h4 className="text-sm font-bold text-gray-700">{editingId ? 'Editar Categoria' : 'Nova Categoria'}</h4></div>
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome</label><input value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-2 border rounded-lg outline-none focus:border-blue-500"/></div>
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">√çcone</label><div className="flex flex-wrap gap-2">{Object.keys(ICON_MAP).map(icon => { const Icon = ICON_MAP[icon]; return (<button key={icon} type="button" onClick={() => setFormData({...formData, icon})} className={`p-2 rounded-lg border ${formData.icon === icon ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-200 text-gray-500'}`}><Icon size={16}/></button>); })}</div></div>
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Cor Pastel</label><div className="flex flex-wrap gap-2">{PASTEL_COLORS.map(color => (<button key={color.id} type="button" onClick={() => setFormData({...formData, color: color.id})} className={`w-8 h-8 rounded-full border-2 ${formData.color === color.id ? 'border-gray-600 scale-110' : 'border-transparent'}`} style={{backgroundColor: color.hex}}></button>))}</div></div>
                            <button type="submit" className="w-full bg-blue-900 text-white py-2 rounded-lg font-bold">{editingId ? 'Salvar' : 'Adicionar'}</button>
                            {editingId && <button type="button" onClick={() => { setEditingId(null); setFormData({ title: '', icon: 'box', color: 'blue' }); }} className="w-full text-gray-500 text-xs underline mt-2">Cancelar Edi√ß√£o</button>}
                        </form>
                        <div className="space-y-2 max-h-60 overflow-y-auto">{categories.map(cat => {
                            const catColor = PASTEL_COLORS.find(c => c.id === cat.color) || PASTEL_COLORS[0];
                            return (<div key={cat.id} className="flex items-center justify-between p-3 bg-white border rounded-lg"><div className="flex items-center gap-2"><div className={`p-1.5 rounded-lg ${catColor.bg} ${catColor.text}`}>{getCategoryIcon(cat.icon)}</div><span className="font-medium text-gray-700">{cat.title}</span></div><div className="flex gap-1"><button onClick={() => handleEdit(cat)} className="p-2 text-blue-600"><Edit2 size={16}/></button><button onClick={() => setConfirmDeleteId(cat.id)} className="p-2 text-red-600"><Trash2 size={16}/></button></div></div>);
                        })}</div>
                    </div>
                    <ConfirmModal isOpen={!!confirmDeleteId} onClose={() => setConfirmDeleteId(null)} onConfirm={() => onDelete(confirmDeleteId)} title="Excluir Categoria" message="Tem certeza? Isso pode afetar tarefas existentes." />
                </Modal>
            );
        };

        const SettingsModal = ({ isOpen, onClose, members, logo, setLogo, onUpdateLogo, onAddMember, onUpdateMember, onDeleteMember, manager, onUpdateManager, geminiKey, onUpdateGeminiKey }) => {
            const [newMemberName, setNewMemberName] = useState('');
            const [newMemberRole, setNewMemberRole] = useState('');
            const fileInputRef = useRef(null);
            const managerPhotoInputRef = useRef(null);
            const memberPhotoInputRef = useRef(null);
            const editPhotoInputRef = useRef(null);
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editRole, setEditRole] = useState('');
            const [editPhoto, setEditPhoto] = useState(null);
            const [newMemberPhoto, setNewMemberPhoto] = useState(null);
            const [confirmDeleteMemberId, setConfirmDeleteMemberId] = useState(null);
            const [localGeminiKey, setLocalGeminiKey] = useState(geminiKey || '');
            
            const [localManagerName, setLocalManagerName] = useState(manager?.name || '');
            const [localManagerRole, setLocalManagerRole] = useState(manager?.role || 'Gestor da Equipe');
            
            useEffect(() => {
                if(manager) {
                    setLocalManagerName(manager.name);
                    setLocalManagerRole(manager.role);
                }
            }, [manager]);

            useEffect(() => {
                setLocalGeminiKey(geminiKey || '');
            }, [geminiKey]);

            const handleLogoUpload = (e) => { const file = e.target.files[0]; if(file) compressImage(file, 200).then(onUpdateLogo); };
            const handleManagerPhotoUpload = (e) => { const file = e.target.files[0]; if(file) compressImage(file, 200).then(url => onUpdateManager({ ...manager, photoUrl: url })); };
            const handleMemberPhotoUpload = (e) => { const file = e.target.files[0]; if(file) compressImage(file, 100).then(setNewMemberPhoto); };
            const handleEditPhotoUpload = (e) => { const file = e.target.files[0]; if(file) compressImage(file, 100).then(setEditPhoto); };
            
            const handleAdd = (e) => { e.preventDefault(); if (!newMemberName || !newMemberRole) return; onAddMember({ name: newMemberName, role: newMemberRole, photoUrl: newMemberPhoto }); setNewMemberName(''); setNewMemberRole(''); setNewMemberPhoto(null); };
            const startEdit = (member) => { setEditingId(member.id); setEditName(member.name); setEditRole(member.role); setEditPhoto(member.photoUrl || null); };
            const saveEdit = (id) => { onUpdateMember({ id, name: editName, role: editRole, photoUrl: editPhoto }); setEditingId(null); };

            const saveManagerInfo = () => {
                 onUpdateManager({ ...(manager || {}), name: localManagerName || "", role: localManagerRole || "Gestor da Equipe" });
            };

            const saveGeminiKey = () => {
                onUpdateGeminiKey(localGeminiKey);
            };

            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Configura√ß√µes" maxWidth="max-w-2xl">
                    <div className="p-6 space-y-8">
                        <section>
                            <h4 className="text-blue-900 font-bold flex items-center gap-2 mb-4"><Key size={18} /> Chave API Gemini (IA)</h4>
                            <div className="bg-white border border-gray-200 rounded-xl p-4">
                                <p className="text-xs text-gray-500 mb-2">Para ativar a IA, insira sua chave da Google AI Studio aqui.</p>
                                <div className="flex gap-2">
                                    <input 
                                        type="password" 
                                        value={localGeminiKey} 
                                        onChange={(e) => setLocalGeminiKey(e.target.value)} 
                                        onBlur={saveGeminiKey}
                                        className="flex-1 p-2 border rounded-lg text-sm outline-none focus:border-blue-500" 
                                        placeholder="Cole sua API Key aqui (come√ßa com AIza...)" 
                                    />
                                    <button onClick={saveGeminiKey} className="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-200">Salvar</button>
                                </div>
                            </div>
                        </section>

                        <section>
                            <h4 className="text-blue-900 font-bold flex items-center gap-2 mb-4"><ImageIcon size={18} /> Identidade Visual</h4>
                            <div className="bg-white border border-gray-200 rounded-xl p-6 flex flex-col md:flex-row items-center gap-6">
                                <div className="h-16 flex items-center justify-center px-4 bg-gray-50 rounded-lg border border-gray-100 min-w-[150px]">{logo ? <img src={logo} className="h-10 w-auto object-contain" /> : <span className="text-sm text-gray-400">Sem Logo</span>}</div>
                                <div className="flex-1"><p className="font-bold text-gray-800 text-sm mb-1">Carregar logo</p><div className="flex gap-2"><button onClick={() => fileInputRef.current?.click()} className="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 bg-white">Escolher arquivo</button><input type="file" ref={fileInputRef} onChange={handleLogoUpload} className="hidden" accept="image/*" /></div></div>
                            </div>
                        </section>

                        <section>
                            <h4 className="text-blue-900 font-bold flex items-center gap-2 mb-4"><Crown size={18} /> Gestor da Equipe</h4>
                             <div className="bg-white border border-gray-200 rounded-xl p-6 flex flex-col md:flex-row items-center gap-6">
                                <div className="relative group cursor-pointer" onClick={() => managerPhotoInputRef.current?.click()}>
                                    <div className="w-16 h-16 rounded-full overflow-hidden border-2 border-gray-200">
                                         <Avatar member={manager} size="w-full h-full" showCrown={false}/>
                                    </div>
                                    <div className="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><Camera size={16} className="text-white"/></div>
                                    <input type="file" ref={managerPhotoInputRef} onChange={handleManagerPhotoUpload} className="hidden" accept="image/*" />
                                </div>
                                <div className="flex-1 space-y-3">
                                    <input value={localManagerName} onChange={(e) => setLocalManagerName(e.target.value)} onBlur={saveManagerInfo} className="w-full p-2 border rounded-lg text-sm font-bold text-gray-800 outline-none focus:border-blue-500" placeholder="Nome do Gestor" />
                                    <input value={localManagerRole} onChange={(e) => setLocalManagerRole(e.target.value)} onBlur={saveManagerInfo} className="w-full p-2 border rounded-lg text-xs text-gray-500 outline-none focus:border-blue-500" placeholder="Cargo (Ex: Head de Marketing)" />
                                </div>
                            </div>
                        </section>

                        <section>
                            <h4 className="text-blue-900 font-bold flex items-center gap-2 mb-4"><Users size={18} /> Equipe Global</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                {members.map((member) => (
                                    <div key={member.id} className="flex items-center justify-between p-3 border border-gray-200 rounded-xl hover:shadow-sm transition-shadow">
                                            <div className="flex items-center gap-3 w-full">
                                                {editingId === member.id ? (<div className="relative group cursor-pointer" onClick={() => editPhotoInputRef.current?.click()}><div className="w-10 h-10 rounded-full bg-gray-100 border border-gray-200 flex items-center justify-center overflow-hidden">{editPhoto ? <img src={editPhoto} className="w-full h-full object-cover"/> : <Camera size={16} className="text-gray-400"/>}</div><input type="file" ref={editPhotoInputRef} onChange={handleEditPhotoUpload} className="hidden" accept="image/*" /></div>) : (<Avatar member={member} />)}
                                                <div className="flex-1 min-w-0">{editingId === member.id ? (<div className="flex flex-col gap-1"><input value={editName} onChange={e=>setEditName(e.target.value)} className="text-sm border rounded px-1 w-full" placeholder="Nome" /><input value={editRole} onChange={e=>setEditRole(e.target.value)} className="text-xs border rounded px-1 w-full" placeholder="Cargo" /></div>) : (<><p className="font-bold text-gray-800 text-sm truncate">{member.name}</p><p className="text-xs text-gray-500 truncate">{member.role}</p></>)}</div>
                                            </div>
                                            <div className="flex gap-1 ml-2">{editingId === member.id ? (<button onClick={() => saveEdit(member.id)} className="p-2 text-green-600 hover:bg-green-50 rounded-lg"><Check size={16}/></button>) : (<button onClick={() => startEdit(member)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg"><Edit2 size={16}/></button>)}<button onClick={() => setConfirmDeleteMemberId(member.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg"><Trash2 size={16}/></button></div>
                                    </div>
                                ))}
                            </div>
                            <div className="border border-gray-200 rounded-xl p-4 bg-gray-50">
                                <h5 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"><UserPlus size={16}/> Novo Membro</h5>
                                <form onSubmit={handleAdd} className="flex flex-col gap-3">
                                    <div className="flex gap-3"><input placeholder="Nome" value={newMemberName} onChange={e => setNewMemberName(e.target.value)} className="flex-1 p-2 border border-gray-300 rounded-lg outline-none focus:border-blue-500"/><input placeholder="Cargo" value={newMemberRole} onChange={e => setNewMemberRole(e.target.value)} className="flex-1 p-2 border border-gray-300 rounded-lg outline-none focus:border-blue-500"/></div>
                                    <div className="flex items-center gap-2"><button type="button" onClick={() => memberPhotoInputRef.current?.click()} className="text-xs flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"><Camera size={14}/> {newMemberPhoto ? 'Foto Selecionada' : 'Carregar Foto'}</button><input type="file" ref={memberPhotoInputRef} onChange={handleMemberPhotoUpload} className="hidden" accept="image/*" />{newMemberPhoto && <img src={newMemberPhoto} className="w-8 h-8 rounded-full object-cover border" />}</div>
                                    <button type="submit" disabled={!newMemberName} className="bg-blue-900 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-800 disabled:opacity-50 mt-2">Adicionar Membro</button>
                                </form>
                            </div>
                        </section>
                    </div>
                    <ConfirmModal isOpen={!!confirmDeleteMemberId} onClose={() => setConfirmDeleteMemberId(null)} onConfirm={() => onDeleteMember(confirmDeleteMemberId)} title="Excluir Membro" message="Tem certeza que deseja excluir este membro da equipe?" />
                </Modal>
            );
        };

        const AIAssistant = ({ isOpen, onClose, members, events, tasks, manager, totalCost, geminiKey }) => {
            const [input, setInput] = useState("");
            const [messages, setMessages] = useState([{ id: 1, sender: 'ai', text: "Ol√°! Sou sua Assistente de Marketing conectada ao Gemini AI üß†. Pergunte sobre quem est√° livre, o que cada um est√° fazendo ou custos dos eventos!" }]);
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);
            const contextData = { members, events, tasks, manager, totalCost };
            
            const handleSend = async (e) => { 
                e.preventDefault(); 
                if (!input.trim()) return; 
                
                const userMessage = { id: Date.now(), sender: 'user', text: input }; 
                setMessages(prev => [...prev, userMessage]); 
                setInput(""); 
                setIsTyping(true);

                const responseText = await callGeminiFlash(userMessage.text, contextData, geminiKey);
                
                setIsTyping(false);
                setMessages(prev => [...prev, { id: Date.now() + 1, sender: 'ai', text: responseText }]); 
            };
            
            const handleQuickAction = (action) => { const queryMap = { 'status': 'Quem est√° livre e quem est√° ocupado agora?', 'costs': 'Fa√ßa uma an√°lise financeira detalhada dos custos por evento', 'team': 'O que cada membro da equipe est√° fazendo exatamente?', 'dates': 'Qual o pr√≥ximo evento e quantos dias faltam?' }; setInput(queryMap[action]); };
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isTyping]);
            
            if (!isOpen) return null;
            return (
                <div className="fixed bottom-24 right-6 w-80 md:w-96 h-[600px] bg-white rounded-2xl shadow-2xl border border-gray-200 z-[150] flex flex-col overflow-hidden animate-in">
                    <div className="bg-gradient-to-r from-blue-900 to-indigo-900 p-4 text-white flex justify-between items-center shadow-md">
                        <div className="flex items-center gap-2">
                            <div className="relative">
                                <Bot size={24} className="text-blue-200"/>
                                <span className={`absolute -top-1 -right-1 w-2.5 h-2.5 rounded-full border border-blue-900 ${geminiKey ? 'bg-green-400 animate-pulse' : 'bg-red-500'}`}></span>
                            </div>
                            <div>
                                <span className="font-bold text-sm block">Assistente IA</span>
                                <span className="text-[10px] text-blue-200 flex items-center gap-1">
                                    <Sparkles size={8}/> {geminiKey ? 'Gemini Conectado' : 'Modo Offline (Sem Chave)'}
                                </span>
                            </div>
                        </div>
                        <button onClick={onClose}><X size={18} className="text-blue-200 hover:text-white"/></button>
                    </div>
                    
                    <div className="bg-gray-50 p-3 flex gap-2 overflow-x-auto border-b hide-scrollbar">
                        <button onClick={() => handleQuickAction('status')} className="whitespace-nowrap px-3 py-1.5 bg-white border border-blue-100 rounded-lg text-xs font-bold text-blue-700 hover:bg-blue-50 shadow-sm transition-colors">üìä Quem est√° livre?</button>
                        <button onClick={() => handleQuickAction('team')} className="whitespace-nowrap px-3 py-1.5 bg-white border border-blue-100 rounded-lg text-xs font-bold text-blue-700 hover:bg-blue-50 shadow-sm transition-colors">üë• Tarefas Atuais</button>
                        <button onClick={() => handleQuickAction('costs')} className="whitespace-nowrap px-3 py-1.5 bg-white border border-blue-100 rounded-lg text-xs font-bold text-blue-700 hover:bg-blue-50 shadow-sm transition-colors">üí∞ Custos</button>
                    </div>

                    <div className="flex-1 bg-gray-50 p-4 overflow-y-auto space-y-4">
                        {messages.map(m => (
                            <div key={m.id} className={`flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`p-3.5 rounded-2xl text-sm max-w-[85%] shadow-sm ${
                                    m.sender === 'user' 
                                    ? 'bg-blue-600 text-white rounded-tr-none' 
                                    : 'bg-white border border-gray-100 text-gray-700 rounded-tl-none prose prose-sm'
                                }`}>
                                    <div style={{ whiteSpace: 'pre-wrap' }}>{m.text}</div>
                                </div>
                            </div>
                        ))}
                        {isTyping && (
                            <div className="flex justify-start">
                                <div className="bg-white border border-gray-100 p-3 rounded-2xl rounded-tl-none shadow-sm flex items-center gap-1">
                                    <div className="w-2 h-2 bg-blue-400 rounded-full typing-dot"></div>
                                    <div className="w-2 h-2 bg-blue-400 rounded-full typing-dot"></div>
                                    <div className="w-2 h-2 bg-blue-400 rounded-full typing-dot"></div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    <form onSubmit={handleSend} className="p-3 bg-white border-t border-gray-100">
                        <div className="flex items-center gap-2 bg-gray-50 p-2 rounded-xl border border-gray-200 focus-within:ring-2 ring-blue-100 transition-all">
                            <input 
                                className="flex-1 bg-transparent text-sm outline-none text-gray-700 px-2" 
                                placeholder="Pergunte sobre tarefas, custos..." 
                                value={input} 
                                onChange={e => setInput(e.target.value)}
                            />
                            <button type="submit" disabled={!input.trim() || isTyping} className="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors shadow-sm">
                                <Send size={16}/>
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        const DashboardView = ({ onSelectEvent, events, members, onNewEvent, tasks, dbOperations }) => {
            const [selectedWorkloadMember, setSelectedWorkloadMember] = useState(null);

            // Calcular estat√≠sticas reais de carga de trabalho
            const workloadStats = members.map(m => {
                const memberTasks = tasks.filter(t => t.responsible?.id === m.id);
                const pendingCount = memberTasks.filter(t => t.status !== 'done').length;
                const totalCount = memberTasks.length;
                const completionRate = totalCount > 0 
                    ? Math.round(((totalCount - pendingCount) / totalCount) * 100) 
                    : 100;
                
                return { ...m, pendingCount, completionRate, tasks: memberTasks };
            });

            // Status global
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'done').length;
            const globalProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const pendingTotal = totalTasks - completedTasks;

            // --- ORDENA√á√ÉO DE EVENTOS POR DATA (Mais pr√≥ximo primeiro) ---
            const sortedEvents = [...events].sort((a, b) => {
                // Tenta extrair a data de in√≠cio para compara√ß√£o
                const getStartDate = (evt) => {
                    if (evt.startDate) return new Date(evt.startDate);
                    if (evt.dateRange) {
                        const parts = evt.dateRange.split(' - ')[0].split('/');
                        if (parts.length === 3) return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                    }
                    return new Date(8640000000000000); // Data muito distante se n√£o tiver data definida
                };
                return getStartDate(a) - getStartDate(b);
            });

            // --- L√ìGICA DE ATUALIZA√á√ïES (COMENT√ÅRIOS) ---
            // Pega todas as mensagens de todas as tarefas, ordena e pega as 10 √∫ltimas
            const recentUpdates = tasks
                .flatMap(t => (t.messages || []).map(m => ({
                    ...m,
                    taskText: t.text,
                    eventId: t.eventId,
                    rawTime: m.timestamp || Date.now() // Fallback para ordena√ß√£o simples se n√£o tiver timestamp
                })))
                .sort((a, b) => b.rawTime - a.rawTime)
                .slice(0, 10);

            // Helper para pegar cor/membro
            const getMemberByName = (name) => members.find(m => m.name === name) || { name: name, photoUrl: null };

            return (
                <div className="max-w-[1600px] mx-auto grid grid-cols-1 xl:grid-cols-4 gap-8 animate-in">
                    <div className="xl:col-span-3 space-y-8">
                        <section className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="bg-white rounded-[2rem] p-8 shadow-sm border border-gray-100 flex items-center justify-between">
                                <div className="relative w-32 h-32 flex-shrink-0">
                                    <svg className="w-full h-full transform -rotate-90">
                                        <circle cx="64" cy="64" r="56" stroke="#F3F4F6" strokeWidth="12" fill="transparent" />
                                        <circle 
                                            cx="64" cy="64" r="56" 
                                            stroke="#002060" strokeWidth="12" fill="transparent" 
                                            strokeDasharray="351.86" 
                                            strokeDashoffset={351.86 - (351.86 * globalProgress) / 100} 
                                            strokeLinecap="round" 
                                            className="transition-all duration-1000 ease-out"
                                        />
                                    </svg>
                                    <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-800">
                                        <span className="text-3xl font-extrabold text-[#002060]">{globalProgress}%</span>
                                    </div>
                                </div>
                                <div className="flex-1 ml-8">
                                    <h3 className="text-lg font-bold text-gray-900 mb-4">Status Global</h3>
                                    <div className="flex items-center gap-6 text-sm font-semibold">
                                        <span className="text-emerald-600 flex items-center gap-2">
                                            <div className="w-2.5 h-2.5 rounded-full bg-emerald-500"></div> {completedTasks} Feitas
                                        </span>
                                        <span className="text-amber-600 flex items-center gap-2">
                                            <div className="w-2.5 h-2.5 rounded-full bg-amber-500"></div> {pendingTotal} Pend.
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="bg-white rounded-[2rem] p-8 shadow-sm border border-gray-100 flex flex-col justify-center">
                                <h3 className="text-sm font-bold text-gray-900 mb-6 flex items-center gap-2">
                                    <Users size={18} /> Carga de Trabalho (Clique para ver detalhes)
                                </h3>
                                <div className="flex items-end gap-6 overflow-x-auto pb-4 hide-scrollbar">
                                    {workloadStats.map(m => (
                                        <div 
                                            key={m.id} 
                                            onClick={() => setSelectedWorkloadMember(m)}
                                            className="flex flex-col items-center gap-2 min-w-[50px] cursor-pointer group transition-all hover:-translate-y-1"
                                            title="Clique para ver tarefas"
                                        >
                                            <div className="w-10 h-16 bg-gray-100 rounded-full overflow-hidden mb-1 relative border border-gray-100">
                                                <div 
                                                    className="absolute bottom-0 left-0 w-full bg-blue-600 transition-all duration-700 rounded-t-sm group-hover:bg-blue-500" 
                                                    style={{height: `${Math.min(m.pendingCount * 10, 100)}%`}}
                                                ></div>
                                            </div>
                                            <Avatar member={m}/>
                                            <span className={`text-xs font-bold ${m.pendingCount > 5 ? 'text-red-500' : 'text-blue-600'}`}>
                                                {m.pendingCount}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </section>
                        
                        <section>
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-lg font-bold text-blue-900 flex items-center gap-2"><Clock size={20} /> Pr√≥ximos Eventos</h2>
                                <button onClick={onNewEvent} className="bg-blue-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg hover:bg-blue-800 transition-colors"><Plus size={16}/> Novo Evento</button>
                            </div>
                            
                            {/* --- GRID DE EVENTOS (Modificado para exibir em caixas lado a lado) --- */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {sortedEvents.map(event => {
                                    const daysLeft = getDaysLeft(event);
                                    const monthAbbr = getMonthAbbr(event.startDate);
                                    const dayNum = getDayNumber(event.startDate);
                                    
                                    return (
                                        <div key={event.id} onClick={() => onSelectEvent(event)} className="bg-white rounded-[1.5rem] p-5 border border-gray-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group flex flex-col relative overflow-hidden h-full">
                                            {event.coverUrl && (
                                                <div className="absolute inset-0 z-0 h-32">
                                                    <img src={event.coverUrl} className="w-full h-full object-cover opacity-10 group-hover:opacity-20 transition-opacity"/>
                                                    <div className="absolute inset-0 bg-gradient-to-b from-transparent to-white"></div>
                                                </div>
                                            )}
                                            
                                            <div className="flex items-start justify-between mb-4 z-10 relative">
                                                <div className="flex-shrink-0 w-14 h-14 bg-gray-50 rounded-xl flex flex-col items-center justify-center border border-gray-100 group-hover:bg-blue-50 transition-colors">
                                                    <span className="text-[9px] font-bold text-gray-500 uppercase">{monthAbbr}</span>
                                                    <span className="text-xl font-extrabold text-gray-800">{dayNum}</span>
                                                </div>
                                                
                                                {daysLeft !== null && (
                                                    <div className={`text-[10px] font-bold px-2 py-1 rounded-full inline-flex items-center gap-1 ${
                                                        daysLeft > 15 ? 'bg-blue-50 text-blue-700 border border-blue-100' :
                                                        daysLeft > 5 ? 'bg-amber-50 text-amber-700 border border-amber-100' :
                                                        'bg-red-50 text-red-700 border border-red-100'
                                                    }`}>
                                                        <Timer size={10}/>
                                                        {daysLeft > 0 ? `${daysLeft} dias` : daysLeft === 0 ? 'Hoje' : 'Fim'}
                                                    </div>
                                                )}
                                            </div>

                                            <div className="flex-1 z-10 relative flex flex-col justify-end">
                                                <h3 className="text-lg font-bold text-blue-900 group-hover:text-blue-700 leading-tight mb-2 line-clamp-2">{event.title}</h3>
                                                <p className="text-xs text-gray-500 flex items-center gap-2 mb-3"><Truck size={12}/> {event.location}</p>
                                                
                                                <div className="mt-auto pt-3 border-t border-gray-100 flex items-center justify-between">
                                                    <div className="flex -space-x-2">
                                                        {/* Pequena preview da equipe */}
                                                        {(event.teamIds || []).slice(0, 3).map(mid => {
                                                            const m = members.find(mem => mem.id === mid);
                                                            return m ? <div key={m.id} className="w-6 h-6 rounded-full border border-white overflow-hidden"><Avatar member={m} size="w-full h-full"/></div> : null;
                                                        })}
                                                    </div>
                                                    <span className="text-[10px] text-gray-400 font-medium">Ver detalhes ‚Üí</span>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>
                    </div>
                    
                    <div className="xl:col-span-1">
                        <section className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 h-full flex flex-col">
                            <h2 className="text-lg font-bold text-blue-900 mb-6 flex items-center gap-2"><MessageSquare size={20} /> Atualiza√ß√µes</h2>
                            <div className="space-y-4 flex-1 overflow-y-auto max-h-[600px] pr-2">
                                {recentUpdates.length === 0 ? (
                                    <div className="p-4 text-center text-gray-400 text-xs italic">
                                        Nenhum coment√°rio recente. <br/>Comente nas tarefas para ver aqui!
                                    </div>
                                ) : (
                                    recentUpdates.map((update, idx) => {
                                        const member = getMemberByName(update.sender);
                                        return (
                                            <div key={idx} className="flex gap-3 pb-4 border-b border-gray-50 last:border-0 group">
                                                <div className="mt-1 flex-shrink-0">
                                                    <Avatar member={member} size="w-8 h-8"/>
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex justify-between items-start">
                                                        <p className="text-xs font-bold text-gray-900">{member.name}</p>
                                                        <span className="text-[10px] text-gray-400">{update.time}</span>
                                                    </div>
                                                    <p className="text-[10px] text-blue-500 font-medium truncate mb-0.5">Em: {update.taskText}</p>
                                                    <p className="text-xs text-gray-600 line-clamp-2">{update.text}</p>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </section>
                    </div>

                    {/* Modal de Detalhes da Carga de Trabalho */}
                    <WorkloadDetailModal 
                        isOpen={!!selectedWorkloadMember} 
                        onClose={() => setSelectedWorkloadMember(null)} 
                        member={selectedWorkloadMember}
                        memberTasks={selectedWorkloadMember?.tasks || []}
                        dbOperations={dbOperations}
                        allMembers={members}
                        events={events} // PASSANDO OS EVENTOS AQUI
                    />
                </div>
            );
        };

        const EventDetailView = ({ event, onBack, globalMembers, onShowToast, dbOperations, tasks, onUpdateEvent, onDeleteEvent, manager, categories, onAddCategory, onUpdateCategory, onDeleteCategory }) => {
            const [viewMode, setViewMode] = useState('categories');
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedTaskId, setSelectedTaskId] = useState(null);
            const [selectedMemberFilter, setSelectedMemberFilter] = useState('');
            const [selectedPhaseFilter, setSelectedPhaseFilter] = useState('all');
            const [isAddMemberOpen, setIsAddMemberOpen] = useState(false);
            const [isAddTempMember, setIsAddTempMember] = useState(false);
            const [tempMemberName, setTempMemberName] = useState('');
            const [tempMemberRole, setTempMemberRole] = useState('');
            const [isManageCategoriesOpen, setIsManageCategoriesOpen] = useState(false);
            const [isAddTaskOpen, setIsAddTaskOpen] = useState(false);
            const [confirmDeleteTaskId, setConfirmDeleteTaskId] = useState(null);
            const [isTeamExpanded, setIsTeamExpanded] = useState(true);
            const [memberToRemove, setMemberToRemove] = useState(null);
            const [isAgendaModalOpen, setIsAgendaModalOpen] = useState(false);
            const [isEditEventOpen, setIsEditEventOpen] = useState(false);
            const [confirmDeleteEvent, setConfirmDeleteEvent] = useState(false); 
            
            // --- Vari√°veis de Estado Restauradas ---
            const [currentCalendarDate, setCurrentCalendarDate] = useState(new Date());
            const [agendaItems, setAgendaItems] = useState([{ id: 1, date: new Date(2026, 1, 2), title: "In√≠cio do Evento", color: "blue" }, { id: 2, date: new Date(2026, 1, 4), title: "Reuni√£o de Alinhamento", color: "purple" }]);
            const [newAgendaItem, setNewAgendaItem] = useState({ date: '', title: '', color: 'blue' });
            // Categories now come from props
            const [eventTeam, setEventTeam] = useState([]);
            const [draggedTask, setDraggedTask] = useState(null);
            const [dragOverColumn, setDragOverColumn] = useState(null);
            const [totalCost, setTotalCost] = useState(0);

            const eventTasks = tasks.filter(t => t.eventId === event.id);
            const selectedTask = eventTasks.find(t => t.id === selectedTaskId);
            const daysLeft = getDaysLeft(event);
            
            useEffect(() => {
                let combinedTeam = [];
                
                // MUDAN√áA: Adiciona o Gestor/Respons√°vel automaticamente √† lista da equipe
                if (event.responsibleId) {
                    const responsibleMember = globalMembers.find(m => m.id === event.responsibleId);
                    if (responsibleMember) combinedTeam.push(responsibleMember);
                }

                if (event && event.teamIds && event.teamIds.length > 0) { 
                    const globalPart = globalMembers.filter(m => event.teamIds.includes(m.id) && m.id !== event.responsibleId); // Evita duplicar o gestor
                    combinedTeam = [...combinedTeam, ...globalPart]; 
                } else if (event && (!event.teamIds || event.teamIds.length === 0) && (!event.temporaryTeam || event.temporaryTeam.length === 0) && !event.responsibleId) {
                    // Fallback se n√£o tiver time nem gestor definido (raro)
                    combinedTeam = [...globalMembers];
                }
                
                if (event && event.temporaryTeam) { 
                    combinedTeam = [...combinedTeam, ...event.temporaryTeam]; 
                }
                setEventTeam(combinedTeam);
            }, [event, globalMembers]);

            useEffect(() => { const total = eventTasks.reduce((acc, t) => acc + (parseFloat(t.cost) || 0), 0); setTotalCost(total); }, [eventTasks]);

            const handleTaskDragStart = (e, task) => { setDraggedTask(task); };
            const handleDragOver = (e, colId) => { e.preventDefault(); setDragOverColumn(colId); };
            
            const handleDrop = (e, targetId) => { 
                e.preventDefault(); 
                if (!draggedTask) return; 
                if (viewMode === 'categories') { 
                    if (draggedTask.category !== targetId) dbOperations.updateTask(draggedTask.id, { category: targetId }); 
                } else { 
                    if (draggedTask.status !== targetId) {
                        dbOperations.updateTask(draggedTask.id, { status: targetId }); 
                    }
                } 
                setDraggedTask(null); 
                setDragOverColumn(null); 
            };
            
            const getMemberStats = (memberId) => { const memberTasks = eventTasks.filter(t => t.responsible?.id === memberId); const pending = memberTasks.filter(t => t.status !== 'done').length; const done = memberTasks.filter(t => t.status === 'done').length; return { pending, done, total: memberTasks.length }; };
            
            const addTeamMember = (member) => { if(!event.teamIds?.includes(member.id)) { const newTeamIds = [...(event.teamIds || []), member.id]; onUpdateEvent(event.id, { teamIds: newTeamIds }); onShowToast(`Membro adicionado: ${member.name}`); } setIsAddMemberOpen(false); };
            const addTemporaryMember = () => { if (!tempMemberName || !tempMemberRole) return; const newTemp = { id: `temp-${Date.now()}`, name: tempMemberName, role: tempMemberRole, isTemporary: true, photoUrl: null }; const newTempTeam = [...(event.temporaryTeam || []), newTemp]; onUpdateEvent(event.id, { temporaryTeam: newTempTeam }); setTempMemberName(''); setTempMemberRole(''); setIsAddMemberOpen(false); onShowToast(`Colaborador tempor√°rio adicionado: ${newTemp.name}`); };
            const handleRemoveMemberClick = (memberId) => { setMemberToRemove(memberId); };
            
            const confirmRemoveMember = async () => { 
                if (memberToRemove) { 
                    // 1. Remove da lista de equipe (Team IDs)
                    const isImplicitTeam = (!event.teamIds || event.teamIds.length === 0) && (!event.temporaryTeam || event.temporaryTeam.length === 0);
                    
                    if (isImplicitTeam) {
                        // Se era impl√≠cito (todos), ao remover um, criamos a lista expl√≠cita com todos MENOS o removido
                        const newTeamIds = globalMembers.map(m => m.id).filter(id => id !== memberToRemove);
                        onUpdateEvent(event.id, { teamIds: newTeamIds });
                    } else if (event.teamIds?.includes(memberToRemove)) { 
                        // Caso normal: remover da lista expl√≠cita
                        const newTeamIds = event.teamIds.filter(id => id !== memberToRemove); 
                        onUpdateEvent(event.id, { teamIds: newTeamIds }); 
                    } else { 
                        // Remover tempor√°rio
                        const newTempTeam = (event.temporaryTeam || []).filter(m => m.id !== memberToRemove); 
                        onUpdateEvent(event.id, { temporaryTeam: newTempTeam }); 
                    } 

                    // 2. NOVO: Desatribuir todas as tarefas deste membro neste evento (Limpeza)
                    // Isso resolve o problema das "20 tarefas fantasmas"
                    const memberTasks = tasks.filter(t => t.eventId === event.id && t.responsible?.id === memberToRemove);
                    const batchPromises = memberTasks.map(t => dbOperations.updateTask(t.id, { responsible: null }));
                    await Promise.all(batchPromises);

                    setMemberToRemove(null); 
                    onShowToast("Membro removido e tarefas liberadas."); 
                } 
            };
            
            const handleAddAgendaItem = () => { if(!newAgendaItem.title || !newAgendaItem.date) return; const dateParts = newAgendaItem.date.split('-'); const dateObj = new Date(dateParts[0], dateParts[1]-1, dateParts[2]); setAgendaItems([...agendaItems, { id: Date.now(), ...newAgendaItem, date: dateObj }]); setNewAgendaItem({ date: '', title: '', color: 'blue' }); onShowToast("Novo item na agenda!"); };
            const changeMonth = (offset) => { const newDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + offset, 1); setCurrentCalendarDate(newDate); };
            const renderCalendar = (date = new Date(), isSmall = false) => { const year = date.getFullYear(); const month = date.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay(); const days = []; for(let i=0; i<firstDay; i++) days.push(<div key={`empty-${i}`} className="h-8"></div>); for(let i=1; i<=daysInMonth; i++) { const items = agendaItems.filter(a => a.date.getDate() === i && a.date.getMonth() === month && a.date.getFullYear() === year); if (isSmall) { const hasEvent = items.length > 0; const pastel = hasEvent ? PASTEL_COLORS.find(c => c.id === items[0].color) : null; days.push(<div key={i} className={`h-6 w-6 text-[10px] flex items-center justify-center rounded-full relative mx-auto ${hasEvent ? 'font-bold' : 'text-gray-500'}`} style={{ backgroundColor: pastel ? pastel.hex : 'transparent', color: pastel ? pastel.text : undefined }}>{i}</div>); } else { days.push(<div key={i} className="h-24 border border-gray-100 p-2 relative bg-white hover:bg-blue-50 transition-colors cursor-pointer group"><span className={`text-sm font-bold ${items.length > 0 ? 'text-blue-600' : 'text-gray-400'}`}>{i}</span><div className="mt-1 space-y-1 overflow-hidden max-h-16">{items.map(item => { const pastel = PASTEL_COLORS.find(c => c.id === item.color); return (<div key={item.id} className={`text-[9px] px-1 py-0.5 rounded truncate ${pastel ? pastel.bg : 'bg-gray-100'} ${pastel ? pastel.text : 'text-gray-600'}`}>{item.title}</div>); })}</div></div>); } } return <div className={`grid grid-cols-7 ${isSmall ? 'gap-1' : 'gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden'}`}>{days}</div>; };
            
            const columns = viewMode === 'categories' ? categories : STATUS_COLUMNS;
            
            const filteredTasks = eventTasks.filter(t => { 
                const query = searchQuery.toLowerCase(); 
                const matchesText = (t.text || '').toLowerCase().includes(query); 
                const matchesSubtasks = t.subtasks && t.subtasks.some(st => st.text.toLowerCase().includes(query)); 
                const matchesSearch = matchesText || matchesSubtasks; 
                const matchesMember = selectedMemberFilter ? t.responsible?.id === selectedMemberFilter : true; 
                const taskPhase = t.phase || 'pre'; 
                const matchesPhase = selectedPhaseFilter === 'all' ? true : taskPhase === selectedPhaseFilter; 
                return matchesSearch && matchesMember && matchesPhase; 
            });

            // Fun√ß√£o para alternar prioridade na lista
            const cycleTaskPriority = (task) => {
                const order = ['low', 'medium', 'high'];
                const nextIndex = (order.indexOf(task.priority || 'low') + 1) % 3;
                dbOperations.updateTask(task.id, { priority: order[nextIndex] });
            };

            return (
                <div className="pb-20 animate-in">
                    <div className="bg-white p-8 rounded-3xl border border-gray-100 shadow-sm mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-6 relative overflow-hidden">
                        {event.coverUrl && (<div className="absolute inset-0 z-0"><img src={event.coverUrl} className="w-full h-full object-cover opacity-20"/><div className="absolute inset-0 bg-gradient-to-r from-white via-white/90 to-transparent"></div></div>)}
                        
                        <div className="flex items-center gap-6 z-10 relative">
                            <button onClick={onBack} className="p-3 bg-white/80 border border-gray-200 rounded-xl hover:bg-white transition-colors backdrop-blur-sm"><ArrowLeft size={24}/></button>
                            <div>
                                <h1 className="text-3xl font-extrabold text-gray-900 mb-1 flex items-center gap-3">
                                    {event.title}
                                    <div className="flex items-center gap-1">
                                        <button onClick={() => setIsEditEventOpen(true)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-white/50 rounded-lg transition-colors" title="Editar Evento">
                                            <Edit2 size={18}/>
                                        </button>
                                        <button onClick={() => setConfirmDeleteEvent(true)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-white/50 rounded-lg transition-colors" title="Excluir Evento">
                                            <Trash2 size={18}/>
                                        </button>
                                    </div>
                                </h1>
                                <p className="text-gray-500 flex items-center gap-3 text-sm font-medium">
                                    <span className="flex items-center gap-1"><Truck size={16}/> {event.location}</span>
                                    <span className="h-4 w-px bg-gray-300"></span>
                                    <span className="flex items-center gap-1"><CalendarIcon size={16}/> {event.dateRange}</span>
                                </p>
                            </div>
                        </div>

                        <div className="flex flex-col md:items-end gap-4 z-10 relative">
                            {/* Componente de Contagem Regressiva */}
                            <div className="bg-white/80 backdrop-blur-sm border border-blue-100 p-3 rounded-2xl flex items-center gap-3 shadow-sm">
                                <div className={`p-2 rounded-xl text-blue-700 ${daysLeft > 0 ? 'bg-blue-100' : 'bg-gray-100 text-gray-500'}`}>
                                    <Clock size={20} />
                                </div>
                                <div>
                                    <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider block">Contagem Regressiva</span>
                                    <span className={`text-lg font-extrabold leading-none ${daysLeft > 0 ? 'text-blue-900' : 'text-gray-500'}`}>
                                        {daysLeft !== null ? (
                                            daysLeft > 0 ? `${daysLeft} dias` : daysLeft === 0 ? '√â Hoje!' : 'Encerrado'
                                        ) : '-'}
                                    </span>
                                </div>
                            </div>

                            <div className="text-right">
                                <span className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1 block">Custo Total</span>
                                <div className="text-2xl font-extrabold text-emerald-600 leading-none">{formatCurrency(totalCost)}</div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-8 h-full">
                        <div className="lg:col-span-1 space-y-6">
                            <section className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 transition-all duration-300"><div className="flex items-center justify-between mb-2"><h2 className="text-base font-bold flex items-center gap-2 text-gray-800"><Users size={18} className="text-blue-900"/> Equipe do Evento</h2><div className="flex gap-1"><button onClick={() => { setIsAddMemberOpen(true); setIsAddTempMember(false); }} className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Plus size={16}/></button><button onClick={() => setIsTeamExpanded(!isTeamExpanded)} className="p-1 text-gray-400 hover:bg-gray-50 rounded">{isTeamExpanded ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}</button></div></div>{isTeamExpanded && (<div className="space-y-4 mt-4 animate-in">{eventTeam.map(member => { const stats = getMemberStats(member.id); return (<div key={member.id} className="flex flex-col gap-2 p-3 bg-gray-50 rounded-xl border border-gray-100 group relative"><button onClick={(e) => { e.stopPropagation(); handleRemoveMemberClick(member.id); }} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 transition-opacity z-10"><X size={14}/></button><div className="flex items-center gap-3"><Avatar member={member} size="w-8 h-8" showCrown={false}/><div className="flex-1 min-w-0"><p className="font-bold text-xs text-gray-900 truncate flex items-center gap-1">{member.name}{member.isTemporary && <span className="text-[8px] bg-amber-100 text-amber-700 px-1 rounded uppercase tracking-wider">Temp</span>}</p><p className="text-[10px] text-gray-500 truncate">{member.role}</p></div></div><div className="grid grid-cols-2 gap-2 mt-1"><div className="bg-amber-100 text-amber-800 rounded-lg p-1.5 text-center"><span className="block text-xs font-bold">{stats.pending}</span><span className="block text-[8px] uppercase font-bold opacity-60">Pendentes</span></div><div className="bg-emerald-100 text-emerald-800 rounded-lg p-1.5 text-center"><span className="block text-xs font-bold">{stats.done}</span><span className="block text-[8px] uppercase font-bold opacity-60">Conclu√≠das</span></div></div></div>); })}</div>)}</section>
                            <section className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 group hover:shadow-md transition-all"><div className="flex items-center justify-between mb-4 cursor-pointer" onClick={() => setIsAgendaModalOpen(true)}><h2 className="text-base font-bold flex items-center gap-2 text-gray-800"><CalendarIcon size={18} className="text-blue-900"/> Agenda</h2><Maximize2 size={14} className="text-gray-400 group-hover:text-blue-600"/></div><div className="bg-gray-50 rounded-xl p-3 border border-gray-100 cursor-pointer hover:border-blue-200 transition-colors" onClick={() => setIsAgendaModalOpen(true)}>{renderCalendar(new Date(), true)}</div><div className="mt-4 space-y-2">{agendaItems.slice(0, 3).map(item => { const pastel = PASTEL_COLORS.find(c => c.id === item.color); return (<div key={item.id} className="flex items-center gap-3 text-xs"><div className={`w-2 h-2 rounded-full ${pastel ? pastel.bg.replace('bg-', 'bg-') : 'bg-gray-300'}`}></div><span className="text-gray-600 truncate flex-1">{item.title}</span><span className="text-gray-400">{item.date.getDate()}/{item.date.getMonth()+1}</span></div>); })}</div></section>
                        </div>
                        <div className="lg:col-span-3">
                            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-6 flex flex-col gap-4">
                                <div className="flex gap-2 border-b border-gray-100 pb-2 overflow-x-auto"><button onClick={() => setSelectedPhaseFilter('all')} className={`px-4 py-2 text-xs font-bold rounded-lg transition-colors whitespace-nowrap ${selectedPhaseFilter === 'all' ? 'bg-blue-50 text-blue-700' : 'text-gray-500 hover:bg-gray-50'}`}>Todos</button><button onClick={() => setSelectedPhaseFilter('pre')} className={`px-4 py-2 text-xs font-bold rounded-lg transition-colors whitespace-nowrap ${selectedPhaseFilter === 'pre' ? 'bg-amber-50 text-amber-700' : 'text-gray-500 hover:bg-gray-50'}`}>Pr√©-Evento</button><button onClick={() => setSelectedPhaseFilter('during')} className={`px-4 py-2 text-xs font-bold rounded-lg transition-colors whitespace-nowrap ${selectedPhaseFilter === 'during' ? 'bg-emerald-50 text-emerald-700' : 'text-gray-500 hover:bg-gray-50'}`}>Durante</button><button onClick={() => setSelectedPhaseFilter('post')} className={`px-4 py-2 text-xs font-bold rounded-lg transition-colors whitespace-nowrap ${selectedPhaseFilter === 'post' ? 'bg-purple-50 text-purple-700' : 'text-gray-500 hover:bg-gray-50'}`}>P√≥s-Evento</button></div>
                                <div className="flex flex-col md:flex-row gap-3 items-center"><div className="flex items-center gap-2 flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 shadow-inner focus-within:ring-2 ring-blue-100 transition-all w-full"><Search size={18} className="text-gray-400"/><input type="text" placeholder="Pesquisar tarefas..." className="bg-transparent outline-none text-sm w-full text-gray-700 placeholder-gray-400" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)}/></div><div className="flex items-center gap-2 w-full md:w-auto"><select className="p-2 border border-gray-200 rounded-lg text-xs font-bold text-gray-600 bg-white outline-none focus:border-blue-500 w-full md:w-48" value={selectedMemberFilter} onChange={(e) => setSelectedMemberFilter(e.target.value)}><option value="">Todos Respons√°veis</option>{eventTeam.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}</select></div><div className="flex items-center gap-2 bg-gray-100 p-1 rounded-lg"><button onClick={() => setViewMode('categories')} className={`p-2 rounded-md ${viewMode === 'categories' ? 'bg-white shadow-sm text-blue-900' : 'text-gray-400'}`} title="Categorias"><Layout size={16}/></button><button onClick={() => setViewMode('status')} className={`p-2 rounded-md ${viewMode === 'status' ? 'bg-white shadow-sm text-blue-900' : 'text-gray-400'}`} title="Status"><CheckSquare size={16}/></button></div><button onClick={() => setIsAddTaskOpen(true)} className="bg-blue-900 text-white p-2 rounded-lg font-bold shadow-lg hover:bg-blue-800 transition-colors"><Plus size={18}/></button><button onClick={() => setIsManageCategoriesOpen(true)} className="p-2 border rounded-lg text-gray-500 hover:text-blue-900 bg-white hover:bg-gray-50"><Settings size={18}/></button></div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 items-start pb-20">
                                {columns.map(col => { 
                                    const colTasks = filteredTasks.filter(t => {
                                        if (viewMode === 'categories') {
                                            return t.category === col.id;
                                        } else {
                                            if (col.id === 'planning') return t.status === 'planning' || t.status === 'todo'; 
                                            if (col.id === 'in_progress') return t.status === 'in_progress';
                                            if (col.id === 'review') return t.status === 'review';
                                            if (col.id === 'done') return t.status === 'done';
                                            return false;
                                        }
                                    });
                                    // Determina a cor de fundo da coluna se estiver no modo Status
                                    const columnBg = viewMode === 'status' ? (col.bgSoft || 'bg-gray-50') : 'bg-gray-50/50';
                                    const style = getCategoryStyles(col.color); 
                                    
                                    return (
                                        <div key={col.id} onDragOver={(e) => handleDragOver(e, col.id)} onDrop={(e) => handleDrop(e, col.id)} className={`${columnBg} rounded-xl p-3 border border-gray-200 flex flex-col min-h-[300px] transition-all ${dragOverColumn === col.id ? 'drag-over shadow-inner' : ''}`}>
                                            <div className={`flex items-center gap-2 p-3 rounded-xl mb-3 border glass-header shadow-sm backdrop-blur-md`}>
                                                <div className={`p-1.5 rounded-lg ${style.replace('border', '').replace('bg-', 'bg-opacity-20 ')}`}>
                                                    {viewMode === 'categories' ? getCategoryIcon(col.icon) : col.icon ? <col.icon size={16} className={style.split(' ')[0]} /> : <Box size={16}/>}
                                                </div>
                                                <span className="text-xs font-extrabold text-gray-700 uppercase tracking-wide">{col.title}</span>
                                                <span className="ml-auto bg-white border border-gray-100 text-gray-600 text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">{colTasks.length}</span>
                                            </div>
                                            <div className="space-y-3">
                                                {colTasks.map(task => { 
                                                    const cat = categories.find(c => c.id === task.category) || categories[0]; 
                                                    const catPastel = PASTEL_COLORS.find(c => c.id === cat.color); 
                                                    const borderColor = catPastel ? catPastel.hex : '#cbd5e1'; 
                                                    return (
                                                        <div key={task.id} draggable onDragStart={(e) => handleTaskDragStart(e, task)} onClick={() => setSelectedTaskId(task.id)} className={`bg-white p-4 rounded-xl border border-gray-100 shadow-sm cursor-grab hover:shadow-lg hover:-translate-y-0.5 transition-all group relative border-l-[3px]`} style={{ borderLeftColor: task.status === 'done' ? '#10b981' : borderColor }}>
                                                            <button onClick={(e) => { e.stopPropagation(); setConfirmDeleteTaskId(task.id); }} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-opacity z-10"><Trash2 size={12}/></button>
                                                            <p className={`text-sm font-medium leading-snug mb-3 text-gray-700 ${task.status === 'done' ? 'line-through text-gray-400' : ''}`}>{task.text}</p>
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center gap-2">
                                                                    <Avatar member={task.responsible} size="w-6 h-6"/>
                                                                    {task.cost > 0 && <span className="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100">{formatCurrency(task.cost)}</span>}
                                                                </div>
                                                                <PriorityBadge level={task.priority} onClick={() => cycleTaskPriority(task)}/>
                                                            </div>
                                                        </div>
                                                    ); 
                                                })}
                                            </div>
                                        </div>
                                    ); 
                                })}
                            </div>
                        </div>
                    </div>
                    <TaskDetailModal task={selectedTask} isOpen={!!selectedTaskId} onClose={() => setSelectedTaskId(null)} members={eventTeam} dbOperations={dbOperations} />
                    <ManageCategoriesModal isOpen={isManageCategoriesOpen} onClose={() => setIsManageCategoriesOpen(false)} categories={categories} onAdd={(c) => { onAddCategory(c); onShowToast("Categoria criada!"); }} onUpdate={(c) => onUpdateCategory(c)} onDelete={(id) => onDeleteCategory(id)} />
                    <Modal isOpen={isAddTaskOpen} onClose={() => setIsAddTaskOpen(false)} title="Nova Tarefa"><div className="p-6 space-y-4"><div><label className="block text-sm font-medium text-gray-700 mb-1">O que precisa ser feito?</label><input autoFocus id="newTaskTitle" className="w-full p-2 border rounded-lg outline-none focus:border-blue-500" placeholder="Ex: Reservar hotel..."/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Categoria</label><select id="newTaskCategory" className="w-full p-2 border rounded-lg bg-white outline-none focus:border-blue-500">{categories.map(cat => <option key={cat.id} value={cat.id}>{cat.title}</option>)}</select></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Fase</label><select id="newTaskPhase" className="w-full p-2 border rounded-lg bg-white outline-none focus:border-blue-500"><option value="pre">Pr√©-Evento</option><option value="during">Durante</option><option value="post">P√≥s-Evento</option></select></div><button onClick={() => { const titleInput = document.getElementById('newTaskTitle'); const catInput = document.getElementById('newTaskCategory'); const phaseInput = document.getElementById('newTaskPhase'); if(titleInput.value) { dbOperations.addTask({ text: titleInput.value, category: catInput.value, phase: phaseInput.value, status: 'planning', priority: 'medium', responsible: eventTeam[0] || globalMembers[0], messages: [], subtasks: [] }); setIsAddTaskOpen(false); onShowToast("Tarefa criada com sucesso!"); } }} className="w-full bg-blue-900 text-white py-2 rounded-lg font-bold">Criar Tarefa</button></div></Modal>
                    <Modal isOpen={isAddMemberOpen} onClose={() => setIsAddMemberOpen(false)} title="Adicionar Colaborador"><div className="flex border-b border-gray-100"><button onClick={() => setIsAddTempMember(false)} className={`flex-1 p-3 text-sm font-bold ${!isAddTempMember ? 'text-blue-700 border-b-2 border-blue-600' : 'text-gray-500'}`}>Da Equipe Fixa</button><button onClick={() => setIsAddTempMember(true)} className={`flex-1 p-3 text-sm font-bold ${isAddTempMember ? 'text-blue-700 border-b-2 border-blue-600' : 'text-gray-500'}`}>Tempor√°rio</button></div>{!isAddTempMember ? (<div className="p-4 space-y-2">{globalMembers.filter(gm => !event.teamIds?.includes(gm.id)).map(m => (<button key={m.id} onClick={() => addTeamMember(m)} className="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg border border-transparent hover:border-gray-200 text-left transition-colors"><Avatar member={m}/><div><p className="font-bold text-sm text-gray-800">{m.name}</p><p className="text-xs text-gray-500">{m.role}</p></div></button>))}{globalMembers.filter(gm => !event.teamIds?.includes(gm.id)).length === 0 && <p className="text-center text-gray-400 text-sm py-4">Todos os membros fixos j√° est√£o no evento.</p>}</div>) : (<div className="p-6 space-y-4"><div className="bg-amber-50 p-3 rounded-lg border border-amber-100 text-xs text-amber-700 mb-2">Colaboradores tempor√°rios existem apenas neste evento.</div><input className="w-full p-2 border rounded-lg text-sm" placeholder="Nome do Colaborador" value={tempMemberName} onChange={e => setTempMemberName(e.target.value)}/><input className="w-full p-2 border rounded-lg text-sm" placeholder="Fun√ß√£o (Ex: Recepcionista)" value={tempMemberRole} onChange={e => setTempMemberRole(e.target.value)}/><button onClick={addTemporaryMember} disabled={!tempMemberName || !tempMemberRole} className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold disabled:opacity-50">Adicionar ao Evento</button></div>)}</Modal>
                    <Modal isOpen={isAgendaModalOpen} onClose={() => setIsAgendaModalOpen(false)} title="Agenda do Evento" fullScreen={true}><div className="flex flex-col h-full bg-gray-50"><div className="flex-1 p-8 overflow-y-auto max-w-5xl mx-auto w-full"><div className="grid grid-cols-1 md:grid-cols-3 gap-8"><div className="md:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><h4 className="font-bold text-gray-800 mb-6 flex items-center gap-2"><Plus size={18} className="text-blue-600"/> Novo Evento</h4><div className="space-y-4"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data</label><input type="date" value={newAgendaItem.date} onChange={e => setNewAgendaItem({...newAgendaItem, date: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none focus:border-blue-500 transition-colors"/></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">T√≠tulo</label><input type="text" placeholder="Ex: Reuni√£o Geral" value={newAgendaItem.title} onChange={e => setNewAgendaItem({...newAgendaItem, title: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none focus:border-blue-500 transition-colors"/></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Descri√ß√£o</label><textarea placeholder="Detalhes..." rows={3} value={newAgendaItem.description} onChange={e => setNewAgendaItem({...newAgendaItem, description: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none focus:border-blue-500 transition-colors resize-none"></textarea></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Cor</label><div className="flex flex-wrap gap-2">{PASTEL_COLORS.map(c => (<button key={c.id} type="button" onClick={() => setNewAgendaItem({...newAgendaItem, color: c.id})} className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${newAgendaItem.color === c.id ? 'border-gray-600 scale-110 shadow-sm' : 'border-transparent'}`} style={{backgroundColor: c.hex}}></button>))}</div></div><button onClick={handleAddAgendaItem} className="w-full bg-blue-900 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-900/20 hover:shadow-blue-900/40 transition-all mt-2">Adicionar √† Agenda</button></div></div><div className="md:col-span-2 space-y-6"><div className="flex items-center justify-between mb-4"><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><CalendarIcon className="text-blue-600"/> {MONTH_NAMES[currentCalendarDate.getMonth()]} {currentCalendarDate.getFullYear()}</h2><div className="flex gap-2"><button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded-lg border"><ChevronLeft size={20}/></button><button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded-lg border"><ChevronRight size={20}/></button></div></div>{renderCalendar(currentCalendarDate)}</div></div></div></div></Modal>
                    <ConfirmModal isOpen={!!confirmDeleteTaskId} onClose={() => setConfirmDeleteTaskId(null)} onConfirm={() => dbOperations.deleteTask(confirmDeleteTaskId)} title="Excluir Tarefa" message="Tem certeza que deseja excluir esta tarefa permanentemente?" />
                    <ConfirmModal isOpen={!!memberToRemove} onClose={() => setMemberToRemove(null)} onConfirm={confirmRemoveMember} title="Remover Membro" message="Tem certeza que deseja remover este membro da equipe deste evento?" />
                    
                    {/* MODAL DE CONFIRMA√á√ÉO DE EXCLUS√ÉO DE EVENTO */}
                    <ConfirmModal 
                        isOpen={confirmDeleteEvent} 
                        onClose={() => setConfirmDeleteEvent(false)} 
                        onConfirm={() => onDeleteEvent(event.id)} 
                        title="Excluir Evento" 
                        message="ATEN√á√ÉO: Esta a√ß√£o √© irrevers√≠vel. O evento e TODAS as suas tarefas ser√£o exclu√≠dos permanentemente. Deseja continuar?" 
                    />

                    {/* MODAL DE EDI√á√ÉO DE EVENTO */}
                    <EditEventModal 
                        isOpen={isEditEventOpen} 
                        onClose={() => setIsEditEventOpen(false)} 
                        event={event} 
                        members={globalMembers}
                        onUpdate={onUpdateEvent}
                    />
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [selectedEvent, setSelectedEvent] = useState(null);
            const [events, setEvents] = useState([]);
            const [members, setMembers] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [manager, setManager] = useState(null);
            const [logo, setLogo] = useState(null);
            const [geminiKey, setGeminiKey] = useState('');
            const [categories, setCategories] = useState([]); // Inicia vazio para saber se j√° carregou
            const [isNewEventModalOpen, setIsNewEventModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isNotificationsOpen, setIsNotificationsOpen] = useState(false);
            const [isAIOpen, setIsAIOpen] = useState(false);
            const [toastMessage, setToastMessage] = useState(null);
            const [user, setUser] = useState(null);

            // CORRE√á√ÉO: Autentica√ß√£o melhorada para evitar erros de permiss√£o
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                
                const unsubAuth = onAuthStateChanged(auth, (u) => {
                    if (u) setUser(u);
                });
                return () => unsubAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubEvents = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'events'), (snap) => { const data = snap.docs.map(d => ({ id: d.id, ...d.data() })); setEvents(data); });
                const unsubMembers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'members'), (snap) => { const data = snap.docs.map(d => ({ id: d.id, ...d.data() })); setMembers(data); });
                const unsubTasks = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), (snap) => { const data = snap.docs.map(d => ({ id: d.id, ...d.data() })); setTasks(data); });
                const unsubSettings = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), (snap) => { 
                    snap.docs.forEach(docSnap => { 
                        if (docSnap.id === 'global') { 
                            setLogo(docSnap.data().logoUrl); 
                            setGeminiKey(docSnap.data().geminiKey);
                        } 
                        if (docSnap.id === 'manager') { 
                            setManager({ id: 'global_manager', ...docSnap.data() }); 
                        } 
                    }); 
                });

                // NOVO: Carregar Categorias
                const unsubCategories = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), async (snap) => {
                    if (snap.empty) {
                        // Se estiver vazio, vamos popular com as categorias padr√£o para garantir que funcione
                        // Isso resolve o problema de "n√£o salvar" na primeira vez, pois inicializa o banco.
                        // Usamos Promise.all para ser r√°pido.
                        const batchPromises = DEFAULT_CATEGORIES.map(cat => 
                            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', cat.id), cat)
                        );
                        await Promise.all(batchPromises);
                    } else {
                        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        // Ordena√ß√£o opcional se tiver campo order, ou alfab√©tica, ou por ID fixo
                        // Por enquanto, vamos manter a ordem que vem ou usar uma l√≥gica simples
                        // Como os IDs padr√£o s√£o fixos, podemos for√ßar a ordem deles primeiro se quisermos
                        setCategories(data);
                    }
                });

                return () => { unsubEvents(); unsubMembers(); unsubTasks(); unsubSettings(); unsubCategories(); };
            }, [user]);

            // --- CRIA√á√ÉO DE LISTA UNIFICADA (GESTOR + MEMBROS) ---
            const allAssignableMembers = manager 
                ? [manager, ...members.filter(m => m.id !== manager.id)] 
                : members;

            const handleAddMember = async (memberData) => { if(!user) return; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'members'), memberData); showToast("Membro adicionado!"); };
            const handleUpdateMember = async (memberData) => { if(!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', memberData.id), memberData); };
            const handleDeleteMember = async (id) => { if(!user) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', id)); showToast("Membro removido."); };
            
            // --- Handlers de Categoria (Persistentes) ---
            const handleAddCategory = async (cat) => { if(!user) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', cat.id), cat); };
            const handleUpdateCategory = async (cat) => { if(!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', cat.id), cat); };
            const handleDeleteCategory = async (id) => { if(!user) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id)); showToast("Categoria exclu√≠da."); };

            // ALTERADO AQUI: responsible agora inicia como null (sem dono) nas tarefas autom√°ticas
            const handleCreateEvent = async (eventData) => { 
                if(!user) return; 
                const eventRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'events'), eventData); 
                if (eventData.initialTasks && eventData.initialTasks.length > 0) { 
                    const batchPromises = eventData.initialTasks.map(task => { 
                        return addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), { 
                            eventId: eventRef.id, 
                            text: task.text, 
                            category: task.category || 'planning', 
                            status: 'planning', 
                            priority: 'medium', 
                            responsible: null, // AGORA SEM DONO AUTOM√ÅTICO
                            messages: [], 
                            subtasks: [] 
                        }); 
                    }); 
                    await Promise.all(batchPromises); 
                } 
                setIsNewEventModalOpen(false); 
                showToast("Evento criado!"); 
            };

            const handleUpdateLogo = async (url) => { if(!user) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { logoUrl: url }, { merge: true }); };
            const handleUpdateGeminiKey = async (key) => { if(!user) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { geminiKey: key }, { merge: true }); showToast("Chave API salva!"); };
            const handleUpdateManager = async (managerData) => { if(!user) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'manager'), managerData, { merge: true }); showToast("Gestor atualizado!"); };
            const handleUpdateEvent = async (eventId, data) => { if(!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', eventId), data); };
            
            // --- NOVO: FUN√á√ÉO DE EXCLUIR EVENTO ---
            const handleDeleteEvent = async (eventId) => {
                if(!user) return;
                
                // 1. Excluir todas as tarefas do evento
                const eventTasks = tasks.filter(t => t.eventId === eventId);
                const deleteTasksPromises = eventTasks.map(t => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', t.id)));
                await Promise.all(deleteTasksPromises);

                // 2. Excluir o evento
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', eventId));
                
                setView('dashboard');
                setSelectedEvent(null);
                showToast("Evento exclu√≠do com sucesso.");
            };

            const dbOperations = { addTask: async (taskData) => { if(!user || !selectedEvent) return; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), { ...taskData, eventId: selectedEvent.id }); }, updateTask: async (taskId, data) => { if(!user) return; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId), data); }, deleteTask: async (taskId) => { if(!user) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId)); } };
            const showToast = (msg) => { setToastMessage(msg); };
            const totalCost = tasks.reduce((acc, t) => acc + (parseFloat(t.cost) || 0), 0);
            const currentSelectedEvent = events.find(e => e.id === selectedEvent?.id) || selectedEvent;

            // Se as categorias ainda n√£o carregaram do banco (array vazio), usamos o padr√£o para n√£o quebrar a UI
            // Mas o useEffect j√° vai cuidar de popular o banco se estiver vazio.
            const displayCategories = categories.length > 0 ? categories : DEFAULT_CATEGORIES;

            return (
                <div className="min-h-screen pb-12">
                     <header className="fixed top-0 left-0 right-0 bg-white h-24 border-b border-gray-100 z-40 px-8 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-6 cursor-pointer" onClick={() => setView('dashboard')}><div className={`h-12 w-32 rounded-lg flex items-center justify-center text-xs text-gray-400 font-medium relative transition-colors ${!logo ? 'border-2 border-dashed border-gray-300 hover:border-blue-400' : ''}`}>{logo ? <img src={logo} className="h-full w-full object-contain"/> : "Sua Logo"}<input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => { const file = e.target.files[0]; if(file) compressImage(file, 200).then(handleUpdateLogo); }} accept="image/*" /></div><div className="h-10 w-px bg-gray-200"></div><div><h1 className="text-2xl font-extrabold text-[#002060]">Event Hub</h1><p className="text-sm text-gray-500 font-medium">Painel de Marketing</p></div></div>
                        <div className="flex items-center gap-6"><div className="flex items-center gap-3 pr-6 border-r border-gray-100 hidden md:flex">{manager ? (<><div className="w-10 h-10 rounded-full bg-gray-200 border border-gray-300 overflow-hidden relative"><Avatar member={manager} size="w-full h-full" showCrown={false} /></div><div className="text-right"><p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider leading-tight">{manager.role}</p><p className="text-sm font-bold text-gray-800 leading-tight">{manager.name}</p></div></>) : (<div className="text-right text-xs text-gray-400 italic">Defina o gestor nas configura√ß√µes</div>)}</div><div className="flex items-center gap-3 relative"><button onClick={() => setIsNotificationsOpen(!isNotificationsOpen)} className="w-10 h-10 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded-xl transition-colors relative border border-gray-200 shadow-sm"><Bell size={20}/><span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span></button>{isNotificationsOpen && <NotificationsDropdown onClose={() => setIsNotificationsOpen(false)} notifications={[{ text: "Sistema conectado", date: "Agora" }]} />}<button onClick={() => setIsSettingsOpen(true)} className="w-10 h-10 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded-xl transition-colors border border-gray-200 shadow-sm"><Settings size={20}/></button></div></div>
                    </header>
                    <main className="pt-32 px-8 max-w-[1600px] mx-auto">
                        {view === 'dashboard' ? (
                            <DashboardView 
                                onSelectEvent={(evt) => { setSelectedEvent(evt); setView('event'); }} 
                                events={events} 
                                members={allAssignableMembers} 
                                updates={[]} 
                                onDeleteUpdate={() => {}} 
                                onNewEvent={() => setIsNewEventModalOpen(true)} 
                                tasks={tasks} 
                                dbOperations={dbOperations} 
                                manager={manager} 
                            />
                        ) : (
                            <EventDetailView 
                                event={currentSelectedEvent} 
                                onBack={() => setView('dashboard')} 
                                globalMembers={allAssignableMembers} 
                                onShowToast={showToast} 
                                dbOperations={dbOperations} 
                                tasks={tasks} 
                                onUpdateEvent={handleUpdateEvent} 
                                onDeleteEvent={handleDeleteEvent} 
                                manager={manager}
                                categories={displayCategories} // Passando categorias persistidas
                                onAddCategory={handleAddCategory}
                                onUpdateCategory={handleUpdateCategory}
                                onDeleteCategory={handleDeleteCategory}
                            />
                        )}
                    </main>
                    <AIAssistant isOpen={isAIOpen} onClose={() => setIsAIOpen(false)} members={allAssignableMembers} events={events} tasks={tasks} manager={manager} totalCost={totalCost} geminiKey={geminiKey} />
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} members={members} logo={logo} setLogo={setLogo} onUpdateLogo={handleUpdateLogo} onAddMember={handleAddMember} onUpdateMember={handleUpdateMember} onDeleteMember={handleDeleteMember} manager={manager} onUpdateManager={handleUpdateManager} geminiKey={geminiKey} onUpdateGeminiKey={handleUpdateGeminiKey} />
                    <NewEventModal isOpen={isNewEventModalOpen} onClose={() => setIsNewEventModalOpen(false)} members={allAssignableMembers} onCreate={handleCreateEvent} categories={displayCategories} />
                    {toastMessage && <Toast message={toastMessage} onClose={() => setToastMessage(null)} />}
                    <button onClick={() => setIsAIOpen(true)} className="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full shadow-2xl hover:scale-110 transition-transform z-40 flex items-center justify-center group"><Bot size={28} className="group-hover:animate-bounce"/></button>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>





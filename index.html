<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Hub - Painel de Marketing</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Import Map para React (ESM) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react-dom": "https://esm.sh/react-dom@18.2.0"
      }
    }
    </script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; padding-bottom: 80px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-header { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.5); }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        blue: { 900: '#1e3a8a', 950: '#172554' }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <!-- Container Principal -->
    <div id="root"></div>

    <!-- Container de Erro Global (Fallback) -->
    <div id="global-error" style="display:none; padding: 20px; color: #ef4444; background: #fee2e2; margin: 20px; border-radius: 8px; font-family: sans-serif;">
        <h2 style="font-weight: bold; margin-bottom: 10px;">Ocorreu um erro ao carregar a aplica√ß√£o:</h2>
        <pre id="error-message" style="white-space: pre-wrap; font-size: 14px;"></pre>
        <button onclick="localStorage.clear(); window.location.reload()" style="margin-top:15px; padding:8px 16px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer;">Limpar Dados e Recarregar</button>
    </div>

    <script>
        // Captura erros globais antes do React carregar
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('global-error').style.display = 'block';
            document.getElementById('error-message').textContent = message + '\n\nSource: ' + source + ':' + lineno;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { createPortal } from 'react-dom';

        import { 
            Calendar as CalendarIcon, Users, CheckSquare, Flag, Plus, X, Clock, 
            Edit2, Trash2, ChevronLeft, ChevronRight, Truck, ArrowLeft, 
            Search, Bell, MessageSquare, Send, AlertCircle, ChevronDown, 
            ChevronUp, Settings, UserPlus, Box, TrendingUp, Filter, Check, 
            Image as ImageIcon, AlertTriangle, Crown, Plane, Target, Camera,
            DollarSign, ClipboardList, Mic, Music, Coffee, Gift, Sparkles, Bot,
            BarChart3, Layout, GripVertical, Flame, Info, Wifi, WifiOff,
            ExternalLink, Lightbulb, BrainCircuit, MoreVertical, Paperclip, FileText,
            Wand2, Copy, Share2, ZoomIn, Layers, Zap, Megaphone, Palette, Maximize2, MapPin, Briefcase, Rocket, Star,
            PieChart, Timer, UserCheck, RefreshCw, Key, Archive, Download, Cloud,
            Home, List, Grid, Smile, LogOut, Repeat, Columns, Database
        } from 'https://esm.sh/lucide-react@0.294.0';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- Configura√ß√£o Firebase ---
        const userFirebaseConfig = {
            apiKey: "AIzaSyD976h76Lt8FZVq3K6wlmtKJgy6QAOsaVA",
            authDomain: "eventhub-c03e4.firebaseapp.com",
            projectId: "eventhub-c03e4",
            storageBucket: "eventhub-c03e4.firebasestorage.app",
            messagingSenderId: "288236914912",
            appId: "1:288236914912:web:940ee18e9d84c651ab2885",
            measurementId: "G-ZE8C5JKQ44"
        };

        let app = null;
        let db = null;
        let auth = null;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        try {
            let configToUse = userFirebaseConfig;
            if (typeof __firebase_config !== 'undefined') {
                configToUse = JSON.parse(__firebase_config);
            } else if (!userFirebaseConfig.apiKey && localStorage.getItem('event_hub_firebase_config')) {
                configToUse = JSON.parse(localStorage.getItem('event_hub_firebase_config'));
            }

            if (configToUse && configToUse.apiKey) {
                app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);
            }
        } catch (e) {
            console.warn("Firebase Init Error:", e);
        }

        const getColPath = (colName) => {
            if (!db) return null;
            return collection(db, 'artifacts', appId, 'public', 'data', colName);
        };
        const getDocPath = (colName, docId) => {
            if (!db) return null;
            return doc(db, 'artifacts', appId, 'public', 'data', colName, String(docId));
        };

        // --- Fun√ß√µes Auxiliares ---
        const compressImage = (file, maxWidth = 800) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL(file.type === 'image/png' ? 'image/png' : 'image/jpeg', 0.7)); 
                        } else resolve(img.src);
                    };
                };
            });
        };

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
        
        const getDaysLeft = (evt) => {
            if (!evt || !evt.startDate) return 0;
            const [year, month, day] = evt.startDate.split('-').map(Number);
            const target = new Date(year, month - 1, day); // Meia-noite local
            const today = new Date();
            today.setHours(0,0,0,0); // Meia-noite local hoje
            const diff = target - today;
            return Math.ceil(diff / (86400000));
        };

        const isEventFinished = (evt) => {
            if (!evt.endDate && !evt.startDate) return false;
            const dateStr = evt.endDate || evt.startDate;
            const [year, month, day] = dateStr.split('-').map(Number);
            const eventEnd = new Date(year, month - 1, day, 23, 59, 59, 999);
            return eventEnd < new Date();
        };

        // --- Dados Iniciais (Vazio) ---
        const INITIAL_MEMBERS = [
            { id: '1', name: 'Paulo Mokarzel', role: 'Head de Eventos', photoUrl: null },
            { id: '2', name: 'Matheus Silva', role: 'Marketing', photoUrl: null },
            { id: '3', name: 'Larissa Tom√©', role: 'Marketing', photoUrl: null },
            { id: '4', name: 'Suzana Santos', role: 'Marketing', photoUrl: null },
            { id: '5', name: 'Thalita Carmo', role: 'Marketing', photoUrl: null }
        ];

        const INITIAL_EVENTS = [];
        const INITIAL_TASKS = [];

        // --- Constantes & Configs ---
        const PASTEL_COLORS = [
            { id: 'blue', bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-200', hex: '#DBEAFE' },
            { id: 'green', bg: 'bg-emerald-100', text: 'text-emerald-700', border: 'border-emerald-200', hex: '#D1FAE5' },
            { id: 'yellow', bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-200', hex: '#FEF3C7' },
            { id: 'red', bg: 'bg-rose-100', text: 'text-rose-700', border: 'border-rose-200', hex: '#FFE4E6' },
            { id: 'purple', bg: 'bg-purple-100', text: 'text-purple-700', border: 'border-purple-200', hex: '#F3E8FF' },
            { id: 'orange', bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200', hex: '#FFEDD5' },
            { id: 'teal', bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-200', hex: '#CCFBF1' },
            { id: 'indigo', bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-200', hex: '#E0E7FF' },
        ];

        const STATUS_COLUMNS = [
            { id: 'planning', title: 'Planejamento', color: 'blue', icon: Box, bgSoft: 'bg-blue-50/80', border: 'border-blue-100' },
            { id: 'in_progress', title: 'Andamento', color: 'amber', icon: Truck, bgSoft: 'bg-amber-50/80', border: 'border-amber-100' },
            { id: 'review', title: 'Finaliza√ß√£o', color: 'purple', icon: Search, bgSoft: 'bg-purple-50/80', border: 'border-purple-100' },
            { id: 'done', title: 'Conclu√≠do', color: 'emerald', icon: CheckSquare, bgSoft: 'bg-emerald-50/80', border: 'border-emerald-100' }
        ];

        const ICON_MAP = { box: Box, truck: Truck, users: Users, trending: TrendingUp, check: CheckSquare, layers: Layers, zap: Zap, megaphone: Megaphone, palette: Palette, gift: Gift, coffee: Coffee, music: Music, layout: Layout, search: Search, smile: Smile, star: Star, cloud: Cloud, key: Key, lock: Archive, map: MapPin, camera: Camera };
        const ICON_KEYS = Object.keys(ICON_MAP);

        const DEFAULT_CATEGORIES = [
            { id: 'planning', title: 'Planejamento & Produto', icon: 'box', color: 'blue', phases: ['pre', 'during', 'post'] },
            { id: 'logistics', title: 'Log√≠stica & Estande', icon: 'truck', color: 'amber', phases: ['pre', 'during'] },
            { id: 'staff', title: 'Staff & Viagem', icon: 'users', color: 'purple', phases: ['pre', 'during'] },
            { id: 'post', title: 'P√≥s-Evento & Leads', icon: 'trending', color: 'emerald', phases: ['post'] }
        ];

        const AGENDA_COLORS = [
            { id: 'blue', bg: 'bg-blue-100', text: 'text-blue-700', ring: 'ring-blue-500' },
            { id: 'green', bg: 'bg-emerald-100', text: 'text-emerald-700', ring: 'ring-emerald-500' },
            { id: 'red', bg: 'bg-rose-100', text: 'text-rose-700', ring: 'ring-rose-500' },
            { id: 'orange', bg: 'bg-orange-100', text: 'text-orange-700', ring: 'ring-orange-500' },
            { id: 'purple', bg: 'bg-purple-100', text: 'text-purple-700', ring: 'ring-purple-500' },
        ];

        const OPTIONAL_STARTUP_TASKS = [
            { id: 'p1', text: 'Definir tema e conceito do evento', category: 'planning', phase: 'pre' },
            { id: 'p2', text: 'Aprovar or√ßamento preliminar', category: 'planning', phase: 'pre' },
            { id: 'l1', text: 'Reservar local/espa√ßo', category: 'logistics', phase: 'pre' },
            { id: 'l2', text: 'Contratar servi√ßo de Buffet', category: 'logistics', phase: 'pre' },
            { id: 's1', text: 'Contratar recepcionistas', category: 'staff', phase: 'pre' },
            { id: 'po1', text: 'Consolidar relat√≥rio de leads', category: 'post', phase: 'post' }
        ];

        // --- Componentes ---

        const Avatar = ({ member, size = "w-10 h-10" }) => {
            if (!member) return <div className={`${size} rounded-full bg-gray-200 border border-gray-300`}></div>;
            const content = member.photoUrl ? (
                <img src={member.photoUrl} className="w-full h-full object-cover" />
            ) : (
                <div className="w-full h-full flex items-center justify-center text-blue-900 font-bold text-[10px]">
                    {member.name?.substring(0,2).toUpperCase()}
                </div>
            );
            return (
                <div className={`${size} rounded-full bg-white border border-gray-200 relative flex-shrink-0 overflow-hidden`}>
                    {content}
                </div>
            );
        };

        const FlagPriority = ({ level, onClick }) => {
            const colors = { 
                high: "text-red-500 hover:text-red-600", 
                medium: "text-amber-500 hover:text-amber-600", 
                low: "text-emerald-500 hover:text-emerald-600" 
            };
            return (
                <button 
                    onClick={(e) => { e.stopPropagation(); onClick && onClick(); }} 
                    className={`transition-transform hover:scale-110 ${colors[level] || colors.low}`}
                    title="Alterar Prioridade"
                >
                    <Flag size={16} fill="currentColor"/>
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-lg", hideHeader = false, fullScreen = false }) => {
            if (!isOpen) return null;
            const content = (
                <div className={`bg-white ${fullScreen ? 'fixed inset-0 z-[100] flex flex-col' : `rounded-2xl shadow-2xl w-full ${maxWidth} max-h-[90vh] overflow-hidden flex flex-col bg-white relative z-[100]`}`}>
                    {!hideHeader && (
                        <div className="p-4 border-b bg-[#1e1b4b] text-white flex justify-between items-center shrink-0">
                            <h3 className="font-bold">{title}</h3>
                            <button onClick={onClose}><X size={20}/></button>
                        </div>
                    )}
                    {hideHeader && <button onClick={onClose} className="absolute top-4 right-4 z-50 p-2 bg-black/10 hover:bg-black/20 rounded-full text-white"><X size={20}/></button>}
                    <div className="p-0 overflow-y-auto flex-1 bg-white relative">{children}</div>
                </div>
            );
            return createPortal(
                <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-in">{content}</div>,
                document.body
            );
        };

        // --- AI Assistant ---
        const AIAssistant = ({ isOpen, onClose, context, apiKey }) => {
            const [messages, setMessages] = useState([{ sender: 'ai', text: "Ol√°! Eu sou o assistente de IA do Event Hub. Selecione uma op√ß√£o abaixo ou digite sua pergunta." }]);
            const [input, setInput] = useState("");
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);

            // Perguntas pr√©-definidas para acesso r√°pido
            const QUICK_QUESTIONS = [
                "üìÖ Resumo dos Eventos",
                "üí∞ Custo Total",
                "üë• Carga da Equipe",
                "‚úÖ Minhas Tarefas",
                "üö® Urg√™ncias"
            ];

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, isTyping]);

            const callGeminiAPI = async (prompt, systemContext) => {
                if (!apiKey) return null;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            systemInstruction: {
                                parts: [{ text: systemContext }]
                            }
                        })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) {
                    console.error("Gemini API Error", error);
                    return null;
                }
            };

            const processQuery = async (text) => {
                const userMsg = { sender: 'user', text };
                setMessages(prev => [...prev, userMsg]);
                setIsTyping(true);

                // Preparar dados do contexto para a IA
                const { events, tasks, members } = context;
                
                const eventsSummary = events.map(e => {
                    const evtTasks = tasks.filter(t => t.eventId === e.id);
                    const cost = evtTasks.reduce((acc, t) => acc + (t.cost || 0), 0);
                    const pendingCount = evtTasks.filter(t => t.status !== 'done').length;
                    return `‚Ä¢ ID: ${e.id}, Evento: "${e.title}", Data: ${e.startDate}, Local: ${e.location}, Respons√°vel: ${members.find(m => m.id === e.responsibleId)?.name || 'N/A'}, Custo: R$${cost}, Tarefas Pendentes: ${pendingCount}`;
                }).join('\n');

                const tasksSummary = tasks.map(t => {
                    return `‚Ä¢ Tarefa: "${t.text}", Status: ${t.status}, Prioridade: ${t.priority}, Respons√°vel: ${t.responsible?.name || 'N/A'}, Custo: R$${t.cost || 0}`;
                }).join('\n');

                const membersSummary = members.map(m => `‚Ä¢ Nome: ${m.name} (${m.role})`).join('\n');

                const systemPrompt = `
                    Voc√™ √© um assistente pessoal inteligente do sistema "Event Hub".
                    
                    OBJETIVO:
                    Responder perguntas sobre a gest√£o dos eventos com clareza absoluta, usando os dados fornecidos abaixo.

                    DADOS ATUAIS DO SISTEMA:
                    ---
                    [EQUIPE]
                    ${membersSummary}
                    ---
                    [EVENTOS]
                    ${eventsSummary}
                    ---
                    [TODAS AS TAREFAS]
                    ${tasksSummary}
                    ---

                    REGRAS DE RESPOSTA (IMPORTANTE):
                    1. CLAREZA: Use linguagem simples e direta. Evite frases longas.
                    2. FORMATA√á√ÉO: Use SEMPRE **negrito** para destacar nomes de eventos, pessoas e valores (ex: **R$ 5.000**).
                    3. LISTAS: Use listas (bullet points) para enumerar eventos ou tarefas. √â mais f√°cil de ler.
                    4. RESUMO: Se pedirem um "Resumo", mostre: Nome do Evento, Data e um breve status (ex: "5 tarefas pendentes").
                    5. FINANCEIRO: Se perguntarem de custos, mostre o total geral e, se poss√≠vel, quebre por evento.
                    6. PESSOAL: Se perguntarem "Minhas Tarefas", assuma que est√£o perguntando de forma gen√©rica sobre a carga de trabalho de todos ou pe√ßa para especificar o nome.
                    7. URG√äNCIAS: Se perguntarem por urg√™ncias, procure tarefas com prioridade 'high' (alta) que n√£o est√£o 'done' (conclu√≠das).

                    Exemplo de formato de resposta desejado:
                    "Aqui est√° o resumo dos seus eventos:
                    * üìÖ **Lan√ßamento 2026**: R$ 10.000 gastos, 3 pend√™ncias.
                    * üìÖ **Workshop**: R$ 2.000 gastos, tudo conclu√≠do."
                `;

                let responseText = "Desculpe, n√£o consegui processar a resposta no momento.";
                const aiResponse = await callGeminiAPI(text, systemPrompt);
                
                if (aiResponse) responseText = aiResponse;
                else responseText = "N√£o consegui conectar com a IA. Verifique sua chave API.";

                setMessages(prev => [...prev, { sender: 'ai', text: responseText }]);
                setIsTyping(false);
            };

            const handleSend = async () => {
                if(!input.trim()) return;
                const txt = input;
                setInput("");
                await processQuery(txt);
            };

            const handleQuickAction = (question) => {
                // Remove o emoji para a query real, se desejar, ou mantenha para contexto
                processQuery(question); 
            };

            if(!isOpen) return null;

            return (
                <div className="fixed bottom-24 right-6 w-80 md:w-96 h-[500px] bg-white rounded-2xl shadow-2xl z-[200] flex flex-col border border-gray-200 animate-in overflow-hidden">
                    <div className="p-4 bg-gradient-to-r from-blue-600 to-indigo-700 text-white flex justify-between items-center">
                        <div className="flex items-center gap-2"><Sparkles size={18}/> <span className="font-bold">Assistente IA</span></div>
                        <button onClick={onClose}><X size={18}/></button>
                    </div>
                    <div className="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-xl text-sm ${m.sender === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-gray-200 text-gray-700 rounded-tl-none shadow-sm'}`} style={{whiteSpace: 'pre-wrap'}}>{m.text}</div>
                            </div>
                        ))}
                        {isTyping && <div className="flex justify-start"><div className="bg-white border border-gray-100 p-3 rounded-xl rounded-tl-none shadow-sm flex gap-1"><div className="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div></div></div>}
                        <div ref={messagesEndRef}></div>
                    </div>
                    
                    {/* √Årea de Perguntas R√°pidas */}
                    <div className="px-4 py-2 bg-gray-50 border-t border-gray-100 overflow-x-auto flex gap-2 hide-scrollbar">
                        {QUICK_QUESTIONS.map((q, i) => (
                            <button 
                                key={i} 
                                onClick={() => handleQuickAction(q)}
                                className="whitespace-nowrap px-3 py-1.5 bg-white border border-blue-200 rounded-full text-xs font-medium text-blue-700 hover:bg-blue-50 transition-colors shadow-sm"
                            >
                                {q}
                            </button>
                        ))}
                    </div>

                    <div className="p-3 bg-white border-t flex gap-2">
                        <input className="flex-1 bg-gray-100 border-none outline-none rounded-lg px-3 py-2 text-sm" placeholder="Digite sua pergunta..." value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSend()}/>
                        <button onClick={handleSend} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"><Send size={18}/></button>
                    </div>
                </div>
            );
        };

        // --- Agenda Component ---
        const AgendaComponent = ({ agendaItems, onAdd, onDelete, onUpdate, readOnly = false, contextTitle = "Agenda", selectedDateFilter, events, scrollable = true }) => {
            const [newItem, setNewItem] = useState({ title: '', date: '', color: 'blue', eventId: '' });
            const [isAdding, setIsAdding] = useState(false);
            const [editItem, setEditItem] = useState(null);

            const filteredItems = selectedDateFilter ? agendaItems.filter(item => item.date === selectedDateFilter) : agendaItems;
            const sortedItems = [...filteredItems].sort((a,b) => new Date(a.date) - new Date(b.date));

            const handleSave = () => {
                if(!newItem.title) return;
                const dateToAdd = newItem.date || selectedDateFilter || new Date().toISOString().split('T')[0];
                if (editItem) { onUpdate(editItem.id, { ...newItem, date: dateToAdd }); setEditItem(null); } 
                else { onAdd({ ...newItem, id: Date.now(), date: dateToAdd }); }
                setNewItem({ title: '', date: '', color: 'blue', eventId: '' });
                setIsAdding(false);
            };

            const startEdit = (item) => { setNewItem({ title: item.title, date: item.date, color: item.color, eventId: item.eventId || '' }); setEditItem(item); setIsAdding(true); };

            return (
                <div className="flex flex-col h-full bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                    <div className="p-4 border-b bg-gray-50/50 flex justify-between items-center">
                        <h3 className="font-bold text-gray-800 flex items-center gap-2">
                            <CalendarIcon size={16} className="text-blue-600"/> 
                            {selectedDateFilter ? new Date(selectedDateFilter).toLocaleDateString('pt-BR') : contextTitle}
                        </h3>
                        {!readOnly && <button onClick={() => { setNewItem(prev => ({...prev, date: selectedDateFilter || prev.date})); setIsAdding(!isAdding); setEditItem(null); }} className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition-colors">{isAdding ? 'Cancelar' : '+ Adicionar'}</button>}
                    </div>
                    {isAdding && (
                        <div className="p-3 bg-blue-50/50 border-b border-blue-100 animate-in space-y-2">
                            <input className="w-full p-2 text-xs border rounded bg-white" placeholder="T√≠tulo..." value={newItem.title} onChange={e=>setNewItem({...newItem, title: e.target.value})} autoFocus/>
                            <div className="flex gap-2">
                                <input type="date" className="flex-1 p-2 text-xs border rounded bg-white" value={newItem.date} onChange={e=>setNewItem({...newItem, date: e.target.value})}/>
                                {events && <select className="flex-1 p-2 text-xs border rounded bg-white" value={newItem.eventId} onChange={e=>setNewItem({...newItem, eventId: e.target.value})}><option value="">Opcional: Evento</option>{events.map(ev => <option key={ev.id} value={ev.id}>{ev.title}</option>)}</select>}
                            </div>
                            <div className="flex gap-1 items-center">{AGENDA_COLORS.map(c => (<button key={c.id} onClick={()=>setNewItem({...newItem, color: c.id})} className={`w-5 h-5 rounded-full ${c.bg} border ${newItem.color === c.id ? 'border-gray-500 scale-110' : 'border-transparent'}`}></button>))}</div>
                            <button onClick={handleSave} className="w-full bg-blue-600 text-white px-3 rounded text-xs font-bold py-1">Salvar</button>
                        </div>
                    )}
                    <div className={`flex-1 p-2 space-y-2 ${scrollable ? 'overflow-y-auto max-h-[300px]' : ''}`}>
                        {sortedItems.length === 0 && <p className="text-center text-gray-400 text-xs py-4">Nenhum item.</p>}
                        {sortedItems.map(item => {
                            const color = AGENDA_COLORS.find(c => c.id === item.color) || AGENDA_COLORS[0];
                            const [y, m, d] = item.date.split('-');
                            return (
                                <div key={item.id} className="group flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 border border-transparent hover:border-gray-100 transition-all">
                                    <div className={`flex-shrink-0 w-12 h-12 rounded-lg ${color.bg} flex flex-col items-center justify-center text-[10px] font-bold ${color.text}`}><span>{d}</span></div>
                                    <div className="flex-1 min-w-0"><p className="text-xs font-bold text-gray-800 truncate">{item.title}</p>{item.eventName && <p className="text-[9px] text-gray-400 truncate">{item.eventName}</p>}</div>
                                    {!readOnly && <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => startEdit(item)} className="text-gray-300 hover:text-blue-500"><Edit2 size={14}/></button><button onClick={() => onDelete(item.id)} className="text-gray-300 hover:text-red-500"><Trash2 size={14}/></button></div>}
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        };

        // --- Modals ---
        const WorkloadDetailModal = ({ isOpen, onClose, member, memberTasks, allMembers, onUpdateTask }) => {
            if (!isOpen || !member) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Carga de Trabalho: ${member.name}`}>
                    <div className="p-6">
                        <div className="flex items-center gap-4 mb-6 p-4 bg-gray-50 rounded-xl border border-gray-100"><div className="w-16 h-16 rounded-full overflow-hidden border-2 border-white shadow-md"><Avatar member={member} size="w-full h-full"/></div><div><h3 className="font-bold text-lg text-gray-900">{member.name}</h3><p className="text-sm text-gray-500">{member.role}</p><span className="inline-block mt-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-bold">{memberTasks.length} Tarefas Ativas</span></div></div>
                        <div className="space-y-2 max-h-60 overflow-y-auto pr-2">{memberTasks.map(t => (<div key={t.id} className="p-3 border border-gray-100 rounded-xl flex justify-between items-center bg-white hover:shadow-sm transition-all group"><span className="text-sm font-medium text-gray-700 truncate flex-1 pr-4">{t.text}</span></div>))}</div>
                    </div>
                </Modal>
            );
        };

        const ManageCategoriesModal = ({ isOpen, onClose, categories, onUpdateCategories }) => {
            const [cats, setCats] = useState(categories);
            const [newCat, setNewCat] = useState({ title: '', color: 'blue', icon: 'box', phases: ['pre','during','post'] });
            const [editingId, setEditingId] = useState(null);
            
            useEffect(() => { setCats(categories); }, [categories]);
            
            const handleUpdate = (id, field, val) => { setCats(prev => prev.map(c => c.id === id ? { ...c, [field]: val } : c)); };
            const handleDelete = (id) => { if (confirm("Tem a certeza?")) setCats(prev => prev.filter(c => c.id !== id)); };
            // Melhoria na gera√ß√£o de ID para evitar conflitos
            const handleAdd = () => { 
                if (!newCat.title.trim()) return; 
                const uniqueId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                setCats(prev => [...prev, { id: uniqueId, ...newCat }]); 
                setNewCat({ title: '', color: 'blue', icon: 'box', phases: ['pre','during','post'] }); 
            };
            const save = () => { onUpdateCategories(cats); onClose(); };

            const toggleNewCatPhase = (p) => {
                setNewCat(prev => {
                    const current = prev.phases || [];
                    if(current.includes(p)) return {...prev, phases: current.filter(x=>x!==p)};
                    return {...prev, phases: [...current, p]};
                })
            }
            
            const toggleEditCatPhase = (id, p) => {
                 setCats(prev => prev.map(c => {
                    if(c.id !== id) return c;
                    const current = c.phases || ['pre','during','post'];
                    let newPhases;
                    if(current.includes(p)) newPhases = current.filter(x=>x!==p);
                    else newPhases = [...current, p];
                    return {...c, phases: newPhases};
                 }));
            }

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Ajustes de Categorias">
                    <div className="p-6">
                        {/* Nova Categoria */}
                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6">
                            <h4 className="text-xs font-bold text-blue-800 uppercase mb-3">Nova Categoria</h4>
                            <div className="flex flex-col gap-3">
                                <input className="w-full p-2 border rounded-lg text-sm bg-white" placeholder="Nome da Categoria..." value={newCat.title} onChange={e=>setNewCat({...newCat, title: e.target.value})}/>
                                
                                {/* Sele√ß√£o de Fases para Nova Categoria */}
                                <div>
                                    <span className="text-[10px] font-bold text-gray-500 uppercase block mb-1">Fases do Evento:</span>
                                    <div className="flex gap-3 flex-wrap">
                                        {[
                                            {id: 'pre', label: 'Pr√©-Evento'}, 
                                            {id: 'during', label: 'Durante'}, 
                                            {id: 'post', label: 'P√≥s-Evento'}
                                        ].map(phase => (
                                            <label key={phase.id} className="flex items-center gap-1.5 text-xs bg-white px-2 py-1 rounded border border-blue-200 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    checked={newCat.phases?.includes(phase.id)} 
                                                    onChange={() => toggleNewCatPhase(phase.id)}
                                                    className="rounded text-blue-600 focus:ring-blue-500"
                                                />
                                                {phase.label}
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                <div className="flex gap-2 items-center">
                                    <span className="text-[10px] font-bold text-gray-500 uppercase">Cor:</span>
                                    {PASTEL_COLORS.map(c => (
                                        <button key={c.id} onClick={() => setNewCat({...newCat, color: c.id})} className={`w-6 h-6 rounded-full ${c.bg} border-2 ${newCat.color === c.id ? 'border-gray-600 scale-110' : 'border-transparent'}`}></button>
                                    ))}
                                </div>
                                <div>
                                    <span className="text-[10px] font-bold text-gray-500 uppercase block mb-1">√çcone:</span>
                                    <div className="grid grid-cols-8 gap-2 bg-white p-2 rounded-lg border max-h-24 overflow-y-auto">
                                        {ICON_KEYS.map(iconKey => { 
                                            const Icon = ICON_MAP[iconKey]; 
                                            return (
                                                <button key={iconKey} onClick={() => setNewCat({...newCat, icon: iconKey})} className={`p-1.5 rounded hover:bg-gray-100 flex justify-center ${newCat.icon === iconKey ? 'text-blue-600 bg-blue-50' : 'text-gray-500'}`}><Icon size={16}/></button>
                                            ) 
                                        })}
                                    </div>
                                </div>
                                <button onClick={handleAdd} className="w-full bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-bold mt-2">Adicionar</button>
                            </div>
                        </div>

                        {/* Lista de Categorias */}
                        <div className="space-y-3 max-h-[40vh] overflow-y-auto pr-2">
                            {cats.map(cat => (
                                <div key={cat.id} className="bg-white p-3 rounded-xl border border-gray-200">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className={`p-2 rounded-lg bg-${cat.color}-100 text-${cat.color}-700`}>
                                                {React.createElement(ICON_MAP[cat.icon] || Box, { size: 18 })}
                                            </div>
                                            {editingId === cat.id ? (
                                                <input className="font-bold text-sm bg-gray-50 border rounded px-1" value={cat.title} onChange={e=>handleUpdate(cat.id, 'title', e.target.value)} />
                                            ) : (
                                                <div className="flex flex-col">
                                                    <span className="font-bold text-sm text-gray-800">{cat.title}</span>
                                                    <span className="text-[10px] text-gray-400">
                                                        {(cat.phases && cat.phases.length > 0 && cat.phases.length < 3) 
                                                            ? cat.phases.map(p => p==='pre'?'Pr√©':p==='during'?'Durante':'P√≥s').join(', ') 
                                                            : 'Todas as Fases'}
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex gap-1">
                                            <button onClick={() => setEditingId(editingId === cat.id ? null : cat.id)} className={`p-1.5 rounded ${editingId === cat.id ? 'text-green-600 bg-green-50' : 'text-gray-400 hover:text-blue-500'}`}>
                                                {editingId === cat.id ? <Check size={16}/> : <Edit2 size={16}/>}
                                            </button>
                                            <button onClick={() => handleDelete(cat.id)} className="p-1.5 text-gray-400 hover:text-red-500">
                                                <Trash2 size={16}/>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {editingId === cat.id && (
                                        <div className="mt-3 pt-3 border-t border-gray-100 space-y-3 animate-in">
                                             {/* Edi√ß√£o de Fases */}
                                             <div>
                                                <span className="text-[10px] font-bold text-gray-400 uppercase block mb-1">Fases:</span>
                                                <div className="flex gap-3 flex-wrap">
                                                    {[
                                                        {id: 'pre', label: 'Pr√©'}, 
                                                        {id: 'during', label: 'Durante'}, 
                                                        {id: 'post', label: 'P√≥s'}
                                                    ].map(phase => {
                                                        const isChecked = (cat.phases || ['pre','during','post']).includes(phase.id);
                                                        return (
                                                            <label key={phase.id} className={`flex items-center gap-1.5 text-xs px-2 py-1 rounded border cursor-pointer ${isChecked ? 'bg-blue-50 border-blue-200 text-blue-800' : 'bg-gray-50 border-gray-200 text-gray-500'}`}>
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={isChecked} 
                                                                    onChange={() => toggleEditCatPhase(cat.id, phase.id)}
                                                                    className="rounded text-blue-600 focus:ring-blue-500"
                                                                />
                                                                {phase.label}
                                                            </label>
                                                        )
                                                    })}
                                                </div>
                                            </div>

                                            <div className="flex gap-2 items-center">
                                                <span className="text-[10px] font-bold text-gray-400 uppercase">Cor:</span>
                                                {PASTEL_COLORS.map(c => (
                                                    <button key={c.id} onClick={() => handleUpdate(cat.id, 'color', c.id)} className={`w-5 h-5 rounded-full ${c.bg} border-2 ${cat.color === c.id ? 'border-gray-600 scale-110' : 'border-transparent'}`}></button>
                                                ))}
                                            </div>
                                            <div>
                                                <span className="text-[10px] font-bold text-gray-400 uppercase block mb-1">√çcone:</span>
                                                <div className="grid grid-cols-8 gap-2 bg-gray-50 p-2 rounded-lg border">
                                                    {ICON_KEYS.map(iconKey => { 
                                                        const Icon = ICON_MAP[iconKey]; 
                                                        return (
                                                            <button 
                                                                key={iconKey} 
                                                                onClick={() => handleUpdate(cat.id, 'icon', iconKey)} 
                                                                className={`p-1 rounded flex justify-center ${cat.icon === iconKey ? 'text-blue-600 bg-blue-50' : 'text-gray-400'}`}
                                                            >
                                                                <Icon size={14}/>
                                                            </button>
                                                        ) 
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        <div className="mt-6 flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-500 text-sm font-bold">Cancelar</button>
                            <button onClick={save} className="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">Concluir</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const SettingsModal = ({ isOpen, onClose, members, onUpdateMember, onAddMember, onUpdateLogo, currentLogo, managerId, onUpdateManager, onUpdateGeminiKey }) => {
            const [apiKey, setApiKey] = useState('');
            const logoInputRef = useRef(null);
            const memberPhotoInputRef = useRef(null);
            const [newMemberName, setNewMemberName] = useState('');
            const [newMemberRole, setNewMemberRole] = useState('Marketing');
            const [newMemberPhoto, setNewMemberPhoto] = useState(null);
            const [editingMemberId, setEditingMemberId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editRole, setEditRole] = useState('');

            const handleLogoUpload = async (e) => { if(e.target.files[0]) { const url = await compressImage(e.target.files[0], 200); onUpdateLogo(url); } };
            const handleNewMemberPhoto = async (e) => { if(e.target.files[0]) { const url = await compressImage(e.target.files[0], 150); setNewMemberPhoto(url); } };
            const handleAddMemberAction = () => { if(!newMemberName) return; onAddMember({ id: Date.now().toString(), name: newMemberName, role: newMemberRole, photoUrl: newMemberPhoto }); setNewMemberName(''); setNewMemberPhoto(null); };
            const handleMemberPhotoUpdate = async (e, memberId) => { if(e.target.files[0]) { const url = await compressImage(e.target.files[0], 150); onUpdateMember(memberId, { photoUrl: url }); } };
            
            const startEditingMember = (member) => { setEditingMemberId(member.id); setEditName(member.name); setEditRole(member.role); };
            const saveMember = () => { onUpdateMember(editingMemberId, { name: editName, role: editRole }); setEditingMemberId(null); };
            const manager = members.find(m => m.id === managerId) || members[0];
            const handleSaveKey = () => { onUpdateGeminiKey(apiKey); alert("Chave API salva!"); };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Ajustes" maxWidth="max-w-2xl">
                    <div className="p-6 space-y-8">
                        <section><h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Sparkles size={16} className="text-blue-600"/> Chave API Gemini (IA)</h4><div className="bg-gray-50 p-4 rounded-xl border border-gray-200"><p className="text-xs text-gray-500 mb-3">Para ativar a IA, insira sua chave da Google AI Studio aqui.</p><div className="flex gap-2"><input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} className="flex-1 p-2 text-sm border rounded-lg outline-none focus:border-blue-500" placeholder="AIza..."/><button onClick={handleSaveKey} className="bg-blue-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-800">Salvar</button></div></div></section>
                        <section><h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><ImageIcon size={16} className="text-blue-600"/> Identidade Visual</h4><div className="flex items-center gap-4"><div className="w-20 h-20 rounded-xl border border-dashed border-gray-300 flex items-center justify-center overflow-hidden bg-transparent relative">{currentLogo ? <img src={currentLogo} className="w-full h-full object-contain"/> : <span className="text-xs text-gray-400">Logo</span>}</div><div><p className="text-sm font-bold text-gray-800 mb-1">Carregar logo</p><button onClick={() => logoInputRef.current.click()} className="text-xs bg-white border border-gray-300 px-3 py-1.5 rounded-lg font-medium hover:bg-gray-50">Escolher arquivo</button><input type="file" ref={logoInputRef} className="hidden" accept="image/*" onChange={handleLogoUpload}/></div></div></section>
                        <section>
                            <h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Crown size={16} className="text-amber-500"/> Gestor da Equipe</h4>
                            <div className="bg-white p-3 border rounded-xl flex items-center justify-between gap-3">
                                <div className="flex items-center gap-3">
                                    <Avatar member={manager}/> 
                                    <div><p className="text-sm font-bold">{manager?.name}</p><p className="text-xs text-gray-500">L√≠der / Admin</p></div>
                                </div>
                                <select className="text-xs p-1 border rounded" value={managerId} onChange={(e) => onUpdateManager(e.target.value)}>
                                    {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                </select>
                            </div>
                        </section>
                        <section><h4 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><Users size={16} className="text-blue-600"/> Equipe Global</h4><div className="space-y-3 mb-4">{members.filter(m => m.role !== 'Tempor√°rio').map(m => (<div key={m.id} className="flex justify-between items-center bg-white p-3 border rounded-xl"><div className="flex items-center gap-3"><div className="relative group cursor-pointer"><Avatar member={m}/><div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white"><Camera size={12}/></div><input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={(e) => handleMemberPhotoUpdate(e, m.id)}/></div><div>{editingMemberId === m.id ? <div className="flex flex-col gap-1"><input className="border p-1 text-sm rounded" value={editName} onChange={e=>setEditName(e.target.value)}/><input className="border p-1 text-xs rounded" value={editRole} onChange={e=>setEditRole(e.target.value)}/></div> : <div><p className="text-sm font-bold text-gray-800">{m.name}</p><p className="text-xs text-gray-500">{m.role}</p></div>}</div></div><div className="flex gap-2">{editingMemberId === m.id ? <button onClick={saveMember} className="text-green-600"><Check size={16}/></button> : <button onClick={() => startEditingMember(m)} className="text-gray-400 hover:text-blue-500"><Edit2 size={16}/></button>}</div></div>))}</div><div className="bg-gray-50 p-4 rounded-xl border border-gray-200"><h5 className="text-xs font-bold uppercase text-gray-500 mb-3">Novo Membro</h5><div className="flex gap-3 items-end"><div className="flex flex-col items-center gap-2"><div className="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center cursor-pointer hover:bg-gray-300 overflow-hidden" onClick={() => memberPhotoInputRef.current.click()}>{newMemberPhoto ? <img src={newMemberPhoto} className="w-full h-full object-cover"/> : <Camera size={16} className="text-gray-500"/>}</div><span className="text-[9px] text-gray-500">Carregar Foto</span><input type="file" ref={memberPhotoInputRef} className="hidden" accept="image/*" onChange={handleNewMemberPhoto}/></div><div className="flex-1 space-y-2"><input className="w-full p-2 text-sm border rounded-lg" placeholder="Nome" value={newMemberName} onChange={e=>setNewMemberName(e.target.value)}/><input className="w-full p-2 text-sm border rounded-lg" placeholder="Cargo (Ex: Marketing)" value={newMemberRole} onChange={e=>setNewMemberRole(e.target.value)}/></div></div><button onClick={handleAddMemberAction} className="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg text-sm font-bold">Adicionar Membro</button></div></section>
                    </div>
                </Modal>
            );
        };

        const NewEventModal = ({ isOpen, onClose, onCreate, members }) => {
            const [title, setTitle] = useState('');
            const [location, setLocation] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [isSingleDay, setIsSingleDay] = useState(false);
            const [responsible, setResponsible] = useState('');
            const [team, setTeam] = useState([]);
            const [selectedOptionalTasks, setSelectedOptionalTasks] = useState([]);
            useEffect(() => { if (isSingleDay) setEndDate(startDate); }, [isSingleDay, startDate]);
            if (!isOpen) return null;
            const toggleTask = (taskId) => { if (selectedOptionalTasks.includes(taskId)) setSelectedOptionalTasks(prev => prev.filter(id => id !== taskId)); else setSelectedOptionalTasks(prev => [...prev, taskId]); };
            const toggleTeamMember = (memberId) => { if (team.includes(memberId)) setTeam(prev => prev.filter(id => id !== memberId)); else setTeam(prev => [...prev, memberId]); };
            
            const handleSubmit = () => {
                if (!title || !startDate || !responsible) { alert("Preencha Nome, Data e Respons√°vel."); return; }
                
                // 1. Gerar ID do Evento agora para usar nas tarefas
                const newEventId = Date.now().toString();

                // 2. Preparar Tarefas Iniciais com IDs e v√≠nculo ao evento
                const initialTasksToCreate = OPTIONAL_STARTUP_TASKS
                    .filter(t => selectedOptionalTasks.includes(t.id))
                    .map((t, index) => ({ 
                        id: (Date.now() + index + 1).toString(), // Gera ID √∫nico para a tarefa
                        eventId: newEventId, // V√≠nculo importante!
                        text: t.text, 
                        category: t.category, 
                        phase: t.phase, 
                        priority: 'medium', 
                        status: 'planning', 
                        cost: 0, 
                        responsible: members.find(m => m.id === responsible) || null,
                        messages: [], 
                        support: [], 
                        subtasks: [] 
                    }));

                const formatDate = (d) => { if (!d) return ''; const [y, m, day] = d.split('-'); return `${day}/${m}/${y}`; }
                const dateRange = isSingleDay || !endDate ? formatDate(startDate) : `${formatDate(startDate)} - ${formatDate(endDate)}`;
                
                onCreate({ 
                    id: newEventId, 
                    title, 
                    location: location || 'Local a definir', 
                    startDate, 
                    endDate: isSingleDay ? startDate : endDate, 
                    dateRange, 
                    responsibleId: responsible, 
                    teamIds: team, 
                    categories: DEFAULT_CATEGORIES, 
                    agenda: [] 
                }, initialTasksToCreate);
                
                onClose(); 
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Novo Evento" hideHeader={true} maxWidth="max-w-3xl">
                    <div className="bg-gradient-to-r from-blue-900 via-indigo-800 to-purple-900 p-8 text-white relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10 transform translate-x-4 -translate-y-4"><Rocket size={120} /></div><h2 className="text-3xl font-extrabold mb-2 flex items-center gap-3 relative z-10"><Sparkles className="text-amber-400 animate-pulse" /> Criar Novo Evento</h2><p className="text-blue-100 text-sm max-w-md relative z-10 opacity-90">Prepare o terreno para um evento inesquec√≠vel. Comece definindo os detalhes principais abaixo.</p></div>
                    <div className="p-8 space-y-6">
                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome do Evento *</label><input className="w-full p-4 border border-gray-200 rounded-xl bg-gray-50 text-sm outline-none focus:border-blue-500" placeholder="Ex: Lan√ßamento 2026" value={title} onChange={e=>setTitle(e.target.value)} autoFocus/></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Local</label><input className="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-sm outline-none" placeholder="Cidade/Estado" value={location} onChange={e=>setLocation(e.target.value)}/></div>
                            <div className="space-y-3"><div className="flex items-center justify-between"><label className="block text-xs font-bold text-gray-500 uppercase">In√≠cio *</label><label className="flex items-center gap-2 text-xs font-bold text-blue-600 cursor-pointer"><input type="checkbox" checked={isSingleDay} onChange={e => setIsSingleDay(e.target.checked)}/> Dia √∫nico?</label></div><div className="flex gap-2"><input type="date" className="w-full p-3 border rounded-xl bg-gray-50 text-sm" value={startDate} onChange={e=>setStartDate(e.target.value)}/>{!isSingleDay && <input type="date" className="w-full p-3 border rounded-xl bg-gray-50 text-sm" value={endDate} onChange={e=>setEndDate(e.target.value)}/>}</div></div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2 border-t border-gray-100">
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Respons√°vel *</label><div className="space-y-2 max-h-40 overflow-y-auto">{members.map(m => (<div key={m.id} onClick={() => setResponsible(m.id)} className={`flex items-center gap-3 p-2 rounded-lg cursor-pointer border transition-all ${responsible === m.id ? 'bg-blue-50 border-blue-500' : 'bg-white border-gray-100 hover:bg-gray-50'}`}><Avatar member={m} size="w-8 h-8"/><span className="text-xs font-bold flex-1">{m.name}</span>{responsible === m.id && <Check size={14} className="text-blue-600"/>}</div>))}</div></div>
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Equipe</label><div className="flex flex-wrap gap-2">{members.filter(m => m.id !== responsible).map(m => (<button key={m.id} onClick={() => toggleTeamMember(m.id)} className={`flex items-center gap-2 p-1.5 rounded-lg border text-xs ${team.includes(m.id) ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'bg-white border-gray-200'}`}><Avatar member={m} size="w-5 h-5"/> {m.name}</button>))}</div></div>
                        </div>
                        <div className="pt-2 border-t border-gray-100"><label className="block text-xs font-bold text-gray-500 uppercase mb-3">Tarefas Iniciais (Opcional)</label><div className="bg-gray-50 border border-gray-200 rounded-xl p-4 max-h-40 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-3">{OPTIONAL_STARTUP_TASKS.map(task => (<label key={task.id} className={`flex items-center gap-2 p-2 rounded-lg border cursor-pointer transition-all ${selectedOptionalTasks.includes(task.id) ? 'bg-white border-blue-300 shadow-sm' : 'border-transparent'}`}><input type="checkbox" className="rounded text-blue-600" checked={selectedOptionalTasks.includes(task.id)} onChange={() => toggleTask(task.id)}/><span className="text-xs text-gray-700">{task.text}</span></label>))}</div></div>
                        <button onClick={handleSubmit} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl font-bold hover:shadow-lg animate-shine bg-[length:200%_auto]">Criar Evento</button>
                    </div>
                </Modal>
            );
        };

        const EditEventModal = ({ isOpen, onClose, event, onUpdate, onDelete, members }) => {
            const [title, setTitle] = useState(event?.title || '');
            const [startDate, setStartDate] = useState(event?.startDate || '');
            const [endDate, setEndDate] = useState(event?.endDate || ''); // Add endDate
            const [location, setLocation] = useState(event?.location || ''); // Add location
            const [cover, setCover] = useState(event?.coverUrl || '');
            const [responsible, setResponsible] = useState(event?.responsibleId || '');
            const fileInputRef = useRef(null);

            useEffect(() => {
                if(event) { 
                    setTitle(event.title || ''); 
                    setStartDate(event.startDate || ''); 
                    setEndDate(event.endDate || ''); 
                    setLocation(event.location || ''); 
                    setCover(event.coverUrl || ''); 
                    setResponsible(event.responsibleId || '');
                }
            }, [event]);

            if(!isOpen || !event) return null;

            const handleSave = () => { 
                // Include location and endDate in update
                onUpdate(event.id, { title, startDate, endDate, location, coverUrl: cover, responsibleId: responsible }); 
                onClose(); 
            };
            const handleCoverUpload = async (e) => { if(e.target.files[0]) { const url = await compressImage(e.target.files[0], 800); setCover(url); } };

            // Calculate countdown for display inside modal
            const getLocalDaysLeft = () => {
                if (!startDate) return 0;
                const [year, month, day] = startDate.split('-').map(Number);
                const target = new Date(year, month - 1, day);
                const today = new Date();
                today.setHours(0,0,0,0);
                const diff = target - today;
                return Math.ceil(diff / (86400000));
            };
            const daysLeft = getLocalDaysLeft();
            const daysLeftText = daysLeft < 0 ? `Terminou h√° ${Math.abs(daysLeft)} dias` : daysLeft === 0 ? "√â hoje!" : `Faltam ${daysLeft} dias`;
            
            const formatDate = (d) => { if (!d) return ''; const [y, m, day] = d.split('-'); return `${day}/${m}/${y}`; };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Editar Evento">
                      {/* Add Countdown Banner */}
                    <div className={`mb-4 p-3 rounded-xl text-center flex flex-col gap-1 ${daysLeft < 0 ? 'bg-gray-100 text-gray-600' : 'bg-blue-50 text-blue-700'}`}>
                        <span className="text-lg font-bold">{daysLeftText}</span>
                        <span className="text-xs font-normal opacity-80">
                            {formatDate(startDate)} {endDate && endDate !== startDate ? ` - ${formatDate(endDate)}` : ''}
                            {location ? ` ‚Ä¢ ${location}` : ''}
                        </span>
                    </div>

                    <div className="space-y-4">
                        <div onClick={()=>fileInputRef.current.click()} className="h-32 bg-gray-100 rounded-xl flex items-center justify-center cursor-pointer overflow-hidden relative group border border-gray-200">
                            {cover ? <img src={cover} className="w-full h-full object-cover"/> : <span className="text-gray-400 font-bold">Alterar Capa</span>}
                            <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white font-bold"><Camera size={24}/></div>
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleCoverUpload}/>
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome do Evento</label>
                            <input className="w-full p-3 border rounded-xl font-bold text-gray-800" placeholder="Nome" value={title} onChange={e=>setTitle(e.target.value)}/>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">In√≠cio</label>
                                <input type="date" className="w-full p-3 border rounded-xl text-sm" value={startDate} onChange={e=>setStartDate(e.target.value)}/>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Fim</label>
                                <input type="date" className="w-full p-3 border rounded-xl text-sm" value={endDate} onChange={e=>setEndDate(e.target.value)}/>
                            </div>
                        </div>

                         <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Localiza√ß√£o</label>
                            <input className="w-full p-3 border rounded-xl text-sm" placeholder="Ex: S√£o Paulo, SP" value={location} onChange={e=>setLocation(e.target.value)}/>
                        </div>

                         <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Respons√°vel</label>
                            <select 
                                className="w-full p-3 border rounded-xl bg-white text-sm" 
                                value={responsible} 
                                onChange={(e) => setResponsible(e.target.value)}
                            >
                                <option value="">Selecione...</option>
                                {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                            </select>
                        </div>
                        
                        <div className="flex gap-2 pt-2">
                            <button onClick={handleSave} className="flex-1 bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition-colors">Salvar</button>
                            {onDelete && (
                                <button 
                                    onClick={() => onDelete(event.id)} 
                                    className="bg-red-50 text-red-600 p-3 rounded-xl font-bold hover:bg-red-100 transition-colors"
                                    title="Excluir Evento"
                                >
                                    <Trash2 size={20}/>
                                </button>
                            )}
                        </div>
                    </div>
                </Modal>
            );
        };

        const NewTaskModal = ({ isOpen, onClose, eventCategories, onCreate, members, eventId }) => {
            const [text, setText] = useState('');
            const [category, setCategory] = useState(eventCategories[0]?.id || '');
            const [phase, setPhase] = useState('pre');
            const [responsible, setResponsible] = useState('');
            const [support, setSupport] = useState([]);
            const [cost, setCost] = useState(0);

            if (!isOpen) return null;

            const handleCreate = () => {
                if (!text) return;
                
                const responsibleMember = members.find(m => m.id === responsible);
                const supportMembers = support.map(id => members.find(m => m.id === id)).filter(Boolean);

                onCreate({
                    id: Date.now(),
                    eventId,
                    text,
                    category,
                    phase,
                    responsible: responsibleMember || null, // FIX: Ensure null if undefined
                    support: supportMembers,
                    status: 'planning',
                    priority: 'medium',
                    subtasks: [],
                    messages: [],
                    cost: Number(cost)
                });
                setText(''); setResponsible(''); setSupport([]); setCost(0);
                onClose();
            };

            const toggleSupport = (id) => {
                if(support.includes(id)) setSupport(prev => prev.filter(s => s !== id));
                else setSupport(prev => [...prev, id]);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Nova Tarefa">
                    <div className="p-6 space-y-4">
                        <input className="w-full p-3 border rounded-xl" placeholder="Descri√ß√£o da Tarefa" value={text} onChange={e=>setText(e.target.value)} autoFocus/>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-xs font-bold text-gray-500 uppercase">Categoria</label><select className="w-full p-2 border rounded-lg mt-1" value={category} onChange={e=>setCategory(e.target.value)}>{eventCategories.map(c=><option key={c.id} value={c.id}>{c.title}</option>)}</select></div>
                            <div><label className="text-xs font-bold text-gray-500 uppercase">Fase</label><select className="w-full p-2 border rounded-lg mt-1" value={phase} onChange={e=>setPhase(e.target.value)}><option value="pre">Pr√©-Evento</option><option value="during">Durante</option><option value="post">P√≥s-Evento</option></select></div>
                        </div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase">Custo Estimado (R$)</label><input type="number" className="w-full p-2 border rounded-lg mt-1" value={cost} onChange={e=>setCost(e.target.value)}/></div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase">Respons√°vel (Opcional)</label><select className="w-full p-2 border rounded-lg mt-1" value={responsible} onChange={e=>setResponsible(e.target.value)}><option value="">Selecione...</option>{members.map(m=><option key={m.id} value={m.id}>{m.name}</option>)}</select></div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Apoio (Opcional)</label><div className="flex flex-wrap gap-2">{members.filter(m=>m.id!==responsible).map(m=><button key={m.id} onClick={()=>toggleSupport(m.id)} className={`p-1.5 rounded-full border-2 ${support.includes(m.id)?'border-blue-500':'border-transparent opacity-50'}`}><Avatar member={m} size="w-8 h-8"/></button>)}</div></div>
                        <button onClick={handleCreate} className="w-full bg-blue-600 text-white p-3 rounded-xl font-bold">Adicionar Tarefa</button>
                    </div>
                </Modal>
            );
        };

        // --- Bottom Navigation ---
        const BottomNav = ({ activeTab, onChangeTab, onAdd }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-2 flex justify-between items-center z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <button onClick={() => onChangeTab('dashboard')} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'dashboard' ? 'text-blue-900' : 'text-gray-400'}`}><Home size={20} /><span className="text-[10px]">In√≠cio</span></button>
                <button onClick={() => onChangeTab('agenda')} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'agenda' ? 'text-blue-900' : 'text-gray-400'}`}><CalendarIcon size={20} /><span className="text-[10px]">Agenda</span></button>
                <div className="relative -top-6"><button onClick={onAdd} className="w-14 h-14 bg-gradient-to-r from-blue-900 to-blue-800 rounded-full shadow-lg flex items-center justify-center text-white"><Plus size={28} /></button></div>
                <button onClick={() => onChangeTab('team')} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'team' ? 'text-blue-900' : 'text-gray-400'}`}><Users size={20} /><span className="text-[10px]">Equipe</span></button>
                <button onClick={() => onChangeTab('settings')} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'settings' ? 'text-blue-900' : 'text-gray-400'}`}><Settings size={20} /><span className="text-[10px]">Ajustes</span></button>
            </div>
        );

        // --- Task Detail Modal (With Chat, Subtasks, Reassign) ---
        const TaskDetailModal = ({ isOpen, onClose, task, members, dbOperations, deleteTask }) => {
            const [messageText, setMessageText] = useState("");
            const [selectedSender, setSelectedSender] = useState(members[0]);
            const [chatAttachment, setChatAttachment] = useState(null);
            const [newSubtask, setNewSubtask] = useState("");
            const [showEmojis, setShowEmojis] = useState(false);
            const chatEndRef = useRef(null);
            const fileInputRef = useRef(null);

            // Fetch specific task from props (which is now fresh from parent)
            const currentTask = task; 

            if (!isOpen || !currentTask) return null;

            // Scroll to bottom on new message
            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [currentTask.messages]);

            const handleSendMessage = () => {
                if (!messageText.trim() && !chatAttachment) return;
                const newMessage = {
                    id: Date.now(),
                    senderId: selectedSender.id,
                    senderName: selectedSender.name,
                    text: messageText,
                    image: chatAttachment,
                    timestamp: new Date().toISOString()
                };
                // IMPORTANT: Create a new array and update via parent
                const updatedMessages = [...(currentTask.messages || []), newMessage];
                dbOperations.updateTask(currentTask.id, { messages: updatedMessages });
                setMessageText("");
                setChatAttachment(null);
            };

            const handleDeleteMessage = (msgId) => {
                const updatedMessages = currentTask.messages.filter(m => m.id !== msgId);
                dbOperations.updateTask(currentTask.id, { messages: updatedMessages });
            };

            const handleAddSubtask = () => {
                if (!newSubtask.trim()) return;
                const newSub = { id: Date.now(), text: newSubtask, completed: false };
                const updatedSubtasks = [...(currentTask.subtasks || []), newSub];
                dbOperations.updateTask(currentTask.id, { subtasks: updatedSubtasks });
                setNewSubtask("");
            };

            const toggleSubtask = (subId) => {
                const updatedSubtasks = currentTask.subtasks.map(s => s.id === subId ? { ...s, completed: !s.completed } : s);
                dbOperations.updateTask(currentTask.id, { subtasks: updatedSubtasks });
            };

            const handleFileSelect = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = await compressImage(file, 400);
                    setChatAttachment(url);
                }
            };

            const addEmoji = (emoji) => {
                setMessageText(prev => prev + emoji);
                setShowEmojis(false);
            };

            const toggleSupport = (memberId) => {
                const currentSupport = currentTask.support || [];
                const newSupport = currentSupport.some(m => m.id === memberId) 
                    ? currentSupport.filter(m => m.id !== memberId) 
                    : [...currentSupport, members.find(m => m.id === memberId)];
                dbOperations.updateTask(currentTask.id, { support: newSupport });
            };

            const handleDeleteTask = () => {
                if(confirm("Tem a certeza que deseja excluir esta tarefa?")) {
                    deleteTask(currentTask.id);
                    onClose();
                }
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Tarefa: ${currentTask.text}`} fullScreen={true}>
                    <div className="flex flex-col md:flex-row h-full">
                        <div className="flex-1 p-6 overflow-y-auto border-r border-gray-200">
                            <div className="flex justify-between items-start mb-6">
                                <h2 className="text-2xl font-bold text-gray-900">{currentTask.text}</h2>
                                <button onClick={handleDeleteTask} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={20}/></button>
                            </div>
                            <div className="mb-6">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Custo (R$)</label>
                                <input 
                                    type="number" 
                                    className="w-full p-2 border rounded-lg font-bold text-gray-800" 
                                    value={currentTask.cost || 0} 
                                    onChange={(e) => dbOperations.updateTask(currentTask.id, { cost: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Respons√°vel</label>
                                    <select 
                                        className="w-full p-3 border rounded-xl bg-gray-50 text-sm font-bold" 
                                        value={currentTask.responsible?.id || ''} 
                                        onChange={(e) => {
                                            const member = members.find(m => m.id === e.target.value);
                                            dbOperations.updateTask(currentTask.id, { responsible: member || null }); // FIX: Ensure null if undefined
                                        }}
                                    >
                                        <option value="">Selecione...</option>
                                        {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                    </select>
                                </div>
                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Apoio</label><div className="flex flex-wrap gap-2">{members.map(m => (<button key={m.id} onClick={() => toggleSupport(m.id)} className={`p-1.5 rounded-full border-2 transition-all ${currentTask.support?.some(s => s.id === m.id) ? 'border-blue-500 scale-110' : 'border-transparent opacity-50 hover:opacity-100'}`}><Avatar member={m} size="w-8 h-8"/></button>))}</div></div>
                            </div>
                            <div className="mb-8"><h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2"><CheckSquare size={18}/> Tarefas Complementares</h3><div className="space-y-2 mb-3">{currentTask.subtasks?.map(sub => (<div key={sub.id} className="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg group"><input type="checkbox" checked={sub.completed} onChange={() => toggleSubtask(sub.id)} className="w-4 h-4 text-blue-600 rounded cursor-pointer"/><span className={`text-sm flex-1 ${sub.completed ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{sub.text}</span><button onClick={() => { const newSubs = currentTask.subtasks.filter(s => s.id !== sub.id); dbOperations.updateTask(currentTask.id, { subtasks: newSubs }); }} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><X size={14}/></button></div>))}</div><div className="flex gap-2"><input className="flex-1 p-2 border rounded-lg text-sm" placeholder="Adicionar item..." value={newSubtask} onChange={e => setNewSubtask(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAddSubtask()}/><button onClick={handleAddSubtask} className="bg-blue-100 text-blue-700 p-2 rounded-lg"><Plus size={18}/></button></div></div>
                        </div>
                        <div className="w-full md:w-[400px] bg-gray-50 flex flex-col border-l border-gray-200">
                            <div className="p-4 border-b bg-white font-bold text-gray-700 flex items-center gap-2"><MessageSquare size={18}/> Chat da Tarefa</div>
                            <div className="flex-1 p-4 overflow-y-auto space-y-4">
                                {(currentTask.messages || []).length === 0 && <p className="text-center text-gray-400 text-xs mt-10">Inicie a conversa sobre esta tarefa.</p>}
                                {(currentTask.messages || []).map(msg => (
                                    <div key={msg.id} className={`flex gap-2 group/msg ${msg.senderId === selectedSender.id ? 'flex-row-reverse' : ''}`}>
                                        <div className="flex-shrink-0 mt-1"><Avatar member={members.find(m => m.id === msg.senderId)} size="w-8 h-8"/></div>
                                        <div className={`p-3 rounded-xl text-sm max-w-[80%] relative ${msg.senderId === selectedSender.id ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-gray-200 rounded-tl-none'}`}>
                                            <p className="text-[10px] font-bold opacity-70 mb-1">{msg.senderName}</p>
                                            {msg.image && <img src={msg.image} className="w-full rounded-lg mb-2"/>}
                                            <p>{msg.text}</p>
                                            <button onClick={() => handleDeleteMessage(msg.id)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover/msg:opacity-100 transition-opacity"><X size={10}/></button>
                                        </div>
                                    </div>
                                ))}
                                <div ref={chatEndRef}></div>
                            </div>
                            <div className="p-3 bg-white border-t">{chatAttachment && (<div className="flex items-center gap-2 bg-blue-50 p-2 rounded-lg mb-2 text-xs text-blue-700"><ImageIcon size={14}/> Imagem selecionada <button onClick={() => setChatAttachment(null)}><X size={14}/></button></div>)}<div className="flex items-center gap-2 mb-2"><span className="text-xs text-gray-500">Falando como:</span><select className="text-xs font-bold border-none bg-transparent outline-none text-blue-700 cursor-pointer" value={selectedSender.id} onChange={e => setSelectedSender(members.find(m => m.id === e.target.value))}>{members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}</select></div><div className="flex items-end gap-2"><div className="flex-1 bg-gray-100 rounded-xl flex items-center p-1 relative"><button onClick={() => fileInputRef.current.click()} className="p-2 text-gray-400 hover:text-blue-600"><Paperclip size={18}/></button><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileSelect}/><button onClick={() => setShowEmojis(!showEmojis)} className="p-2 text-gray-400 hover:text-yellow-500"><Smile size={18}/></button>{showEmojis && (<div className="absolute bottom-12 left-0 bg-white shadow-xl border rounded-xl p-2 grid grid-cols-6 gap-2 z-10 w-64">{['üëç','üëé','üî•','üéâ','‚úÖ','‚ùå','üìÖ','üòä','ü§î','üëÄ','üöÄ','üí°'].map(e => (<button key={e} onClick={() => addEmoji(e)} className="text-xl hover:bg-gray-100 rounded p-1">{e}</button>))}</div>)}<textarea className="flex-1 bg-transparent border-none outline-none text-sm p-2 max-h-24 resize-none" rows={1} placeholder="Escreva uma mensagem..." value={messageText} onChange={e => setMessageText(e.target.value)} onKeyDown={e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } }}/></div><button onClick={handleSendMessage} className="p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 shadow-md"><Send size={18}/></button></div></div>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- Dashboard & Event Views ---

        const Dashboard = ({ events, tasks, members, onSelectEvent, onNewEvent, onMemberClick, onAddAgendaItem, onDeleteAgendaItem, onUpdateAgendaItem, globalLogo, managerId }) => {
            const [eventViewMode, setEventViewMode] = useState('active'); // 'active' or 'completed'
            
            // SORTING LOGIC ADDED HERE: Ascending for Active, Descending for Finished
            const activeEvents = events
                .filter(e => !isEventFinished(e))
                .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            
            const finishedEvents = events
                .filter(e => isEventFinished(e))
                .sort((a, b) => new Date(b.endDate || b.startDate) - new Date(a.endDate || a.startDate));
                
            const activeEventIds = activeEvents.map(e => e.id);
            
            const workload = members
                .filter(m => m.role !== 'Tempor√°rio')
                .map(m => {
                // Consider tasks from ALL active events for workload calculation
                const memberTasks = tasks.filter(t => activeEventIds.includes(t.eventId) && t.responsible?.id === m.id);
                const pending = memberTasks.filter(t => t.status !== 'done').length;
                const done = memberTasks.filter(t => t.status === 'done').length;
                const total = pending + done;
                return { ...m, pending, done, total: pending + done };
            });
            
            const allAgendaItems = events.flatMap(e => (e.agenda || []).map(a => ({...a, eventName: e.title})));
            const manager = members.find(m => m.id === managerId) || members[0];

            // Logic for global status - only active events
            const activeTasks = tasks.filter(t => activeEventIds.includes(t.eventId));
            const completedActiveTasks = activeTasks.filter(t => t.status === 'done').length;
            const totalActiveTasks = activeTasks.length;
            const progress = totalActiveTasks > 0 ? Math.round((completedActiveTasks / totalActiveTasks) * 100) : 0;

            const eventsToDisplay = eventViewMode === 'active' ? activeEvents : finishedEvents;

            return (
                <div className="max-w-[1600px] mx-auto p-6 md:p-8 animate-in pb-24">
                    <div className="flex justify-between items-center mb-8">
                        <div className="flex items-center gap-4">
                            <div className="w-20 h-20 flex items-center justify-center font-bold text-xs bg-transparent rounded-2xl overflow-hidden">{globalLogo ? <img src={globalLogo} className="w-full h-full object-contain"/> : 'LOGO'}</div>
                            <div><h1 className="text-2xl font-extrabold text-blue-950">Event Hub</h1><p className="text-sm text-gray-500">Painel de Marketing</p></div>
                        </div>
                        <div className="flex items-center gap-3 bg-white p-2 rounded-full shadow-sm border border-gray-100 pr-4 hover:shadow-md transition-all cursor-pointer group">
                            <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-2 border-white relative"><Avatar member={manager} size="w-full h-full"/></div>
                            <div className="text-left hidden sm:block"><p className="text-xs font-bold text-gray-800">{manager?.name}</p><p className="text-[10px] text-blue-600 font-bold uppercase flex items-center gap-1"><Crown size={10} fill="currentColor" /> Gestor da Equipe</p></div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 gap-8">
                        <div>
                            {/* Stats Row - Enhanced UI */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                {/* Global Status */}
                                <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 relative overflow-hidden flex items-center justify-between h-auto min-h-[14rem]">
                                    <div className="relative w-32 h-32 flex-shrink-0"><svg className="w-full h-full -rotate-90"><circle cx="64" cy="64" r="54" stroke="#F3F4F6" strokeWidth="12" fill="none"/><circle cx="64" cy="64" r="54" stroke="#1e3a8a" strokeWidth="12" fill="none" strokeDasharray="339" strokeDashoffset={339 - (339*progress)/100} strokeLinecap="round"/></svg><div className="absolute inset-0 flex items-center justify-center font-bold text-2xl text-blue-900">{progress}%</div></div>
                                    <div className="ml-8 flex-1">
                                        <h3 className="font-bold text-gray-900 mb-3 text-lg">Status Global (Ativos)</h3>
                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between bg-emerald-50 p-2 rounded-lg border border-emerald-100">
                                                <span className="text-xs font-bold text-emerald-700 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-emerald-500"></div> Conclu√≠das</span>
                                                <span className="text-sm font-extrabold text-emerald-800">{completedActiveTasks}</span>
                                            </div>
                                            <div className="flex items-center justify-between bg-amber-50 p-2 rounded-lg border border-amber-100">
                                                <span className="text-xs font-bold text-amber-700 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-amber-500"></div> Pendentes</span>
                                                <span className="text-sm font-extrabold text-amber-800">{totalActiveTasks - completedActiveTasks}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Workload - Enhanced UI (Grid instead of Scroll) */}
                                <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 flex flex-col justify-center h-auto min-h-[14rem]">
                                    <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2"><Users size={18} className="text-blue-600"/> Carga de Trabalho (Eventos Ativos)</h3>
                                    
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                        {workload.map(m => (
                                            <div key={m.id} onClick={() => onMemberClick(m)} className="flex items-center gap-3 p-2 rounded-xl border border-gray-50 hover:bg-gray-50 hover:border-gray-200 transition-all cursor-pointer group bg-white shadow-sm">
                                                <div className="relative shrink-0">
                                                    <Avatar member={m} size="w-10 h-10"/>
                                                    {m.total > 0 && (<div className={`absolute -top-1 -right-1 w-4 h-4 rounded-full flex items-center justify-center text-[9px] text-white font-bold border border-white ${m.total > 5 ? 'bg-blue-600' : 'bg-blue-400'}`}>{m.total}</div>)}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-[11px] font-bold text-gray-800 truncate">{m.name.split(' ')[0]}</p>
                                                    <div className="flex gap-2 mt-0.5">
                                                        <span className="text-[9px] font-bold text-amber-600 flex items-center gap-0.5" title="Pendentes"><div className="w-1.5 h-1.5 rounded-full bg-amber-500"></div> {m.pending}</span>
                                                        <span className="text-[9px] font-bold text-emerald-600 flex items-center gap-0.5" title="Conclu√≠das"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500"></div> {m.done}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-xl font-bold text-blue-950 flex items-center gap-2">
                                    {eventViewMode === 'active' ? <Clock size={24}/> : <CheckSquare size={24}/>} 
                                    {eventViewMode === 'active' ? 'Eventos em Andamento' : 'Eventos Conclu√≠dos'}
                                </h2>
                                <div className="bg-white p-1 rounded-xl border border-gray-200 flex shadow-sm">
                                    <button 
                                        onClick={() => setEventViewMode('active')}
                                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${eventViewMode === 'active' ? 'bg-blue-100 text-blue-800 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}
                                    >
                                        <Clock size={14}/> Em Andamento
                                    </button>
                                    <button 
                                        onClick={() => setEventViewMode('completed')}
                                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${eventViewMode === 'completed' ? 'bg-emerald-100 text-emerald-800 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}
                                    >
                                        <CheckSquare size={14}/> Conclu√≠dos
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-10 min-h-[200px]">
                                {eventsToDisplay.length === 0 ? (
                                    <div className="col-span-full flex flex-col items-center justify-center py-12 opacity-50 bg-white rounded-2xl border border-dashed border-gray-200">
                                        <div className="bg-gray-50 p-4 rounded-full mb-3 text-gray-400">
                                            {eventViewMode === 'active' ? <Rocket size={32}/> : <Archive size={32}/>}
                                        </div>
                                        <p className="text-sm font-bold text-gray-500">
                                            {eventViewMode === 'active' ? 'Nenhum evento ativo no momento.' : 'Nenhum evento conclu√≠do ainda.'}
                                        </p>
                                    </div>
                                ) : (
                                    eventsToDisplay.map(evt => (
                                        <div key={evt.id} onClick={() => onSelectEvent(evt)} className={`bg-white rounded-xl border shadow-sm hover:shadow-md transition-all cursor-pointer group overflow-hidden aspect-square flex flex-col relative transform hover:-translate-y-1 ${eventViewMode === 'completed' ? 'grayscale border-gray-200' : 'border-gray-100'}`}>
                                            <div className="flex-1 bg-gray-100 relative overflow-hidden">
                                                {evt.coverUrl && <img src={evt.coverUrl} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"/>}
                                                {eventViewMode === 'active' && (
                                                    <div className="absolute top-2 right-2 bg-white/90 px-1.5 py-0.5 rounded text-[10px] font-bold shadow-sm text-blue-900">{getDaysLeft(evt)} dias</div>
                                                )}
                                                {eventViewMode === 'completed' && (
                                                    <div className="absolute inset-0 bg-white/10 flex items-center justify-center">
                                                        <div className="bg-emerald-500 text-white p-2 rounded-full shadow-lg"><Check size={20}/></div>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="p-3 shrink-0 bg-white border-t border-gray-50">
                                                <h3 className="font-bold text-gray-900 mb-0.5 truncate text-sm">{evt.title}</h3>
                                                <p className="text-[10px] text-gray-500 flex items-center gap-1"><MapPin size={10}/> {evt.location || 'Local a definir'}</p>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const EventDetail = ({ event, onBack, tasks, members, onUpdateTask, onUpdateEvent, categories, onOpenCategorySettings, onAddTask, onDeleteTask, onAddTeamMember, onRemoveTeamMember, onDeleteEvent, onCreateMember }) => {
            const [selectedDate, setSelectedDate] = useState(null);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [selectedTaskId, setSelectedTaskId] = useState(null); // Changed to ID
            const [filterPhase, setFilterPhase] = useState('all');
            const [viewGrouping, setViewGrouping] = useState('category'); 
            const [isEditEventOpen, setIsEditEventOpen] = useState(false);
            const [isAddTeamOpen, setIsAddTeamOpen] = useState(false);
            
            // Novos estados para criar membro tempor√°rio
            const [isCreatingMember, setIsCreatingMember] = useState(false);
            const [tempMemberName, setTempMemberName] = useState('');

            // NOVOS ESTADOS DE FILTRO
            const [searchQuery, setSearchQuery] = useState('');
            const [memberFilter, setMemberFilter] = useState('');

            // ESTADO PARA EXPANDIR CATEGORIAS
            const [expandedCategories, setExpandedCategories] = useState([]);

            const toggleCategory = (id) => {
                setExpandedCategories(prev => 
                    prev.includes(id) ? prev.filter(c => c !== id) : [...prev, id]
                );
            };

            // Derived state for the modal
            const selectedTask = tasks.find(t => t.id === selectedTaskId);

            const handleDragStart = (e, task) => { e.dataTransfer.setData("taskId", task.id); };
            const handleDragOver = (e) => e.preventDefault();
            const handleDrop = (e, targetId) => { const taskId = e.dataTransfer.getData("taskId"); if (viewGrouping === 'status') onUpdateTask(parseInt(taskId), { status: targetId }); else onUpdateTask(parseInt(taskId), { category: targetId }); };
            
            // L√ìGICA DE FILTRAGEM ATUALIZADA
            const filteredTasks = tasks.filter(t => {
                // 1. Filtro de Evento
                if (t.eventId !== event.id) return false;
                
                // 2. Filtro de Fase
                if (filterPhase !== 'all' && t.phase !== filterPhase) return false;
                
                // 3. Filtro de Texto (T√≠tulo e Subtarefas)
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    const textMatch = t.text.toLowerCase().includes(query);
                    const subtaskMatch = t.subtasks && t.subtasks.some(sub => sub.text.toLowerCase().includes(query));
                    if (!textMatch && !subtaskMatch) return false;
                }

                // 4. Filtro de Membro Respons√°vel
                if (memberFilter && t.responsible?.id !== memberFilter) return false;

                return true;
            });

            const handleAddAgenda = (item) => onUpdateEvent(event.id, { agenda: [...(event.agenda||[]), item] });
            const handleDeleteAgenda = (id) => onUpdateEvent(event.id, { agenda: (event.agenda||[]).filter(a=>a.id!==id) });
            const handleUpdateAgenda = (id, newItem) => { const newAgenda = (event.agenda || []).map(a => a.id === id ? { ...a, ...newItem } : a); onUpdateEvent(event.id, { agenda: newAgenda }); };
            const cyclePriority = (task) => { const map = { low: 'medium', medium: 'high', high: 'low' }; onUpdateTask(task.id, { priority: map[task.priority || 'low'] }); };
            
            // FIX: Ensure responsible person is not duplicated in the team list
            const eventTeam = [
                members.find(m => m.id === event.responsibleId),
                ...members.filter(m => event.teamIds?.includes(m.id) && m.id !== event.responsibleId)
            ].filter(Boolean);

            // Create Temp Member Handler
            const handleCreateTempMember = () => {
                if(!tempMemberName.trim()) return;
                const newId = Date.now().toString();
                const newMember = { id: newId, name: tempMemberName, role: 'Tempor√°rio', photoUrl: null };
                
                // 1. Cria no banco global
                onCreateMember(newMember);
                
                // 2. Adiciona ao time deste evento automaticamente
                onAddTeamMember(event.id, newId);
                
                setTempMemberName('');
                setIsCreatingMember(false);
            };

            // FILTER COLUMNS BASED ON PHASE
            const columns = useMemo(() => {
                if (viewGrouping === 'status') return STATUS_COLUMNS;
                const cats = event.categories || DEFAULT_CATEGORIES;
                if (filterPhase === 'all') return cats;
                // Only return categories that apply to the selected phase (or have no phase defined -> default all)
                return cats.filter(c => !c.phases || c.phases.length === 0 || c.phases.includes(filterPhase));
            }, [viewGrouping, event.categories, filterPhase]);

            const totalEventCost = filteredTasks.reduce((acc, t) => acc + (t.cost || 0), 0);

            // ADDED: Define daysLeft and daysLeftText and formatDate here to fix ReferenceError
            const daysLeft = getDaysLeft(event);
            const daysLeftText = daysLeft < 0 ? `Terminou h√° ${Math.abs(daysLeft)} dias` : daysLeft === 0 ? "√â hoje!" : `Faltam ${daysLeft} dias`;
            const formatDate = (d) => { if (!d) return ''; const [y, m, day] = d.split('-'); return `${day}/${m}/${y}`; };

            return (
                <div className="min-h-screen bg-[#F8FAFC] pb-24 animate-in">
                    <div className="h-48 bg-blue-900 relative">
                        {event.coverUrl && <img src={event.coverUrl} className="w-full h-full object-cover opacity-30"/>}
                        <div className="absolute inset-0 bg-gradient-to-t from-[#F8FAFC] to-transparent"></div>
                        <div className="absolute bottom-4 left-6">
                            <h1 className="text-2xl font-extrabold text-blue-950">{event.title}</h1>
                            {/* Added Info Block in Header */}
                            <div className="flex flex-col mt-1">
                                 <span className="text-xs font-bold text-blue-900 bg-white/50 px-2 py-1 rounded inline-flex items-center gap-1 w-fit mb-1">
                                    <Clock size={12}/> {daysLeftText} ‚Ä¢ {formatDate(event.startDate)} {event.endDate ? `- ${formatDate(event.endDate)}` : ''}
                                 </span>
                                 <span className="text-xs text-blue-950/70 font-medium flex items-center gap-1"><MapPin size={12}/> {event.location || 'Local n√£o definido'}</span>
                            </div>
                            <p className="text-xs font-bold text-emerald-600 mt-1 flex items-center gap-1"><DollarSign size={12}/> Custo Total: {formatCurrency(totalEventCost)}</p>
                        </div>
                        <button onClick={onBack} className="absolute top-4 left-4 p-2 bg-white/20 rounded-full hover:bg-white/40 text-white"><ArrowLeft/></button>
                        <button onClick={() => setIsEditEventOpen(true)} className="absolute top-4 right-4 p-2 bg-white/20 rounded-full hover:bg-white/40 text-white"><Edit2/></button>
                    </div>

                    <div className="max-w-[1800px] mx-auto px-6 mt-4 grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <div className="lg:col-span-1 space-y-6">
                            <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-gray-800 flex items-center gap-2"><Users size={16}/> Equipe do Evento</h3>
                                    <div className="flex gap-1">
                                        <button onClick={()=>setIsAddTeamOpen(!isAddTeamOpen)} className="text-blue-600 hover:bg-blue-50 p-1.5 rounded bg-blue-50/50" title="Adicionar existente"><UserPlus size={16}/></button>
                                        <button onClick={()=>setIsCreatingMember(!isCreatingMember)} className="text-emerald-600 hover:bg-emerald-50 p-1.5 rounded bg-emerald-50/50" title="Criar Novo"><Plus size={16}/></button>
                                    </div>
                                </div>
                                
                                {/* Criar Novo Membro (Tempor√°rio) Inline */}
                                {isCreatingMember && (
                                    <div className="mb-3 p-2 bg-emerald-50 rounded-lg border border-emerald-100 animate-in">
                                        <p className="text-[10px] font-bold text-emerald-700 uppercase mb-1">Novo Colaborador</p>
                                        <div className="flex gap-1">
                                            <input 
                                                className="flex-1 p-1.5 text-xs border rounded outline-none" 
                                                placeholder="Nome..." 
                                                value={tempMemberName}
                                                onChange={e => setTempMemberName(e.target.value)}
                                                autoFocus
                                            />
                                            <button onClick={handleCreateTempMember} className="bg-emerald-600 text-white px-2 rounded text-xs font-bold"><Check size={14}/></button>
                                        </div>
                                    </div>
                                )}

                                {/* Adicionar Existente Inline */}
                                {isAddTeamOpen && (<div className="mb-3 p-2 bg-blue-50 rounded-lg max-h-32 overflow-y-auto animate-in border border-blue-100">{members.filter(m => !eventTeam.some(et => et.id === m.id)).map(m => (<div key={m.id} className="flex justify-between items-center p-1 hover:bg-white rounded cursor-pointer transition-colors" onClick={() => { onAddTeamMember(event.id, m.id); setIsAddTeamOpen(false); }}><div className="flex items-center gap-2"><Avatar member={m} size="w-5 h-5"/><span className="text-xs font-medium text-gray-700">{m.name}</span></div><Plus size={12} className="text-blue-500"/></div>))} {members.filter(m => !eventTeam.some(et => et.id === m.id)).length === 0 && <p className="text-[10px] text-gray-400 text-center">Todos j√° est√£o no time.</p>}</div>)}
                                
                                <div className="space-y-3">{eventTeam.map(m => (<div key={m.id} className="flex items-center gap-3 group"><Avatar member={m}/><div className="flex-1 min-w-0"><p className="text-xs font-bold truncate">{m.name}</p><p className="text-[10px] text-gray-500 truncate">{m.role}</p></div>{m.id === event.responsibleId ? <Crown size={14} className="text-amber-500"/> : <button onClick={() => onRemoveTeamMember(event.id, m.id)} className="text-red-400 opacity-0 group-hover:opacity-100"><X size={14}/></button>}</div>))}</div>
                            </div>
                            <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden flex flex-col h-[500px]">
                                <div className="p-4 border-b bg-gray-50/50 font-bold text-gray-700 flex items-center gap-2"><CalendarIcon size={16}/> Agenda do Evento</div>
                                <div className="flex-1 overflow-visible">
                                    <AgendaComponent agendaItems={event.agenda || []} selectedDateFilter={null} onAdd={handleAddAgenda} onDelete={handleDeleteAgenda} onUpdate={handleUpdateAgenda} contextTitle="" scrollable={true} />
                                </div>
                            </div>
                        </div>
                        <div className="lg:col-span-3 space-y-6 flex flex-col">
                            <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col xl:flex-row justify-between gap-4 items-start xl:items-center">
                                {/* Barra de Filtros Esquerda: Fases */}
                                <div className="flex bg-gray-100 p-1 rounded-lg shrink-0 overflow-x-auto max-w-full">
                                    {['all', 'pre', 'during', 'post'].map(ph => (
                                        <button key={ph} onClick={()=>setFilterPhase(ph)} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all whitespace-nowrap ${filterPhase===ph ? 'bg-white shadow text-blue-900' : 'text-gray-500'}`}>
                                            {ph === 'all' ? 'Todos' : ph === 'pre' ? 'Pr√©' : ph === 'during' ? 'Durante' : 'P√≥s'}
                                        </button>
                                    ))}
                                </div>

                                {/* Barra Central: Busca e Membro */}
                                <div className="flex-1 flex flex-col sm:flex-row gap-3 w-full">
                                    <div className="relative flex-1">
                                        <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"/>
                                        <input 
                                            className="w-full pl-9 pr-3 py-1.5 text-xs border rounded-lg bg-gray-50 focus:bg-white outline-none focus:border-blue-300 transition-colors" 
                                            placeholder="Buscar tarefa ou complemento..." 
                                            value={searchQuery} 
                                            onChange={e=>setSearchQuery(e.target.value)}
                                        />
                                    </div>
                                    <select 
                                        className="p-1.5 text-xs border rounded-lg bg-gray-50 outline-none min-w-[140px] text-gray-700 cursor-pointer hover:bg-white transition-colors" 
                                        value={memberFilter} 
                                        onChange={e=>setMemberFilter(e.target.value)}
                                    >
                                        <option value="">Todos Respons√°veis</option>
                                        {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                    </select>
                                </div>

                                {/* Barra Direita: A√ß√µes */}
                                <div className="flex items-center gap-2 shrink-0">
                                    <div className="flex bg-gray-100 p-1 rounded-lg mr-2">
                                        <button onClick={() => setViewGrouping('category')} className={`p-2 rounded-md ${viewGrouping === 'category' ? 'bg-white shadow text-blue-600' : 'text-gray-400'}`} title="Ver por Categoria"><Grid size={16}/></button>
                                        <button onClick={() => setViewGrouping('status')} className={`p-2 rounded-md ${viewGrouping === 'status' ? 'bg-white shadow text-blue-600' : 'text-gray-400'}`} title="Ver por Status"><Columns size={16}/></button>
                                    </div>
                                    <button onClick={onOpenCategorySettings} className="p-2 border rounded-lg text-gray-500 hover:bg-gray-50" title="Ajustes de Categoria"><Settings size={16}/></button>
                                    <button onClick={onAddTask} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 flex items-center gap-2 shadow-sm shadow-blue-200"><Plus size={14}/> Nova Tarefa</button>
                                </div>
                            </div>
                            
                             {/* Category List - Accordion Style */}
                             <div className="flex flex-col gap-4 pb-4">
                                {columns.map(col => {
                                    const colTasks = filteredTasks.filter(t => viewGrouping === 'status' ? t.status === col.id : t.category === col.id);
                                    const isExpanded = expandedCategories.includes(col.id);
                                    
                                    return (
                                        <div key={col.id} className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden transition-all">
                                            {/* Header - Clickable */}
                                            <div 
                                                onClick={() => toggleCategory(col.id)}
                                                className="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                                            >
                                                <div className="flex items-center gap-3">
                                                     {/* Icon & Title */}
                                                     <div className={`p-2 rounded-lg bg-${col.color}-100 text-${col.color}-700`}>
                                                        {React.createElement(ICON_MAP[col.icon] || Box, { size: 20 })}
                                                     </div>
                                                     <h3 className="font-bold text-gray-800 text-sm md:text-base">{col.title}</h3>
                                                     <span className="bg-gray-100 text-gray-500 text-xs font-bold px-2 py-1 rounded-full">{colTasks.length}</span>
                                                </div>
                                                {/* Chevron */}
                                                {isExpanded ? <ChevronUp size={20} className="text-gray-400"/> : <ChevronDown size={20} className="text-gray-400"/>}
                                            </div>

                                            {/* Body - Tasks */}
                                            {isExpanded && (
                                                <div className="p-4 bg-gray-50 border-t border-gray-100 animate-in">
                                                    {colTasks.length === 0 && <p className="text-sm text-gray-400 italic text-center py-2">Nenhuma tarefa nesta categoria.</p>}
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                                        {colTasks.map(task => (
                                                            <div key={task.id} draggable onDragStart={(e) => handleDragStart(e, task)} onClick={() => { setSelectedTaskId(task.id); setIsTaskModalOpen(true); }} className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm hover:shadow-md cursor-pointer group relative">
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <FlagPriority level={task.priority} onClick={()=>cyclePriority(task)}/>
                                                                    <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                        <button className="text-gray-400 hover:text-blue-600"><Edit2 size={12}/></button>
                                                                    </div>
                                                                </div>
                                                                <p className="text-sm font-medium text-gray-800 mb-3">{task.text}</p>
                                                                <div className="flex items-center justify-between pt-2 border-t border-gray-50">
                                                                    <div className="flex items-center gap-2">
                                                                        <Avatar member={task.responsible} size="w-5 h-5"/>
                                                                        <span className="text-[10px] text-gray-500">{task.responsible?.name.split(' ')[0]}</span>
                                                                    </div>
                                                                    {task.cost > 0 && <span className="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-1 rounded">{formatCurrency(task.cost)}</span>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                    {selectedTask && <TaskDetailModal isOpen={isTaskModalOpen} onClose={() => { setIsTaskModalOpen(false); setSelectedTaskId(null); }} task={selectedTask} members={members} dbOperations={{ updateTask: (id, updates) => onUpdateTask(id, updates) }} deleteTask={onDeleteTask} />}
                    <EditEventModal isOpen={isEditEventOpen} onClose={() => setIsEditEventOpen(false)} event={event} onUpdate={onUpdateEvent} members={members} onDelete={onDeleteEvent} />
                </div>
            );
        };

        const GlobalAgendaView = ({ events, tasks, onAddAgendaItem, onDeleteAgendaItem, onUpdateAgendaItem }) => {
            const agendaItems = events.flatMap(e => (e.agenda || []).map(a => ({...a, eventName: e.title})));
            const taskItems = tasks.filter(t => t.date).map(t => ({ id: `t-${t.id}`, title: t.text, date: t.date, color: 'green', eventName: 'Tarefa' }));
            const items = agendaItems.concat(taskItems);
            
            return (
                <div className="p-6 pb-24 bg-[#F8FAFC] min-h-screen">
                    <h1 className="text-2xl font-bold text-blue-950 mb-6 flex items-center gap-2"><CalendarIcon/> Agenda Geral</h1>
                    <div className="h-[600px]"><AgendaComponent agendaItems={items} selectedDateFilter={null} onAdd={(item) => onAddAgendaItem('global', item)} onDelete={onDeleteAgendaItem} onUpdate={onUpdateAgendaItem} contextTitle="Todos os Compromissos" events={events} scrollable={true} /></div>
                </div>
            );
        };

        const GlobalTeamView = ({ members, onEdit }) => (
            <div className="p-6 pb-24 bg-[#F8FAFC] min-h-screen">
                <div className="flex justify-between items-center mb-6"><h1 className="text-2xl font-bold text-blue-950">Equipe</h1><button onClick={onEdit} className="text-blue-600 font-bold text-sm bg-blue-50 px-3 py-2 rounded-lg hover:bg-blue-100">Gerenciar</button></div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{members.filter(m => m.role !== 'Tempor√°rio').map(m => (<div key={m.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4"><div className="w-16 h-16 rounded-full overflow-hidden"><Avatar member={m} size="w-full h-full"/></div><div><p className="font-bold text-gray-900 text-lg">{m.name}</p><p className="text-sm text-gray-500">{m.role}</p></div></div>))}</div>
            </div>
        );

        // --- App ---
        // Change from arrow function to function declaration to avoid ReferenceError with hoisting
        function App() {
            const [view, setView] = useState('dashboard');
            const [selectedEvent, setSelectedEvent] = useState(null);
            
            // --- FIREBASE STATE ---
            const [events, setEvents] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [members, setMembers] = useState([]);
            const [user, setUser] = useState(null);
            const [needsConfig, setNeedsConfig] = useState(false);
            // ----------------------
            
            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            const [isNewEventOpen, setIsNewEventOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isCatSettingsOpen, setIsCatSettingsOpen] = useState(false);
            const [isNewTaskOpen, setIsNewTaskOpen] = useState(false);
            const [isAIOpen, setIsAIOpen] = useState(false);
            const [selectedWorkloadMember, setSelectedWorkloadMember] = useState(null);
            const [logo, setLogo] = useState(null);
            const [managerId, setManagerId] = useState('1'); 
            const [geminiKey, setGeminiKey] = useState('');

            // Auth & Listeners
            useEffect(() => {
                if (!app) {
                    setNeedsConfig(true);
                    return;
                }

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Authentication Failed", e);
                    }
                };
                initAuth();

                return onAuthStateChanged(auth, (u) => {
                    setUser(u);
                });
            }, []);

            useEffect(() => {
                if(!user || !db) return;

                // Listen Events
                const unsubEvents = onSnapshot(getColPath('events'), (snap) => {
                    if (snap.empty && !localStorage.getItem('db_initialized')) {
                        // Seed initial data if DB is empty (REMOVED INITIAL EVENTS TO BE EMPTY AS REQUESTED)
                        INITIAL_MEMBERS.forEach(m => setDoc(getDocPath('members', m.id), m));
                        setDoc(getDocPath('config', 'main'), { managerId: '1' });
                        localStorage.setItem('db_initialized', 'true');
                    } else {
                        setEvents(snap.docs.map(d => d.data()));
                    }
                });

                // Listen Tasks
                const unsubTasks = onSnapshot(getColPath('tasks'), (snap) => {
                    setTasks(snap.docs.map(d => d.data()));
                });

                // Listen Members
                const unsubMembers = onSnapshot(getColPath('members'), (snap) => {
                    setMembers(snap.docs.map(d => d.data()));
                });

                // Listen Settings
                const unsubSettings = onSnapshot(getDocPath('config', 'main'), (snap) => {
                    if(snap.exists()) {
                        const data = snap.data();
                        if(data.logo) setLogo(data.logo);
                        if(data.managerId) setManagerId(data.managerId);
                        if(data.geminiKey) setGeminiKey(data.geminiKey);
                    }
                });

                return () => {
                    unsubEvents();
                    unsubTasks();
                    unsubMembers();
                    unsubSettings();
                };
            }, [user]);

            // --- Handlers modified to use Firestore ---

            const handleUpdateTask = (id, updates) => {
                updateDoc(getDocPath('tasks', id), updates);
            };

            const handleDeleteTask = (id) => {
                deleteDoc(getDocPath('tasks', id));
            };

            const handleCreateTask = (newTask) => {
                setDoc(getDocPath('tasks', newTask.id), newTask);
            };

            const handleUpdateEvent = (id, updates) => {
                updateDoc(getDocPath('events', id), updates);
            };

            const handleCreateEvent = (newEvent, newTasks) => {
                setDoc(getDocPath('events', newEvent.id), newEvent);
                newTasks.forEach(t => setDoc(getDocPath('tasks', t.id), t));
            };

            const handleDeleteEvent = (eventId) => {
                if(confirm("Tem certeza que deseja excluir este evento e todas as suas tarefas?")) {
                    deleteDoc(getDocPath('events', eventId));
                    // Delete associated tasks
                    const associatedTasks = tasks.filter(t => t.eventId === eventId);
                    associatedTasks.forEach(t => deleteDoc(getDocPath('tasks', t.id)));
                    
                    setView('dashboard');
                    setSelectedEvent(null);
                }
            };

            const handleUpdateMember = (id, updates) => {
                updateDoc(getDocPath('members', id), updates);
            };

            const handleAddMember = (newMember) => {
                setDoc(getDocPath('members', newMember.id), newMember);
            };

            const handleUpdateLogo = (url) => {
                setDoc(getDocPath('config', 'main'), { logo: url }, { merge: true });
            };

            const handleUpdateManager = (id) => {
                setDoc(getDocPath('config', 'main'), { managerId: id }, { merge: true });
            };
            
            const handleUpdateGeminiKey = (key) => {
                setDoc(getDocPath('config', 'main'), { geminiKey: key }, { merge: true });
            };
            
            const handleGlobalAddAgenda = (type, item) => {
                if(item.eventId) {
                    const evt = events.find(e => e.id === item.eventId);
                    if(evt) handleUpdateEvent(evt.id, { agenda: [...(evt.agenda||[]), item] });
                } else if (events.length > 0) {
                    const evt = events[0]; 
                    handleUpdateEvent(evt.id, { agenda: [...(evt.agenda||[]), item] });
                }
            };

            const handleGlobalDeleteAgenda = (id) => { 
                // We need to find which event has this agenda item since structure is nested
                const evt = events.find(e => (e.agenda || []).some(a => a.id === id));
                if (evt) {
                    handleUpdateEvent(evt.id, { agenda: evt.agenda.filter(a => a.id !== id) });
                }
            };

            const handleGlobalUpdateAgenda = (id, newItem) => {
                const evt = events.find(e => (e.agenda || []).some(a => a.id === id));
                if (evt) {
                    const newAgenda = evt.agenda.map(a => a.id === id ? { ...a, ...newItem } : a);
                    handleUpdateEvent(evt.id, { agenda: newAgenda });
                }
            };
            
            const handleUpdateEventCategories = (newCats) => {
                if(selectedEvent) {
                    handleUpdateEvent(selectedEvent.id, { categories: newCats });
                    setSelectedEvent(prev => ({ ...prev, categories: newCats }));
                }
            };

            const handleAddTeamMember = (eventId, memberId) => {
                const event = events.find(e => e.id === eventId);
                if (event && !event.teamIds?.includes(memberId)) {
                    const newTeam = [...(event.teamIds || []), memberId];
                    handleUpdateEvent(eventId, { teamIds: newTeam });
                }
            };

            const handleRemoveTeamMember = (eventId, memberId) => {
                 const event = events.find(e => e.id === eventId);
                 if(event) {
                      const newTeam = (event.teamIds || []).filter(id => id !== memberId);
                      handleUpdateEvent(eventId, { teamIds: newTeam });
                 }
            };

            const currentSelectedEvent = selectedEvent ? events.find(e => e.id === selectedEvent.id) : null;

            if (needsConfig) {
                return <SetupScreen />;
            }

            return (
                <>
                    {view === 'dashboard' && <Dashboard events={events} tasks={tasks} members={members} onSelectEvent={(e) => { setSelectedEvent(e); setView('detail'); }} onNewEvent={() => setIsNewEventOpen(true)} onMemberClick={setSelectedWorkloadMember} onAddAgendaItem={handleGlobalAddAgenda} onDeleteAgendaItem={handleGlobalDeleteAgenda} onUpdateAgendaItem={handleGlobalUpdateAgenda} globalLogo={logo} managerId={managerId}/>}
                    {view === 'detail' && currentSelectedEvent && (
                        <EventDetail 
                            event={currentSelectedEvent} onBack={() => setView('dashboard')} 
                            tasks={tasks} members={members} categories={currentSelectedEvent.categories || DEFAULT_CATEGORIES}
                            onUpdateTask={handleUpdateTask} onUpdateEvent={handleUpdateEvent} onDeleteTask={handleDeleteTask}
                            onOpenCategorySettings={() => setIsCatSettingsOpen(true)}
                            onAddTask={() => setIsNewTaskOpen(true)}
                            onAddTeamMember={handleAddTeamMember}
                            onRemoveTeamMember={handleRemoveTeamMember}
                            onDeleteEvent={handleDeleteEvent}
                            onCreateMember={handleAddMember} 
                        />
                    )}
                    {view === 'agenda' && <GlobalAgendaView events={events} tasks={tasks} onAddAgendaItem={handleGlobalAddAgenda} onDeleteAgendaItem={handleGlobalDeleteAgenda} onUpdateAgendaItem={handleGlobalUpdateAgenda}/>}
                    {view === 'team' && <GlobalTeamView members={members} onEdit={() => setIsSettingsOpen(true)} />}
                    {view === 'settings' && <SettingsModal isOpen={true} onClose={() => setView('dashboard')} members={members} onUpdateMember={handleUpdateMember} onAddMember={handleAddMember} onUpdateLogo={handleUpdateLogo} currentLogo={logo} managerId={managerId} onUpdateManager={handleUpdateManager} onUpdateGeminiKey={handleUpdateGeminiKey}/>}
                    
                    <BottomNav activeTab={view} onChangeTab={(v) => { if(v === 'settings') setIsSettingsOpen(true); else setView(v); }} onAdd={() => setIsNewEventOpen(true)} />
                    
                    <button 
                        onClick={() => setIsAIOpen(!isAIOpen)}
                        className="fixed bottom-24 right-6 w-14 h-14 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full shadow-xl shadow-blue-600/30 flex items-center justify-center text-white z-[150] hover:scale-110 transition-transform duration-300 animate-in"
                    >
                        {isAIOpen ? <X size={24}/> : <Sparkles size={24}/>}
                    </button>

                    <AIAssistant isOpen={isAIOpen} onClose={() => setIsAIOpen(false)} context={{totalCost: tasks.reduce((a,b)=>a+(b.cost||0),0), tasks, members, events}} apiKey={geminiKey} />

                    <NewEventModal isOpen={isNewEventOpen} onClose={() => setIsNewEventOpen(false)} onCreate={handleCreateEvent} members={members} />
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} members={members} onUpdateMember={handleUpdateMember} onAddMember={handleAddMember} onUpdateLogo={handleUpdateLogo} currentLogo={logo} managerId={managerId} onUpdateManager={handleUpdateManager} onUpdateGeminiKey={handleUpdateGeminiKey}/>
                    <WorkloadDetailModal isOpen={!!selectedWorkloadMember} onClose={() => setSelectedWorkloadMember(null)} member={selectedWorkloadMember} memberTasks={tasks.filter(t => t.responsible?.id === selectedWorkloadMember?.id)} allMembers={members} onUpdateTask={handleUpdateTask} />
                    <ManageCategoriesModal isOpen={isCatSettingsOpen} onClose={() => setIsCatSettingsOpen(false)} categories={currentSelectedEvent?.categories || DEFAULT_CATEGORIES} onUpdateCategories={handleUpdateEventCategories} />
                    {currentSelectedEvent && <NewTaskModal isOpen={isNewTaskOpen} onClose={() => setIsNewTaskOpen(false)} eventId={currentSelectedEvent.id} eventCategories={currentSelectedEvent.categories || DEFAULT_CATEGORIES} onCreate={handleCreateTask} members={members} />}
                </>
            );
        };

        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = createRoot(rootElement);
            root.render(<App />);
        } else {
            console.error("Root element not found");
        }
    </script>
</body>
</html>







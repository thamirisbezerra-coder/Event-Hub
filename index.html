import React, { useState, useRef, useEffect } from 'react';
import { createRoot } from 'react-dom/client';
import { 
    Calendar as CalendarIcon, Users, CheckSquare, Flag, Plus, X, Clock, 
    Edit2, Trash2, ChevronLeft, ChevronRight, Truck, ArrowLeft, 
    Search, Bell, MessageSquare, Send, AlertCircle, ChevronDown, 
    ChevronUp, Settings, UserPlus, Box, TrendingUp, Filter, Check, 
    Image as ImageIcon, AlertTriangle, Crown, Plane, Target, Camera,
    DollarSign, ClipboardList, Mic, Music, Coffee, Gift, Sparkles, Bot,
    BarChart3, Layout, GripVertical, Flame, Info, Wifi, WifiOff,
    ExternalLink
} from 'lucide-react';

// --- Firebase Imports ---
import { initializeApp, getApps, getApp } from 'firebase/app';
import { getAnalytics } from "firebase/analytics";
import { 
    getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc,
    doc, onSnapshot, query, where, getDocs, orderBy 
} from 'firebase/firestore';
import { 
    getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
} from 'firebase/auth';

// --- Configura√ß√£o Firebase (Segura) ---
let app, auth, db;
let isFirebaseAvailable = false;
// Usamos o ID da App fornecido pelo ambiente ou um padr√£o seguro
const appId = typeof __app_id !== 'undefined' ? __app_id : 'event-hub-default';

try {
    if (typeof __firebase_config !== 'undefined') {
        const firebaseConfig = JSON.parse(__firebase_config);
        app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        auth = getAuth(app);
        db = getFirestore(app);
        isFirebaseAvailable = true;
    } else {
        console.warn("Firebase config not found. Running in Offline/Demo mode.");
    }
} catch (error) {
    console.error("Firebase Initialization Error:", error);
    isFirebaseAvailable = false;
}

// --- Utils: Compress√£o de Imagem (Essencial para persist√™ncia local) ---
const compressImage = (file: File, maxWidth = 300): Promise<string> => {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target?.result as string;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const scaleSize = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d');
                ctx?.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL('image/jpeg', 0.7)); // Retorna JPEG comprimido
            };
        };
    });
};

// --- Assets Iniciais ---
const DefaultLogo = () => (
    <svg viewBox="0 0 200 60" className="h-full w-auto" fill="none" xmlns="http://www.w3.org/2000/svg">
        <text x="0" y="40" fontFamily="Arial, sans-serif" fontWeight="900" fontSize="38" fill="#002060">Doremus</text>
        <path d="M0 50 Q50 65 100 50 T200 50" stroke="#E60000" strokeWidth="5" fill="none"/>
    </svg>
);

// --- Avatares ---
const ExecutiveAvatars = [
    { id: 'ex1', svg: (<svg viewBox="0 0 100 100" className="w-full h-full" fill="none" stroke="#1f2937" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="50" cy="50" r="48" fill="#f9fafb" stroke="#e5e7eb" strokeWidth="1"/><path d="M50 90V75" strokeWidth="8"/><path d="M25 95C25 80 35 75 50 75C65 75 75 80 75 95" fill="#f3f4f6"/><circle cx="50" cy="40" r="20" fill="white"/><path d="M50 75L50 85" strokeWidth="4"/><path d="M42 42C42 42 45 45 50 45C55 45 58 42 58 42"/><path d="M40 35V35.5 M60 35V35.5" strokeWidth="4"/><path d="M30 35C30 20 40 15 50 15C60 15 70 20 70 35" fill="white"/></svg>) },
    { id: 'ex2', svg: (<svg viewBox="0 0 100 100" className="w-full h-full" fill="none" stroke="#1f2937" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="50" cy="50" r="48" fill="#f9fafb" stroke="#e5e7eb" strokeWidth="1"/><path d="M25 95C25 80 35 75 50 75C65 75 75 80 75 95" fill="#f3f4f6"/><circle cx="50" cy="40" r="20" fill="white"/><path d="M30 40C30 15 35 10 50 10C65 10 70 15 70 40V55" /><path d="M42 45C42 45 45 47 50 47C55 47 58 45 58 45"/><path d="M40 38V38.5 M60 38V38.5" strokeWidth="4"/></svg>) },
    { id: 'ex3', svg: (<svg viewBox="0 0 100 100" className="w-full h-full" fill="none" stroke="#1f2937" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="50" cy="50" r="48" fill="#f9fafb" stroke="#e5e7eb" strokeWidth="1"/><path d="M25 95C25 80 35 75 50 75C65 75 75 80 75 95" fill="#f3f4f6"/><circle cx="50" cy="40" r="20" fill="white"/><circle cx="43" cy="40" r="5" /> <circle cx="57" cy="40" r="5" /><path d="M48 40H52"/><path d="M45 52H55"/><path d="M30 35C30 20 40 20 50 20C60 20 70 25 70 35" fill="white"/></svg>) },
    { id: 'ex4', svg: (<svg viewBox="0 0 100 100" className="w-full h-full" fill="none" stroke="#1f2937" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="50" cy="50" r="48" fill="#f9fafb" stroke="#e5e7eb" strokeWidth="1"/><path d="M25 95C25 80 35 75 50 75C65 75 75 80 75 95" fill="#f3f4f6"/><circle cx="50" cy="42" r="20" fill="white"/><circle cx="50" cy="18" r="8" fill="white"/><path d="M42 48C42 48 45 50 50 50C55 50 58 48 58 48"/><path d="M40 40V40.5 M60 40V40.5" strokeWidth="4"/><path d="M30 42C30 25 35 25 50 25C65 25 70 30 70 42"/></svg>) },
    { id: 'ex5', svg: (<svg viewBox="0 0 100 100" className="w-full h-full" fill="none" stroke="#1f2937" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="50" cy="50" r="48" fill="#f9fafb" stroke="#e5e7eb" strokeWidth="1"/><path d="M25 95C25 80 35 75 50 75C65 75 75 80 75 95" fill="#f3f4f6"/><circle cx="50" cy="40" r="20" fill="white"/><path d="M35 45Q50 60 65 45" fill="white"/><path d="M40 35V35.5 M60 35V35.5" strokeWidth="4"/><path d="M32 35C32 20 40 18 50 18C60 18 68 20 68 35" fill="white"/></svg>) }
];

// --- Configura√ß√£o de √çcones e Cores para Categorias ---
const ICON_MAP: any = {
    box: Box, truck: Truck, users: Users, trending: TrendingUp,
    alert: AlertCircle, check: CheckSquare, message: MessageSquare,
    camera: Camera, plane: Plane, target: Target, dollar: DollarSign,
    clipboard: ClipboardList, mic: Mic, music: Music, coffee: Coffee, gift: Gift
};

const COLOR_PRESETS: any = {
    blue: 'text-blue-600 bg-blue-50 border-blue-200',
    amber: 'text-amber-600 bg-amber-50 border-amber-200',
    purple: 'text-purple-600 bg-purple-50 border-purple-200',
    emerald: 'text-emerald-600 bg-emerald-50 border-emerald-200',
    red: 'text-red-600 bg-red-50 border-red-200',
    pink: 'text-pink-600 bg-pink-50 border-pink-200',
    cyan: 'text-cyan-600 bg-cyan-50 border-cyan-200',
    indigo: 'text-indigo-600 bg-indigo-50 border-indigo-200',
    gray: 'text-gray-600 bg-gray-100 border-gray-200'
};

const REMINDER_COLORS = [
    { id: 'blue', value: 'bg-blue-100 text-blue-800 border-blue-200', hex: '#dbeafe', label: 'Azul' },
    { id: 'red', value: 'bg-red-100 text-red-800 border-red-200', hex: '#fee2e2', label: 'Vermelho' },
    { id: 'green', value: 'bg-emerald-100 text-emerald-800 border-emerald-200', hex: '#d1fae5', label: 'Verde' },
    { id: 'yellow', value: 'bg-amber-100 text-amber-800 border-amber-200', hex: '#fef3c7', label: 'Amarelo' },
    { id: 'purple', value: 'bg-purple-100 text-purple-800 border-purple-200', hex: '#f3e8ff', label: 'Roxo' },
];

const STATUS_COLUMNS = [
    { id: 'todo', title: 'A Fazer', color: 'blue', icon: 'clipboard' },
    { id: 'in_progress', title: 'Em Andamento', color: 'amber', icon: 'truck' },
    { id: 'review', title: 'Revis√£o', color: 'purple', icon: 'search' },
    { id: 'done', title: 'Conclu√≠do', color: 'emerald', icon: 'check' }
];

const getCategoryIcon = (iconName: string) => {
    const Icon = ICON_MAP[iconName] || Box;
    return <Icon size={18} />;
};

const getCategoryStyles = (colorName: string) => {
    return COLOR_PRESETS[colorName] || COLOR_PRESETS.blue;
};

// --- Utilit√°rios ---
const MONTH_NAMES = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

const calculateDaysRemaining = (dateString: string) => {
    if (!dateString) return 0;
    const match = dateString.match(/(\d{2})\/(\d{2})\/(\d{4})/);
    if (match) {
        const targetDate = new Date(`${match[3]}-${match[2]}-${match[1]}`);
        const today = new Date();
        const diffTime = targetDate.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        return diffDays > 0 ? diffDays : 0;
    }
    // Fallback simples se o formato for texto
    return 30;
};

const getEventStartDate = (dateString: string) => {
    if (!dateString) return new Date();
    const match = dateString.match(/(\d{2})\/(\d{2})\/(\d{4})/);
    if (match) {
        return new Date(parseInt(match[3]), parseInt(match[2]) - 1, parseInt(match[1]));
    }
    return new Date();
};

// --- Componentes ---
const PriorityBadge = ({ level, onClick }: { level: string, onClick?: () => void }) => {
    const styles: any = {
        high: "bg-red-100 text-red-700 border-red-200 hover:bg-red-200",
        medium: "bg-amber-100 text-amber-700 border-amber-200 hover:bg-amber-200",
        low: "bg-emerald-100 text-emerald-700 border-emerald-200 hover:bg-emerald-200"
    };
    const labels: any = { high: "Alta", medium: "M√©dia", low: "Baixa" };
    const safeLevel = styles[level] ? level : 'low';
    
    return (
        <button onClick={(e) => { e.stopPropagation(); onClick && onClick(); }} className={`flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-bold border transition-colors ${styles[safeLevel]}`}>
            <Flag size={10} fill="currentColor" /> {labels[safeLevel]}
        </button>
    );
};

const Avatar = ({ member, size = "w-10 h-10", textSize = "text-xs" }: any) => {
    if (!member) return <div className={`${size} rounded-full bg-gray-200 border border-gray-300`}></div>;

    if (member.photoUrl) {
        return <img src={member.photoUrl} alt={member.name} className={`${size} rounded-full object-cover border border-gray-200`} />;
    }
    return (
        <div className={`${size} rounded-full bg-white border border-gray-200 flex items-center justify-center text-blue-900 font-bold ${textSize} overflow-hidden`}>
            {member.avatarType === 'executive' ? ExecutiveAvatars.find(d => d.id === member.avatarContent)?.svg : <span>{member.avatar || member.name?.substring(0,2)}</span>}
        </div>
    );
};

const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-lg", fullScreen = false }: any) => {
    if (!isOpen) return null;
    const containerClasses = fullScreen 
        ? "fixed inset-0 z-[200] bg-white flex flex-col animate-in fade-in duration-200"
        : `bg-white rounded-2xl shadow-2xl w-full ${maxWidth} overflow-hidden transform transition-all scale-100 flex flex-col max-h-[90vh]`;
    const wrapperClasses = fullScreen ? "" : "fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-in fade-in duration-200";
    const content = (
        <div className={containerClasses}>
            <div className="flex items-center justify-between p-4 border-b bg-[#1e1b4b] text-white flex-shrink-0">
                <div className="flex items-center gap-2">{title === "Configura√ß√µes" && <Settings size={20}/>}<h3 className="text-lg font-bold">{title}</h3></div>
                <button onClick={onClose} className="p-1 hover:bg-white/10 rounded-full transition-colors text-white/80 hover:text-white"><X size={20} /></button>
            </div>
            <div className="p-0 overflow-y-auto flex-1 bg-white relative">{children}</div>
        </div>
    );
    if (fullScreen) return content;
    return <div className={wrapperClasses}>{content}</div>;
};

// --- GEMINI AI ASSISTANT ---
const AIAssistant = ({ isOpen, onClose, members, events, user }: any) => {
    const [input, setInput] = useState("");
    const [messages, setMessages] = useState([
        { id: 1, sender: 'ai', text: "Ol√°! Sou sua **Assistente de Marketing**. üî∑\n\nEstou aqui para ajudar com o seu evento. Pode perguntar coisas como:\n\n‚Ä¢ **Quem est√° livre** agora?\n‚Ä¢ **Resumo** dos eventos\n‚Ä¢ **Leads** captados\n\nO que voc√™ precisa saber?" }
    ]);
    const [isLoading, setIsLoading] = useState(false);
    const [allTasks, setAllTasks] = useState<any[]>([]);
    const messagesEndRef = useRef<HTMLDivElement>(null);
    const apiKey = ""; 

    useEffect(() => {
        // Se estiver offline, tenta carregar do localStorage primeiro
        if (!isFirebaseAvailable) {
            const localTasks = localStorage.getItem('eh_tasks');
            if (localTasks) setAllTasks(JSON.parse(localTasks));
            return;
        }

        if (!user) return;
        
        try {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
            const unsubscribe = onSnapshot(q, (snapshot) => {
                setAllTasks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }, (error) => {
                console.error("Error fetching tasks for AI:", error);
            });
            return () => unsubscribe();
        } catch (e) {
            console.error("AI Firebase Error", e);
        }
    }, [user]);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    useEffect(scrollToBottom, [messages, isLoading]);

    const callGemini = async (userQuery: string) => {
        const teamStats = members.map((m: any) => {
            const memberTasks = allTasks.filter(t => t.responsible?.id === m.id);
            const pending = memberTasks.filter(t => !t.completed).length;
            const highPriority = memberTasks.filter(t => !t.completed && t.priority === 'high').length;
            return { name: m.name, total: memberTasks.length, pending, highPriority, tasks: memberTasks.filter(t=>!t.completed).map(t=>t.text) };
        });

        const eventStats = events.map((e: any) => {
            const evtTasks = allTasks.filter(t => t.eventId === e.id);
            const pending = evtTasks.filter(t => !t.completed).length;
            const urgentTasks = evtTasks.filter(t => !t.completed && t.priority === 'high').map(t => t.text);
            const leadsInfo = e.leadsCount ? `${e.leadsCount} leads captados. Obs: ${e.leadsNotes || 'Sem obs'}` : "Nenhum lead registrado ainda.";
            
            return {
                title: e.title,
                date: e.dateRange,
                location: e.location,
                stats: {
                    totalTasks: evtTasks.length,
                    pendingTasks: pending,
                    urgentTasks: urgentTasks,
                    leads: leadsInfo
                }
            };
        });

        const contextData = {
            teamAnalysis: teamStats,
            eventAnalysis: eventStats,
            rawTasks: allTasks.map(t => ({ text: t.text, priority: t.priority, status: t.completed ? "Feita" : "Pendente", responsible: t.responsible?.name }))
        };

        const systemPrompt = `
        Voc√™ √© a **Assistente de Marketing**, uma IA corporativa e eficiente do Event Hub da Doremus.
        
        **SEU CONTEXTO DE DADOS ATUAL:**
        ${JSON.stringify(contextData)}

        **SUAS INSTRU√á√ïES R√çGIDAS:**
        1.  **NUNCA** forne√ßa um resumo completo a menos que o usu√°rio use explicitamente a palavra "resumo".
        2.  Responda **APENAS** o que foi perguntado de forma direta e concisa.
        3.  Use **negrito** para destacar nomes de pessoas, datas, n√∫meros importantes e nomes de eventos.
        4.  Se perguntarem "Quem est√° livre?", liste apenas quem n√£o tem tarefas pendentes.
        5.  Se perguntarem sobre "Leads", informe os n√∫meros exatos.
        6.  Use emojis profissionais (üî∑, üìä, üóìÔ∏è, ‚úÖ) para manter o tom corporativo.
        7.  Idioma: Portugu√™s (Brasil).
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: userQuery }]
                    }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    }
                })
            });

            const data = await response.json();
            
            if (data.error) {
                console.error("Gemini Error:", data.error);
                return "Desculpe, tive um problema ao processar sua solicita√ß√£o. Tente novamente.";
            }

            return data.candidates?.[0]?.content?.parts?.[0]?.text || "N√£o consegui gerar uma resposta.";
        } catch (error) {
            console.error("API Error:", error);
            return "Erro de conex√£o com a IA. Verifique sua internet.";
        }
    };

    const handleSend = async (e: any) => {
        e.preventDefault();
        if (!input.trim()) return;

        const userText = input;
        setInput("");
        setMessages(prev => [...prev, { id: Date.now(), sender: 'user', text: userText }]);
        setIsLoading(true);

        const aiResponse = await callGemini(userText);
        
        setMessages(prev => [...prev, { id: Date.now() + 1, sender: 'ai', text: aiResponse }]);
        setIsLoading(false);
    };

    if (!isOpen) return null;

    return (
        <div className="fixed bottom-20 right-6 w-96 h-[500px] bg-white rounded-2xl shadow-2xl border border-gray-200 z-[150] flex flex-col overflow-hidden animate-in slide-in-from-bottom-5">
            <div className="bg-blue-950 p-4 flex items-center justify-between text-white shadow-md">
                <div className="flex items-center gap-2">
                    <div className="p-1.5 bg-blue-800 rounded-lg"><Sparkles size={20} className="text-blue-200" /></div>
                    <div>
                        <h3 className="font-bold text-sm">Assistente de Marketing</h3>
                        <div className="flex items-center gap-1.5">
                            <span className="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                            <span className="text-[10px] text-blue-200">Online</span>
                        </div>
                    </div>
                </div>
                <button onClick={onClose} className="text-white/80 hover:text-white"><X size={18}/></button>
            </div>

            <div className="flex-1 bg-slate-50 p-4 overflow-y-auto space-y-4">
                {messages.map((msg) => (
                    <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[85%] rounded-2xl px-4 py-2.5 text-sm whitespace-pre-wrap shadow-sm ${msg.sender === 'user' ? 'bg-blue-900 text-white rounded-tr-none' : 'bg-white text-slate-800 border border-slate-200 rounded-tl-none'}`}>
                            {msg.text}
                        </div>
                    </div>
                ))}
                {isLoading && (
                    <div className="flex justify-start">
                        <div className="bg-white border border-slate-200 rounded-2xl rounded-tl-none px-4 py-3 flex gap-1 shadow-sm">
                            <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
                            <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-75"></div>
                            <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-150"></div>
                        </div>
                    </div>
                )}
                <div ref={messagesEndRef} />
            </div>

            <form onSubmit={handleSend} className="p-3 bg-white border-t border-slate-100">
                <div className="relative flex items-center">
                    <input 
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        placeholder="Pergunte algo..." 
                        className="w-full pl-4 pr-12 py-3 bg-slate-100 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-800 focus:bg-white transition-all text-slate-700 placeholder-slate-400"
                    />
                    <button type="submit" disabled={!input.trim() || isLoading} className="absolute right-2 p-2 bg-blue-900 text-white rounded-lg hover:bg-blue-800 disabled:opacity-50 disabled:hover:bg-blue-900 transition-colors">
                        <Send size={16} />
                    </button>
                </div>
            </form>
        </div>
    );
};

const ManageCategoriesModal = ({ isOpen, onClose, categories, onAdd, onUpdate, onDelete }: any) => {
    const [editingId, setEditingId] = useState<string|null>(null);
    const [formData, setFormData] = useState({ title: '', icon: 'box', color: 'blue' });
    const handleSubmit = (e: any) => {
        e.preventDefault();
        if (!formData.title) return;
        if (editingId) { onUpdate({ id: editingId, ...formData }); setEditingId(null); } else { onAdd(formData); }
        setFormData({ title: '', icon: 'box', color: 'blue' });
    };
    const handleEdit = (cat: any) => { setEditingId(cat.id); setFormData({ title: cat.title, icon: cat.icon || 'box', color: cat.color || 'blue' }); };
    const handleCancelEdit = () => { setEditingId(null); setFormData({ title: '', icon: 'box', color: 'blue' }); };
    if (!isOpen) return null;
    return (
        <Modal isOpen={isOpen} onClose={onClose} title="Gerenciar Categorias" maxWidth="max-w-xl">
            <div className="p-6 space-y-6">
                <form onSubmit={handleSubmit} className="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4">
                    <div className="flex items-center justify-between"><h4 className="text-sm font-bold text-gray-700">{editingId ? 'Editar Categoria' : 'Nova Categoria'}</h4>{editingId && <button type="button" onClick={handleCancelEdit} className="text-xs text-red-500 hover:underline">Cancelar Edi√ß√£o</button>}</div>
                    <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome</label><input value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-2 border rounded-lg outline-none focus:border-blue-500" placeholder="Ex: Financeiro"/></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Cor</label><div className="flex flex-wrap gap-2">{Object.keys(COLOR_PRESETS).map(color => (<button key={color} type="button" onClick={() => setFormData({...formData, color})} className={`w-6 h-6 rounded-full border-2 ${formData.color === color ? 'border-gray-600 scale-110' : 'border-transparent hover:border-gray-300'}`} style={{backgroundColor: color === 'white' ? '#eee' : `var(--color-${color})`}}><div className={`w-full h-full rounded-full ${COLOR_PRESETS[color].split(' ')[1]}`}></div></button>))}</div></div>
                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">√çcone</label><div className="grid grid-cols-6 gap-2 max-h-32 overflow-y-auto">{Object.keys(ICON_MAP).map(icon => (<button key={icon} type="button" onClick={() => setFormData({...formData, icon})} className={`p-1.5 rounded-lg flex items-center justify-center transition-colors ${formData.icon === icon ? 'bg-blue-100 text-blue-700 ring-2 ring-blue-500' : 'bg-white border hover:bg-gray-50 text-gray-500'}`}>{getCategoryIcon(icon)}</button>))}</div></div>
                    </div>
                    <button type="submit" className="w-full bg-blue-900 text-white py-2 rounded-lg font-bold hover:bg-blue-800 transition-colors">{editingId ? 'Salvar Altera√ß√µes' : 'Adicionar Categoria'}</button>
                </form>
                <div className="space-y-2 max-h-60 overflow-y-auto">{categories.map((cat: any) => (<div key={cat.id} className="flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm"><div className="flex items-center gap-3"><div className={`p-2 rounded-lg ${getCategoryStyles(cat.color).split(' ')[1]} ${getCategoryStyles(cat.color).split(' ')[0]}`}>{getCategoryIcon(cat.icon)}</div><span className="font-medium text-gray-700">{cat.title}</span></div><div className="flex gap-1"><button onClick={() => handleEdit(cat)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg"><Edit2 size={16}/></button><button onClick={() => onDelete(cat.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg"><Trash2 size={16}/></button></div></div>))}</div>
            </div>
        </Modal>
    );
};

const EditEventModal = ({ isOpen, onClose, event, onSave }: any) => {
    const [formData, setFormData] = useState({ title: '', location: '', dateRange: '' });
    useEffect(() => { if (event) setFormData({ title: event.title, location: event.location, dateRange: event.dateRange }); }, [event]);
    const handleSubmit = (e: any) => { e.preventDefault(); onSave(event.id, formData); onClose(); };
    if (!isOpen) return null;
    return (
        <Modal isOpen={isOpen} onClose={onClose} title="Editar Detalhes do Evento">
            <form onSubmit={handleSubmit} className="p-6 space-y-4">
                <div><label className="block text-sm font-medium text-gray-700 mb-1">T√≠tulo do Evento</label><input value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-2 border rounded-lg" /></div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">Localiza√ß√£o</label><input value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} className="w-full p-2 border rounded-lg" /></div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">Data (Texto)</label><input value={formData.dateRange} onChange={e => setFormData({...formData, dateRange: e.target.value})} className="w-full p-2 border rounded-lg" placeholder="Ex: 01/05/2026" /></div>
                <button type="submit" className="w-full bg-blue-900 text-white py-2 rounded-lg font-bold">Salvar Altera√ß√µes</button>
            </form>
        </Modal>
    );
};

const LeadsModal = ({ isOpen, onClose, event, onSave }: any) => {
    const [leadsCount, setLeadsCount] = useState('');
    const [leadsNotes, setLeadsNotes] = useState('');
    
    useEffect(() => {
        if (event) {
            setLeadsCount(event.leadsCount || '');
            setLeadsNotes(event.leadsNotes || '');
        }
    }, [event]);

    const handleSubmit = (e: any) => {
        e.preventDefault();
        onSave(event.id, { leadsCount, leadsNotes });
        onClose();
    };

    if (!isOpen) return null;
    return (
        <Modal isOpen={isOpen} onClose={onClose} title="Registro de Leads">
            <form onSubmit={handleSubmit} className="p-6 space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Quantidade de Leads</label>
                    <div className="relative">
                        <Users className="absolute left-3 top-2.5 text-gray-400" size={18}/>
                        <input type="number" value={leadsCount} onChange={e => setLeadsCount(e.target.value)} className="w-full pl-10 p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: 150" />
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes / Resultados</label>
                    <textarea rows={4} value={leadsNotes} onChange={e => setLeadsNotes(e.target.value)} className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: O p√∫blico mostrou muito interesse no produto X..." />
                </div>
                <button type="submit" className="w-full bg-emerald-600 text-white py-2 rounded-lg font-bold hover:bg-emerald-700 transition-colors">Salvar Leads</button>
            </form>
        </Modal>
    );
};

const NotificationsDropdown = ({ onClose, notifications }: any) => {
    return (
        <div className="absolute top-12 right-0 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 z-50 animate-in fade-in zoom-in-95 duration-200 overflow-hidden">
            <div className="p-3 border-b bg-gray-50 flex justify-between items-center"><span className="font-bold text-gray-700 text-sm">Notifica√ß√µes</span><span className="text-[10px] text-blue-600 cursor-pointer hover:underline" onClick={onClose}>Fechar</span></div>
            <div className="max-h-64 overflow-y-auto">
                {notifications.length === 0 ? <div className="p-4 text-center text-gray-400 text-xs">Nenhuma notifica√ß√£o nova.</div> : 
                notifications.map((notif: any, idx: number) => (
                    <div key={idx} className={`p-3 border-b border-gray-50 hover:bg-gray-50 transition-colors cursor-pointer bg-blue-50/30`}>
                        <div className="flex gap-3">
                            <div className={`mt-1 w-2 h-2 rounded-full flex-shrink-0 bg-blue-600`}></div>
                            <div><p className={`text-xs font-bold text-gray-800`}>{notif.text}</p><p className="text-[10px] text-gray-400 mt-1">{notif.date}</p></div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

const AddTaskModal = ({ isOpen, onClose, onAdd, members, categories, preSelectedCategory }: any) => {
    const [text, setText] = useState("");
    const [category, setCategory] = useState(preSelectedCategory || (categories[0]?.id || ""));
    const [responsibleId, setResponsibleId] = useState(members[0]?.id || "");
    const [priority, setPriority] = useState("medium");
    useEffect(() => { if (preSelectedCategory) setCategory(preSelectedCategory); else if (categories.length > 0 && !category) setCategory(categories[0].id); }, [preSelectedCategory, categories]);
    const handleSubmit = (e: any) => { e.preventDefault(); if(!text) return; const responsible = members.find((m: any) => m.id === responsibleId) || members[0] || { name: 'Desconhecido', role: 'N/A' }; onAdd({ text, category, responsible, priority, status: 'todo' }); setText(""); onClose(); };
    if(!isOpen) return null;
    return (
        <Modal isOpen={isOpen} onClose={onClose} title="Nova Tarefa">
            <form onSubmit={handleSubmit} className="p-6 space-y-4">
                <div><label className="block text-sm font-medium text-gray-700 mb-1">T√≠tulo</label><input autoFocus value={text} onChange={e => setText(e.target.value)} className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Contratar Buffet" /></div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">Categoria</label><select value={category} onChange={e => setCategory(e.target.value)} className="w-full p-2 border rounded-lg bg-white outline-none">{categories.map((cat: any) => (<option key={cat.id} value={cat.id}>{cat.title}</option>))}</select></div>
                <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Respons√°vel</label><select value={responsibleId} onChange={e => setResponsibleId(e.target.value)} className="w-full p-2 border rounded-lg bg-white outline-none">{members.map((m: any) => (<option key={m.id} value={m.id}>{m.name}</option>))}</select></div>
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Prioridade</label><select value={priority} onChange={e => setPriority(e.target.value)} className="w-full p-2 border rounded-lg bg-white outline-none"><option value="low">Baixa</option><option value="medium">M√©dia</option><option value="high">Alta</option></select></div>
                </div>
                <div className="pt-4"><button type="submit" className="w-full py-2 bg-blue-900 text-white rounded-lg hover:bg-blue-800 font-bold">Criar Tarefa</button></div>
            </form>
        </Modal>
    );
};

const SettingsModal = ({ isOpen, onClose, members, logo, setLogo, onUpdateLogo, onAddMember, onUpdateMember, onDeleteMember }: any) => {
    const [newMemberName, setNewMemberName] = useState('');
    const [newMemberRole, setNewMemberRole] = useState('');
    const fileInputRef = useRef<HTMLInputElement>(null);
    const memberPhotoInputRef = useRef<HTMLInputElement>(null);
    const editPhotoInputRef = useRef<HTMLInputElement>(null); 
    
    const [editingId, setEditingId] = useState<string|null>(null);
    const [editName, setEditName] = useState('');
    const [editRole, setEditRole] = useState('');
    const [editPhoto, setEditPhoto] = useState<string|null>(null); 
    
    const [newMemberPhoto, setNewMemberPhoto] = useState<string|null>(null);
    
    const handleLogoUpload = (e: any) => { 
        const file = e.target.files[0]; 
        if (file) { 
            compressImage(file, 200).then(base64 => {
                 onUpdateLogo(base64); 
            });
        } 
    };
    
    const handleMemberPhotoUpload = (e: any) => { 
        const file = e.target.files[0]; 
        if(file) { 
            compressImage(file, 100).then(base64 => {
                setNewMemberPhoto(base64);
            });
        } 
    };
    
    const handleEditPhotoUpload = (e: any) => { 
        const file = e.target.files[0]; 
        if(file) { 
            compressImage(file, 100).then(base64 => {
                setEditPhoto(base64); 
            });
        } 
    };

    const handleAdd = (e: any) => { e.preventDefault(); if (!newMemberName || !newMemberRole) return; onAddMember({ name: newMemberName, role: newMemberRole, avatarType: 'executive', avatarContent: 'ex1', photoUrl: newMemberPhoto }); setNewMemberName(''); setNewMemberRole(''); setNewMemberPhoto(null); };
    
    const startEdit = (member: any) => { 
        setEditingId(member.id); 
        setEditName(member.name); 
        setEditRole(member.role); 
        setEditPhoto(member.photoUrl || null); 
    };
    
    const saveEdit = (id: string) => { 
        onUpdateMember({ id, name: editName, role: editRole, photoUrl: editPhoto }); 
        setEditingId(null); 
    };

    if (!isOpen) return null;
    return (
        <Modal isOpen={isOpen} onClose={onClose} title="Configura√ß√µes" maxWidth="max-w-2xl">
            <div className="p-6 space-y-8">
                <section>
                    <h4 className="text-blue-900 font-bold flex items-center gap-2 mb-4"><ImageIcon size={18} /> Identidade</h4>
                    <div className="bg-white border border-gray-200 rounded-xl p-6 flex flex-col md:flex-row items-center gap-6">
                        <div className="h-16 flex items-center justify-center px-4 bg-gray-50 rounded-lg border border-gray-100 min-w-[150px]">{typeof logo === 'string' ? <img src={logo} alt="Logo" className="h-10 w-auto object-contain" /> : logo}</div>
                        <div className="flex-1"><p className="font-bold text-gray-800 text-sm mb-1">Carregar logo</p><div className="flex gap-2"><button onClick={() => fileInputRef.current?.click()} className="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 bg-white">Escolher arquivo</button><input type="file" ref={fileInputRef} onChange={handleLogoUpload} className="hidden" accept="image/*" /></div></div>
                    </div>
                </section>
                <section>
                    <h4 className="text-blue-900 font-bold flex items-center gap-2 mb-4"><Users size={18} /> Equipe</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        {members.map((member: any) => (
                            <div key={member.id} className="flex items-center justify-between p-3 border border-gray-200 rounded-xl hover:shadow-sm transition-shadow">
                                <div className="flex items-center gap-3 w-full">
                                    {editingId === member.id ? (
                                        <div className="relative group cursor-pointer" onClick={() => editPhotoInputRef.current?.click()}>
                                            <div className="w-10 h-10 rounded-full bg-gray-100 border border-gray-200 flex items-center justify-center overflow-hidden">
                                                {editPhoto ? <img src={editPhoto} className="w-full h-full object-cover"/> : <Camera size={16} className="text-gray-400"/>}
                                            </div>
                                            <div className="absolute inset-0 bg-black/30 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><Edit2 size={12} className="text-white"/></div>
                                            <input type="file" ref={editPhotoInputRef} onChange={handleEditPhotoUpload} className="hidden" accept="image/*" />
                                        </div>
                                    ) : (
                                        <Avatar member={member} />
                                    )}
                                    
                                    <div className="flex-1 min-w-0">
                                        {editingId === member.id ? (
                                            <div className="flex flex-col gap-1">
                                                <input value={editName} onChange={e=>setEditName(e.target.value)} className="text-sm border rounded px-1 w-full" placeholder="Nome" />
                                                <input value={editRole} onChange={e=>setEditRole(e.target.value)} className="text-xs border rounded px-1 w-full" placeholder="Cargo" />
                                            </div>
                                        ) : (
                                            <>
                                                <p className="font-bold text-gray-800 text-sm truncate">{member.name}</p>
                                                <p className="text-xs text-gray-500 truncate">{member.role}</p>
                                            </>
                                        )}
                                    </div>
                                </div>
                                <div className="flex gap-1 ml-2">
                                    {editingId === member.id ? (
                                        <button onClick={() => saveEdit(member.id)} className="p-2 text-green-600 hover:bg-green-50 rounded-lg"><Check size={16}/></button>
                                    ) : (
                                        <button onClick={() => startEdit(member)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg"><Edit2 size={16}/></button>
                                    )}
                                    <button onClick={() => onDeleteMember(member.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg"><Trash2 size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="border border-gray-200 rounded-xl p-4 bg-gray-50">
                        <h5 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"><UserPlus size={16}/> Novo Membro</h5>
                        <form onSubmit={handleAdd} className="flex flex-col gap-3">
                            <div className="flex gap-3">
                                <input placeholder="Nome" value={newMemberName} onChange={e => setNewMemberName(e.target.value)} className="flex-1 p-2 border border-gray-300 rounded-lg outline-none focus:border-blue-500"/>
                                <input placeholder="Cargo" value={newMemberRole} onChange={e => setNewMemberRole(e.target.value)} className="flex-1 p-2 border border-gray-300 rounded-lg outline-none focus:border-blue-500"/>
                            </div>
                            <div className="flex items-center gap-2">
                                <button type="button" onClick={() => memberPhotoInputRef.current?.click()} className="text-xs flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    <Camera size={14}/> {newMemberPhoto ? 'Foto Selecionada' : 'Carregar Foto'}
                                </button>
                                <input type="file" ref={memberPhotoInputRef} onChange={handleMemberPhotoUpload} className="hidden" accept="image/*" />
                                {newMemberPhoto && <img src={newMemberPhoto} className="w-8 h-8 rounded-full object-cover border" />}
                            </div>
                            <button type="submit" disabled={!newMemberName} className="bg-blue-900 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-800 disabled:opacity-50 mt-2">Adicionar Membro</button>
                        </form>
                    </div>
                </section>
            </div>
        </Modal>
    );
};

const TaskDetailModal = ({ task, isOpen, onClose, members, onAddSupport, onSendMessage, onAssignResponsible }: any) => {
    const [messageText, setMessageText] = useState("");
    const [isImportant, setIsImportant] = useState(false);
    const [isSelectingResponsible, setIsSelectingResponsible] = useState(false);
    const [isSelectingSupport, setIsSelectingSupport] = useState(false);

    // CORRE√á√ÉO: Guard Clause para evitar crash
    if (!task) return null;

    const messages = task.messages || [];
    const responsible = task.responsible || { name: "N√£o definido", role: "-", avatar: "?" };
    const supportList = task.support || [];

    const handleSend = () => { if (!messageText.trim()) return; onSendMessage(task.id, messageText, isImportant); setMessageText(""); setIsImportant(false); };

    // Marcar como lido localmente ao abrir (CORRE√á√ÉO: Verifica√ß√£o segura de task.messages)
    useEffect(() => {
        if(isOpen && task) {
            const key = `task_msg_count_${task.id}`;
            const count = task.messages?.length || 0;
            localStorage.setItem(key, count.toString());
        }
    }, [isOpen, task]);

    return (
        <Modal isOpen={isOpen} onClose={onClose} title="Detalhes da Tarefa" maxWidth="max-w-2xl">
            <div className="flex flex-col h-[70vh]">
                <div className="px-6 py-4 border-b bg-gray-50">
                    <div className="flex items-center gap-3 mb-2"><PriorityBadge level={task.priority} /><span className="text-xs font-mono text-gray-400">ID: #{task.id}</span></div>
                    <h2 className="text-2xl font-bold text-gray-900 leading-tight">{task.text}</h2>
                </div>
                <div className="flex-1 overflow-y-auto p-6 space-y-8">
                    <div className="flex items-start gap-8">
                        <div className="relative">
                            <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Respons√°vel</p>
                            <button onClick={() => setIsSelectingResponsible(!isSelectingResponsible)} className="flex items-center gap-2 p-2 -ml-2 rounded-lg hover:bg-gray-100 transition-colors text-left group border border-transparent hover:border-gray-200">
                                <Avatar member={responsible} />
                                <div><p className="text-sm font-bold text-gray-800 flex items-center gap-1">{responsible.name} <ChevronDown size={14} className="text-gray-400 group-hover:text-blue-600"/></p><p className="text-xs text-gray-500">{responsible.role}</p></div>
                            </button>
                            {isSelectingResponsible && (<div className="absolute top-full left-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 z-50 p-2 animate-in fade-in zoom-in duration-200"><div className="space-y-1">{members.map((member: any) => (<button key={member.id} onClick={() => { onAssignResponsible(task.id, member); setIsSelectingResponsible(false); }} className={`w-full flex items-center gap-3 p-2 rounded-lg hover:bg-blue-50 transition-colors text-left ${responsible.name === member.name ? 'bg-blue-50' : ''}`}><div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-xs font-bold text-blue-700 border border-blue-200 overflow-hidden"><Avatar member={member} size="w-8 h-8"/></div><p className="text-sm font-medium text-gray-900">{member.name}</p></button>))}</div></div>)}
                        </div>
                        <div className="flex-1 relative">
                            <div className="flex items-center justify-between mb-2"><p className="text-xs font-bold text-gray-400 uppercase tracking-wider">Apoio</p><button onClick={() => setIsSelectingSupport(!isSelectingSupport)} className="text-xs text-blue-600 font-bold hover:underline flex items-center gap-1">+ Gerenciar</button></div>
                            {isSelectingSupport && (<div className="absolute top-8 left-0 w-64 bg-white rounded-xl shadow-xl border border-gray-100 z-50 p-3 animate-in fade-in zoom-in duration-200"><div className="max-h-40 overflow-y-auto space-y-1">{members.map((member: any) => { const isSelected = supportList.some((s: any) => s.id === member.id); return (<button key={member.id} onClick={() => onAddSupport(task.id, member)} className={`w-full flex items-center justify-between p-2 rounded-lg transition-colors text-left ${isSelected ? 'bg-blue-50 text-blue-900' : 'hover:bg-gray-50 text-gray-700'}`}><div className="flex items-center gap-2"><Avatar member={member} size="w-6 h-6" textSize="text-[8px]"/><span className="text-xs font-medium">{member.name}</span></div>{isSelected && <Check size={14} className="text-blue-600"/>}</button>)})}</div><button onClick={() => setIsSelectingSupport(false)} className="mt-2 w-full py-1 text-xs text-gray-500 hover:bg-gray-100 rounded">Pronto</button></div>)}
                            {supportList.length > 0 ? (<div className="flex flex-wrap gap-2">{supportList.map((s: any, idx: number) => (<div key={idx} className="flex items-center gap-2 bg-gray-50 px-2 py-1 rounded-full border"><Avatar member={s} size="w-5 h-5" textSize="text-[8px]"/><span className="text-xs font-medium text-gray-700">{s.name}</span></div>))}</div>) : (<p className="text-sm text-gray-400 italic">Ningu√©m alocado.</p>)}
                        </div>
                    </div>
                    <div>
                        <div className="flex items-center gap-2 mb-4"><MessageSquare size={16} className="text-gray-400" /><h3 className="text-sm font-bold text-gray-800">Comunica√ß√£o</h3></div>
                        <div className="bg-gray-50 rounded-xl p-4 min-h-[200px] max-h-[300px] overflow-y-auto mb-4 border border-gray-100">
                            {messages.length === 0 ? <p className="text-sm text-center text-gray-400">Nenhuma mensagem ainda.</p> : <div className="space-y-3">{messages.map((msg: any, i: number) => (<div key={i} className={`flex gap-3 ${msg.sender === 'Eu' ? 'flex-row-reverse' : ''}`}><div className={`p-3 rounded-xl max-w-[80%] text-sm ${msg.isImportant ? 'bg-red-50 border border-red-100 text-red-800' : 'bg-white border border-gray-200 text-gray-700'}`}>{msg.isImportant && <div className="flex items-center gap-1 text-red-600 font-bold text-xs mb-1"><AlertCircle size={12} /> Importante</div>}{msg.text}</div></div>))}</div>}
                        </div>
                        <div className="bg-white border border-gray-200 rounded-xl p-2 shadow-sm">
                            <div className="flex items-center gap-2 mb-2 px-2"><label className="flex items-center gap-2 text-xs font-medium text-gray-600 cursor-pointer hover:text-gray-800 select-none"><input type="checkbox" checked={isImportant} onChange={(e) => setIsImportant(e.target.checked)} className="rounded text-red-500 focus:ring-red-500" /> Marcar como Aviso Importante</label></div>
                            <div className="flex items-center gap-2"><input type="text" placeholder="Escreva uma mensagem..." className="flex-1 text-sm p-2 outline-none text-gray-700" value={messageText} onChange={(e) => setMessageText(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSend()}/><button onClick={handleSend} className="p-2 bg-blue-900 text-white rounded-lg hover:bg-blue-800 transition-colors"><Send size={16} /></button></div>
                        </div>
                    </div>
                </div>
            </div>
        </Modal>
    );
};

const DashboardView = ({ onSelectEvent, events, members, logo }: any) => {
    return (
        <div className="max-w-[1600px] mx-auto grid grid-cols-1 xl:grid-cols-4 gap-8 animate-in slide-in-from-bottom-4 duration-500">
            <div className="xl:col-span-3 space-y-8">
                <section className="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                    <div className="flex flex-col lg:flex-row gap-12">
                        <div className="flex items-center gap-8 min-w-[300px]">
                            <div className="relative w-32 h-32 flex-shrink-0">
                                <svg className="w-full h-full transform -rotate-90"><circle cx="64" cy="64" r="56" stroke="#F3F4F6" strokeWidth="12" fill="transparent" /><circle cx="64" cy="64" r="56" stroke="#002060" strokeWidth="12" fill="transparent" strokeDasharray="351.86" strokeDashoffset="348" strokeLinecap="round" /></svg>
                                <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-800"><span className="text-3xl font-extrabold text-[#002060]">1%</span></div>
                            </div>
                            <div><h3 className="text-lg font-bold text-gray-900 mb-2">Status Global</h3><div className="flex items-center gap-4 text-sm font-semibold"><span className="text-emerald-600 flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-emerald-500"></div> 1 Feitas</span><span className="text-amber-600 flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-amber-500"></div> 175 Pend.</span></div></div>
                        </div>
                        <div className="flex-1"><h3 className="text-sm font-bold text-gray-900 mb-6 flex items-center gap-2"><Users size={18} /> Carga de Trabalho</h3><div className="flex items-start gap-6 overflow-x-auto pb-2">{members.map((member: any) => (<div key={member.id} className="flex flex-col items-center gap-2 min-w-[50px]"><div className="h-1 w-8 bg-gray-200 rounded-full overflow-hidden mb-1"><div className="h-full bg-blue-600 w-0"></div></div><div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-xs font-bold text-gray-600 border border-gray-200 shadow-sm overflow-hidden"><Avatar member={member}/></div><span className="text-xs font-bold text-blue-600">0</span></div>))}</div></div>
                    </div>
                </section>
                <section>
                    <h2 className="text-lg font-bold text-blue-900 mb-6 flex items-center gap-2"><Clock size={20} /> Pr√≥ximos Eventos</h2>
                    <div className="space-y-4">
                        {events.map((event: any) => (
                            <div key={event.id} onClick={() => onSelectEvent(event)} className="bg-white rounded-3xl p-6 border border-gray-100 shadow-sm hover:shadow-md hover:border-blue-200 transition-all cursor-pointer group flex flex-col md:flex-row items-center gap-6">
                                <div className="flex-shrink-0 w-20 h-20 bg-gray-50 rounded-2xl flex flex-col items-center justify-center group-hover:bg-blue-50 transition-colors"><span className="text-xs font-bold text-gray-500 uppercase">{event.month}</span><span className="text-3xl font-extrabold text-gray-800 group-hover:text-blue-900">{event.day}</span></div>
                                <div className="flex-1 min-w-0"><div className="flex items-center justify-between mb-1"><h3 className="text-xl font-bold text-gray-900 group-hover:text-blue-700 transition-colors truncate">{event.title}</h3><span className="text-xs font-medium text-amber-600 bg-amber-50 px-2 py-1 rounded-full border border-amber-100 hidden md:inline-block">‚ö† faltam {event.pending || 0} tarefas</span></div><div className="flex flex-col gap-1 text-sm text-gray-500"><span className="flex items-center gap-1.5"><Truck size={14}/> {event.location}</span><div className="flex items-center gap-3"><span className="text-blue-600 font-medium">{event.dateRange}</span><span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-xs font-bold">Faltam {calculateDaysRemaining(event.dateRange)} dias</span></div></div></div>
                            </div>
                        ))}
                    </div>
                </section>
            </div>
            <div className="xl:col-span-1"><section className="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 h-full"><h2 className="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2"><MessageSquare size={20} className="text-blue-900"/> Atualiza√ß√µes</h2><div className="space-y-6"><div className="text-sm text-gray-500 italic">Nenhuma atualiza√ß√£o recente.</div></div></section></div>
        </div>
    );
};

const EventDetailView = ({ event, onBack, globalMembers, db, user }: any) => {
    const [eventTeam, setEventTeam] = useState(globalMembers.slice(0, 3));
    const [isAddingMember, setIsAddingMember] = useState(false);
    const [isTeamExpanded, setIsTeamExpanded] = useState(true);
    const [isAgendaExpanded, setIsAgendaExpanded] = useState(true);
    const [isAddTaskOpen, setIsAddTaskOpen] = useState(false);
    const [preSelectedCategory, setPreSelectedCategory] = useState(null);
    const [isManageCategoriesOpen, setIsManageCategoriesOpen] = useState(false);
    const [isEditEventOpen, setIsEditEventOpen] = useState(false);
    const [isLeadsModalOpen, setIsLeadsModalOpen] = useState(false);
    const [viewMode, setViewMode] = useState('categories'); // 'categories' or 'status'
    
    const [tasks, setTasks] = useState<any[]>([]);
    const [categories, setCategories] = useState<any[]>([]);
    const [selectedTask, setSelectedTask] = useState<any>(null);
    const [isCalendarOpen, setIsCalendarOpen] = useState(false);
    const [currentDate, setCurrentDate] = useState(new Date(2024, 5, 1));
    const [searchTerm, setSearchTerm] = useState("");
    
    // Drag and Drop States
    const [draggedTask, setDraggedTask] = useState<any>(null);
    const [dragOverColumn, setDragOverColumn] = useState<any>(null);
    const [draggedColumn, setDraggedColumn] = useState<any>(null);
    
    const [calendarReminders, setCalendarReminders] = useState<any[]>([]);
    const [selectedDateForReminder, setSelectedDateForReminder] = useState<Date|null>(null);
    
    // Formul√°rio de Lembrete Expandido
    const [reminderForm, setReminderForm] = useState({
        text: "",
        color: "blue",
        startTime: "",
        endTime: "",
        participants: "" // Campo de texto para externos
    });

    // Novo estado para sele√ß√£o m√∫ltipla de membros na agenda
    const [selectedMemberIds, setSelectedMemberIds] = useState<string[]>([]);

    const daysRemaining = calculateDaysRemaining(event.dateRange);

    useEffect(() => {
        if(event?.dateRange) {
            const startDate = getEventStartDate(event.dateRange);
            setCurrentDate(startDate);
        }
    }, [event]);

    useEffect(() => {
        if (eventTeam.length > 0 && globalMembers.length > 0) {
            setEventTeam(prev => prev.map((p: any) => {
                const updated = globalMembers.find((g: any) => g.id === p.id);
                return updated || p;
            }));
        }
    }, [globalMembers]);

    useEffect(() => {
        if (!user || !isFirebaseAvailable || !db) {
            // Load from LocalStorage if available
            const savedTasks = localStorage.getItem('eh_tasks');
            const savedCats = localStorage.getItem('eh_categories');
            const savedReminders = localStorage.getItem('eh_reminders');

            if (savedTasks) setTasks(JSON.parse(savedTasks));
            else {
                 const mockTasks = [
                    { id: 't1', text: 'Tarefa Demo', category: 'planning', status: 'todo', priority: 'medium', messages: [] },
                    { id: 't2', text: 'Validar Layout', category: 'logistics', status: 'in_progress', priority: 'high', messages: [] }
                ];
                setTasks(mockTasks);
            }

            if (savedCats) setCategories(JSON.parse(savedCats));
            else {
                const defaults = [
                    { id: 'planning', title: 'Planejamento & Produto', icon: 'box', color: 'blue', order: 0 },
                    { id: 'logistics', title: 'Log√≠stica & Estande', icon: 'truck', color: 'amber', order: 1 },
                    { id: 'staff', title: 'Staff & Viagem', icon: 'users', color: 'purple', order: 2 },
                    { id: 'post', title: 'P√≥s-Evento & Leads', icon: 'trending', color: 'emerald', order: 3 }
                ];
                setCategories(defaults);
            }

            if (savedReminders) setCalendarReminders(JSON.parse(savedReminders));

            return;
        }

        const q = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
        const unsubscribe = onSnapshot(q, (snapshot) => { setTasks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); }, (err) => console.error("Err tasks", err));
        const qr = collection(db, 'artifacts', appId, 'public', 'data', 'reminders');
        const unsubR = onSnapshot(qr, (snapshot) => { setCalendarReminders(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); }, (err) => console.error("Err reminders", err));
        
        const qc = query(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), orderBy('order', 'asc'));
        const unsubC = onSnapshot(qc, (snapshot) => {
            if (snapshot.empty) {
                const defaults = [
                    { id: 'planning', title: 'Planejamento & Produto', icon: 'box', color: 'blue', order: 0 },
                    { id: 'logistics', title: 'Log√≠stica & Estande', icon: 'truck', color: 'amber', order: 1 },
                    { id: 'staff', title: 'Staff & Viagem', icon: 'users', color: 'purple', order: 2 },
                    { id: 'post', title: 'P√≥s-Evento & Leads', icon: 'trending', color: 'emerald', order: 3 }
                ];
                defaults.forEach(d => setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', d.id), d));
            } else {
                const cats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setCategories(cats.sort((a: any,b: any) => (a.order || 0) - (b.order || 0)));
            }
        }, (err) => console.error("Err categories", err));

        return () => { unsubscribe(); unsubR(); unsubC(); };
    }, [db, user]);

    // --- Persist√™ncia no LocalStorage (Modo Demo) ---
    useEffect(() => {
        if (!isFirebaseAvailable) {
            localStorage.setItem('eh_tasks', JSON.stringify(tasks));
        }
    }, [tasks]);

    useEffect(() => {
        if (!isFirebaseAvailable) {
            localStorage.setItem('eh_categories', JSON.stringify(categories));
        }
    }, [categories]);

    useEffect(() => {
        if (!isFirebaseAvailable) {
            localStorage.setItem('eh_reminders', JSON.stringify(calendarReminders));
        }
    }, [calendarReminders]);


    const handleUpdateEvent = async (id: string, data: any) => { 
        if (db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', id), data); 
        // No modo offline, a atualiza√ß√£o do evento precisa ser tratada no pai (App)
    };
    const handleAddTeamMember = (member: any) => { if (!eventTeam.find((m: any) => m.id === member.id)) { setEventTeam([...eventTeam, member]); } setIsAddingMember(false); };
    const handleRemoveTeamMember = (memberId: string) => { setEventTeam(eventTeam.filter((m: any) => m.id !== memberId)); };
    const handlePromoteToLeader = (memberId: string) => {
        const memberIndex = eventTeam.findIndex((m: any) => m.id === memberId);
        if (memberIndex < 0) return;
        const newTeam = [...eventTeam];
        const [member] = newTeam.splice(memberIndex, 1);
        newTeam.unshift(member);
        setEventTeam(newTeam);
    };
    
    const toggleTask = async (e: any, id: string) => { 
        e.stopPropagation(); 
        const task = tasks.find(t => t.id === id); 
        if (task) { 
            const newStatus = !task.completed ? 'done' : 'todo';
            if (db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id), { completed: !task.completed, status: newStatus }); 
            else setTasks(tasks.map(t => t.id === id ? { ...t, completed: !t.completed, status: newStatus } : t));
        } 
    };
    const deleteTask = async (e: any, id: string) => { 
        e.stopPropagation(); 
        if(confirm("Deseja excluir esta tarefa?")) {
            if(db) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id));
            else setTasks(tasks.filter(t => t.id !== id));
        }
    };
    const cyclePriority = async (id: string) => { 
        const priorities = ["low", "medium", "high"]; 
        const task = tasks.find(t => t.id === id); 
        if(task) { 
            const nextIndex = (priorities.indexOf(task.priority) + 1) % priorities.length; 
            if(db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', id), { priority: priorities[nextIndex] }); 
            else setTasks(tasks.map(t => t.id === id ? { ...t, priority: priorities[nextIndex] } : t));
        } 
    };
    const handleAddTask = async (newTask: any) => { 
        if(db) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), { ...newTask, completed: false, messages: [], support: [], eventId: event.id }); 
        else setTasks([...tasks, { id: Date.now().toString(), ...newTask, completed: false, messages: [], support: [], eventId: event.id }]);
    };
    const handleAssignResponsible = async (taskId: string, member: any) => { 
        if(db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId), { responsible: member }); 
        if (selectedTask && selectedTask.id === taskId) setSelectedTask({ ...selectedTask, responsible: member }); 
    };
    const handleSendMessage = async (taskId: string, text: string, isImportant: boolean) => { 
        const newMessage = { sender: "Eu", text, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), isImportant }; 
        const task = tasks.find(t => t.id === taskId); 
        if(task) { 
            const updatedMessages = [...(task.messages || []), newMessage]; 
            if(db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId), { messages: updatedMessages }); 
            setSelectedTask((prev: any) => ({...prev, messages: updatedMessages})); 
        } 
    };
    const handleAddSupport = async (taskId: string, member: any) => { 
        const task = tasks.find(t => t.id === taskId); 
        if(task) { 
            const currentSupport = task.support || []; 
            const exists = currentSupport.some((s: any) => s.id === member.id); 
            const newSupport = exists ? currentSupport.filter((s: any) => s.id !== member.id) : [...currentSupport, member]; 
            if(db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId), { support: newSupport }); 
            if (selectedTask && selectedTask.id === taskId) setSelectedTask((prev: any) => ({...prev, support: newSupport})); 
        } 
    };

    const handleAddReminder = async () => {
        if(!reminderForm.text || !selectedDateForReminder) return;
        
        // Combina membros selecionados + externos
        const internalNames = globalMembers.filter(m => selectedMemberIds.includes(m.id)).map(m => m.name);
        const externalNames = reminderForm.participants ? [reminderForm.participants] : [];
        const finalParticipants = [...internalNames, ...externalNames].join(", ");

        const newReminder = { 
            date: selectedDateForReminder.toISOString().split('T')[0], 
            text: reminderForm.text, 
            eventId: event.id, 
            color: reminderForm.color,
            startTime: reminderForm.startTime,
            endTime: reminderForm.endTime,
            participants: finalParticipants
        };

        if(db) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reminders'), newReminder);
        else setCalendarReminders([...calendarReminders, { id: Date.now().toString(), ...newReminder }]);
        
        // Reset form
        setReminderForm({ text: "", color: "blue", startTime: "", endTime: "", participants: "" });
        setSelectedMemberIds([]);
    };

    const handleDeleteReminder = async (id: string) => {
        if(confirm("Deseja cancelar (excluir) este compromisso?")) {
            if(db) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reminders', id));
            else setCalendarReminders(calendarReminders.filter(r => r.id !== id));
        }
    };

    const toggleMemberSelection = (memberId: string) => {
        if (selectedMemberIds.includes(memberId)) {
            setSelectedMemberIds(selectedMemberIds.filter(id => id !== memberId));
        } else {
            setSelectedMemberIds([...selectedMemberIds, memberId]);
        }
    };

    const handleAddCategory = async (catData: any) => { 
        if(db) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), { ...catData, order: categories.length });
        else setCategories([...categories, { ...catData, id: Date.now().toString(), order: categories.length }]);
    };
    const handleUpdateCategory = async (catData: any) => { 
        if(db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', catData.id), catData); 
        else setCategories(categories.map(c => c.id === catData.id ? catData : c));
    };
    const handleDeleteCategory = async (id: string) => { 
        if(confirm('Tem certeza? As tarefas dessa categoria ficar√£o √≥rf√£s.')) {
            if(db) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id));
            else setCategories(categories.filter(c => c.id !== id));
        }
    };

    // Logic for unread tasks
    const isTaskUnread = (task: any) => {
        if (!task.messages || task.messages.length === 0) return false;
        const lastSeenCount = parseInt(localStorage.getItem(`task_msg_count_${task.id}`) || '0');
        return task.messages.length > lastSeenCount;
    };

    // Drag & Drop Handlers
    const handleTaskDragStart = (e: any, task: any) => {
        setDraggedTask(task);
        e.dataTransfer.effectAllowed = 'move';
        // Ghost image styling if needed
    };

    const handleDragOver = (e: any, columnId: string) => {
        e.preventDefault();
        setDragOverColumn(columnId);
    };
    
    const handleDropUrgent = async (e: any) => {
        e.preventDefault();
        if (draggedTask) {
            if(db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', draggedTask.id), { priority: 'high' });
            else setTasks(tasks.map(t => t.id === draggedTask.id ? { ...t, priority: 'high' } : t));
            setDraggedTask(null);
        }
    };

    const handleDrop = async (e: any, targetId: string) => {
        e.preventDefault();
        if (!draggedTask) return;

        if (viewMode === 'categories') {
            // Moving between categories
            if (draggedTask.category !== targetId) {
                if(db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', draggedTask.id), { category: targetId });
                else setTasks(tasks.map(t => t.id === draggedTask.id ? { ...t, category: targetId } : t));
            }
        } else {
            // Moving between statuses
            if (draggedTask.status !== targetId) {
                 const updates: any = { status: targetId };
                 if (targetId === 'done') updates.completed = true;
                 else if (targetId === 'todo' || targetId === 'in_progress') updates.completed = false;
                 
                 if(db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', draggedTask.id), updates);
                 else setTasks(tasks.map(t => t.id === draggedTask.id ? { ...t, ...updates } : t));
            }
        }
        setDraggedTask(null);
        setDragOverColumn(null);
    };
    
    const handleColumnDragStart = (e: any, col: any) => {
        setDraggedColumn(col);
    };
    
    const handleColumnDrop = async (e: any, targetCol: any) => {
        e.preventDefault();
        if (!draggedColumn || draggedColumn.id === targetCol.id) return;
        
        // Simple swap logic for demonstration - ideally shift array
        const newCategories = [...categories];
        const draggedIdx = newCategories.findIndex(c => c.id === draggedColumn.id);
        const targetIdx = newCategories.findIndex(c => c.id === targetCol.id);
        
        // Swap orders
        const tempOrder = draggedColumn.order;
        if(db) {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', draggedColumn.id), { order: targetCol.order });
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', targetCol.id), { order: tempOrder });
        } else {
             // Local Swap Logic
             const catA = newCategories[draggedIdx];
             const catB = newCategories[targetIdx];
             catA.order = targetCol.order;
             catB.order = tempOrder;
             setCategories([...newCategories]);
        }
        
        setDraggedColumn(null);
    };

    const renderCalendarGrid = (isSmall = false) => { 
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDay = new Date(year, month, 1).getDay();
        
        let hasPrevMonthReminders = false;
        let hasNextMonthReminders = false;

        if (!isSmall) {
            const prevMonth = new Date(year, month - 1, 1);
            const nextMonth = new Date(year, month + 1, 1);
            hasPrevMonthReminders = calendarReminders.some(r => { const d = new Date(r.date); return d.getMonth() === prevMonth.getMonth() && d.getFullYear() === prevMonth.getFullYear(); });
            hasNextMonthReminders = calendarReminders.some(r => { const d = new Date(r.date); return d.getMonth() === nextMonth.getMonth() && d.getFullYear() === nextMonth.getFullYear(); });
        }
        
        const days = []; 
        for(let i=0; i<firstDay; i++) { days.push(<div key={`empty-${i}`} className={`p-1 ${isSmall ? 'h-6' : 'h-24 md:h-32 bg-gray-50/50'}`}></div>); }
        for(let i=1; i<=daysInMonth; i++) {
            const dateStr = new Date(year, month, i).toISOString().split('T')[0];
            const dayReminders = calendarReminders.filter(r => r.date === dateStr);
            let content;
            if (isSmall) {
                 const hasReminder = dayReminders.length > 0;
                 content = (<div key={i} className={`h-6 text-center text-xs p-1 rounded-full flex items-center justify-center ${hasReminder ? REMINDER_COLORS.find(c => c.id === dayReminders[0].color)?.value || 'bg-blue-100 text-blue-800' : ''}`}>{i}</div>);
            } else {
                content = (
                    <div key={i} onClick={() => { setSelectedDateForReminder(new Date(year, month, i)); setReminderForm({ ...reminderForm, text: "", startTime: "", endTime: "", participants: "" }); setSelectedMemberIds([]); }} className={`relative border border-gray-100 transition-colors h-24 md:h-32 p-2 hover:bg-blue-50 cursor-pointer flex flex-col items-start justify-start bg-white`}><span className={`font-bold text-lg text-gray-700`}>{i}</span>{dayReminders.map((rem: any, idx: number) => { const colorObj = REMINDER_COLORS.find(c => c.id === rem.color) || REMINDER_COLORS[0]; return (<div key={idx} className={`w-full text-[10px] px-1 py-0.5 rounded mt-1 truncate border ${colorObj.value}`}>{rem.startTime ? `${rem.startTime} ` : ''}{rem.text}</div>); })}{dayReminders.length === 0 && (<div className="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100"><Plus size={20} className="text-gray-300" /></div>)}</div>
                );
            }
            days.push(content);
        } 
        return { days, hasPrevMonthReminders, hasNextMonthReminders }; 
    };
    
    const calendarData = renderCalendarGrid(false);
    const smallCalendarData = renderCalendarGrid(true);
    
    const filteredTasks = tasks.filter(t => t.text.toLowerCase().includes(searchTerm.toLowerCase()));
    
    // Define columns based on View Mode
    const columns = viewMode === 'categories' ? categories : STATUS_COLUMNS;

    // Filter reminders for the selected date in modal
    const currentDayReminders = selectedDateForReminder 
        ? calendarReminders.filter(r => r.date === selectedDateForReminder.toISOString().split('T')[0]) 
        : [];

    return (
        <div className="animate-in slide-in-from-right-4 duration-500 pb-10 relative">
            <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 mb-10 bg-white p-8 rounded-3xl border border-gray-100 shadow-sm">
                <div className="flex items-center gap-6">
                    <button onClick={onBack} className="p-3 bg-gray-50 border border-gray-200 rounded-xl hover:bg-gray-100 transition-colors group"><ArrowLeft size={24} className="text-gray-500 group-hover:text-blue-600" /></button>
                    <div>
                        <div className="flex items-center gap-2 group">
                            <h1 className="text-3xl font-extrabold text-gray-900 mb-1">{event.title}</h1>
                            <button onClick={() => setIsEditEventOpen(true)} className="p-1 text-gray-400 hover:text-blue-600 transition-opacity" title="Editar Evento"><Edit2 size={18}/></button>
                            <button onClick={() => setIsLeadsModalOpen(true)} className="p-1 text-gray-400 hover:text-emerald-600 transition-opacity" title="Registrar Leads"><BarChart3 size={18}/></button>
                        </div>
                        <p className="text-gray-500 flex items-center gap-3 text-sm font-medium"><span className="flex items-center gap-1"><Truck size={16} className="text-blue-900"/> {event.location}</span><span className="h-4 w-px bg-gray-300"></span><span className="flex items-center gap-1"><CalendarIcon size={16} className="text-blue-900"/> {event.dateRange}</span></p>
                    </div>
                </div>
                <div className="bg-gradient-to-r from-blue-900 to-blue-800 text-white px-8 py-4 rounded-2xl shadow-xl flex items-center gap-4"><Clock size={32} className="text-blue-200" /><div><p className="text-xs font-bold text-blue-200 uppercase tracking-widest mb-1">Contagem Regressiva</p><p className="text-3xl font-black leading-none">{daysRemaining} dias</p></div></div>
            </div>
            
            {/* ... Resto do DashboardView (sem altera√ß√µes visuais significativas aqui) ... */}
            <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <div className="lg:col-span-1 space-y-6">
                     <section className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 transition-all duration-300">
                        <div className="flex items-center justify-between mb-2"><h2 className="text-base font-bold flex items-center gap-2 text-gray-800"><Users size={18} className="text-blue-900"/> Equipe</h2><div className="flex items-center gap-2"><button onClick={() => setIsAddingMember(true)} className="p-1 hover:bg-gray-100 rounded text-blue-900"><Plus size={16}/></button><button onClick={() => setIsTeamExpanded(!isTeamExpanded)} className="p-1 hover:bg-gray-100 rounded text-gray-400">{isTeamExpanded ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}</button></div></div>
                        {isTeamExpanded && (
                            <div className="space-y-2 mt-4 animate-in fade-in slide-in-from-top-1">
                                <div className="bg-blue-50 rounded-lg p-2 border border-blue-100 mb-3 relative overflow-hidden"><div className="absolute top-0 right-0 bg-blue-200 text-blue-800 text-[9px] px-2 py-0.5 rounded-bl-lg font-bold uppercase tracking-wide">Respons√°vel</div><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-white border-2 border-blue-200 flex items-center justify-center overflow-hidden"><Avatar member={eventTeam[0]}/></div><div><p className="font-bold text-xs text-blue-900 flex items-center gap-1">{eventTeam[0]?.name} <Crown size={10} className="text-yellow-500 fill-yellow-500"/></p><p className="text-[10px] text-blue-600">L√≠der do Evento</p></div></div></div>
                                {eventTeam.slice(1).map((member: any) => (<div key={member.id} className="flex items-center justify-between group p-2 hover:bg-gray-50 rounded-lg transition-colors"><div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-blue-900 font-bold text-xs overflow-hidden"><Avatar member={member} size="w-8 h-8"/></div><div className="leading-tight"><p className="font-semibold text-xs text-gray-900">{member.name}</p><p className="text-[10px] text-gray-500">{member.role}</p></div></div><div className="flex gap-1"><button onClick={() => handlePromoteToLeader(member.id)} className="p-1.5 text-gray-400 hover:text-yellow-500 hover:bg-yellow-50 rounded-lg transition-colors" title="Promover a L√≠der"><Crown size={16} /></button><button onClick={() => handleRemoveTeamMember(member.id)} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><X size={16} /></button></div></div>))}
                                {isAddingMember && (<div className="mt-3 p-2 bg-gray-50 rounded-lg border border-gray-200"><p className="text-[10px] font-bold text-gray-500 uppercase mb-2">Banco de Talentos:</p><div className="max-h-32 overflow-y-auto space-y-1">{globalMembers.filter((gm: any) => !eventTeam.find((et: any) => et.id === gm.id)).map((gm: any) => (<button key={gm.id} onClick={() => handleAddTeamMember(gm)} className="w-full text-left flex items-center gap-2 p-1.5 hover:bg-white rounded text-xs text-gray-700"><div className="w-4 h-4 rounded-full bg-gray-200 flex items-center justify-center text-[8px] font-bold overflow-hidden"><Avatar member={gm} size="w-4 h-4"/></div>{gm.name}</button>))}</div><button onClick={() => setIsAddingMember(false)} className="mt-2 w-full py-1 text-[10px] text-gray-500 hover:bg-gray-200 rounded">Cancelar</button></div>)}
                            </div>
                        )}
                    </section>
                    <section className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 transition-all duration-300"><div className="flex items-center justify-between mb-2"><h2 className="text-base font-bold flex items-center gap-2 text-gray-800"><CalendarIcon size={18} className="text-blue-900"/> Agenda</h2><button onClick={() => setIsAgendaExpanded(!isAgendaExpanded)} className="p-1 hover:bg-gray-100 rounded text-gray-400">{isAgendaExpanded ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}</button></div>{isAgendaExpanded && (<div onClick={() => setIsCalendarOpen(true)} className="bg-white rounded-lg border border-gray-100 p-2 opacity-60 cursor-pointer hover:opacity-100 transition-opacity mt-2"><div className="grid grid-cols-7 gap-1 text-center text-[10px] text-gray-400 font-medium">{['D','S','T','Q','Q','S','S'].map((d, i) => <span key={i}>{d}</span>)}{smallCalendarData.days}</div></div>)}</section>
                </div>
                <div className="lg:col-span-3">
                    <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
                        <h2 className="text-lg font-bold flex items-center gap-2 text-gray-800"><CheckSquare size={20} className="text-blue-900"/> Tarefas do Projeto</h2>
                        <div className="flex items-center gap-2 bg-gray-100 p-1 rounded-lg">
                            <button onClick={() => setViewMode('categories')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${viewMode === 'categories' ? 'bg-white text-blue-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>Por Categoria</button>
                            <button onClick={() => setViewMode('status')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${viewMode === 'status' ? 'bg-white text-blue-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>Por Status</button>
                        </div>
                        <div className="relative w-full sm:w-auto flex-1 max-w-md"><Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" /><input type="text" placeholder="Pesquisar tarefa..." className="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}/></div>
                        <div className="flex gap-2">
                            <button onClick={() => setIsManageCategoriesOpen(true)} className="p-2 bg-white border border-gray-200 rounded-lg text-gray-500 hover:text-blue-900 transition-colors" title="Gerenciar Categorias"><Settings size={18}/></button>
                            <button onClick={() => { setPreSelectedCategory(null); setIsAddTaskOpen(true); }} className="bg-blue-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-800 transition-colors flex items-center gap-2 shadow-lg shadow-blue-900/20"><Plus size={16}/> Nova Tarefa</button>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 items-start h-full">
                        {columns.map((col: any) => { 
                            // Determine tasks for this column based on viewMode
                            const colTasks = filteredTasks.filter(t => {
                                if (viewMode === 'categories') return t.category === col.id;
                                // View Mode Status Logic
                                if (col.id === 'done') return t.completed;
                                if (col.id === 'todo') return !t.completed && (!t.status || t.status === 'todo');
                                return !t.completed && t.status === col.id;
                            });
                            
                            const styleClass = viewMode === 'categories' ? getCategoryStyles(col.color) : getCategoryStyles(col.color || 'gray');
                            
                            return (
                                <div 
                                    key={col.id} 
                                    onDragOver={(e) => handleDragOver(e, col.id)}
                                    onDrop={(e) => handleDrop(e, col.id)}
                                    className={`bg-gray-50 rounded-xl p-3 border border-gray-200 flex flex-col h-full min-h-[300px] transition-colors ${dragOverColumn === col.id ? 'drag-over' : ''}`}
                                    draggable={viewMode === 'categories'}
                                    onDragStart={(e) => handleColumnDragStart(e, col)}
                                >
                                    <div className={`flex items-center gap-2 p-2 rounded-lg mb-3 border ${styleClass} bg-white shadow-sm cursor-grab active:cursor-grabbing`}>
                                        {viewMode === 'categories' && <GripVertical size={14} className="text-gray-300"/>}
                                        <div className={`p-1 rounded ${styleClass.split(' ')[1]} ${styleClass.split(' ')[0]}`}>
                                            {viewMode === 'categories' ? getCategoryIcon(col.icon) : <Box size={16}/>}
                                        </div>
                                        <span className="text-xs font-bold text-gray-700">{col.title}</span>
                                        <div className="ml-auto flex items-center gap-1">
                                            <span className="text-[10px] font-bold bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">{colTasks.length}</span>
                                            {viewMode === 'categories' && <button onClick={() => { setPreSelectedCategory(col.id); setIsAddTaskOpen(true); }} className="hover:bg-blue-100 p-0.5 rounded text-blue-600"><Plus size={14}/></button>}
                                        </div>
                                    </div>
                                    <div className="space-y-2 flex-1">
                                        {colTasks.map(task => (
                                            <div 
                                                key={task.id} 
                                                draggable
                                                onDragStart={(e) => handleTaskDragStart(e, task)}
                                                onClick={() => setSelectedTask(task)} 
                                                className={`bg-white p-3 rounded-lg border shadow-sm cursor-pointer hover:shadow-md transition-all group relative ${task.completed ? 'opacity-60' : 'hover:border-blue-300'} ${draggedTask?.id === task.id ? 'dragging' : ''}`}
                                            >
                                                <div className="flex items-start gap-2 mb-2">
                                                    <button onClick={(e) => toggleTask(e, task.id)} className={`mt-0.5 flex-shrink-0 w-4 h-4 rounded border flex items-center justify-center transition-colors ${task.completed ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-gray-300 text-transparent hover:border-blue-400'}`}><CheckSquare size={10} fill="currentColor" /></button>
                                                    <p className={`text-xs font-medium leading-tight flex-1 ${task.completed ? 'line-through text-gray-400' : 'text-gray-700'}`}>{task.text}</p>
                                                    {isTaskUnread(task) && (
                                                        <div className="relative group/msg">
                                                            <MessageSquare size={14} className="text-blue-500" />
                                                            <span className="absolute -top-1 -right-1 flex h-2.5 w-2.5">
                                                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                                                <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500 border border-white"></span>
                                                            </span>
                                                        </div>
                                                    )}
                                                    <button onClick={(e) => deleteTask(e, task.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={12}/></button>
                                                </div>
                                                <div className="flex items-center justify-between mt-2 pt-2 border-t border-gray-50">
                                                    <div className="w-5 h-5 rounded-full bg-gray-100 border border-gray-200 flex items-center justify-center text-[8px] font-bold text-gray-600 overflow-hidden" title={task.responsible?.name}><Avatar member={task.responsible} size="w-5 h-5" textSize="text-[8px]"/></div>
                                                    <PriorityBadge level={task.priority} onClick={() => cyclePriority(task.id)} />
                                                </div>
                                            </div>
                                        ))}
                                        {colTasks.length === 0 && <div className="text-center py-8 text-gray-300 border-2 border-dashed border-gray-200 rounded-lg"><p className="text-[10px]">Vazio</p></div>}
                                    </div>
                                </div>
                            ); 
                        })}
                    </div>
                </div>
            </div>
            
             {/* DROP ZONE DE URGENCIA */}
            {draggedTask && (
                <div 
                    onDragOver={(e) => e.preventDefault()}
                    onDrop={handleDropUrgent}
                    className="fixed bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-red-600/90 to-red-500/80 backdrop-blur-sm z-[160] flex items-center justify-center text-white animate-in slide-in-from-bottom-10 border-t-4 border-red-400 border-dashed"
                >
                    <div className="flex flex-col items-center animate-pulse">
                        <Flame size={32} />
                        <p className="font-bold text-lg">Solte aqui para tornar URGENTE üî•</p>
                    </div>
                </div>
            )}

            <TaskDetailModal task={selectedTask} isOpen={!!selectedTask} onClose={() => setSelectedTask(null)} members={eventTeam} onAddSupport={handleAddSupport} onSendMessage={handleSendMessage} onAssignResponsible={handleAssignResponsible}/>
            <AddTaskModal isOpen={isAddTaskOpen} onClose={() => setIsAddTaskOpen(false)} onAdd={handleAddTask} members={eventTeam} categories={categories} preSelectedCategory={preSelectedCategory} />
            <ManageCategoriesModal isOpen={isManageCategoriesOpen} onClose={() => setIsManageCategoriesOpen(false)} categories={categories} onAdd={handleAddCategory} onUpdate={handleUpdateCategory} onDelete={handleDeleteCategory} />
            <EditEventModal isOpen={isEditEventOpen} onClose={() => setIsEditEventOpen(false)} event={event} onSave={handleUpdateEvent} />
            <LeadsModal isOpen={isLeadsModalOpen} onClose={() => setIsLeadsModalOpen(false)} event={event} onSave={handleUpdateEvent} />
            
            <Modal isOpen={isCalendarOpen} onClose={() => setIsCalendarOpen(false)} title={`Agenda: ${event.title}`} fullScreen={true}>
                 <div className="flex flex-col h-full bg-gray-50">
                     <div className="flex items-center justify-center py-4 bg-white border-b shadow-sm sticky top-0 z-10 gap-8">
                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 hover:bg-gray-100 rounded-full border shadow-sm relative">
                            <ChevronLeft size={24}/>
                            {calendarData.hasPrevMonthReminders && <span className="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>}
                        </button>
                        <span className="text-2xl font-bold text-gray-800 capitalize min-w-[200px] text-center">{MONTH_NAMES[currentDate.getMonth()]} {currentDate.getFullYear()}</span>
                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 hover:bg-gray-100 rounded-full border shadow-sm relative">
                            <ChevronRight size={24}/>
                            {calendarData.hasNextMonthReminders && <span className="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>}
                        </button>
                     </div>
                     <div className="flex-1 p-4 md:p-8 overflow-y-auto">
                        <div className="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                            {['DOM','SEG','TER','QUA','QUI','SEX','S√ÅB'].map(d=><div key={d} className="bg-gray-100 p-2 text-center text-sm font-bold text-gray-500 uppercase">{d}</div>)}
                            {calendarData.days}
                        </div>
                     </div>
                  </div>
            </Modal>

            {/* MODAL DE LEMBRETE DETALHADO (Atualizado com Seletor de Equipe) */}
            {selectedDateForReminder && (
                <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md animate-in zoom-in-95 flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-blue-900 text-white rounded-t-xl">
                            <h3 className="text-lg font-bold flex items-center gap-2"><CalendarIcon size={18}/> {selectedDateForReminder.toLocaleDateString()}</h3>
                            <button onClick={() => setSelectedDateForReminder(null)} className="text-white/80 hover:text-white"><X size={20}/></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {/* Lista de Compromissos Existentes */}
                            {currentDayReminders.length > 0 && (
                                <div className="space-y-3">
                                    <h4 className="text-xs font-bold text-gray-500 uppercase">Compromissos do dia</h4>
                                    {currentDayReminders.map((rem: any) => {
                                        const colorObj = REMINDER_COLORS.find(c => c.id === rem.color) || REMINDER_COLORS[0];
                                        return (
                                            <div key={rem.id} className={`p-3 rounded-lg border flex items-start justify-between group ${colorObj.value.replace('border-', 'border-l-4 ')}`}>
                                                <div>
                                                    <p className="font-bold text-sm text-gray-800">{rem.text}</p>
                                                    {(rem.startTime || rem.participants) && (
                                                        <div className="text-xs text-gray-500 mt-1 space-y-0.5">
                                                            {rem.startTime && <div className="flex items-center gap-1"><Clock size={10}/> {rem.startTime} - {rem.endTime || '?'}</div>}
                                                            {rem.participants && <div className="flex items-center gap-1"><Users size={10}/> {rem.participants}</div>}
                                                        </div>
                                                    )}
                                                </div>
                                                <button onClick={() => handleDeleteReminder(rem.id)} className="text-gray-400 hover:text-red-500 p-1 opacity-50 group-hover:opacity-100 transition-opacity"><Trash2 size={16}/></button>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* Formul√°rio Novo */}
                            <div className="space-y-4 pt-4 border-t border-gray-100">
                                <h4 className="text-xs font-bold text-blue-900 uppercase flex items-center gap-1"><Plus size={12}/> Adicionar Novo</h4>
                                
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">T√≠tulo</label>
                                    <input autoFocus value={reminderForm.text} onChange={e => setReminderForm({...reminderForm, text: e.target.value})} className="w-full border p-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Reuni√£o com fornecedor..." />
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-medium text-gray-600 mb-1">In√≠cio</label>
                                        <input type="time" value={reminderForm.startTime} onChange={e => setReminderForm({...reminderForm, startTime: e.target.value})} className="w-full border p-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-600 mb-1">Fim</label>
                                        <input type="time" value={reminderForm.endTime} onChange={e => setReminderForm({...reminderForm, endTime: e.target.value})} className="w-full border p-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Participantes da Equipe</label>
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        {globalMembers.map((member: any) => {
                                            const isSelected = selectedMemberIds.includes(member.id);
                                            return (
                                                <button 
                                                    key={member.id}
                                                    onClick={() => toggleMemberSelection(member.id)}
                                                    className={`flex items-center gap-1 pl-1 pr-2 py-1 rounded-full border text-[10px] font-bold transition-all ${isSelected ? 'bg-blue-100 border-blue-200 text-blue-800' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`}
                                                >
                                                    <div className="w-4 h-4 rounded-full overflow-hidden flex items-center justify-center bg-gray-100">
                                                        <Avatar member={member} size="w-4 h-4" />
                                                    </div>
                                                    {member.name.split(' ')[0]}
                                                    {isSelected && <Check size={10} />}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Outros / Externos</label>
                                    <input 
                                        value={reminderForm.participants} 
                                        onChange={e => setReminderForm({...reminderForm, participants: e.target.value})} 
                                        className="w-full border p-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="Ex: Cliente X, Diretor Y..." 
                                    />
                                    <p className="text-[10px] text-gray-400 mt-1">Os nomes selecionados acima ser√£o adicionados automaticamente.</p>
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-2">Cor da Etiqueta</label>
                                    <div className="flex gap-2">
                                        {REMINDER_COLORS.map(color => (
                                            <button 
                                                key={color.id}
                                                onClick={() => setReminderForm({...reminderForm, color: color.id})}
                                                className={`w-6 h-6 rounded-full border-2 transition-transform hover:scale-110 ${reminderForm.color === color.id ? 'border-gray-500 scale-110' : 'border-transparent'}`}
                                                style={{ backgroundColor: color.hex }}
                                                title={color.label}
                                            />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-2">
                            <button onClick={() => setSelectedDateForReminder(null)} className="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded-lg text-sm">Fechar</button>
                            <button onClick={handleAddReminder} className="px-6 py-2 bg-blue-900 text-white rounded-lg font-bold text-sm hover:bg-blue-800 shadow-lg">Adicionar</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

const App = () => {
    const [currentView, setCurrentView] = useState('dashboard');
    const [selectedEvent, setSelectedEvent] = useState<any>(null);
    const [logo, setLogo] = useState<any>(<DefaultLogo />);
    const [authError, setAuthError] = useState<string|null>(null);
    const [user, setUser] = useState<any>(null);
    const [members, setMembers] = useState<any[]>([]);
    const [events, setEvents] = useState<any[]>([]);
    const [isSettingsOpen, setIsSettingsOpen] = useState(false);
    const [isNotificationsOpen, setIsNotificationsOpen] = useState(false);
    const [isAIOpen, setIsAIOpen] = useState(false); 
    const [notifications, setNotifications] = useState<any[]>([]);

    useEffect(() => {
        const initAuth = async () => { 
            if (!isFirebaseAvailable) {
                // setAuthError("Modo Offline: Firebase n√£o configurado"); // N√£o precisamos assustar o usu√°rio se o modo offline funciona
                return;
            }
            try { 
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error: any) { 
                console.error("Erro no login:", error); 
                setAuthError(error.message); 
            } 
        };
        initAuth();
        if(auth) {
            const unsubscribe = onAuthStateChanged(auth, setUser);
            return () => unsubscribe();
        }
    }, []);

    useEffect(() => {
        if (!user || !isFirebaseAvailable || !db) {
            // Load from LocalStorage FIRST for persistence in demo mode
            const savedMembers = localStorage.getItem('eh_members');
            const savedEvents = localStorage.getItem('eh_events');
            const savedLogo = localStorage.getItem('eh_logo');
            
            if (savedMembers) setMembers(JSON.parse(savedMembers));
            else {
                const defaultMembers = [
                    { id: '1', name: "Paulo Mokarzel", role: "Gestor", avatar: "PM", avatarType: 'executive', avatarContent: 'ex5' },
                    { id: '2', name: "Ana Silva", role: "Coordena√ß√£o", avatar: "AS", avatarType: 'executive', avatarContent: 'ex4' }
                ];
                setMembers(defaultMembers);
            }
            
            if (savedEvents) setEvents(JSON.parse(savedEvents));
            else {
                 const defaultEvents = [
                     { id: 'e1', day: "02", month: "FEV", title: "Conven√ß√£o de Vendas", location: "Audit√≥rio Doremus", dateRange: "02/02/2026 - 06/02/2026", pending: 21 },
                     { id: 'e2', day: "31", month: "MAR", title: "Nis Nutri", location: "Transamerica Expo Center", dateRange: "31/03/2026 - 01/04/2026", pending: 22 }
                ];
                setEvents(defaultEvents);
            }

            if (savedLogo) setLogo(savedLogo);

            return;
        }
        
        // Members
        const qm = collection(db, 'artifacts', appId, 'public', 'data', 'members');
        const unsubM = onSnapshot(qm, (snapshot) => {
            if (snapshot.empty) {
                const defaults = [
                    { name: "Paulo Mokarzel", role: "Gestor", avatar: "PM", avatarType: 'executive', avatarContent: 'ex5' },
                    { name: "Ana Silva", role: "Coordena√ß√£o", avatar: "AS", avatarType: 'executive', avatarContent: 'ex4' }
                ];
                defaults.forEach(m => addDoc(qm, m));
            } else {
                const loadedMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setMembers(loadedMembers);
            }
        }, (err) => console.error("Err members", err));

        // Events
        const qe = collection(db, 'artifacts', appId, 'public', 'data', 'events');
        const unsubE = onSnapshot(qe, (snapshot) => {
            if (snapshot.empty) {
                const defaults = [
                    { day: "02", month: "FEV", title: "Conven√ß√£o de Vendas", location: "Audit√≥rio Doremus", dateRange: "02/02/2026 - 06/02/2026", pending: 21 },
                    { day: "31", month: "MAR", title: "Nis Nutri", location: "Transamerica Expo Center", dateRange: "31/03/2026 - 01/04/2026", pending: 22 },
                    { day: "01", month: "MAI", title: "Jornada T√©cnica", location: "Hotel", dateRange: "01/05/2026", pending: 22 }
                ];
                defaults.forEach(evt => addDoc(qe, evt));
            } else {
                setEvents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }
        }, (err) => console.error("Err events", err));
        
        // Logo
        const ql = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'logo');
        const unsubL = onSnapshot(ql, (snapshot) => {
            if (snapshot.exists()) setLogo(snapshot.data().value);
        }, (err) => console.error("Err logo", err));

        // Notifications (from reminders)
        const qn = collection(db, 'artifacts', appId, 'public', 'data', 'reminders');
        const unsubN = onSnapshot(qn, (snapshot) => {
            const reminders = snapshot.docs.map(doc => ({
                text: `Lembrete: ${doc.data().text}`,
                date: new Date(doc.data().date).toLocaleDateString('pt-BR')
            }));
            const systemMsg = { text: "Bem-vindo ao Event Hub! Configure sua equipe.", date: "Agora" };
            setNotifications([systemMsg, ...reminders].slice(0, 5));
        }, (err) => console.error("Err notifications", err));

        return () => { unsubM(); unsubE(); unsubL(); unsubN(); };
    }, [user]);

    // --- Persist√™ncia Local (Modo Demo) ---
    useEffect(() => {
        if (!isFirebaseAvailable) {
            localStorage.setItem('eh_members', JSON.stringify(members));
        }
    }, [members]);

    useEffect(() => {
        if (!isFirebaseAvailable) {
            localStorage.setItem('eh_events', JSON.stringify(events));
        }
    }, [events]);

    useEffect(() => {
        if (!isFirebaseAvailable && typeof logo === 'string') {
            localStorage.setItem('eh_logo', logo);
        }
    }, [logo]);


    const handleAddMember = async (newMember: any) => { 
        if (db) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'members'), newMember);
        else setMembers([...members, { ...newMember, id: Date.now().toString() }]);
    };
    const handleUpdateMember = async (updatedMember: any) => { 
        if (db) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', updatedMember.id), updatedMember); 
        else setMembers(members.map(m => m.id === updatedMember.id ? updatedMember : m));
    };
    const handleDeleteMember = async (id: string) => { 
        if (confirm('Tem certeza?')) { 
            if (db) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', id)); 
            else setMembers(members.filter(m => m.id !== id));
        } 
    };
    const handleUpdateLogo = async (newLogo: string) => { 
        if (db) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'logo'), { value: newLogo }); 
        else setLogo(newLogo);
    };

    const manager = members.find((m: any) => m.role === 'Gestor') || { name: 'Paulo Mokarzel', role: 'Gestor', avatarType: 'executive', avatarContent: 'ex5' };

    return (
        <div className="min-h-screen bg-[#F8FAFC] font-sans text-gray-800 pb-12" onClick={() => setIsNotificationsOpen(false)}>
            {/* Indicador de Status da Conex√£o */}
            <div className={`fixed bottom-4 left-4 z-[200] px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-sm ${isFirebaseAvailable && user ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
                {isFirebaseAvailable && user ? <Wifi size={14}/> : <WifiOff size={14}/>}
                {isFirebaseAvailable && user ? 'Conectado' : 'Modo Offline / Demo'}
            </div>

            {authError && (<div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 sticky top-0 z-[200]"><p className="font-bold flex items-center gap-2"><AlertTriangle size={20}/> Aviso do Sistema</p><p>{authError}. Usando dados locais.</p></div>)}
            
            <nav className="bg-white border-b border-gray-100 px-6 py-4 mb-8 sticky top-0 z-40 shadow-sm"><div className="max-w-[1600px] mx-auto flex items-center justify-between"><div className="flex items-center gap-12"><div className="flex items-center gap-2 cursor-pointer" onClick={() => { setSelectedEvent(null); setCurrentView('dashboard'); }}><div className="h-10 w-auto flex items-center">{typeof logo === 'string' ? <img src={logo} alt="Logo" className="h-full w-auto object-contain" /> : logo}</div><div className="flex flex-col border-l border-gray-300 pl-4 ml-4 h-10 justify-center"><span className="text-xl font-bold text-gray-900 tracking-tight leading-none">Event Hub</span><span className="text-xs text-gray-500 font-medium">Painel de Marketing</span></div></div></div><div className="flex items-center gap-6"><div className="hidden md:flex items-center gap-3 mr-4"><div className="w-10 h-10 rounded-full overflow-hidden border border-gray-200"><Avatar member={manager} size="w-10 h-10"/></div><div className="flex flex-col items-end"><span className="text-[10px] text-gray-400 font-bold uppercase tracking-wide">Gestor <Crown size={12} className="inline text-yellow-500 fill-yellow-500"/></span><span className="text-sm font-bold text-gray-800">{manager.name}</span></div></div><div className="flex items-center gap-3 relative"><button onClick={(e) => { e.stopPropagation(); setIsNotificationsOpen(!isNotificationsOpen); }} className={`p-2 bg-white border border-gray-100 rounded-lg text-gray-500 hover:text-blue-900 hover:border-blue-100 transition-colors relative shadow-sm ${isNotificationsOpen ? 'ring-2 ring-blue-100' : ''}`}><Bell size={20}/>{!isNotificationsOpen && notifications.length > 0 && <span className="absolute top-2 right-2.5 w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span>}</button>{isNotificationsOpen && <NotificationsDropdown onClose={() => setIsNotificationsOpen(false)} notifications={notifications} />}<button onClick={() => setIsSettingsOpen(true)} className="p-2 bg-white border border-gray-100 rounded-lg text-gray-500 hover:text-blue-900 shadow-sm"><Settings size={20}/></button><button onClick={() => alert("Criar Novo Evento")} className="bg-blue-900 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-blue-800 transition-all shadow-lg flex items-center gap-2"><Plus size={18}/> Novo Evento</button></div></div></div></nav>
            <main className="max-w-[1600px] mx-auto px-6">{currentView === 'dashboard' ? <DashboardView onSelectEvent={(e: any) => { setSelectedEvent(e); setCurrentView('detail'); }} events={events} members={members} logo={logo} /> : <EventDetailView event={selectedEvent} onBack={() => { setSelectedEvent(null); setCurrentView('dashboard'); }} globalMembers={members} db={db} user={user} />}</main>
            
            {/* Bot√£o Flutuante da IA */}
            <button 
                onClick={() => setIsAIOpen(!isAIOpen)}
                className="fixed bottom-6 right-6 p-4 bg-blue-900 text-white rounded-full shadow-lg hover:shadow-2xl hover:scale-105 transition-all z-[140] flex items-center justify-center group border-2 border-white/20"
            >
                {isAIOpen ? <X size={24} /> : <Sparkles size={24} className="group-hover:rotate-12 transition-transform"/>}
            </button>

            <AIAssistant isOpen={isAIOpen} onClose={() => setIsAIOpen(false)} members={members} events={events} user={user} />
            <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} members={members} setMembers={setMembers} logo={logo} setLogo={setLogo} onAddMember={handleAddMember} onUpdateMember={handleUpdateMember} onDeleteMember={handleDeleteMember} onUpdateLogo={handleUpdateLogo} />
        </div>
    );
};

export default App;







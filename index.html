<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Hub - Painel de Marketing</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .drag-over { background-color: #eff6ff !important; border-color: #3b82f6 !important; }
        .dragging { opacity: 0.5; transform: scale(0.95); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-in-notification { animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .animate-shimmer { animation: shimmer 2s infinite linear; background: linear-gradient(to right, #eff6ff 4%, #dbeafe 25%, #eff6ff 36%); background-size: 1000px 100%; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        blue: { 900: '#1e3a8a', 950: '#172554' }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createPortal } from 'https://esm.sh/react-dom@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Calendar as CalendarIcon, Users, CheckSquare, Flag, Plus, X, Clock, 
            Edit2, Trash2, ChevronLeft, ChevronRight, Truck, ArrowLeft, 
            Search, Bell, MessageSquare, Send, AlertCircle, ChevronDown, 
            ChevronUp, Settings, UserPlus, Box, TrendingUp, Filter, Check, 
            Image as ImageIcon, AlertTriangle, Crown, Plane, Target, Camera,
            DollarSign, ClipboardList, Mic, Music, Coffee, Gift, Sparkles, Bot,
            BarChart3, Layout, GripVertical, Flame, Info, Wifi, WifiOff,
            ExternalLink, Lightbulb, BrainCircuit, MoreVertical, Paperclip, FileText,
            Wand2, Copy, Share2, ZoomIn, Layers, Zap, Megaphone, Palette, Maximize2, MapPin
        } from 'https://esm.sh/lucide-react@0.294.0';

        // --- Utils & Constants ---
        const compressImage = (file, maxWidth = 800) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            const outputType = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
                            resolve(canvas.toDataURL(outputType, 0.9)); 
                        } else resolve(img.src);
                    };
                };
            });
        };

        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        const PASTEL_COLORS = [
            { id: 'blue', bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-200', hex: '#DBEAFE', hover: 'hover:bg-blue-200' },
            { id: 'green', bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-200', hex: '#D1FAE5', hover: 'hover:bg-emerald-200' },
            { id: 'yellow', bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-200', hex: '#FEF3C7', hover: 'hover:bg-amber-200' },
            { id: 'red', bg: 'bg-rose-100', text: 'text-rose-800', border: 'border-rose-200', hex: '#FFE4E6', hover: 'hover:bg-rose-200' },
            { id: 'purple', bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-200', hex: '#F3E8FF', hover: 'hover:bg-purple-200' },
            { id: 'orange', bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200', hex: '#FFEDD5', hover: 'hover:bg-orange-200' },
            { id: 'teal', bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-200', hex: '#CCFBF1', hover: 'hover:bg-teal-200' },
            { id: 'indigo', bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-200', hex: '#E0E7FF', hover: 'hover:bg-indigo-200' },
        ];

        const COLOR_PRESETS = {
            blue: 'text-blue-800 bg-blue-100 border-blue-200',
            amber: 'text-amber-800 bg-amber-100 border-amber-200',
            purple: 'text-purple-800 bg-purple-100 border-purple-200',
            emerald: 'text-emerald-800 bg-emerald-100 border-emerald-200',
            gray: 'text-gray-800 bg-gray-100 border-gray-200',
            rose: 'text-rose-800 bg-rose-100 border-rose-200',
            indigo: 'text-indigo-800 bg-indigo-100 border-indigo-200',
            teal: 'text-teal-800 bg-teal-100 border-teal-200',
            orange: 'text-orange-800 bg-orange-100 border-orange-200'
        };

        const STATUS_COLUMNS = [
            { id: 'todo', title: 'A Fazer', color: 'blue', icon: ClipboardList },
            { id: 'in_progress', title: 'Em Andamento', color: 'amber', icon: Truck },
            { id: 'review', title: 'Revisão', color: 'purple', icon: Search },
            { id: 'done', title: 'Concluído', color: 'emerald', icon: CheckSquare }
        ];

        const ICON_MAP = { 
            box: Box, truck: Truck, users: Users, trending: TrendingUp, check: CheckSquare, 
            layers: Layers, zap: Zap, megaphone: Megaphone, palette: Palette, gift: Gift,
            coffee: Coffee, music: Music
        };
        
        const getCategoryStyles = (color) => COLOR_PRESETS[color] || COLOR_PRESETS.blue;
        const getCategoryIcon = (iconName) => { const Icon = ICON_MAP[iconName] || Box; return <Icon size={18} />; };
        const MONTH_NAMES = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        const DEFAULT_CATEGORIES = [
            { id: 'planning', title: 'Planejamento & Produto', icon: 'box', color: 'blue' },
            { id: 'logistics', title: 'Logística & Estande', icon: 'truck', color: 'amber' },
            { id: 'staff', title: 'Staff & Viagem', icon: 'users', color: 'purple' },
            { id: 'post', title: 'Pós-Evento & Leads', icon: 'trending', color: 'emerald' }
        ];

        const PREDEFINED_TASKS_DATA = [
            { text: "Definir orçamento inicial", category: "planning" },
            { text: "Reservar local do evento", category: "logistics" },
            { text: "Contratar buffet", category: "logistics" },
            { text: "Criar identidade visual", category: "planning" },
            { text: "Enviar convites", category: "planning" },
            { text: "Contratar equipe de foto/vídeo", category: "staff" },
            { text: "Definir cronograma", category: "planning" },
            { text: "Comprar brindes", category: "logistics" },
            { text: "Reservar passagens/hotel", category: "staff" },
            { text: "Criar formulário de leads", category: "post" }
        ];

        // --- Componentes Genéricos ---

        const ImagePreviewModal = ({ isOpen, onClose, imageUrl }) => {
            if (!isOpen || !imageUrl) return null;
            return createPortal(
                <div className="fixed inset-0 z-[9999] bg-black/90 flex items-center justify-center p-4 animate-in" onClick={onClose}>
                    <div className="relative max-w-4xl max-h-[90vh]">
                         <button onClick={onClose} className="absolute -top-10 right-0 text-white hover:text-gray-300"><X size={24}/></button>
                         <img src={imageUrl} className="max-w-full max-h-[85vh] rounded-lg shadow-2xl" onClick={(e) => e.stopPropagation()} />
                    </div>
                </div>,
                document.body
            );
        };

        const Avatar = ({ member, size = "w-10 h-10", showCrown = true }) => {
            if (!member) return <div className={`${size} rounded-full bg-gray-200 border border-gray-300`}></div>;
            const isManager = member.role && member.role.toLowerCase().includes('gestor');
            const content = member.photoUrl ? (
                <img src={member.photoUrl} className="w-full h-full object-cover" />
            ) : (
                <div className="w-full h-full flex items-center justify-center text-blue-900 font-bold text-[10px]">
                    {member.name?.substring(0,2)}
                </div>
            );
            return (
                <div className={`${size} rounded-full bg-white border border-gray-200 relative flex-shrink-0`}>
                    <div className="w-full h-full rounded-full overflow-hidden">{content}</div>
                    {isManager && showCrown && (
                        <div className="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-yellow-400 rounded-full border-2 border-white flex items-center justify-center z-10 shadow-sm">
                            <Crown size={8} className="text-yellow-900 fill-yellow-900"/>
                        </div>
                    )}
                </div>
            );
        };

        const PriorityBadge = ({ level, onClick }) => {
            const styles = { high: "bg-red-100 text-red-700 hover:bg-red-200", medium: "bg-amber-100 text-amber-700 hover:bg-amber-200", low: "bg-emerald-100 text-emerald-700 hover:bg-emerald-200" };
            const labels = { high: "Alta", medium: "Média", low: "Baixa" };
            const safeLevel = styles[level] ? level : 'low';
            return (
                <button onClick={(e) => { e.stopPropagation(); onClick && onClick(); }} className={`flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold border border-transparent transition-colors ${styles[safeLevel]}`}>
                    <Flag size={10} fill="currentColor" /> {labels[safeLevel]}
                </button>
            );
        };

        // MODAL COM PORTAL PARA CORRIGIR POSICIONAMENTO
        const Modal = ({ isOpen, onClose, title, children, fullScreen, maxWidth = "max-w-lg" }) => {
            useEffect(() => {
                if (isOpen) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = 'unset';
                }
                return () => { document.body.style.overflow = 'unset'; };
            }, [isOpen]);

            if (!isOpen) return null;
            
            const content = (
                <div className={`bg-white ${fullScreen ? 'fixed inset-0 z-[100] flex flex-col' : `rounded-2xl shadow-2xl w-full ${maxWidth} max-h-[90vh] overflow-hidden flex flex-col bg-white relative z-[100]`}`}>
                    <div className="p-4 border-b bg-[#1e1b4b] text-white flex justify-between items-center shrink-0">
                        <div className="flex items-center gap-2">
                             {title === 'Configurações' && <Settings size={18}/>}
                             <h3 className="font-bold">{title}</h3>
                        </div>
                        <button onClick={onClose}><X size={20}/></button>
                    </div>
                    <div className="p-0 overflow-y-auto flex-1 bg-white relative">{children}</div>
                </div>
            );

            const modalMarkup = fullScreen ? (
                <div className="fixed inset-0 z-[9999] bg-white animate-in" style={{animationDuration: '200ms'}}>
                    {content}
                </div>
            ) : (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-in" style={{animationDuration: '200ms'}}>
                    {content}
                </div>
            );

            return createPortal(modalMarkup, document.body);
        };

        const Toast = ({ message, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 5000); return () => clearTimeout(timer); }, [onClose]);
            return createPortal(
                <div className="fixed top-6 right-6 z-[10000] bg-white rounded-xl shadow-2xl border-l-4 border-blue-600 p-4 flex items-start gap-3 max-w-sm slide-in-notification">
                    <div className="bg-blue-100 p-2 rounded-full text-blue-600"><Bell size={20}/></div>
                    <div className="flex-1"><h4 className="font-bold text-gray-800 text-sm">Nova Atualização</h4><p className="text-xs text-gray-600 mt-1">{message}</p></div>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={14}/></button>
                </div>,
                document.body
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={title} maxWidth="max-w-sm">
                    <div className="p-6">
                        <p className="text-sm text-gray-600 mb-6">{message}</p>
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-bold">Cancelar</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg text-sm font-bold">Sim, excluir</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const NotificationsDropdown = ({ onClose, notifications }) => {
            return (
                <div className="absolute top-14 right-0 w-80 bg-white rounded-2xl shadow-2xl border border-gray-100 z-[100] animate-in fade-in zoom-in-95 duration-200 overflow-hidden">
                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center"><span className="font-bold text-gray-800 text-sm flex items-center gap-2"><Bell size={14} className="text-blue-600"/> Notificações</span><button onClick={onClose}><X size={16} className="text-gray-400 hover:text-gray-600"/></button></div>
                    <div className="max-h-80 overflow-y-auto">
                        {notifications.length === 0 ? <div className="p-8 text-center text-gray-400 text-xs">Tudo limpo por aqui! ✨</div> : 
                        notifications.map((notif, idx) => (
                            <div key={idx} className="p-4 border-b border-gray-50 hover:bg-blue-50/50 transition-colors cursor-pointer group">
                                <div className="flex gap-3"><div className="mt-1 w-2 h-2 rounded-full flex-shrink-0 bg-blue-500 ring-4 ring-blue-100"></div><div><p className="text-sm font-semibold text-gray-800 group-hover:text-blue-700 transition-colors">{notif.text}</p><p className="text-xs text-gray-400 mt-1 flex items-center gap-1"><Clock size={10}/> {notif.date}</p></div></div>
                            </div>
                        ))}
                    </div>
                    <div className="p-2 bg-gray-50 text-center border-t border-gray-100"><button className="text-xs font-bold text-blue-600 hover:text-blue-800">Marcar todas como lidas</button></div>
                </div>
            );
        };

        // --- Novo Modal de Criação de Evento ---
        const NewEventModal = ({ isOpen, onClose, members, onCreate }) => {
            const [formData, setFormData] = useState({
                title: '',
                location: '',
                startDate: '',
                endDate: '',
                responsible: '',
                team: [],
                selectedTasks: [],
                cover: null
            });
            const [customTask, setCustomTask] = useState('');
            const [customTaskCategory, setCustomTaskCategory] = useState(DEFAULT_CATEGORIES[0].id);
            const coverInputRef = useRef(null);

            if (!isOpen) return null;

            const handleToggleMember = (memberId) => {
                if (formData.team.includes(memberId)) {
                    setFormData({ ...formData, team: formData.team.filter(id => id !== memberId) });
                } else {
                    setFormData({ ...formData, team: [...formData.team, memberId] });
                }
            };

            const handleToggleTask = (task) => {
                const exists = formData.selectedTasks.some(t => t.text === task.text);
                if (exists) {
                    setFormData({ ...formData, selectedTasks: formData.selectedTasks.filter(t => t.text !== task.text) });
                } else {
                    setFormData({ ...formData, selectedTasks: [...formData.selectedTasks, task] });
                }
            };

            const addCustomTask = () => {
                if (customTask.trim()) {
                    const newTask = { text: customTask.trim(), category: customTaskCategory, isCustom: true };
                    setFormData({ ...formData, selectedTasks: [...formData.selectedTasks, newTask] });
                    setCustomTask('');
                }
            };

            const removeCustomTask = (taskText) => {
                setFormData({ ...formData, selectedTasks: formData.selectedTasks.filter(t => t.text !== taskText) });
            };

            const handleCoverUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    compressImage(file, 800).then(url => {
                        setFormData({ ...formData, cover: url });
                    });
                }
            };

            const handleSubmit = () => {
                if (!formData.title || !formData.startDate || !formData.responsible) return;
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const [y, m, d] = dateStr.split('-');
                    return `${d}/${m}/${y}`;
                };

                const newEvent = {
                    title: formData.title,
                    location: formData.location || 'Local a definir',
                    dateRange: `${formatDate(formData.startDate)} - ${formData.endDate ? formatDate(formData.endDate) : formatDate(formData.startDate)}`,
                    responsibleId: formData.responsible,
                    teamIds: formData.team,
                    initialTasks: formData.selectedTasks,
                    coverUrl: formData.cover
                };

                onCreate(newEvent);
                setFormData({ title: '', location: '', startDate: '', endDate: '', responsible: '', team: [], selectedTasks: [], cover: null });
            };

            const groupedTasks = PREDEFINED_TASKS_DATA.reduce((acc, task) => {
                if (!acc[task.category]) acc[task.category] = [];
                acc[task.category].push(task);
                return acc;
            }, {});

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Criar Novo Evento" maxWidth="max-w-4xl">
                    <div className="p-6 space-y-6">
                        {/* Capa do Evento */}
                        <div className="relative w-full h-40 bg-gray-100 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center overflow-hidden group hover:border-blue-400 transition-colors cursor-pointer" onClick={() => coverInputRef.current?.click()}>
                            {formData.cover ? (
                                <img src={formData.cover} className="w-full h-full object-cover" />
                            ) : (
                                <div className="text-center p-4">
                                    <ImageIcon size={32} className="mx-auto text-gray-400 mb-2"/>
                                    <p className="text-sm font-bold text-gray-500">Adicionar Capa do Evento</p>
                                    <p className="text-xs text-gray-400">Clique para fazer upload</p>
                                </div>
                            )}
                            <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <span className="text-white font-bold text-sm"><Camera size={20} className="inline mr-2"/>Alterar Capa</span>
                            </div>
                            <input type="file" ref={coverInputRef} onChange={handleCoverUpload} className="hidden" accept="image/*"/>
                        </div>

                        {/* Dados Básicos */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome do Evento</label>
                                <input className="w-full p-2 border rounded-lg outline-none focus:border-blue-500" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="Ex: Convenção 2026"/>
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Local</label>
                                <div className="flex items-center gap-2 border rounded-lg p-2 focus-within:border-blue-500">
                                    <MapPin size={16} className="text-gray-400"/>
                                    <input className="flex-1 outline-none text-sm" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} placeholder="Ex: Auditório Principal"/>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data Início</label>
                                <input type="date" className="w-full p-2 border rounded-lg text-sm" value={formData.startDate} onChange={e => setFormData({...formData, startDate: e.target.value})}/>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data Fim</label>
                                <input type="date" className="w-full p-2 border rounded-lg text-sm" value={formData.endDate} onChange={e => setFormData({...formData, endDate: e.target.value})}/>
                            </div>
                        </div>

                        {/* Responsável e Equipe */}
                        <div className="space-y-4 border-t pt-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Responsável Principal</label>
                                <select className="w-full p-2 border rounded-lg bg-white text-sm" value={formData.responsible} onChange={e => setFormData({...formData, responsible: e.target.value})}>
                                    <option value="">Selecione um gestor...</option>
                                    {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Equipe do Evento</label>
                                <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                                    {members.map(m => (
                                        <button 
                                            key={m.id} 
                                            onClick={() => handleToggleMember(m.id)}
                                            className={`flex items-center gap-2 p-1.5 rounded-lg border text-xs transition-colors ${formData.team.includes(m.id) ? 'bg-blue-100 border-blue-300 text-blue-800' : 'bg-white border-gray-200 text-gray-600 hover:border-blue-200'}`}
                                        >
                                            <div className="w-5 h-5 rounded-full overflow-hidden border border-gray-200">
                                                {m.photoUrl ? <img src={m.photoUrl} className="w-full h-full object-cover"/> : <div className="w-full h-full bg-gray-200 flex items-center justify-center font-bold">{m.name.substring(0,1)}</div>}
                                            </div>
                                            {m.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Tarefas Iniciais */}
                        <div className="space-y-4 border-t pt-4">
                            <label className="block text-xs font-bold text-gray-500 uppercase">Checklist Inicial (Selecione o que se aplica)</label>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {Object.keys(groupedTasks).map(catId => {
                                    const cat = DEFAULT_CATEGORIES.find(c => c.id === catId);
                                    return (
                                        <div key={catId} className="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                            <h5 className={`text-xs font-bold mb-2 flex items-center gap-1 ${getCategoryStyles(cat?.color || 'gray').split(' ')[0]}`}>
                                                {getCategoryIcon(cat?.icon)} {cat?.title}
                                            </h5>
                                            <div className="space-y-1">
                                                {groupedTasks[catId].map((task, idx) => (
                                                    <label key={idx} className="flex items-center gap-2 p-1.5 rounded cursor-pointer hover:bg-white hover:shadow-sm transition-all">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={formData.selectedTasks.some(t => t.text === task.text)} 
                                                            onChange={() => handleToggleTask(task)} 
                                                            className="rounded text-blue-600 focus:ring-blue-500"
                                                        />
                                                        <span className="text-xs text-gray-700">{task.text}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            <div className="bg-white border border-gray-200 rounded-lg p-3">
                                <label className="block text-xs font-bold text-gray-500 mb-2">Adicionar Tarefa Personalizada</label>
                                <div className="flex gap-2">
                                    <select 
                                        className="w-1/3 p-2 border rounded-lg text-sm bg-gray-50 outline-none"
                                        value={customTaskCategory}
                                        onChange={e => setCustomTaskCategory(e.target.value)}
                                    >
                                        {DEFAULT_CATEGORIES.map(cat => <option key={cat.id} value={cat.id}>{cat.title}</option>)}
                                    </select>
                                    <input 
                                        className="flex-1 p-2 border rounded-lg text-sm outline-none focus:border-blue-500" 
                                        placeholder="Digite a tarefa..." 
                                        value={customTask} 
                                        onChange={e => setCustomTask(e.target.value)}
                                        onKeyDown={e => e.key === 'Enter' && addCustomTask()}
                                    />
                                    <button onClick={addCustomTask} className="p-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200"><Plus size={16}/></button>
                                </div>
                                {/* Lista de personalizadas */}
                                <div className="flex flex-wrap gap-2 mt-3">
                                    {formData.selectedTasks.filter(t => t.isCustom).map((t, idx) => (
                                        <span key={idx} className="bg-purple-50 text-purple-700 px-2 py-1 rounded text-xs flex items-center gap-1 border border-purple-100">
                                            {t.text} <button onClick={() => removeCustomTask(t.text)} className="hover:text-purple-900"><X size={10}/></button>
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-end pt-4 border-t">
                            <button onClick={handleSubmit} disabled={!formData.title} className="bg-blue-900 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-blue-800 disabled:opacity-50 shadow-lg shadow-blue-900/20">Criar Evento</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- Detalhes da Tarefa ---
        const TaskDetailModal = ({ task, isOpen, onClose, members, onUpdateTask, onSendMessage, onAssignResponsible, onAddAttachment, onDeleteAttachment, onDeleteMessage }) => {
            const [messageText, setMessageText] = useState("");
            const [isSelectingResponsible, setIsSelectingResponsible] = useState(false);
            const [isSelectingSupport, setIsSelectingSupport] = useState(false);
            const [selectedSender, setSelectedSender] = useState(members[0]);
            const [previewImage, setPreviewImage] = useState(null);
            const [chatAttachment, setChatAttachment] = useState(null);
            const [newSubtask, setNewSubtask] = useState("");
            const [confirmDeleteMessageId, setConfirmDeleteMessageId] = useState(null);
            const chatContainerRef = useRef(null);
            const chatFileRef = useRef(null);

            const messages = task?.messages || [];
            
            useEffect(() => { 
                if (isOpen && chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
                if (isOpen && task && members.length > 0) {
                    const me = members.find(m => m.name === 'Paulo Mokarzel') || members[0];
                    if (me) setSelectedSender(me);
                }
            }, [messages, isOpen, task, members]);

            if (!task) return null;
            
            const responsible = task.responsible || { name: "Não definido", role: "-", avatar: "?" };
            const supportList = task.support || [];
            const attachments = task.attachments || [];
            const subtasks = task.subtasks || [];

            const handleSend = () => { 
                if (!messageText.trim() && !chatAttachment) return; 
                onSendMessage(task.id, messageText, selectedSender, chatAttachment); 
                setMessageText(""); 
                setChatAttachment(null);
            };

            const handleAddSubtask = () => {
                if(!newSubtask.trim()) return;
                const updatedSubtasks = [...subtasks, { id: Date.now(), text: newSubtask, completed: false }];
                onUpdateTask(task.id, { subtasks: updatedSubtasks });
                setNewSubtask("");
            };

            const toggleSubtask = (subId) => {
                const updatedSubtasks = subtasks.map(s => s.id === subId ? {...s, completed: !s.completed} : s);
                onUpdateTask(task.id, { subtasks: updatedSubtasks });
            };

            const deleteSubtask = (subId) => {
                if(window.confirm("Excluir este complemento?")) {
                    const updatedSubtasks = subtasks.filter(s => s.id !== subId);
                    onUpdateTask(task.id, { subtasks: updatedSubtasks });
                }
            };

            const handleChatImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) { compressImage(file, 400).then(url => { setChatAttachment(url); }); }
            };

            const addSupport = (member) => {
                const exists = supportList.find(s => s.id === member.id);
                if (!exists) {
                    onUpdateTask(task.id, { support: [...supportList, member] });
                }
                setIsSelectingSupport(false);
            };

            const removeSupport = (memberId) => {
                const updatedSupport = supportList.filter(s => s.id !== memberId);
                onUpdateTask(task.id, { support: updatedSupport });
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Tarefa #${task.id.toString().slice(-4)}`} fullScreen={true}>
                    <div className="flex flex-col md:flex-row h-full">
                        <div className="flex-1 flex flex-col border-r border-gray-100 bg-gray-50/50 overflow-y-auto">
                            <div className="p-6 border-b bg-white">
                                <div className="flex items-center gap-3 mb-3">
                                    <PriorityBadge level={task.priority} />
                                    <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold border ${task.status === 'done' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-blue-100 text-blue-700 border-blue-200'}`}>{task.status === 'done' ? 'Concluído' : 'Em Andamento'}</span>
                                </div>
                                <h2 className="text-xl font-bold text-gray-900 leading-tight mb-6">{task.text}</h2>
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="relative">
                                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Responsável</p>
                                        <button onClick={() => setIsSelectingResponsible(!isSelectingResponsible)} className="flex items-center gap-2 p-1.5 -ml-1.5 rounded-lg hover:bg-gray-100 transition-colors text-left group w-full">
                                            <Avatar member={responsible} size="w-8 h-8" showCrown={false}/>
                                            <div className="flex-1 min-w-0">
                                                <p className="text-xs font-bold text-gray-800 flex items-center gap-1 truncate">{responsible.name} <ChevronDown size={12}/></p>
                                                <p className="text-[10px] text-gray-500 truncate">{responsible.role}</p>
                                            </div>
                                        </button>
                                        {isSelectingResponsible && (<div className="absolute top-full left-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 z-50 p-2 max-h-48 overflow-y-auto"><div className="space-y-1">{members.map((member) => (<button key={member.id} onClick={() => { onAssignResponsible(task.id, member); setIsSelectingResponsible(false); }} className={`w-full flex items-center gap-3 p-2 rounded-lg hover:bg-blue-50 transition-colors text-left ${responsible.name === member.name ? 'bg-blue-50' : ''}`}><Avatar member={member} size="w-6 h-6" showCrown={false}/><span className="text-xs font-bold">{member.name}</span></button>))}</div></div>)}
                                    </div>
                                    <div className="relative">
                                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Apoio</p>
                                        <div className="flex flex-wrap gap-2">
                                            {supportList.map(member => (
                                                <div key={member.id} className="relative group cursor-pointer" onClick={() => removeSupport(member.id)}>
                                                    <Avatar member={member} size="w-8 h-8" showCrown={false}/>
                                                    <div className="absolute inset-0 bg-black/20 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <X size={12} className="text-white"/>
                                                    </div>
                                                </div>
                                            ))}
                                            <button onClick={() => setIsSelectingSupport(!isSelectingSupport)} className="w-8 h-8 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 hover:border-blue-400 hover:text-blue-500 transition-colors"><Plus size={14}/></button>
                                        </div>
                                        {isSelectingSupport && (<div className="absolute top-full left-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 z-50 p-2 max-h-48 overflow-y-auto"><div className="space-y-1">{members.map((member) => (<button key={member.id} onClick={() => addSupport(member)} className={`w-full flex items-center gap-3 p-2 rounded-lg hover:bg-blue-50 transition-colors text-left`}><Avatar member={member} size="w-6 h-6" showCrown={false}/><span className="text-xs font-bold">{member.name}</span></button>))}</div></div>)}
                                    </div>
                                    <div className="col-span-2">
                                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Custo Estimado</p>
                                        <div className="flex items-center gap-2 bg-white border border-gray-200 rounded-lg p-2 max-w-[200px]">
                                            <DollarSign size={14} className="text-gray-400"/>
                                            <input type="number" className="w-full text-sm font-bold text-gray-700 outline-none" placeholder="0,00" value={task.cost || ''} onChange={(e) => onUpdateTask(task.id, { cost: e.target.value })} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="p-4 bg-white border-b border-gray-100">
                                <h4 className="font-bold text-xs text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-2"><Layers size={14}/> Complementos</h4>
                                <div className="space-y-2 mb-3">
                                    {subtasks.map(sub => (
                                        <div key={sub.id} className="flex items-center gap-2 group">
                                            <button onClick={() => toggleSubtask(sub.id)} className={`w-4 h-4 rounded border flex items-center justify-center transition-colors ${sub.completed ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300 hover:border-blue-400'}`}>{sub.completed && <Check size={10}/>}</button>
                                            <span className={`text-sm flex-1 ${sub.completed ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{sub.text}</span>
                                            <button onClick={() => deleteSubtask(sub.id)} className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500"><X size={14}/></button>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <input value={newSubtask} onChange={(e) => setNewSubtask(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddSubtask()} placeholder="Adicionar complemento..." className="flex-1 text-xs p-2 bg-gray-50 rounded border border-gray-200 outline-none focus:border-blue-300" />
                                    <button onClick={handleAddSubtask} disabled={!newSubtask} className="p-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 disabled:opacity-50"><Plus size={14}/></button>
                                </div>
                            </div>

                            <div className="flex-1 flex flex-col bg-slate-100 overflow-hidden">
                                <div className="p-3 border-b bg-white/50 backdrop-blur-sm flex items-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-wider sticky top-0 z-10"><MessageSquare size={14}/> Comentários</div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-6" ref={chatContainerRef}>
                                    {messages.length === 0 ? <p className="text-xs text-center text-gray-400 mt-10">Nenhuma mensagem. Inicie a conversa!</p> : 
                                    messages.map((msg, i) => {
                                        const isMe = msg.senderId === selectedSender.id;
                                        const senderMember = members.find(m => m.id === msg.senderId) || { name: msg.sender, photoUrl: null };
                                        return (
                                            <div key={i} className={`flex gap-3 group/msg ${isMe ? 'flex-row-reverse' : ''}`}>
                                                <Avatar member={senderMember} size="w-8 h-8" showCrown={false} />
                                                <div className={`max-w-[75%] flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="text-[10px] font-bold text-gray-600">{senderMember.name}</span>
                                                        <span className="text-[9px] text-gray-400">{msg.time}</span>
                                                        <button onClick={() => setConfirmDeleteMessageId(i)} className="opacity-0 group-hover/msg:opacity-100 text-gray-400 hover:text-red-500 transition-opacity"><Trash2 size={10}/></button>
                                                    </div>
                                                    <div className={`p-3 rounded-2xl text-sm shadow-sm relative group ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-700 border border-gray-200 rounded-tl-none'}`}>
                                                        {msg.attachment && (<div className="mb-2 rounded-lg overflow-hidden cursor-pointer bg-black/5 hover:opacity-90 transition-opacity" onClick={() => setPreviewImage(msg.attachment)}><img src={msg.attachment} className="max-w-full h-32 object-cover" alt="Anexo" /></div>)}
                                                        <p className="whitespace-pre-wrap">{msg.text}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="p-3 bg-white border-t border-gray-200">
                                    {chatAttachment && (<div className="flex items-center gap-2 mb-2 p-2 bg-blue-50 rounded-lg border border-blue-100 text-xs text-blue-700"><ImageIcon size={14}/> Imagem anexada <button onClick={() => setChatAttachment(null)} className="ml-auto hover:text-red-500"><X size={14}/></button></div>)}
                                    <div className="flex flex-col gap-2">
                                        <div className="flex items-center gap-2 text-xs text-gray-500 px-1"><span>Falando como:</span><select className="bg-transparent font-bold text-blue-900 outline-none cursor-pointer hover:bg-gray-50 rounded p-1" value={selectedSender.id} onChange={(e) => setSelectedSender(members.find(m => m.id === e.target.value))}>{members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}</select></div>
                                        <div className="flex items-end gap-2 bg-gray-50 p-2 rounded-xl border border-gray-200 focus-within:ring-2 ring-blue-100 transition-all">
                                            <button onClick={() => chatFileRef.current?.click()} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Anexar imagem"><Paperclip size={18} /></button><input type="file" ref={chatFileRef} onChange={handleChatImageUpload} className="hidden" accept="image/*" />
                                            <textarea rows={1} placeholder="Escreva uma mensagem..." className="flex-1 text-sm p-2 bg-transparent outline-none text-gray-700 resize-none max-h-24" value={messageText} onChange={(e) => setMessageText(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }}} />
                                            <button onClick={handleSend} disabled={!messageText.trim() && !chatAttachment} className="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"><Send size={16} /></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="w-full md:w-80 bg-white border-l border-gray-100 flex flex-col h-full overflow-y-auto">
                            <div className="p-4 border-b border-gray-100">
                                <h4 className="font-bold text-sm text-gray-800 flex items-center gap-2 mb-4"><Paperclip size={16}/> Arquivos & Documentos</h4>
                                <div className="space-y-2 mb-4">
                                    {attachments.map(att => (<div key={att.id} className="flex items-center gap-3 p-2 rounded-lg border border-gray-100 bg-gray-50 hover:bg-blue-50 transition-colors group"><div className="w-8 h-8 rounded bg-white border border-gray-200 flex items-center justify-center text-blue-600"><FileText size={16}/></div><div className="flex-1 min-w-0"><p className="text-xs font-bold text-gray-700 truncate">{att.name}</p><p className="text-[10px] text-gray-400">{att.size}</p></div><button onClick={() => { if(window.confirm("Excluir este anexo?")) onDeleteAttachment(task.id, att.id); }} className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500"><X size={14}/></button></div>))}
                                    {attachments.length === 0 && <p className="text-xs text-gray-400 italic">Nenhum arquivo anexado.</p>}
                                </div>
                                <label className="flex items-center justify-center gap-2 w-full p-2 border border-dashed border-blue-300 rounded-lg text-xs font-bold text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors"><Plus size={14}/> Adicionar Arquivo<input type="file" className="hidden" onChange={(e) => { const file = e.target.files[0]; if(file) onAddAttachment(task.id, { id: Date.now(), name: file.name, size: (file.size/1024).toFixed(1)+'KB' }); }}/></label>
                            </div>
                        </div>
                    </div>
                    <ImagePreviewModal isOpen={!!previewImage} onClose={() => setPreviewImage(null)} imageUrl={previewImage} />
                    <ConfirmModal isOpen={confirmDeleteMessageId !== null} onClose={() => setConfirmDeleteMessageId(null)} onConfirm={() => onDeleteMessage(task.id, confirmDeleteMessageId)} title="Excluir Comentário" message="Tem certeza que deseja excluir este comentário?" />
                </Modal>
            );
        };

        // --- Configurações de Categoria Modal ---
        const ManageCategoriesModal = ({ isOpen, onClose, categories, onAdd, onUpdate, onDelete }) => {
            const [editingId, setEditingId] = useState(null);
            const [formData, setFormData] = useState({ title: '', icon: 'box', color: 'blue' });
            const [confirmDeleteId, setConfirmDeleteId] = useState(null);

            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (!formData.title) return; 
                if (editingId) { onUpdate({ id: editingId, ...formData }); setEditingId(null); } 
                else { onAdd({ ...formData, id: Date.now().toString() }); } 
                setFormData({ title: '', icon: 'box', color: 'blue' }); 
            };
            const handleEdit = (cat) => { setEditingId(cat.id); setFormData({ title: cat.title, icon: cat.icon || 'box', color: cat.color || 'blue' }); };
            
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Gerenciar Categorias">
                    <div className="p-6 space-y-6">
                        <form onSubmit={handleSubmit} className="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4">
                            <div className="flex items-center justify-between"><h4 className="text-sm font-bold text-gray-700">{editingId ? 'Editar Categoria' : 'Nova Categoria'}</h4></div>
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nome</label><input value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-2 border rounded-lg outline-none focus:border-blue-500"/></div>
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Ícone</label><div className="flex flex-wrap gap-2">{Object.keys(ICON_MAP).map(icon => { const Icon = ICON_MAP[icon]; return (<button key={icon} type="button" onClick={() => setFormData({...formData, icon})} className={`p-2 rounded-lg border ${formData.icon === icon ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-gray-200 text-gray-500'}`}><Icon size={16}/></button>); })}</div></div>
                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Cor Pastel</label><div className="flex flex-wrap gap-2">{PASTEL_COLORS.map(color => (<button key={color.id} type="button" onClick={() => setFormData({...formData, color: color.id})} className={`w-8 h-8 rounded-full border-2 ${formData.color === color.id ? 'border-gray-600 scale-110' : 'border-transparent'}`} style={{backgroundColor: color.hex}}></button>))}</div></div>
                            <button type="submit" className="w-full bg-blue-900 text-white py-2 rounded-lg font-bold">{editingId ? 'Salvar' : 'Adicionar'}</button>
                            {editingId && <button type="button" onClick={() => { setEditingId(null); setFormData({ title: '', icon: 'box', color: 'blue' }); }} className="w-full text-gray-500 text-xs underline mt-2">Cancelar Edição</button>}
                        </form>
                        <div className="space-y-2 max-h-60 overflow-y-auto">{categories.map(cat => {
                            const catColor = PASTEL_COLORS.find(c => c.id === cat.color) || PASTEL_COLORS[0];
                            return (
                                <div key={cat.id} className="flex items-center justify-between p-3 bg-white border rounded-lg">
                                    <div className="flex items-center gap-2"><div className={`p-1.5 rounded-lg ${catColor.bg} ${catColor.text}`}>{getCategoryIcon(cat.icon)}</div><span className="font-medium text-gray-700">{cat.title}</span></div>
                                    <div className="flex gap-1"><button onClick={() => handleEdit(cat)} className="p-2 text-blue-600"><Edit2 size={16}/></button><button onClick={() => setConfirmDeleteId(cat.id)} className="p-2 text-red-600"><Trash2 size={16}/></button></div>
                                </div>
                            );
                        })}</div>
                    </div>
                    <ConfirmModal isOpen={!!confirmDeleteId} onClose={() => setConfirmDeleteId(null)} onConfirm={() => onDelete(confirmDeleteId)} title="Excluir Categoria" message="Tem certeza? Isso pode afetar tarefas existentes." />
                </Modal>
            );
        };

        // --- Configurações Modal (COMPLETO) ---
        const SettingsModal = ({ isOpen, onClose, members, logo, setLogo, onUpdateLogo, onAddMember, onUpdateMember, onDeleteMember }) => {
            const [newMemberName, setNewMemberName] = useState('');
            const [newMemberRole, setNewMemberRole] = useState('');
            const fileInputRef = useRef(null);
            const memberPhotoInputRef = useRef(null);
            const editPhotoInputRef = useRef(null);
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editRole, setEditRole] = useState('');
            const [editPhoto, setEditPhoto] = useState(null);
            const [newMemberPhoto, setNewMemberPhoto] = useState(null);
            const [confirmDeleteMemberId, setConfirmDeleteMemberId] = useState(null);
            
            const handleLogoUpload = (e) => { const file = e.target.files[0]; if(file) compressImage(file, 200).then(onUpdateLogo); };
            const handleMemberPhotoUpload = (e) => { const file = e.target.files[0]; if(file) compressImage(file, 100).then(setNewMemberPhoto); };
            const handleEditPhotoUpload = (e) => { const file = e.target.files[0]; if(file) compressImage(file, 100).then(setEditPhoto); };
            
            const handleAdd = (e) => { e.preventDefault(); if (!newMemberName || !newMemberRole) return; onAddMember({ name: newMemberName, role: newMemberRole, photoUrl: newMemberPhoto }); setNewMemberName(''); setNewMemberRole(''); setNewMemberPhoto(null); };
            const startEdit = (member) => { setEditingId(member.id); setEditName(member.name); setEditRole(member.role); setEditPhoto(member.photoUrl || null); };
            const saveEdit = (id) => { onUpdateMember({ id, name: editName, role: editRole, photoUrl: editPhoto }); setEditingId(null); };

            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Configurações" maxWidth="max-w-2xl">
                    <div className="p-6 space-y-8">
                        <section>
                            <h4 className="text-blue-900 font-bold flex items-center gap-2 mb-4"><ImageIcon size={18} /> Identidade</h4>
                            <div className="bg-white border border-gray-200 rounded-xl p-6 flex flex-col md:flex-row items-center gap-6">
                                <div className="h-16 flex items-center justify-center px-4 bg-gray-50 rounded-lg border border-gray-100 min-w-[150px]">{logo ? <img src={logo} className="h-10 w-auto object-contain" /> : <span className="text-sm text-gray-400">Sem Logo</span>}</div>
                                <div className="flex-1"><p className="font-bold text-gray-800 text-sm mb-1">Carregar logo</p><div className="flex gap-2"><button onClick={() => fileInputRef.current?.click()} className="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 bg-white">Escolher arquivo</button><input type="file" ref={fileInputRef} onChange={handleLogoUpload} className="hidden" accept="image/*" /></div></div>
                            </div>
                        </section>
                        <section>
                            <h4 className="text-blue-900 font-bold flex items-center gap-2 mb-4"><Users size={18} /> Equipe Global</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                {members.map((member) => (
                                    <div key={member.id} className="flex items-center justify-between p-3 border border-gray-200 rounded-xl hover:shadow-sm transition-shadow">
                                        <div className="flex items-center gap-3 w-full">
                                            {editingId === member.id ? (<div className="relative group cursor-pointer" onClick={() => editPhotoInputRef.current?.click()}><div className="w-10 h-10 rounded-full bg-gray-100 border border-gray-200 flex items-center justify-center overflow-hidden">{editPhoto ? <img src={editPhoto} className="w-full h-full object-cover"/> : <Camera size={16} className="text-gray-400"/>}</div><input type="file" ref={editPhotoInputRef} onChange={handleEditPhotoUpload} className="hidden" accept="image/*" /></div>) : (<Avatar member={member} />)}
                                            <div className="flex-1 min-w-0">{editingId === member.id ? (<div className="flex flex-col gap-1"><input value={editName} onChange={e=>setEditName(e.target.value)} className="text-sm border rounded px-1 w-full" placeholder="Nome" /><input value={editRole} onChange={e=>setEditRole(e.target.value)} className="text-xs border rounded px-1 w-full" placeholder="Cargo" /></div>) : (<><p className="font-bold text-gray-800 text-sm truncate">{member.name}</p><p className="text-xs text-gray-500 truncate">{member.role}</p></>)}</div>
                                        </div>
                                        <div className="flex gap-1 ml-2">{editingId === member.id ? (<button onClick={() => saveEdit(member.id)} className="p-2 text-green-600 hover:bg-green-50 rounded-lg"><Check size={16}/></button>) : (<button onClick={() => startEdit(member)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg"><Edit2 size={16}/></button>)}<button onClick={() => setConfirmDeleteMemberId(member.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg"><Trash2 size={16}/></button></div>
                                    </div>
                                ))}
                            </div>
                            <div className="border border-gray-200 rounded-xl p-4 bg-gray-50">
                                <h5 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"><UserPlus size={16}/> Novo Membro</h5>
                                <form onSubmit={handleAdd} className="flex flex-col gap-3">
                                    <div className="flex gap-3"><input placeholder="Nome" value={newMemberName} onChange={e => setNewMemberName(e.target.value)} className="flex-1 p-2 border border-gray-300 rounded-lg outline-none focus:border-blue-500"/><input placeholder="Cargo" value={newMemberRole} onChange={e => setNewMemberRole(e.target.value)} className="flex-1 p-2 border border-gray-300 rounded-lg outline-none focus:border-blue-500"/></div>
                                    <div className="flex items-center gap-2"><button type="button" onClick={() => memberPhotoInputRef.current?.click()} className="text-xs flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"><Camera size={14}/> {newMemberPhoto ? 'Foto Selecionada' : 'Carregar Foto'}</button><input type="file" ref={memberPhotoInputRef} onChange={handleMemberPhotoUpload} className="hidden" accept="image/*" />{newMemberPhoto && <img src={newMemberPhoto} className="w-8 h-8 rounded-full object-cover border" />}</div>
                                    <button type="submit" disabled={!newMemberName} className="bg-blue-900 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-800 disabled:opacity-50 mt-2">Adicionar Membro</button>
                                </form>
                            </div>
                        </section>
                    </div>
                    <ConfirmModal isOpen={!!confirmDeleteMemberId} onClose={() => setConfirmDeleteMemberId(null)} onConfirm={() => onDeleteMember(confirmDeleteMemberId)} title="Excluir Membro" message="Tem certeza que deseja excluir este membro da equipe?" />
                </Modal>
            );
        };

        // --- AI Assistant Component ---
        const AIAssistant = ({ isOpen, onClose, members, events, tasks }) => {
            const [input, setInput] = useState("");
            const [messages, setMessages] = useState([{ id: 1, sender: 'ai', text: "Olá! Sou sua Assistente de Marketing. Como posso ajudar com o evento hoje?" }]);
            const messagesEndRef = useRef(null);
            
            const handleSend = (e) => {
                e.preventDefault();
                if (!input.trim()) return;
                setMessages([...messages, { id: Date.now(), sender: 'user', text: input }, { id: Date.now()+1, sender: 'ai', text: "Entendido! Estou processando sua solicitação..." }]);
                setInput("");
            };

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            if (!isOpen) return null;
            return (
                <div className="fixed bottom-24 right-6 w-80 md:w-96 h-[500px] bg-white rounded-2xl shadow-2xl border border-gray-200 z-[150] flex flex-col overflow-hidden animate-in">
                    <div className="bg-blue-900 p-4 text-white flex justify-between items-center"><div className="flex items-center gap-2"><Bot size={20}/> <span className="font-bold text-sm">Assistente IA</span></div><button onClick={onClose}><X size={16}/></button></div>
                    <div className="flex-1 bg-gray-50 p-4 overflow-y-auto space-y-3">
                        {messages.map(m => (<div key={m.id} className={`p-3 rounded-xl text-sm ${m.sender === 'user' ? 'bg-blue-100 ml-auto max-w-[80%]' : 'bg-white border mr-auto max-w-[80%]'}`}>{m.text}</div>))}
                        <div ref={messagesEndRef} />
                    </div>
                    <form onSubmit={handleSend} className="p-3 bg-white border-t"><input className="w-full bg-gray-100 p-2 rounded-lg text-sm outline-none" placeholder="Digite..." value={input} onChange={e=>setInput(e.target.value)}/></form>
                </div>
            );
        };

        // --- Dashboard View ---
        const DashboardView = ({ onSelectEvent, events, members, updates, onDeleteUpdate, onNewEvent }) => {
            const [confirmDeleteId, setConfirmDeleteId] = useState(null);
            return (
                <div className="max-w-[1600px] mx-auto grid grid-cols-1 xl:grid-cols-4 gap-8 animate-in slide-in-from-right-4 duration-500">
                    <div className="xl:col-span-3 space-y-8">
                        <section className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="bg-white rounded-[2rem] p-8 shadow-sm border border-gray-100 flex items-center justify-between">
                                <div className="relative w-32 h-32 flex-shrink-0"><svg className="w-full h-full transform -rotate-90"><circle cx="64" cy="64" r="56" stroke="#F3F4F6" strokeWidth="12" fill="transparent" /><circle cx="64" cy="64" r="56" stroke="#002060" strokeWidth="12" fill="transparent" strokeDasharray="351.86" strokeDashoffset="351.86" strokeLinecap="round" /></svg><div className="absolute inset-0 flex flex-col items-center justify-center text-gray-800"><span className="text-3xl font-extrabold text-[#002060]">0%</span></div></div>
                                <div className="flex-1 ml-8"><h3 className="text-lg font-bold text-gray-900 mb-4">Status Global</h3><div className="flex items-center gap-6 text-sm font-semibold"><span className="text-emerald-600 flex items-center gap-2"><div className="w-2.5 h-2.5 rounded-full bg-emerald-500"></div> 0 Feitas</span><span className="text-amber-600 flex items-center gap-2"><div className="w-2.5 h-2.5 rounded-full bg-amber-500"></div> 176 Pend.</span></div></div>
                            </div>
                            <div className="bg-white rounded-[2rem] p-8 shadow-sm border border-gray-100 flex flex-col justify-center"><h3 className="text-sm font-bold text-gray-900 mb-6 flex items-center gap-2"><Users size={18} /> Carga de Trabalho</h3><div className="flex items-end gap-6 overflow-x-auto pb-2 hide-scrollbar">{members.map(m => (<div key={m.id} className="flex flex-col items-center gap-2 min-w-[50px]"><div className="w-10 h-1 bg-gray-100 rounded-full overflow-hidden mb-1"><div className="h-full bg-blue-600 rounded-full" style={{width: '60%'}}></div></div><Avatar member={m}/><span className="text-xs font-bold text-blue-600">3</span></div>))}</div></div>
                        </section>
                        <section>
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-lg font-bold text-blue-900 flex items-center gap-2"><Clock size={20} /> Próximos Eventos</h2>
                                <button onClick={onNewEvent} className="bg-blue-900 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg hover:bg-blue-800 transition-colors"><Plus size={16}/> Novo Evento</button>
                            </div>
                            <div className="space-y-4">{events.map(event => (
                                <div key={event.id} onClick={() => onSelectEvent(event)} className="bg-white rounded-[1.5rem] p-6 border border-gray-100 shadow-sm hover:shadow-md transition-all cursor-pointer group flex flex-col md:flex-row items-center gap-6 relative overflow-hidden">
                                    {event.coverUrl && (
                                        <div className="absolute inset-0 z-0">
                                            <img src={event.coverUrl} className="w-full h-full object-cover opacity-10 group-hover:opacity-20 transition-opacity"/>
                                            <div className="absolute inset-0 bg-gradient-to-r from-white via-white/80 to-transparent"></div>
                                        </div>
                                    )}
                                    <div className="flex-shrink-0 w-20 h-20 bg-gray-50 rounded-2xl flex flex-col items-center justify-center border border-gray-100 group-hover:bg-blue-50 transition-colors z-10 relative"><span className="text-[10px] font-bold text-gray-500 uppercase">DEZ</span><span className="text-3xl font-extrabold text-gray-800">02</span></div>
                                    <div className="flex-1 z-10 relative"><h3 className="text-xl font-bold text-blue-700 group-hover:text-blue-900">{event.title}</h3><p className="text-sm text-gray-500 mt-1 flex items-center gap-2"><Truck size={14}/> {event.location}</p></div>
                                </div>
                            ))}</div>
                        </section>
                    </div>
                    <div className="xl:col-span-1">
                        <section className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 h-full">
                            <h2 className="text-lg font-bold text-blue-900 mb-6 flex items-center gap-2"><MessageSquare size={20} /> Atualizações</h2>
                            <div className="space-y-6 relative before:absolute before:left-4 before:top-2 before:bottom-2 before:w-px before:bg-gray-100">
                                {updates.map((u, i) => (
                                    <div key={u.id} className="relative pl-10 group">
                                        <div className="absolute left-0 top-0 w-8 h-8 rounded-full border-2 border-white shadow-sm z-10 bg-gray-200"><Avatar member={members.find(m => m.name.includes(u.user))}/></div>
                                        <div className="flex flex-col gap-1">
                                            <div className="flex justify-between items-start"><p className="text-xs text-gray-500"><span className="font-bold text-gray-800">{u.user}</span> <span className="text-gray-400">{u.date}</span></p><button onClick={(e) => { e.stopPropagation(); setConfirmDeleteId(u.id); }} className="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-opacity"><Trash2 size={12}/></button></div>
                                            <div className="p-3 bg-gray-50 rounded-xl rounded-tl-none text-xs text-gray-600 border border-gray-100">{u.text}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    </div>
                    <ConfirmModal isOpen={!!confirmDeleteId} onClose={() => setConfirmDeleteId(null)} onConfirm={() => onDeleteUpdate(confirmDeleteId)} title="Excluir Atualização" message="Tem certeza que deseja excluir?" />
                </div>
            );
        };

        // --- Event Detail View (PRINCIPAL) ---
        const EventDetailView = ({ event, onBack, globalMembers, onShowToast }) => {
            const [tasks, setTasks] = useState([]);
            const [viewMode, setViewMode] = useState('categories');
            const [searchQuery, setSearchQuery] = useState('');
            
            const [selectedTaskId, setSelectedTaskId] = useState(null);
            const selectedTask = tasks.find(t => t.id === selectedTaskId);

            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            
            const [eventTeam, setEventTeam] = useState([]);
            
            useEffect(() => {
                if (event && event.teamIds) {
                    const teamMembers = globalMembers.filter(m => event.teamIds.includes(m.id));
                    setEventTeam(teamMembers.length > 0 ? teamMembers : globalMembers);
                } else {
                    setEventTeam(globalMembers);
                }
            }, [event, globalMembers]);

            const [draggedTask, setDraggedTask] = useState(null);
            const [dragOverColumn, setDragOverColumn] = useState(null);
            const [totalCost, setTotalCost] = useState(0);
            
            const [isManageCategoriesOpen, setIsManageCategoriesOpen] = useState(false);
            const [isAddTaskOpen, setIsAddTaskOpen] = useState(false);
            const [confirmDeleteTaskId, setConfirmDeleteTaskId] = useState(null);
            const [isAddMemberOpen, setIsAddMemberOpen] = useState(false);
            const [isTeamExpanded, setIsTeamExpanded] = useState(true);
            const [memberToRemove, setMemberToRemove] = useState(null);

            // Agenda State
            const [isAgendaExpanded, setIsAgendaExpanded] = useState(true);
            const [isAgendaModalOpen, setIsAgendaModalOpen] = useState(false);
            const [currentCalendarDate, setCurrentCalendarDate] = useState(new Date());
            const [agendaItems, setAgendaItems] = useState([
                { id: 1, date: new Date(2026, 1, 2), title: "Início do Evento", color: "blue", description: "Abertura oficial no Auditório principal." },
                { id: 2, date: new Date(2026, 1, 4), title: "Reunião de Alinhamento", color: "purple", description: "Reunião com fornecedores de buffet." }
            ]);
            const [newAgendaItem, setNewAgendaItem] = useState({ date: '', title: '', color: 'blue', description: '' });

            useEffect(() => {
                const saved = localStorage.getItem(`tasks_${event.id}`);
                if (saved) {
                    setTasks(JSON.parse(saved));
                } else if (event.initialTasks && event.initialTasks.length > 0) {
                    const newTasks = event.initialTasks.map((t, i) => ({
                        id: Date.now().toString() + i,
                        text: t.text, // Access .text property
                        category: t.category || 'planning', // Access .category property or default
                        status: 'todo',
                        priority: 'medium',
                        responsible: eventTeam[0] || globalMembers[0],
                        messages: [],
                        subtasks: []
                    }));
                    setTasks(newTasks);
                } else {
                    setTasks([
                        { id: '1', text: 'Definir orçamento', category: 'planning', status: 'done', priority: 'high', responsible: globalMembers[0], cost: 5000, messages: [], subtasks: [] },
                        { id: '2', text: 'Contratar buffet', category: 'logistics', status: 'in_progress', priority: 'medium', responsible: globalMembers[1], cost: 12000, messages: [], subtasks: [] }
                    ]);
                }
            }, [event]);

            useEffect(() => { 
                localStorage.setItem(`tasks_${event.id}`, JSON.stringify(tasks)); 
                const total = tasks.reduce((acc, t) => acc + (parseFloat(t.cost) || 0), 0);
                setTotalCost(total);
            }, [tasks, event.id]);

            // Drag & Drop
            const handleTaskDragStart = (e, task) => { setDraggedTask(task); };
            const handleDragOver = (e, colId) => { e.preventDefault(); setDragOverColumn(colId); };
            const handleDrop = (e, targetId) => {
                e.preventDefault();
                if (!draggedTask) return;
                if (viewMode === 'categories') {
                    if (draggedTask.category !== targetId) setTasks(tasks.map(t => t.id === draggedTask.id ? { ...t, category: targetId } : t));
                } else {
                    if (draggedTask.status !== targetId) {
                        const newStatus = targetId === 'done' ? 'done' : targetId === 'todo' ? 'todo' : targetId === 'in_progress' ? 'in_progress' : targetId;
                        setTasks(tasks.map(t => t.id === draggedTask.id ? { ...t, status: newStatus } : t));
                    }
                }
                setDraggedTask(null); setDragOverColumn(null);
            };

            const getMemberStats = (memberId) => {
                const memberTasks = tasks.filter(t => t.responsible?.id === memberId);
                const pending = memberTasks.filter(t => t.status !== 'done').length;
                const done = memberTasks.filter(t => t.status === 'done').length;
                return { pending, done, total: memberTasks.length };
            };

            // Task Actions
            const handleUpdateTask = (taskId, updates) => setTasks(tasks.map(t => t.id === taskId ? { ...t, ...updates } : t));
            const handleSendMessage = (taskId, text, senderMember, attachment) => {
                setTasks(tasks.map(t => t.id === taskId ? { ...t, messages: [...(t.messages||[]), { sender: senderMember.name, senderId: senderMember.id, text, attachment, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }] } : t));
            };
            const onDeleteMessage = (taskId, msgIndex) => { setTasks(tasks.map(t => t.id === taskId ? { ...t, messages: t.messages.filter((_, i) => i !== msgIndex) } : t)); };
            const deleteTask = (taskId) => { setTasks(tasks.filter(t => t.id !== taskId)); };

            // Team Actions
            const addTeamMember = (member) => { 
                if(!eventTeam.find(m=>m.id === member.id)) { 
                    setEventTeam([...eventTeam, member]); 
                    onShowToast(`Membro adicionado: ${member.name}`); 
                } 
                setIsAddMemberOpen(false); 
            };
            
            const handleRemoveMemberClick = (memberId) => {
                setMemberToRemove(memberId);
            };

            const confirmRemoveMember = () => {
                if (memberToRemove) {
                    setEventTeam(prev => prev.filter(m => m.id !== memberToRemove));
                    setMemberToRemove(null);
                    onShowToast("Membro removido.");
                }
            };

            // Agenda Actions
            const handleAddAgendaItem = () => {
                if(!newAgendaItem.title || !newAgendaItem.date) return;
                const dateParts = newAgendaItem.date.split('-');
                const dateObj = new Date(dateParts[0], dateParts[1]-1, dateParts[2]);
                setAgendaItems([...agendaItems, { id: Date.now(), ...newAgendaItem, date: dateObj }]);
                setNewAgendaItem({ date: '', title: '', color: 'blue', description: '' });
                onShowToast("Novo item na agenda!");
            };

            const changeMonth = (offset) => {
                const newDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + offset, 1);
                setCurrentCalendarDate(newDate);
            };

            const columns = viewMode === 'categories' ? categories : STATUS_COLUMNS;

            // Calendar Render Helper
            const renderCalendar = (date = new Date(), isSmall = false) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const days = [];

                // Empty slots
                for(let i=0; i<firstDay; i++) days.push(<div key={`empty-${i}`} className="h-8"></div>);

                for(let i=1; i<=daysInMonth; i++) {
                    const currentDay = new Date(year, month, i);
                    const items = agendaItems.filter(a => a.date.getDate() === i && a.date.getMonth() === month && a.date.getFullYear() === year);
                    
                    if (isSmall) {
                        const hasEvent = items.length > 0;
                        const pastel = hasEvent ? PASTEL_COLORS.find(c => c.id === items[0].color) : null;
                        days.push(
                            <div key={i} className={`h-6 w-6 text-[10px] flex items-center justify-center rounded-full relative mx-auto ${hasEvent ? 'font-bold' : 'text-gray-500'}`} style={{ backgroundColor: pastel ? pastel.hex : 'transparent', color: pastel ? pastel.text : undefined }}>
                                {i}
                            </div>
                        );
                    } else {
                        days.push(
                            <div key={i} className="h-24 border border-gray-100 p-2 relative bg-white hover:bg-blue-50 transition-colors cursor-pointer group">
                                <span className={`text-sm font-bold ${items.length > 0 ? 'text-blue-600' : 'text-gray-400'}`}>{i}</span>
                                <div className="mt-1 space-y-1 overflow-hidden max-h-16">
                                    {items.map(item => {
                                        const pastel = PASTEL_COLORS.find(c => c.id === item.color);
                                        return (
                                            <div key={item.id} className={`text-[9px] px-1 py-0.5 rounded truncate ${pastel ? pastel.bg : 'bg-gray-100'} ${pastel ? pastel.text : 'text-gray-600'}`}>
                                                {item.title}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        );
                    }
                }
                return <div className={`grid grid-cols-7 ${isSmall ? 'gap-1' : 'gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden'}`}>{days}</div>;
            };

            // Filter tasks based on search
            const filteredTasks = tasks.filter(t => {
                const query = searchQuery.toLowerCase();
                const matchesText = t.text.toLowerCase().includes(query);
                const matchesSubtasks = t.subtasks && t.subtasks.some(st => st.text.toLowerCase().includes(query));
                return matchesText || matchesSubtasks;
            });

            return (
                <div className="pb-20 animate-in slide-in-from-right-4 duration-500">
                    {/* Header do Evento */}
                    <div className="bg-white p-8 rounded-3xl border border-gray-100 shadow-sm mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-6 relative overflow-hidden">
                        {event.coverUrl && (
                            <div className="absolute inset-0 z-0">
                                <img src={event.coverUrl} className="w-full h-full object-cover opacity-20"/>
                                <div className="absolute inset-0 bg-gradient-to-r from-white via-white/90 to-transparent"></div>
                            </div>
                        )}
                        <div className="flex items-center gap-6 z-10 relative">
                            <button onClick={onBack} className="p-3 bg-white/80 border border-gray-200 rounded-xl hover:bg-white transition-colors backdrop-blur-sm"><ArrowLeft size={24}/></button>
                            <div>
                                <h1 className="text-3xl font-extrabold text-gray-900 mb-1">{event.title}</h1>
                                <p className="text-gray-500 flex items-center gap-3 text-sm font-medium">
                                    <span className="flex items-center gap-1"><Truck size={16}/> {event.location}</span>
                                    <span className="h-4 w-px bg-gray-300"></span>
                                    <span className="flex items-center gap-1"><CalendarIcon size={16}/> {event.dateRange}</span>
                                </p>
                            </div>
                        </div>
                        <div className="flex flex-col items-end z-10 relative">
                            <span className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Custo Total Acumulado</span>
                            <div className="text-3xl font-extrabold text-emerald-600 flex items-center gap-2">{formatCurrency(totalCost)}</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-8 h-full">
                        {/* Sidebar Equipe & Agenda */}
                        <div className="lg:col-span-1 space-y-6">
                            {/* Status da Equipe */}
                            <section className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 transition-all duration-300">
                                <div className="flex items-center justify-between mb-2">
                                    <h2 className="text-base font-bold flex items-center gap-2 text-gray-800"><Users size={18} className="text-blue-900"/> Equipe do Evento</h2>
                                    <div className="flex gap-1">
                                        <button onClick={() => setIsAddMemberOpen(true)} className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Plus size={16}/></button>
                                        <button onClick={() => setIsTeamExpanded(!isTeamExpanded)} className="p-1 text-gray-400 hover:bg-gray-50 rounded">{isTeamExpanded ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}</button>
                                    </div>
                                </div>
                                {isTeamExpanded && (
                                    <div className="space-y-4 mt-4 animate-in">
                                        {eventTeam.map(member => {
                                            const stats = getMemberStats(member.id);
                                            return (
                                                <div key={member.id} className="flex flex-col gap-2 p-3 bg-gray-50 rounded-xl border border-gray-100 group relative">
                                                    <button onClick={(e) => { e.stopPropagation(); handleRemoveMemberClick(member.id); }} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 transition-opacity z-10"><X size={14}/></button>
                                                    <div className="flex items-center gap-3">
                                                        <Avatar member={member} size="w-8 h-8" showCrown={false}/>
                                                        <div className="flex-1 min-w-0"><p className="font-bold text-xs text-gray-900 truncate">{member.name}</p><p className="text-[10px] text-gray-500 truncate">{member.role}</p></div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2 mt-1">
                                                        <div className="bg-amber-100 text-amber-800 rounded-lg p-1.5 text-center"><span className="block text-xs font-bold">{stats.pending}</span><span className="block text-[8px] uppercase font-bold opacity-60">Pendentes</span></div>
                                                        <div className="bg-emerald-100 text-emerald-800 rounded-lg p-1.5 text-center"><span className="block text-xs font-bold">{stats.done}</span><span className="block text-[8px] uppercase font-bold opacity-60">Feitas</span></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </section>

                            {/* Agenda Restaurada e Ampliável */}
                            <section className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 group hover:shadow-md transition-all">
                                <div className="flex items-center justify-between mb-4 cursor-pointer" onClick={() => setIsAgendaModalOpen(true)}>
                                    <h2 className="text-base font-bold flex items-center gap-2 text-gray-800"><CalendarIcon size={18} className="text-blue-900"/> Agenda</h2>
                                    <Maximize2 size={14} className="text-gray-400 group-hover:text-blue-600"/>
                                </div>
                                <div className="bg-gray-50 rounded-xl p-3 border border-gray-100 cursor-pointer hover:border-blue-200 transition-colors" onClick={() => setIsAgendaModalOpen(true)}>
                                    {renderCalendar(new Date(), true)}
                                </div>
                                <div className="mt-4 space-y-2">
                                    {agendaItems.slice(0, 3).map(item => {
                                        const pastel = PASTEL_COLORS.find(c => c.id === item.color);
                                        return (
                                            <div key={item.id} className="flex items-center gap-3 text-xs">
                                                <div className={`w-2 h-2 rounded-full ${pastel ? pastel.bg.replace('bg-', 'bg-') : 'bg-gray-300'}`}></div>
                                                <span className="text-gray-600 truncate flex-1">{item.title}</span>
                                                <span className="text-gray-400">{item.date.getDate()}/{item.date.getMonth()+1}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </section>
                        </div>

                        {/* Kanban Board */}
                        <div className="lg:col-span-3">
                            <div className="flex justify-between items-center mb-6">
                                <div className="flex items-center gap-2 flex-1 max-w-md bg-white border border-gray-200 rounded-lg px-3 py-2 shadow-sm focus-within:ring-2 ring-blue-100 transition-all">
                                    <Search size={18} className="text-gray-400"/>
                                    <input 
                                        type="text" 
                                        placeholder="Pesquisar tarefas ou complementos..." 
                                        className="bg-transparent outline-none text-sm w-full text-gray-700 placeholder-gray-400"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                    />
                                </div>
                                <div className="flex items-center gap-2 bg-gray-100 p-1 rounded-lg ml-4">
                                    <button onClick={() => setViewMode('categories')} className={`px-3 py-1.5 text-xs font-bold rounded-md ${viewMode === 'categories' ? 'bg-white text-blue-900 shadow-sm' : 'text-gray-500'}`}>Categorias</button>
                                    <button onClick={() => setViewMode('status')} className={`px-3 py-1.5 text-xs font-bold rounded-md ${viewMode === 'status' ? 'bg-white text-blue-900 shadow-sm' : 'text-gray-500'}`}>Status</button>
                                </div>
                                <div className="flex gap-2 ml-4">
                                    <button onClick={() => setIsManageCategoriesOpen(true)} className="p-2 border rounded-lg text-gray-500 hover:text-blue-900 bg-white hover:bg-gray-50"><Settings size={18}/></button>
                                    <button onClick={() => setIsAddTaskOpen(true)} className="bg-blue-900 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2"><Plus size={16}/> Nova Tarefa</button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 items-start pb-20">
                                {columns.map(col => {
                                    const colTasks = filteredTasks.filter(t => viewMode === 'categories' ? t.category === col.id : (col.id === 'done' ? t.status === 'done' : (!['done'].includes(t.status) && (col.id === 'todo' ? t.status === 'todo' || !t.status : t.status === col.id))));
                                    const style = getCategoryStyles(col.color);
                                    
                                    return (
                                        <div key={col.id} onDragOver={(e) => handleDragOver(e, col.id)} onDrop={(e) => handleDrop(e, col.id)} className={`bg-gray-50 rounded-xl p-3 border border-gray-200 flex flex-col min-h-[300px] transition-colors ${dragOverColumn === col.id ? 'drag-over' : ''}`}>
                                            <div className={`flex items-center gap-2 p-2 rounded-lg mb-3 border bg-white shadow-sm ${style}`}>
                                                <div className={`p-1 rounded ${style.split(' ')[1]}`}>
                                                    {viewMode === 'categories' ? getCategoryIcon(col.icon) : (col.id === 'todo' ? <ClipboardList size={16}/> : col.id === 'in_progress' ? <Truck size={16}/> : col.id === 'review' ? <Search size={16}/> : <CheckSquare size={16}/>)}
                                                </div>
                                                <span className="text-xs font-bold text-gray-700">{col.title}</span>
                                                <span className="ml-auto bg-gray-100 text-gray-600 text-[10px] px-2 rounded-full">{colTasks.length}</span>
                                            </div>
                                            <div className="space-y-2">
                                                {colTasks.map(task => {
                                                     const cat = categories.find(c => c.id === task.category) || categories[0];
                                                     const catPastel = PASTEL_COLORS.find(c => c.id === cat.color);
                                                     const borderColor = catPastel ? catPastel.hex : '#cbd5e1';

                                                     return (
                                                        <div key={task.id} draggable onDragStart={(e) => handleTaskDragStart(e, task)} onClick={() => setSelectedTaskId(task.id)} className={`bg-white p-3 rounded-lg border shadow-sm cursor-grab hover:shadow-md transition-all group relative border-l-4 ${task.status === 'done' ? 'border-l-emerald-400 opacity-75' : 'hover:border-blue-300'}`} style={{ borderLeftColor: task.status === 'done' ? undefined : borderColor }}>
                                                            <button onClick={(e) => { e.stopPropagation(); setConfirmDeleteTaskId(task.id); }} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-opacity z-10"><Trash2 size={12}/></button>
                                                            <p className={`text-xs font-medium leading-tight mb-3 ${task.status === 'done' ? 'line-through text-gray-400' : 'text-gray-700'}`}>{task.text}</p>
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center gap-2">
                                                                    <Avatar member={task.responsible} size="w-5 h-5" textSize="text-[8px]" showCrown={false}/>
                                                                    {task.cost > 0 && <span className="text-[9px] font-bold text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">{formatCurrency(task.cost)}</span>}
                                                                </div>
                                                                <PriorityBadge level={task.priority} />
                                                            </div>
                                                        </div>
                                                     );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                    
                    <TaskDetailModal 
                        task={selectedTask} 
                        isOpen={!!selectedTaskId} 
                        onClose={() => setSelectedTaskId(null)} 
                        members={eventTeam} 
                        onSendMessage={handleSendMessage} 
                        onAssignResponsible={(tid, m) => handleUpdateTask(tid, { responsible: m })}
                        onAddSupport={(tid, m) => handleUpdateTask(tid, { support: [...(selectedTask.support||[]), m] })}
                        onAddAttachment={(tid, att) => handleUpdateTask(tid, { attachments: [...(selectedTask.attachments||[]), att] })}
                        onDeleteAttachment={(tid, aid) => handleUpdateTask(tid, { attachments: selectedTask.attachments.filter(a => a.id !== aid) })}
                        onUpdateTask={handleUpdateTask}
                        onDeleteMessage={onDeleteMessage}
                    />

                    <ManageCategoriesModal 
                        isOpen={isManageCategoriesOpen} 
                        onClose={() => setIsManageCategoriesOpen(false)} 
                        categories={categories} 
                        onAdd={(c) => { setCategories([...categories, c]); onShowToast("Categoria criada!"); }}
                        onUpdate={(c) => setCategories(categories.map(cat => cat.id === c.id ? c : cat))}
                        onDelete={(id) => setCategories(categories.filter(c => c.id !== id))}
                    />

                    {/* Modal Nova Tarefa com Campos Solicitados */}
                    <Modal isOpen={isAddTaskOpen} onClose={() => setIsAddTaskOpen(false)} title="Nova Tarefa">
                        <div className="p-6 space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">O que precisa ser feito?</label><input autoFocus id="newTaskTitle" className="w-full p-2 border rounded-lg outline-none focus:border-blue-500" placeholder="Ex: Reservar hotel..."/></div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                                <select id="newTaskCategory" className="w-full p-2 border rounded-lg bg-white outline-none focus:border-blue-500">
                                    {categories.map(cat => <option key={cat.id} value={cat.id}>{cat.title}</option>)}
                                </select>
                            </div>
                            <button onClick={() => { 
                                const titleInput = document.getElementById('newTaskTitle');
                                const catInput = document.getElementById('newTaskCategory');
                                if(titleInput.value) {
                                    setTasks([...tasks, { id: Date.now().toString(), text: titleInput.value, category: catInput.value, status: 'todo', priority: 'medium', responsible: eventTeam[0], messages: [], subtasks: [] }]); 
                                    setIsAddTaskOpen(false); 
                                    onShowToast("Tarefa criada com sucesso!");
                                }
                            }} className="w-full bg-blue-900 text-white py-2 rounded-lg font-bold">Criar Tarefa</button>
                        </div>
                    </Modal>

                    {/* Modal Adicionar Membro ao Evento */}
                    <Modal isOpen={isAddMemberOpen} onClose={() => setIsAddMemberOpen(false)} title="Adicionar Participante">
                        <div className="p-4 space-y-2">
                            {globalMembers.filter(gm => !eventTeam.find(em => em.id === gm.id)).map(m => (
                                <button key={m.id} onClick={() => addTeamMember(m)} className="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg border border-transparent hover:border-gray-200 text-left">
                                    <Avatar member={m}/>
                                    <div><p className="font-bold text-sm text-gray-800">{m.name}</p><p className="text-xs text-gray-500">{m.role}</p></div>
                                </button>
                            ))}
                            {globalMembers.filter(gm => !eventTeam.find(em => em.id === gm.id)).length === 0 && <p className="text-center text-gray-500 text-sm py-4">Todos os membros já estão no evento.</p>}
                        </div>
                    </Modal>

                    {/* Modal Agenda Expandida */}
                    <Modal isOpen={isAgendaModalOpen} onClose={() => setIsAgendaModalOpen(false)} title="Agenda do Evento" fullScreen={true}>
                        <div className="flex flex-col h-full bg-gray-50">
                            <div className="flex-1 p-8 overflow-y-auto max-w-5xl mx-auto w-full">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                    <div className="md:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                        <h4 className="font-bold text-gray-800 mb-6 flex items-center gap-2"><Plus size={18} className="text-blue-600"/> Novo Evento</h4>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data</label>
                                                <input type="date" value={newAgendaItem.date} onChange={e => setNewAgendaItem({...newAgendaItem, date: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none focus:border-blue-500 transition-colors"/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Título</label>
                                                <input type="text" placeholder="Ex: Reunião Geral" value={newAgendaItem.title} onChange={e => setNewAgendaItem({...newAgendaItem, title: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none focus:border-blue-500 transition-colors"/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Descrição</label>
                                                <textarea placeholder="Detalhes..." rows={3} value={newAgendaItem.description} onChange={e => setNewAgendaItem({...newAgendaItem, description: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-xl text-sm outline-none focus:border-blue-500 transition-colors resize-none"></textarea>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Cor</label>
                                                <div className="flex flex-wrap gap-2">
                                                    {PASTEL_COLORS.map(c => (
                                                        <button key={c.id} type="button" onClick={() => setNewAgendaItem({...newAgendaItem, color: c.id})} className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${newAgendaItem.color === c.id ? 'border-gray-600 scale-110 shadow-sm' : 'border-transparent'}`} style={{backgroundColor: c.hex}}></button>
                                                    ))}
                                                </div>
                                            </div>
                                            <button onClick={handleAddAgendaItem} className="w-full bg-blue-900 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-900/20 hover:shadow-blue-900/40 transition-all mt-2">Adicionar à Agenda</button>
                                        </div>
                                    </div>
                                    
                                    <div className="md:col-span-2 space-y-6">
                                        <div className="flex items-center justify-between mb-4">
                                            <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                                <CalendarIcon className="text-blue-600"/> 
                                                {MONTH_NAMES[currentCalendarDate.getMonth()]} {currentCalendarDate.getFullYear()}
                                            </h2>
                                            <div className="flex gap-2">
                                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded-lg border"><ChevronLeft size={20}/></button>
                                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded-lg border"><ChevronRight size={20}/></button>
                                            </div>
                                        </div>
                                        {renderCalendar(currentCalendarDate)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </Modal>

                    <ConfirmModal isOpen={!!confirmDeleteTaskId} onClose={() => setConfirmDeleteTaskId(null)} onConfirm={() => deleteTask(confirmDeleteTaskId)} title="Excluir Tarefa" message="Tem certeza que deseja excluir esta tarefa permanentemente?" />
                    <ConfirmModal isOpen={!!memberToRemove} onClose={() => setMemberToRemove(null)} onConfirm={confirmRemoveMember} title="Remover Membro" message="Tem certeza que deseja remover este membro da equipe deste evento?" />
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [selectedEvent, setSelectedEvent] = useState(null);
            const [isAIOpen, setIsAIOpen] = useState(false);
            const [logo, setLogo] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isNotificationsOpen, setIsNotificationsOpen] = useState(false);
            const [isNewEventModalOpen, setIsNewEventModalOpen] = useState(false);
            const [toastMessage, setToastMessage] = useState(null);
            
            const [updates, setUpdates] = useState([
                { id: 1, user: 'Paulo Mokarzel', text: 'Produtos definidos e aprovados.', date: '04/12/2025' },
                { id: 2, user: 'Ana Silva', text: 'Gráfica colocou a previsão para entrega dos rótulos para o dia 23/05.', date: '27/11/2025' }
            ]);
            
            const [members, setMembers] = useState([
                { id: '1', name: 'Paulo Mokarzel', role: 'Gestor da Equipe', photoUrl: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop' },
                { id: '2', name: 'Ana Silva', role: 'Gerente de Mkt', photoUrl: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop' },
                { id: '3', name: 'Beatriz Costa', role: 'Coordenadora', photoUrl: 'https://images.unsplash.com/photo-1580489944761-15a19d654956?w=100&h=100&fit=crop' },
                { id: '4', name: 'João Mendes', role: 'Logística', photoUrl: null },
                { id: '5', name: 'Fernanda Lima', role: 'Social Media', photoUrl: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=100&h=100&fit=crop' }
            ]);

            const [events, setEvents] = useState([
                { id: 'ev1', title: 'Convenção de Vendas 2026', location: 'Auditório Doremus', dateRange: '02/02/2026 - 06/02/2026', coverUrl: null }
            ]);

            const notifications = [{ text: "Tarefa concluída: Orçamento Aprovado", date: "Há 10 min" }];

            const handleLogoUpload = (e) => { const file = e.target.files[0]; if(file) compressImage(file, 200).then(setLogo); };

            // Show toast function
            const showToast = (msg) => {
                setToastMessage(msg);
                if(Math.random() > 0.7) { setTimeout(() => setToastMessage("Nova atualização: João comentou na tarefa Logística"), 8000); }
            };

            const handleAddEvent = (eventData) => {
                const newEvent = {
                    id: `ev-${Date.now()}`,
                    ...eventData
                };
                setEvents([...events, newEvent]);
                setIsNewEventModalOpen(false);
                showToast("Evento criado com sucesso!");
            };

            return (
                <div className="min-h-screen pb-12">
                    <header className="fixed top-0 left-0 right-0 bg-white h-24 border-b border-gray-100 z-40 px-8 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-6 cursor-pointer" onClick={() => setView('dashboard')}>
                            <div className={`h-12 w-32 rounded-lg flex items-center justify-center text-xs text-gray-400 font-medium relative transition-colors ${!logo ? 'border-2 border-dashed border-gray-300 hover:border-blue-400' : ''}`}>{logo ? <img src={logo} className="h-full w-full object-contain"/> : "Sua Logo"}<input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleLogoUpload} accept="image/*" /></div>
                            <div className="h-10 w-px bg-gray-200"></div><div><h1 className="text-2xl font-extrabold text-[#002060]">Event Hub</h1><p className="text-sm text-gray-500 font-medium">Painel de Marketing</p></div>
                        </div>
                        <div className="flex items-center gap-6">
                            <div className="flex items-center gap-3 pr-6 border-r border-gray-100 hidden md:flex">
                                <div className="w-10 h-10 rounded-full bg-gray-200 border border-gray-300 overflow-hidden relative"><Avatar member={members[0]} size="w-full h-full" textSize="text-xs"/></div>
                                <div className="text-right"><p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider leading-tight">Gestor da Equipe</p><p className="text-sm font-bold text-gray-800 leading-tight">{members[0].name}</p></div>
                            </div>
                            <div className="flex items-center gap-3 relative">
                                <button onClick={() => setIsNotificationsOpen(!isNotificationsOpen)} className="w-10 h-10 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded-xl transition-colors relative border border-gray-200 shadow-sm"><Bell size={20}/><span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span></button>
                                {isNotificationsOpen && <NotificationsDropdown onClose={() => setIsNotificationsOpen(false)} notifications={notifications} />}
                                <button onClick={() => setIsSettingsOpen(true)} className="w-10 h-10 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded-xl transition-colors border border-gray-200 shadow-sm"><Settings size={20}/></button>
                            </div>
                        </div>
                    </header>
                    <main className="pt-32 px-8 max-w-[1600px] mx-auto">
                        {view === 'dashboard' ? (
                            <DashboardView 
                                onSelectEvent={(e) => { setSelectedEvent(e); setView('event'); }} 
                                events={events} 
                                members={members} 
                                updates={updates}
                                onDeleteUpdate={(id) => setUpdates(updates.filter(u => u.id !== id))}
                                onNewEvent={() => setIsNewEventModalOpen(true)}
                            />
                        ) : (
                            <EventDetailView event={selectedEvent} onBack={() => setView('dashboard')} globalMembers={members} onShowToast={showToast}/>
                        )}
                    </main>
                    
                    <AIAssistant isOpen={isAIOpen} onClose={() => setIsAIOpen(false)} members={members} events={events} tasks={[]} />

                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)} 
                        members={members} 
                        logo={logo} 
                        setLogo={setLogo} 
                        onUpdateLogo={setLogo} 
                        onAddMember={(m) => setMembers([...members, {...m, id: Date.now().toString()}])} 
                        onUpdateMember={(m) => setMembers(members.map(mem => mem.id === m.id ? {...mem, ...m} : mem))} 
                        onDeleteMember={(id) => setMembers(members.filter(m => m.id !== id))} 
                    />

                    <NewEventModal 
                        isOpen={isNewEventModalOpen} 
                        onClose={() => setIsNewEventModalOpen(false)} 
                        members={members} 
                        onCreate={handleAddEvent}
                    />
                    
                    {toastMessage && <Toast message={toastMessage} onClose={() => setToastMessage(null)} />}

                    <button onClick={() => setIsAIOpen(true)} className="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full shadow-2xl hover:scale-110 transition-transform z-40 flex items-center justify-center group"><Bot size={28} className="group-hover:animate-bounce"/></button>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>






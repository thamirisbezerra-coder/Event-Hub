<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Hub - Marketing</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Scrollbar customizada */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>

    <!-- Import Map para gerenciar bibliotecas -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
      }
    }
    </script>
    
    <!-- Babel para traduzir o React no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calendar, CheckCircle2, Circle, Clock, AlertTriangle, 
            Users, Package, Truck, BarChart3, Plus, 
            ArrowLeft, Trash2, MapPin, MessageSquare, Send, CornerDownLeft,
            Settings, Upload, UserPlus, Image as ImageIcon, Pencil, X, AlertOctagon
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { 
            getFirestore, collection, onSnapshot, 
            addDoc, updateDoc, doc, deleteDoc, query, orderBy, serverTimestamp, setDoc 
        } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';

        // -----------------------------------------------------------
        // üõ†Ô∏è CONFIGURA√á√ÉO DE AMBIENTE (L√ìGICA H√çBRIDA)
        // -----------------------------------------------------------
        
        // Verifica se estamos no ambiente de preview (Canvas)
        const isPreviewEnv = typeof __firebase_config !== 'undefined';

        // Usa configura√ß√£o do ambiente OU cai no placeholder para o usu√°rio editar
        const firebaseConfig = isPreviewEnv ? JSON.parse(__firebase_config) : {
            // ‚ö†Ô∏è ATEN√á√ÉO: SUBSTITUA ISSO COM SEUS DADOS DO CONSOLE FIREBASE PARA FUNCIONAR NO GITHUB ‚ö†Ô∏è
            apiKey: "SUA_API_KEY_AQUI", 
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "SEU_MESSAGING_ID",
            appId: "SEU_APP_ID"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'marketing-event-hub-prod'; 
        
        // üõë TELA DE BLOQUEIO SE N√ÉO TIVER CONFIGURADO
        if (!isPreviewEnv && firebaseConfig.apiKey === "SUA_API_KEY_AQUI") {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="min-height:100vh; display:flex; align-items:center; justify-content:center; background-color:#f8fafc; font-family:sans-serif; padding:20px;">
                    <div style="max-width:600px; background:white; padding:40px; border-radius:24px; box-shadow:0 10px 25px -5px rgba(0,0,0,0.1); text-align:center;">
                        <div style="background:#fee2e2; width:64px; height:64px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        </div>
                        <h1 style="color:#1e293b; font-size:1.5rem; font-weight:800; margin-bottom:10px;">Falta Configurar o Firebase</h1>
                        <p style="color:#64748b; line-height:1.6; margin-bottom:20px;">
                            O aplicativo n√£o consegue salvar dados porque est√° usando uma chave gen√©rica. 
                            Para funcionar no GitHub Pages, voc√™ precisa editar o arquivo <code>index.html</code>.
                        </p>
                        <div style="background:#1e293b; color:#a5b4fc; padding:20px; border-radius:12px; text-align:left; font-family:monospace; font-size:0.85rem; overflow-x:auto; margin-bottom:20px;">
                            const firebaseConfig = {<br/>
                            &nbsp;&nbsp;<span style="color:#f87171;">apiKey: "SUA_API_KEY_AQUI",</span> // &lt;-- Cole sua chave real aqui<br/>
                            &nbsp;&nbsp;authDomain: "...",<br/>
                            &nbsp;&nbsp;projectId: "..."<br/>
                            };
                        </div>
                        <a href="https://console.firebase.google.com/" target="_blank" style="display:inline-block; background:#4f46e5; color:white; text-decoration:none; padding:12px 24px; border-radius:99px; font-weight:600; font-size:0.9rem; transition:all 0.2s;">
                            Ir para Console do Firebase &rarr;
                        </a>
                    </div>
                </div>
            `;
            throw new Error("Aplica√ß√£o parada: Aguardando configura√ß√£o de API Key.");
        }

        // Inicializa√ß√£o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Constantes e Dados Iniciais ---
        const PRESET_COLORS = [
            { color: 'bg-rose-500', bubble: 'bg-rose-100 text-rose-900 border-rose-200' },
            { color: 'bg-violet-600', bubble: 'bg-violet-100 text-violet-900 border-violet-200' },
            { color: 'bg-amber-500', bubble: 'bg-amber-100 text-amber-900 border-amber-200' },
            { color: 'bg-cyan-500', bubble: 'bg-cyan-100 text-cyan-900 border-cyan-200' },
            { color: 'bg-emerald-500', bubble: 'bg-emerald-100 text-emerald-900 border-emerald-200' },
            { color: 'bg-blue-500', bubble: 'bg-blue-100 text-blue-900 border-blue-200' },
            { color: 'bg-fuchsia-500', bubble: 'bg-fuchsia-100 text-fuchsia-900 border-fuchsia-200' },
        ];

        const DEFAULT_TASKS = [
            { title: 'Defini√ß√£o de Produtos Inova√ß√£o', category: 'produto', assignee: '', status: 'pending', deadline: '' },
            { title: 'Design: Etiquetas e Apresenta√ß√µes', category: 'produto', assignee: '', status: 'pending', deadline: '' },
            { title: 'Entrega Final Design (1 m√™s antes)', category: 'produto', assignee: '', status: 'pending', deadline: '' },
            { title: 'Solicita√ß√£o de Brindes/Amostras', category: 'produto', assignee: '', status: 'pending', deadline: '' },
            { title: 'Material de Merchandising', category: 'logistica', assignee: '', status: 'pending', deadline: '' },
            { title: 'Acompanhamento Design do Estande', category: 'logistica', assignee: '', status: 'pending', deadline: '' },
            { title: 'Acompanhamento Obra do Estande', category: 'logistica', assignee: '', status: 'pending', deadline: '' },
            { title: 'Emiss√£o de Notas Fiscais', category: 'logistica', assignee: '', status: 'pending', deadline: '' },
            { title: 'Transporte (Agendamento/Placa/Motorista)', category: 'logistica', assignee: '', status: 'pending', deadline: '', notes: 'Placa: \nMotorista: \nCredencial: ' },
            { title: 'Contrata√ß√£o Fotografia/Ag√™ncia', category: 'staff', assignee: '', status: 'pending', deadline: '' },
            { title: 'Lista de Equipamentos', category: 'staff', assignee: '', status: 'pending', deadline: '' },
            { title: 'Hospedagem T√©cnicos/Staff', category: 'staff', assignee: '', status: 'pending', deadline: '' },
            { title: 'Aluguel de Carros', category: 'staff', assignee: '', status: 'pending', deadline: '' },
            { title: 'Lead Tracking / Coleta de Dados', category: 'pos-evento', assignee: '', status: 'pending', deadline: '' },
            { title: 'Feedback P√≥s-Feira', category: 'pos-evento', assignee: '', status: 'pending', deadline: '' },
            { title: 'Postagens Cobertura (V√≠deos/Fotos)', category: 'pos-evento', assignee: '', status: 'pending', deadline: '' },
        ];

        // --- Componente Avatar ---
        const Avatar = ({ photo, name, color, size = 'md', className = '' }) => {
            const sizeClasses = {
                xs: 'w-6 h-6 text-[9px]',
                sm: 'w-8 h-8 text-[10px]',
                md: 'w-10 h-10 text-xs',
                lg: 'w-14 h-14 text-sm',
                xl: 'w-24 h-24 text-base'
            };

            if (photo) {
                return (
                    <img 
                        src={photo} 
                        alt={name} 
                        className={`${sizeClasses[size]} rounded-full object-cover border-2 border-white shadow-sm hover:scale-105 transition-transform duration-200 ${className}`}
                    />
                );
            }

            const initials = name ? name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
            const bgColor = color || 'bg-slate-300';

            return (
                <div className={`${sizeClasses[size]} rounded-full ${bgColor} flex items-center justify-center text-white font-bold border-2 border-white shadow-sm ${className}`}>
                    {initials}
                </div>
            );
        };

        // --- App Principal ---
        function MarketingEventsSuperApp() {
            const [user, setUser] = useState(null);
            const [events, setEvents] = useState([]);
            const [team, setTeam] = useState([]);
            const [settings, setSettings] = useState({});
            const [loading, setLoading] = useState(true);
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedEventId, setSelectedEventId] = useState(null);
            
            // Modais
            const [showNewEventModal, setShowNewEventModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            
            // Edi√ß√£o
            const [editingMember, setEditingMember] = useState(null);
            const [expandedComments, setExpandedComments] = useState({});

            // Autentica√ß√£o Robusta
            useEffect(() => {
                const initAuth = async () => {
                    // Se estiver no ambiente de preview com token, usa o token
                    if (isPreviewEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            console.warn("Erro ao logar com token customizado, tentando an√¥nimo", e);
                            await signInAnonymously(auth);
                        }
                    } else {
                        // Caso contr√°rio (GitHub Pages), login an√¥nimo
                        await signInAnonymously(auth);
                    }
                };
                
                initAuth().catch(err => console.error("Erro na autentica√ß√£o:", err));
                const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
                return () => unsubscribe();
            }, []);

            // Buscar Eventos
            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'marketing_events'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const eventsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    eventsData.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
                    setEvents(eventsData);
                    setLoading(false);
                }, (error) => {
                    console.error("Erro ao carregar eventos:", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            // Buscar Equipe
            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'team_members'), orderBy('name'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        setTeam(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    } else {
                        // Criar equipe padr√£o se vazio
                        const defaultTeam = [
                            { name: 'Suzana Santos', role: 'Gest√£o', color: 'bg-rose-500', bubble: 'bg-rose-100 text-rose-900 border-rose-200' },
                            { name: 'Felipe Paiva', role: 'Design', color: 'bg-violet-600', bubble: 'bg-violet-100 text-violet-900 border-violet-200' },
                            { name: 'Matheus Silva', role: 'Log√≠stica', color: 'bg-amber-500', bubble: 'bg-amber-100 text-amber-900 border-amber-200' },
                            { name: 'Larissa Tom√©', role: 'Eventos', color: 'bg-cyan-500', bubble: 'bg-cyan-100 text-cyan-900 border-cyan-200' },
                        ];
                        defaultTeam.forEach(member => {
                            addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'team_members'), member);
                        });
                    }
                }, (error) => console.error("Erro ao carregar equipe:", error));
                return () => unsubscribe();
            }, [user]);

            // Buscar Configura√ß√µes
            useEffect(() => {
                if (!user) return;
                const unsubscribe = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), (doc) => {
                    if (doc.exists()) {
                        setSettings(doc.data());
                    }
                });
                return () => unsubscribe();
            }, [user]);

            // L√≥gica e Estat√≠sticas
            const stats = useMemo(() => {
                const allTasks = events.flatMap(e => e.tasks);
                const totalPending = allTasks.filter(t => t.status === 'pending').length;
                const totalDone = allTasks.filter(t => t.status === 'done').length;
                
                const workload = team.map(member => ({
                    ...member,
                    count: allTasks.filter(t => t.assignee === member.name && t.status === 'pending').length,
                }));

                const alerts = events.map(event => {
                    const pendingCount = event.tasks.filter(t => t.status === 'pending').length;
                    return { eventId: event.id, eventTitle: event.title, pendingCount, hasWarning: pendingCount > 0 };
                }).filter(a => a.hasWarning);

                const recentComments = events
                    .flatMap(e => e.tasks.flatMap(t => (t.comments || []).map(c => ({ ...c, taskTitle: t.title, eventTitle: e.title }))))
                    .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
                    .slice(0, 5);

                return { totalPending, totalDone, workload, alerts, recentComments };
            }, [events, team]);

            const getMemberData = (name) => team.find(m => m.name === name) || { name, role: 'Staff', color: 'bg-slate-400', bubble: 'bg-slate-100 text-slate-800' };

            // Fun√ß√µes Auxiliares
            const handleFileUpload = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            const updateLogo = async (e) => {
                if (e.target.files && e.target.files[0]) {
                    const base64 = await handleFileUpload(e.target.files[0]);
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { logo: base64 }, { merge: true });
                }
            };

            const addTeamMember = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const name = formData.get('name');
                const role = formData.get('role');
                const file = formData.get('photo');
                
                let photo = '';
                if (file.size > 0) {
                    photo = await handleFileUpload(file);
                }

                const randomColor = PRESET_COLORS[team.length % PRESET_COLORS.length];

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'team_members'), {
                    name, role, photo, ...randomColor
                });
                e.target.reset();
            };

            const updateTeamMember = async (e) => {
                e.preventDefault();
                if (!editingMember) return;
                const formData = new FormData(e.target);
                const updates = { 
                    name: formData.get('name'), 
                    role: formData.get('role') 
                };
                if (formData.get('photo').size > 0) {
                    updates.photo = await handleFileUpload(formData.get('photo'));
                }
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team_members', editingMember.id), updates);
                setEditingMember(null);
                e.target.reset();
            };

            const deleteTeamMember = async (id) => {
                if(confirm('Remover membro?')) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team_members', id));
                }
            };

            // A√ß√µes do Evento
            const handleCreateEvent = async (e) => {
                e.preventDefault();
                if (!user) return;
                const formData = new FormData(e.target);
                const newEvent = {
                    title: formData.get('title'),
                    date: formData.get('date'),
                    location: formData.get('location'),
                    mainResponsible: formData.get('responsible'),
                    status: 'planning',
                    leadsCount: 0,
                    feedback: '',
                    createdAt: serverTimestamp(),
                    tasks: DEFAULT_TASKS.map(t => ({ ...t, id: crypto.randomUUID() }))
                };
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'marketing_events'), newEvent);
                setShowNewEventModal(false);
            };

            const handleUpdateTask = async (eventId, taskId, updates) => {
                const event = events.find(e => e.id === eventId);
                const updatedTasks = event.tasks.map(t => t.id === taskId ? { ...t, ...updates } : t);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'marketing_events', eventId), { tasks: updatedTasks });
            };

            const handleAddTaskComment = async (eventId, taskId, text, author) => {
                const event = events.find(e => e.id === eventId);
                const newComment = { id: crypto.randomUUID(), text, authorName: author, createdAt: new Date().toISOString() };
                const updatedTasks = event.tasks.map(t => t.id === taskId ? { ...t, comments: [...(t.comments || []), newComment] } : t);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'marketing_events', eventId), { tasks: updatedTasks });
            };

            // --- Views ---
            const AssigneeSelector = ({ currentAssignee, onSelect, minimal = false }) => {
                const [isOpen, setIsOpen] = useState(false);
                const assignedMember = getMemberData(currentAssignee);
                return (
                    <div className="relative">
                        <button onClick={() => setIsOpen(!isOpen)} className={`flex items-center gap-2 ${minimal ? 'p-1 hover:bg-slate-100 rounded-full' : 'pl-1 pr-3 py-1 bg-white border border-slate-200 rounded-full hover:border-violet-400'} transition-colors group shadow-sm`}>
                            <Avatar name={currentAssignee} photo={assignedMember?.photo} color={assignedMember?.color} size={minimal ? "xs" : "sm"} />
                            {!minimal && <span className="text-xs font-medium truncate max-w-[80px] text-slate-700">{currentAssignee ? currentAssignee.split(' ')[0] : 'Resp.'}</span>}
                        </button>
                        {isOpen && (
                            <>
                                <div className="fixed inset-0 z-40" onClick={() => setIsOpen(false)} />
                                <div className="absolute top-full left-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-slate-100 z-50 overflow-hidden max-h-60 overflow-y-auto">
                                    <div className="p-2 bg-slate-50 border-b border-slate-100 text-xs font-bold text-slate-500 uppercase">Selecionar</div>
                                    {team.map(member => (
                                        <button key={member.id} onClick={() => { onSelect(member.name); setIsOpen(false); }} className="w-full flex items-center gap-3 p-2 hover:bg-violet-50 transition-colors text-left">
                                            <Avatar name={member.name} photo={member.photo} color={member.color} size="sm" />
                                            <div className="flex flex-col"><span className="text-sm font-medium text-slate-700">{member.name}</span><span className="text-[10px] text-slate-400">{member.role}</span></div>
                                        </button>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>
                );
            };

            if (loading) return <div className="flex h-screen items-center justify-center bg-slate-50"><div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div></div>;

            return (
                <div className="min-h-screen bg-slate-50/50 p-4 md:p-8 max-w-7xl mx-auto">
                    {/* Header e Navega√ß√£o */}
                    {currentView === 'dashboard' ? (
                        <div className="space-y-8 animate-fadeIn pb-20">
                            {/* Hero Dashboard */}
                            <div className="bg-white rounded-3xl p-6 md:p-8 shadow-xl shadow-slate-200/50 border border-slate-100">
                                <div className="flex flex-col md:flex-row justify-between items-center gap-6 mb-8">
                                    <div className="flex items-center gap-6">
                                        {settings.logo && <img src={settings.logo} className="h-16 object-contain" />}
                                        {settings.logo && <div className="h-10 w-px bg-slate-200 hidden md:block"></div>}
                                        <div><h1 className="text-2xl font-black text-slate-800 tracking-tight">Event Hub</h1><p className="text-slate-500 font-medium text-sm">Painel de Marketing</p></div>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => setShowSettingsModal(true)} className="bg-slate-100 text-slate-600 px-4 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-slate-200"><Settings size={20} /></button>
                                        <button onClick={() => setShowNewEventModal(true)} className="bg-blue-900 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:scale-105 transition-all"><Plus size={20} /> Novo Evento</button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                    <div className="bg-slate-50 rounded-2xl p-5 border border-slate-100 flex items-center gap-4">
                                        <div className="relative w-24 h-24 flex-shrink-0">
                                            <svg className="w-full h-full" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="transparent" stroke="#e2e8f0" strokeWidth="12" /><circle cx="50" cy="50" r="40" fill="transparent" stroke="#10b981" strokeWidth="12" strokeDasharray={`${(stats.totalDone / (stats.totalDone + stats.totalPending || 1)) * 251} 251`} strokeDashoffset="0" className="origin-center -rotate-90" /></svg>
                                            <div className="absolute inset-0 flex items-center justify-center flex-col"><span className="text-xl font-black text-slate-700">{Math.round((stats.totalDone / (stats.totalDone + stats.totalPending || 1)) * 100)}%</span></div>
                                        </div>
                                        <div><h3 className="font-bold text-slate-800">Status Global</h3><div className="flex gap-3 text-xs font-bold mt-2"><span className="text-emerald-600 flex items-center gap-1"><Circle size={8} fill="currentColor" /> {stats.totalDone} Feitas</span><span className="text-amber-500 flex items-center gap-1"><Circle size={8} fill="currentColor" /> {stats.totalPending} Pend.</span></div></div>
                                    </div>

                                    <div className="bg-slate-50 rounded-2xl p-5 border border-slate-100 col-span-1 md:col-span-2">
                                        <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4"><Users size={16} /> Carga de Trabalho</h3>
                                        <div className="flex gap-4 items-end h-24 overflow-x-auto pb-2">
                                            {stats.workload.map(member => (
                                                <div key={member.id} className="flex flex-col items-center gap-2 min-w-[50px]">
                                                    <div className="w-8 bg-slate-200 rounded-t-lg relative flex-1 min-h-[10px]"><div className="absolute bottom-0 left-0 right-0 bg-indigo-600 rounded-t-lg transition-all" style={{ height: `${Math.max(Math.min((member.count / 10) * 100, 100), 5)}%` }}></div></div>
                                                    <Avatar name={member.name} photo={member.photo} color={member.color} size="xs" />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2 space-y-4">
                                    <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><div className="text-indigo-600"><Clock /></div> Pr√≥ximos Eventos</h2>
                                    {events.map(event => {
                                        const pending = event.tasks.filter(t => t.status === 'pending').length;
                                        return (
                                            <div key={event.id} onClick={() => { setSelectedEventId(event.id); setCurrentView('detail'); }} className="bg-white rounded-2xl p-6 shadow-md hover:shadow-xl transition-all cursor-pointer border border-transparent hover:border-indigo-100 relative">
                                                {pending > 0 && <div className="absolute top-4 right-4 bg-amber-50 text-amber-700 px-3 py-1 rounded-full text-xs font-bold border border-amber-100 flex items-center gap-1"><AlertTriangle size={12}/> faltam {pending}</div>}
                                                <div className="flex gap-4">
                                                    <div className="bg-slate-100 p-3 rounded-xl text-center min-w-[70px]"><span className="block text-xs font-bold text-slate-500 uppercase">{new Date(event.date).toLocaleDateString('pt-BR', { month: 'short' })}</span><span className="block text-2xl font-black text-slate-800">{new Date(event.date).getDate()}</span></div>
                                                    <div><h3 className="text-lg font-bold text-slate-800">{event.title}</h3><p className="text-sm text-slate-500 flex items-center gap-1"><MapPin size={14}/> {event.location}</p></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="space-y-4">
                                    <div className="bg-white rounded-2xl p-5 shadow-lg border border-slate-100 max-h-[500px] overflow-auto flex flex-col">
                                        <h3 className="font-bold text-slate-800 mb-4 flex gap-2"><MessageSquare size={18} className="text-indigo-500" /> Atualiza√ß√µes</h3>
                                        <div className="space-y-4">
                                            {stats.recentComments.map((c, i) => {
                                                const author = getMemberData(c.authorName);
                                                return (
                                                    <div key={i} className="flex gap-3 pb-3 border-b border-slate-50 last:border-0">
                                                        <Avatar name={c.authorName} photo={author?.photo} color={author?.color} size="xs" className="mt-1"/>
                                                        <div>
                                                            <div className="flex gap-2 items-baseline"><span className="text-xs font-bold text-slate-700">{c.authorName.split(' ')[0]}</span><span className="text-[10px] text-slate-400">{new Date(c.createdAt).toLocaleDateString()}</span></div>
                                                            <div className="text-[10px] text-indigo-500 font-medium mb-1 flex items-center gap-1"><CornerDownLeft size={10}/> {c.eventTitle}</div>
                                                            <p className="text-xs bg-slate-50 p-2 rounded-lg text-slate-600">{c.text}</p>
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="animate-fadeIn pb-20">
                            {/* Detalhe do Evento */}
                            <div className="bg-white rounded-3xl p-6 md:p-8 shadow-xl mb-8 flex flex-col md:flex-row justify-between gap-6">
                                <div className="flex items-center gap-4">
                                    <button onClick={() => setCurrentView('dashboard')} className="p-3 bg-slate-50 hover:bg-slate-100 rounded-full text-slate-600"><ArrowLeft size={24}/></button>
                                    <div>
                                        <h1 className="text-3xl font-black text-slate-800">{events.find(e => e.id === selectedEventId)?.title}</h1>
                                        <div className="flex gap-4 text-sm text-slate-500 mt-2"><span className="flex gap-2"><Clock size={16}/> {new Date(events.find(e => e.id === selectedEventId)?.date).toLocaleDateString()}</span></div>
                                    </div>
                                </div>
                                <div className="flex gap-4">
                                    <div className="flex items-center gap-3 bg-slate-50 p-2 rounded-xl">
                                        <Avatar name={events.find(e => e.id === selectedEventId)?.mainResponsible} photo={getMemberData(events.find(e => e.id === selectedEventId)?.mainResponsible)?.photo} color={getMemberData(events.find(e => e.id === selectedEventId)?.mainResponsible)?.color} size="md"/>
                                        <div><p className="text-xs font-bold text-slate-400 uppercase">L√≠der</p><p className="font-bold text-slate-700 text-sm">{events.find(e => e.id === selectedEventId)?.mainResponsible}</p></div>
                                    </div>
                                    <button onClick={() => { if(confirm('Excluir?')) { deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'marketing_events', selectedEventId)); setCurrentView('dashboard'); }}} className="text-red-400 hover:bg-red-50 p-3 rounded-lg"><Trash2/></button>
                                </div>
                            </div>
                            
                            {/* Lista de Tarefas Simplificada para Exemplo */}
                            <div className="bg-white rounded-2xl shadow-xl p-6">
                                <h3 className="font-bold text-lg mb-4">Tarefas</h3>
                                {events.find(e => e.id === selectedEventId)?.tasks.map(task => (
                                    <div key={task.id} className="p-4 border-b border-slate-100 last:border-0 flex gap-4 hover:bg-slate-50 transition-colors">
                                        <button onClick={() => handleUpdateTask(selectedEventId, task.id, { status: task.status === 'done' ? 'pending' : 'done' })} className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center ${task.status === 'done' ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300'}`}><CheckCircle2 size={16}/></button>
                                        <div className="flex-1">
                                            <div className="flex justify-between">
                                                <span className={`font-semibold ${task.status === 'done' ? 'text-emerald-800 line-through' : 'text-slate-800'}`}>{task.title}</span>
                                                <AssigneeSelector currentAssignee={task.assignee} onSelect={(name) => handleUpdateTask(selectedEventId, task.id, { assignee: name })} minimal />
                                            </div>
                                            
                                            <div className="mt-2 flex gap-2">
                                                <button onClick={() => setExpandedComments(p => ({...p, [task.id]: !p[task.id]}))} className="text-xs font-bold text-slate-400 flex items-center gap-1 hover:text-indigo-600"><MessageSquare size={14}/> {task.comments?.length||0}</button>
                                                <input type="date" value={task.deadline} onChange={(e) => handleUpdateTask(selectedEventId, task.id, { deadline: e.target.value })} className="text-xs border rounded px-1 bg-transparent" />
                                            </div>

                                            {expandedComments[task.id] && (
                                                <div className="mt-3 bg-slate-50 p-3 rounded-lg border border-slate-200">
                                                    <div className="space-y-2 mb-2 max-h-40 overflow-auto">
                                                        {task.comments?.map(c => (
                                                            <div key={c.id} className="text-xs bg-white p-2 rounded shadow-sm">
                                                                <span className="font-bold">{c.authorName.split(' ')[0]}:</span> {c.text}
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <input id={`comment-${task.id}`} placeholder="Comentar..." className="flex-1 text-xs p-1 border rounded" />
                                                        <button onClick={() => { const input = document.getElementById(`comment-${task.id}`); if(input.value) { handleAddTaskComment(selectedEventId, task.id, input.value, events.find(e=>e.id===selectedEventId).mainResponsible); input.value=''; } }} className="bg-indigo-600 text-white p-1 rounded"><Send size={12}/></button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Modal Configura√ß√µes */}
                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col">
                                <div className="bg-slate-800 p-6 text-white flex justify-between items-center">
                                    <h2 className="text-xl font-bold flex gap-2"><Settings className="text-violet-400"/> Configura√ß√µes</h2>
                                    <button onClick={() => { setShowSettingsModal(false); setEditingMember(null); }}><X/></button>
                                </div>
                                <div className="p-8 overflow-y-auto space-y-8 flex-1">
                                    <section>
                                        <h3 className="font-bold text-slate-800 mb-4 flex gap-2"><ImageIcon size={20} className="text-violet-600"/> Logo</h3>
                                        <div className="flex items-center gap-6 bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                            <div className="w-32 h-16 bg-white border rounded flex items-center justify-center overflow-hidden">{settings.logo ? <img src={settings.logo} className="w-full h-full object-contain"/> : <span className="text-xs text-slate-400">Sem Logo</span>}</div>
                                            <div><label className="block text-sm font-medium mb-2">Carregar logo</label><input type="file" accept="image/*" onChange={updateLogo} className="text-xs text-slate-500"/></div>
                                        </div>
                                    </section>
                                    <section>
                                        <h3 className="font-bold text-slate-800 mb-4 flex gap-2"><Users size={20} className="text-violet-600"/> Equipe</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                            {team.map(member => (
                                                <div key={member.id} className={`flex items-center gap-3 p-3 bg-white border rounded-xl shadow-sm ${editingMember?.id === member.id ? 'border-violet-500 ring-2 ring-violet-100' : 'border-slate-200'}`}>
                                                    <Avatar name={member.name} photo={member.photo} color={member.color}/>
                                                    <div className="flex-1 min-w-0"><p className="font-bold text-sm truncate">{member.name}</p><p className="text-xs text-slate-500 truncate">{member.role}</p></div>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => setEditingMember(member)} className="text-slate-400 hover:text-violet-600 p-2"><Pencil size={16}/></button>
                                                        <button onClick={() => deleteTeamMember(member.id)} className="text-slate-400 hover:text-red-500 p-2"><Trash2 size={16}/></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className={`bg-slate-50 p-6 rounded-2xl border ${editingMember ? 'border-violet-200 bg-violet-50' : 'border-slate-200'}`}>
                                            <div className="flex justify-between items-center mb-4"><h4 className="text-sm font-bold flex gap-2">{editingMember ? <><Pencil size={16}/> Editando: {editingMember.name}</> : <><UserPlus size={16}/> Novo Membro</>}</h4>{editingMember && <button onClick={() => setEditingMember(null)} className="text-xs underline">Cancelar</button>}</div>
                                            <form onSubmit={editingMember ? updateTeamMember : addTeamMember} className="space-y-4">
                                                <div className="grid grid-cols-2 gap-4"><input required name="name" defaultValue={editingMember?.name} placeholder="Nome" className="p-2 border rounded-lg text-sm"/><input required name="role" defaultValue={editingMember?.role} placeholder="Cargo" className="p-2 border rounded-lg text-sm"/></div>
                                                <div><label className="text-xs font-medium text-slate-600">Foto</label><input name="photo" type="file" accept="image/*" className="block w-full text-xs text-slate-500 mt-1"/></div>
                                                <button type="submit" className={`w-full text-white py-2 rounded-lg font-bold text-sm ${editingMember ? 'bg-violet-600' : 'bg-slate-800'}`}>{editingMember ? 'Salvar' : 'Adicionar'}</button>
                                            </form>
                                        </div>
                                    </section>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Novo Evento */}
                    {showNewEventModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden">
                                <div className="bg-blue-900 p-6 text-white"><h2 className="text-2xl font-black">Novo Evento</h2></div>
                                <form onSubmit={handleCreateEvent} className="p-8 space-y-4">
                                    <input required name="title" placeholder="Nome" className="w-full p-3 border rounded-xl"/>
                                    <div className="grid grid-cols-2 gap-4"><input required name="date" type="date" className="p-3 border rounded-xl"/><select name="responsible" className="p-3 border rounded-xl">{team.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}</select></div>
                                    <input required name="location" placeholder="Local" className="w-full p-3 border rounded-xl"/>
                                    <div className="flex gap-4 mt-4"><button type="button" onClick={() => setShowNewEventModal(false)} className="flex-1 py-3 text-slate-500 hover:bg-slate-50 rounded-xl">Cancelar</button><button type="submit" className="flex-1 py-3 bg-blue-900 text-white rounded-xl font-bold">Criar</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<MarketingEventsSuperApp />);
    </script>
</body>
</html>
